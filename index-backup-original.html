<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="Images/BTS LOGO.png">
    <title>The blue Traders.com</title>
    <meta name="description" content="A sample HTML5 template.">
    <link rel="stylesheet" href="styles.css">
    <style>

        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #d0d8e4;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 220px;
            height: 100%;
            background: #04283d;
            color: #fff;
            padding-top: 60px;
            box-shadow: 2px 0 8px rgba(0,0,0,0.07);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .sidebar.hide {
            transform: translateX(-100%);
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li {
            margin: 0;
        }

        .sidebar ul li a {
            display: block;
            color: #fff;
            text-decoration: none;
            padding: 16px 24px;
            font-size: 1.1em;
            transition: 0.2s;
        }

        .sidebar ul li a:hover {
            background: #3949ab;
        }

        .main-content {
            margin-left: 220px;
            transition: margin-left 0.3s;
        }

        .sidebar.hide ~ .main-content {
            margin-left: 0;
        }

        header {
            background: #0d6b6e;
            color: #fff;
            padding: 0 32px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 900;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo {
            height: 40px;
            width: 40px;
            border-radius: 20px;
            background: #033133;
            object-fit: contain;
        }

        header h1 {
            font-size: 1.5em;
            margin: 0;
            font-weight: 700;
            letter-spacing: 1px;
        }

        header nav ul {
            display: flex;
            gap: 20px;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        header nav ul li a {
            color: #fff;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 4px;
            transition: 0.2s;
        }

        header nav ul li a:hover {
            background: #3949ab;
        }

        .toggle-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 2em;
            cursor: pointer;
            margin-right: 16px;
            display: none;
        }

        @media (max-width: 900px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.hide {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
            .toggle-btn {
                display: block;
            }
        }

        footer {
            background: #1a5e7e;
            color: #fff;
            text-align: center;
            padding: 16px 0;
            margin-top: 40px;
            font-size: 1em;
        }
    </style>
    
    
</head>
<body>
</body>
    <nav class="sidebar" id="sidebar">
        <ul>
            <li><a href="#">Home</a></li>
            <li><a href="#">Verify your Account</a></li>
            <li><a href="#">Deposit</a></li>
            <li><a href="#">Withdraw</a></li>
            <li><a href="#">Transferfunds</a></li>
            <li><a href="#">Accounts</a></li>
            <li><a href="#">Profile</a></li>
            <li><a href="#">Settings</a></li>
            <li><a href="#">Promotions</a></li>
            <li><a href="#">Refer a Friend</a></li>
            
        </ul>
    </nav>
    <div class="main-content">
        <header>
            <button class="toggle-btn" id="toggleSidebar">&#9776;</button>
            <div class="logo-container">
                <img src="Images/BTS LOGO.png" alt="logo" class="logo">
            <h3>The Blue Trader platforms</h3>
            </div>
            
            <nav>
                <span id="accountBalance" style="margin-right:24px;font-weight:600;color:#fff;background:#158173;padding:6px 16px;border-radius:20px;box-shadow:0 1px 4px rgba(0,0,0,0.06);font-size:1em;">
                    Balance: $5,000.00
                </span>
                
                <ul style="display: flex; gap: 20px; list-style: none; margin: 0;"> 
                    <li><a href="#" style="color:#fff;">Markets</a></li>
                    <li><a href="#" style="color:#fff;">Open Demo/Live A/C</a></li>
                    <li><a href="#" style="color:#fff;">SignUp/Login</a></li>
                    
                   
                </ul>
                 
            </nav>
        </header>
        <main>
            <section>
                <h2>About: The blue Traders</h2>
                <p>The blue traders.com "Unveiling your treasures"</p>
                <div style="background:#f4f7fa;padding:18px 16px;border-radius:8px;max-width:600px;margin-bottom:18px;">
                    <b>The Blue Traders</b> is a modern online trading platform offering Forex, Indices, Synthetics, Commodities, Metals, and Crypto. Enjoy fast deposits, instant withdrawals, and 24/7 support. Secure, user-friendly, and built for traders of all levels.
                </div>
            
            </section>
        </main>
        <footer>
            <p>
                <a href="mailto:support@bluetraders.com" style="color:#fff;text-decoration:underline;">support@bluetraders.com</a> |
                <a href="tel:+256786760152" style="color:#fff;text-decoration:underline;">(+256) 786 760 152</a> |
                <a href="https://www.bluetraders.com" target="_blank" style="color:#fff;text-decoration:underline;">www.bluetraders.com</a>
                | <a href="https://wa.me/256786760152" target="_blank" style="color:#fff;text-decoration:underline;">WhatsApp: +256 786 760 152</a>
                | <a href="https://t.me/+256786760152" target="_blank" style="color:#fff;text-decoration:underline;">Telegram: +256 786 760 152</a>

                | <a href="#" style="color:#fff;text-decoration:underline;">Forex Education With Domicile FX</a>
                | <a href="#" style="color:#fff;text-decoration:underline;">Forex News</a>
            </p>
            <p>&copy; 2024 The blue traders</p>
            <P></P>
            <div style="margin-top:24px;text-align:center;">
                <h3 style="color:#158173;margin-bottom:8px;">Company Profile</h3>
                <p style="max-width:700px;margin:0 auto 8px auto;font-size:1.05em;color:#3949ab;">
                    <b>The Blue Traders</b> is a leading online trading platform offering access to global financial markets including Forex, Indices, Synthetics, Commodities, Metals, and Cryptocurrencies. Established in 2024/5s/21, we are committed to providing secure, transparent, and innovative trading solutions for traders of all levels.
                </p>
                <p style="max-width:700px;margin:0 auto 8px auto;font-size:1.05em;color:#3949ab;">
                    Our mission is to empower clients with advanced technology, competitive pricing, and exceptional customer support. We operate with integrity and adhere to strict regulatory standards, ensuring the safety of client funds and data.
                </p>
                <p style="max-width:700px;margin:0 auto 8px auto;font-size:1.05em;color:#3949ab;">
                    <b>Key Features:</b> <br>
                    • Multi-asset trading (Forex, Synthetics, Indices, Metals, Commodities, Crypto)<br>
                    • Fast deposits & withdrawals via bank, mobile money, and crypto<br>
                    • 24/7 trading and multilingual support<br>
                    • Secure, user-friendly platform with advanced charting tools<br>
                    • Educational resources and demo accounts for beginners
                </p>
                <p style="max-width:700px;margin:0 auto 8px auto;font-size:1.05em;color:#3949ab;">
                    <b>Registered Office:</b> Kampala, Uganda<br>
                    <b>Email:</b> support@bluetraders.com<br>
                    <b>Website:</b> <a href="https://www.bluetraders.com" target="_blank" style="color:#158173;">www.bluetraders.com</a>
                </p>
            </div>
            <style>
                /* Blend company profile text color with footer background */
                footer .company-profile-blend {
                    color: #e0e6ef !important;
                }
            </style>
            <script>
                // Apply blend class to company profile paragraphs in the footer
                document.addEventListener('DOMContentLoaded', function () {
                    var footer = document.querySelector('footer');
                    if (footer) {
                        var profileParagraphs = footer.querySelectorAll('div > p');
                        profileParagraphs.forEach(function (p) {
                            p.classList.add('company-profile-blend');
                        });
                    }
                });
            </script>

            <!-- Animated Stickers Section -->
            <div id="animated-stickers" style="display:flex;justify-content:center;gap:32px;flex-wrap:wrap;margin:32px 0 0 0;">
                <!-- Sticker 1: Rocket Growth -->
                <div style="display:flex;flex-direction:column;align-items:center;">
                    <svg width="80" height="80" viewBox="0 0 80 80" style="animation:float1 2.2s ease-in-out infinite alternate;">
                        <defs>
                            <radialGradient id="rocketGlow" cx="50%" cy="50%" r="60%">
                                <stop offset="0%" stop-color="#ffd600" stop-opacity="0.7"/>
                                <stop offset="100%" stop-color="#fff" stop-opacity="0"/>
                            </radialGradient>
                        </defs>
                        <ellipse cx="40" cy="70" rx="18" ry="6" fill="url(#rocketGlow)" />
                        <g>
                            <rect x="36" y="20" width="8" height="28" rx="4" fill="#3949ab"/>
                            <polygon points="40,10 46,28 34,28" fill="#158173"/>
                            <rect x="38" y="48" width="4" height="10" rx="2" fill="#ffd600"/>
                            <polygon points="40,58 44,66 36,66" fill="#e53935"/>
                        </g>
                        <circle cx="40" cy="34" r="3" fill="#fff"/>
                    </svg>
                    <div style="margin-top:8px;font-weight:700;color:#3949ab;">Growth</div>
                </div>
                <!-- Sticker 2: Secure Shield -->
                <div style="display:flex;flex-direction:column;align-items:center;">
                    <svg width="80" height="80" viewBox="0 0 80 80" style="animation:float2 2.4s ease-in-out infinite alternate;">
                        <defs>
                            <linearGradient id="shieldGrad" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stop-color="#158173"/>
                                <stop offset="100%" stop-color="#3949ab"/>
                            </linearGradient>
                        </defs>
                        <path d="M40 14 Q60 22 60 38 Q60 60 40 70 Q20 60 20 38 Q20 22 40 14Z" fill="url(#shieldGrad)" stroke="#fff" stroke-width="2"/>
                        <path d="M32 40 l8 8 12-16" fill="none" stroke="#ffd600" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <div style="margin-top:8px;font-weight:700;color:#158173;">Security</div>
                </div>
                <!-- Sticker 3: 24/7 Support Headset -->
                <div style="display:flex;flex-direction:column;align-items:center;">
                    <svg width="80" height="80" viewBox="0 0 80 80" style="animation:float3 2.1s ease-in-out infinite alternate;">
                        <circle cx="40" cy="40" r="32" fill="#f4f7fa"/>
                        <ellipse cx="40" cy="54" rx="18" ry="8" fill="#3949ab" opacity="0.12"/>
                        <g>
                            <rect x="24" y="36" width="32" height="18" rx="9" fill="#158173"/>
                            <circle cx="32" cy="45" r="5" fill="#fff"/>
                            <circle cx="48" cy="45" r="5" fill="#fff"/>
                            <rect x="36" y="54" width="8" height="4" rx="2" fill="#ffd600"/>
                        </g>
                        <path d="M20 40 Q20 28 40 28 Q60 28 60 40" fill="none" stroke="#3949ab" stroke-width="3"/>
                    </svg>
                    <div style="margin-top:8px;font-weight:700;color:#e53935;">24/7 Support</div>
                </div>
                <!-- Sticker 4: Trading Chart -->
                <div style="display:flex;flex-direction:column;align-items:center;">
                    <svg width="80" height="80" viewBox="0 0 80 80" style="animation:float4 2.3s ease-in-out infinite alternate;">
                        <rect x="16" y="24" width="48" height="32" rx="8" fill="#fff" stroke="#3949ab" stroke-width="2"/>
                        <polyline points="24,48 32,36 40,44 48,30 56,40" fill="none" stroke="#158173" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="32" cy="36" r="3" fill="#ffd600"/>
                        <circle cx="48" cy="30" r="3" fill="#e53935"/>
                        <circle cx="56" cy="40" r="3" fill="#158173"/>
                    </svg>
                    <div style="margin-top:8px;font-weight:700;color:#3949ab;">Trading</div>
                </div>
            </div>
            <style>
            @keyframes float1 { 0%{transform:translateY(0);} 100%{transform:translateY(-10px);} }
            @keyframes float2 { 0%{transform:translateY(0);} 100%{transform:translateY(-14px);} }
            @keyframes float3 { 0%{transform:translateY(0);} 100%{transform:translateY(-8px);} }
            @keyframes float4 { 0%{transform:translateY(0);} 100%{transform:translateY(-12px);} }
            #animated-stickers svg { filter: drop-shadow(0 2px 8px #3949ab22); }
            </style>

        </footer>

    </div>
    <script>
        const toggleBtn = document.getElementById('toggleSidebar');
        const sidebar = document.getElementById('sidebar');
        toggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('hide');
        });

        document.addEventListener('DOMContentLoaded', () => {
            // Sample account data
            const accounts = [
                 { account: '267943',  nickname: 'Domicile', leverage: 'Unlimited', balance: '10,000.00' },
                { account: '123456', nickname: 'Main', leverage: '1:500', balance: '$5,000.00' },
                { account: '654321', nickname: 'Savings', leverage: '1:200', balance: '$1,200.00' }
            ];

            // Find the About section and replace it with the accounts table
            const main = document.querySelector('main');
            main.innerHTML = `
                <section>
                    <h2>My Accounts</h2>
                    <button id="addAccountBtn" style="margin-bottom:16px;background:#158173;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">Add Account</button>
                    <div style="overflow-x:auto;">
                        <table style="width:100%;border-collapse:collapse;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                            <thead>
                                <tr style="background:#f4f7fa;">
                                    <th style="padding:12px 8px;border-bottom:1px solid #e0e0e0;">Account</th>
                                    <th style="padding:12px 8px;border-bottom:1px solid #e0e0e0;">Nick Name</th>
                                    <th style="padding:12px 8px;border-bottom:1px solid #e0e0e0;">Leverage</th>
                                    <th style="padding:12px 8px;border-bottom:1px solid #e0e0e0;">Balance</th>
                                    <th style="padding:12px 8px;border-bottom:1px solid #e0e0e0;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="accountsTableBody"></tbody>
                        </table>
                    </div>
                </section>
            `;

            function renderAccounts() {
                const tbody = document.getElementById('accountsTableBody');
                tbody.innerHTML = '';
                accounts.forEach((acc, idx) => {
                    tbody.innerHTML += `
                        <tr>
                            <td style="padding:10px 8px;border-bottom:1px solid #e0e0e0;">${acc.account}</td>
                            <td style="padding:10px 8px;border-bottom:1px solid #e0e0e0;">${acc.nickname}</td>
                            <td style="padding:10px 8px;border-bottom:1px solid #e0e0e0;">${acc.leverage}</td>
                            <td style="padding:10px 8px;border-bottom:1px solid #e0e0e0;">${acc.balance}</td>
                            <td style="padding:10px 8px;border-bottom:1px solid #e0e0e0;">
                                <button class="editBtn" data-idx="${idx}" style="background:#3949ab;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;margin-right:6px;">Edit</button>
                                <button class="deleteBtn" data-idx="${idx}" style="background:#e53935;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;">Delete</button>
                            </td>
                        </tr>
                    `;
                });
            }

            renderAccounts();

            // Add Account functionality (simple prompt for demo)
            document.getElementById('addAccountBtn').addEventListener('click', () => {
                const account = prompt('Account Number:');
                const nickname = prompt('Nick Name:');
                const leverage = prompt('Leverage (e.g., 1:500):');
                const balance = prompt('Balance (e.g., $1000.00):');
                if (account && nickname && leverage && balance) {
                    accounts.push({ account, nickname, leverage, balance });
                    renderAccounts();
                }
            });

            // Edit/Delete actions
            document.getElementById('accountsTableBody').addEventListener('click', (e) => {
                if (e.target.classList.contains('editBtn')) {
                    const idx = e.target.getAttribute('data-idx');
                    const acc = accounts[idx];
                    const nickname = prompt('Edit Nick Name:', acc.nickname);
                    const leverage = prompt('Edit Leverage:', acc.leverage);
                    const balance = prompt('Edit Balance:', acc.balance);
                    if (nickname && leverage && balance) {
                        acc.nickname = nickname;
                        acc.leverage = leverage;
                        acc.balance = balance;
                        renderAccounts();
                    }
                }
                if (e.target.classList.contains('deleteBtn')) {
                    const idx = e.target.getAttribute('data-idx');
                    if (confirm('Are you sure you want to delete this account?')) {
                        accounts.splice(idx, 1);
                        renderAccounts();
                    }
                }
            });
        });

        const main = document.querySelector('main');
        const openLiveSection = document.createElement('section');
        openLiveSection.style.marginTop = '32px';
        openLiveSection.innerHTML = `
            <div style="display:flex;align-items:center;gap:24px;flex-wrap:wrap;">
                <div style="background:#fff;padding:24px 32px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.06);min-width:260px;">
                    <h3 style="margin-top:0;margin-bottom:12px;color:#158173;">Open Live Account</h3>
                    <p style="margin:0 0 16px 0;">Start trading real markets with a live account. Fast, secure, and easy setup.</p>
                    <button id="openLiveBtn" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;font-size:1em;">Open Live Account</button>
                </div>
                <div style="background:#f4f7fa;padding:24px 32px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.03);min-width:220px;">
                    <h3 style="margin-top:0;margin-bottom:12px;color:#3949ab;">View</h3>
                    <p style="margin:0 0 16px 0;">Already have an account? View and manage your live accounts here.</p>
                    <button id="viewAccountsBtn" style="background:#3949ab;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;font-size:1em;">View Accounts</button>
                </div>
            </div>
        `;
        main.parentNode.insertBefore(openLiveSection, main);

        document.getElementById('openLiveBtn').addEventListener('click', () => {
            alert('Redirecting to Open Live Account form...');
            // window.location.href = '/open-live-account'; // Uncomment and set actual URL
        });

        document.getElementById('viewAccountsBtn').addEventListener('click', () => {
            main.scrollIntoView({ behavior: 'smooth' });
        });

        // Sidebar modal features for each menu item with icons

        // Icon SVGs
        const icons = {
            home: `<svg width="20" height="20" fill="none" viewBox="0 0 24 24"><path fill="#fff" d="M3 10.5L12 4l9 6.5V20a1 1 0 0 1-1 1h-5v-5h-6v5H4a1 1 0 0 1-1-1V10.5z" stroke="#158173" stroke-width="1.5"/></svg>`,
            verify: `<svg width="20" height="20" fill="none" viewBox="0 0 24 24"><path d="M12 2l7 4v6c0 5.25-3.5 10-7 10s-7-4.75-7-10V6l7-4z" stroke="#158173" stroke-width="1.5" fill="none"/><path d="M9 12l2 2 4-4" stroke="#158173" stroke-width="1.5" fill="none"/></svg>`,
            deposit: `<svg width="20" height="20" fill="none" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="14" rx="2" stroke="#158173" stroke-width="1.5"/><path d="M12 8v6m0 0l-2-2m2 2l2-2" stroke="#158173" stroke-width="1.5"/></svg>`,
            withdraw: `<svg width="20" height="20" fill="none" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="14" rx="2" stroke="#158173" stroke-width="1.5"/><path d="M12 16V10m0 0l2 2m-2-2l-2 2" stroke="#158173" stroke-width="1.5"/></svg>`,
            transfer: `<svg width="20" height="20" fill="none" viewBox="0 0 24 24"><path d="M17 17h-7a4 4 0 1 1 0-8h7" stroke="#158173" stroke-width="1.5"/><path d="M15 13l2 2-2 2" stroke="#158173" stroke-width="1.5"/></svg>`,
            accounts: `<svg width="20" height="20" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4" stroke="#158173" stroke-width="1.5"/><path d="M4 20v-1a7 7 0 0 1 14 0v1" stroke="#158173" stroke-width="1.5"/></svg>`,
            profile: `<svg width="20" height="20" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4" stroke="#158173" stroke-width="1.5"/><path d="M4 20v-1a7 7 0 0 1 14 0v1" stroke="#158173" stroke-width="1.5"/></svg>`,
            settings: `<svg width="20" height="20" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3" stroke="#158173" stroke-width="1.5"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06A1.65 1.65 0 0 0 15 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 8.6 15a1.65 1.65 0 0 0-1.82-.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.6a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 15 8.6a1.65 1.65 0 0 0 1.82.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 15z" stroke="#158173" stroke-width="1.5"/></svg>`,
            promotions: `<svg width="20" height="20" fill="none" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="10" rx="2" stroke="#158173" stroke-width="1.5"/><path d="M7 7V5a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2" stroke="#158173" stroke-width="1.5"/></svg>`,
            refer: `<svg width="20" height="20" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="7" r="4" stroke="#158173" stroke-width="1.5"/><path d="M2 21v-1a7 7 0 0 1 14 0v1" stroke="#158173" stroke-width="1.5"/><path d="M18 8l3 3-3 3" stroke="#158173" stroke-width="1.5"/></svg>`
        };

        // Attach icons to sidebar links
        const sidebarLinks = document.querySelectorAll('.sidebar ul li a');
        sidebarLinks.forEach(link => {
            const text = link.textContent.trim();
            let icon = '';
            switch (text) {
                case 'Home': icon = icons.home; break;
                case 'Verify your Account': icon = icons.verify; break;
                case 'Deposit': icon = icons.deposit; break;
                case 'Withdraw': icon = icons.withdraw; break;
                case 'Transferfunds': icon = icons.transfer; break;
                case 'Acconts': icon = icons.accounts; break;
                case 'Profile': icon = icons.profile; break;
                case 'Settings': icon = icons.settings; break;
                case 'Promotions': icon = icons.promotions; break;
                case 'Refer a Friend': icon = icons.refer; break;
            }
            if (icon) {
                link.innerHTML = `<span style="vertical-align:middle;display:inline-block;margin-right:10px;">${icon}</span><span style="vertical-align:middle;">${text}</span>`;
            }
        });

        // Modal logic (unchanged except for icon code above)
        function createModal({ id, title, content, onSubmit }) {
            let modal = document.getElementById(id);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = id;
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100vw';
                modal.style.height = '100vh';
                modal.style.background = 'rgba(0,0,0,0.4)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '2000';
                modal.innerHTML = `
                    <div style="background:#fff;padding:32px 24px;border-radius:8px;max-width:420px;width:100%;box-shadow:0 4px 24px rgba(0,0,0,0.12);position:relative;">
                    <button class="closeModalBtn" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#3949ab;">&times;</button>
                    <h2 style="margin-top:0;color:#158173;">${title}</h2>
                    <div class="modalContent">${content}</div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.querySelector('.closeModalBtn').onclick = () => {
                    modal.style.display = 'none';
                };
                if (onSubmit) {
                    modal.querySelector('form').onsubmit = onSubmit;
                }
            }
            modal.style.display = 'flex';
        }

        document.querySelectorAll('.sidebar ul li a').forEach(link => {
            const text = link.textContent.replace(/<[^>]+>/g, '').trim();
            link.addEventListener('click', (e) => {
                if ([
                    'Verify your Account', 'Deposit', 'Withdraw', 'Transferfunds',
                    'Acconts', 'Profile', 'Settings', 'Promotions', 'Refer a Friend'
                ].includes(text)) {
                    e.preventDefault();
                }
                // Verify your Account
                if (text === 'Verify your Account') {
                    createModal({
                        id: 'verifyModal',
                        title: 'Verify your Account',
                        content: `
                            <p style="margin-bottom:18px;">To unlock all features, please verify your identity. Upload a valid ID and proof of address.</p>
                            <form id="verifyForm">
                            <label style="display:block;margin-bottom:8px;font-weight:500;">ID Document (PDF/JPG/PNG):</label>
                            <input type="file" accept=".pdf,.jpg,.jpeg,.png" required style="margin-bottom:16px;width:100%;">
                            <label style="display:block;margin-bottom:8px;font-weight:500;">Proof of Address (PDF/JPG/PNG):</label>
                            <input type="file" accept=".pdf,.jpg,.jpeg,.png" required style="margin-bottom:20px;width:100%;">
                            <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;font-size:1em;">Submit for Verification</button>
                            </form>
                            <div id="verifyStatus" style="margin-top:16px;color:#3949ab;font-weight:500;display:none;"></div>
                        `,
                        onSubmit: function(ev) {
                            ev.preventDefault();
                            const status = document.getElementById('verifyStatus');
                            status.style.display = 'block';
                            status.textContent = 'Your documents have been submitted. Verification is in progress...';
                            setTimeout(() => {
                                status.textContent = 'Verification successful! Your account is now fully verified.';
                            }, 2000);
                        }
                    });
                }
                // Deposit
                if (text === 'Deposit') {
                    createModal({
                        id: 'depositModal',
                        title: 'Deposit Funds',
                        content: `
                            <form id="depositForm">
                            <label style="display:block;margin-bottom:8px;font-weight:500;">Amount (USD):</label>
                            <input type="number" min="1" required style="margin-bottom:16px;width:100%;padding:8px;">
                            <label style="display:block;margin-bottom:8px;font-weight:500;">Payment Method:</label>
                            <select required style="margin-bottom:20px;width:100%;padding:8px;">
                                <option value="">Select</option>
                                <option>Bank Card</option>
                                <option>Crypto</option>
                                <option>Mobile Money</option>
                            </select>
                            <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;font-size:1em;">Deposit</button>
                            </form>
                            <div id="depositStatus" style="margin-top:16px;color:#3949ab;font-weight:500;display:none;"></div>
                        `,
                        onSubmit: function(ev) {
                            ev.preventDefault();
                            const status = document.getElementById('depositStatus');
                            status.style.display = 'block';
                            status.textContent = 'Processing your deposit...';
                            setTimeout(() => {
                                status.textContent = 'Deposit successful!';
                            }, 1500);
                        }
                    });
                }
                // Withdraw
                if (text === 'Withdraw') {
                    createModal({
                        id: 'withdrawModal',
                        title: 'Withdraw Funds',
                        content: `
                            <form id="withdrawForm">
                            <label style="display:block;margin-bottom:8px;font-weight:500;">Amount (USD):</label>
                            <input type="number" min="1" required style="margin-bottom:16px;width:100%;padding:8px;">
                            <label style="display:block;margin-bottom:8px;font-weight:500;">Withdrawal Method:</label>
                            <select required style="margin-bottom:20px;width:100%;padding:8px;">
                                <option value="">Select</option>
                                <option>Bank Card</option>
                                <option>Crypto</option>
                                <option>Mobile Money</option>
                            </select>
                            <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;font-size:1em;">Withdraw</button>
                            </form>
                            <div id="withdrawStatus" style="margin-top:16px;color:#3949ab;font-weight:500;display:none;"></div>
                        `,
                        onSubmit: function(ev) {
                            ev.preventDefault();
                            const status = document.getElementById('withdrawStatus');
                            status.style.display = 'block';
                            status.textContent = 'Processing your withdrawal...';
                            setTimeout(() => {
                                status.textContent = 'Withdrawal request submitted!';
                            }, 1500);
                        }
                    });
                }
                // Transfer Funds
                if (text === 'Transferfunds') {
                    createModal({
                        id: 'transferModal',
                        title: 'Transfer Funds',
                        content: `
                            <form id="transferForm">
                            <label style="display:block;margin-bottom:8px;font-weight:500;">From Account:</label>
                            <input type="text" required style="margin-bottom:12px;width:100%;padding:8px;">
                            <label style="display:block;margin-bottom:8px;font-weight:500;">To Account:</label>
                            <input type="text" required style="margin-bottom:12px;width:100%;padding:8px;">
                            <label style="display:block;margin-bottom:8px;font-weight:500;">Amount (USD):</label>
                            <input type="number" min="1" required style="margin-bottom:20px;width:100%;padding:8px;">
                            <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;font-size:1em;">Transfer</button>
                            </form>
                            <div id="transferStatus" style="margin-top:16px;color:#3949ab;font-weight:500;display:none;"></div>
                        `,
                        onSubmit: function(ev) {
                            ev.preventDefault();
                            const status = document.getElementById('transferStatus');
                            status.style.display = 'block';
                            status.textContent = 'Transferring funds...';
                            setTimeout(() => {
                                status.textContent = 'Funds transferred successfully!';
                            }, 1500);
                        }
                    });
                }
                // Accounts
                if (text === 'Acconts') {
                    createModal({
                        id: 'accountsModal',
                        title: 'My Accounts',
                        content: `
                            <div style="overflow-x:auto;">
                            <table style="width:100%;border-collapse:collapse;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                                <thead>
                                <tr style="background:#f4f7fa;">
                                    <th style="padding:12px 8px;border-bottom:1px solid #e0e0e0;">Account</th>
                                    <th style="padding:12px 8px;border-bottom:1px solid #e0e0e0;">Nick Name</th>
                                    <th style="padding:12px 8px;border-bottom:1px solid #e0e0e0;">Leverage</th>
                                    <th style="padding:12px 8px;border-bottom:1px solid #e0e0e0;">Balance</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td style="padding:10px 8px;border-bottom:1px solid #e0e0e0;">123456</td>
                                    <td style="padding:10px 8px;border-bottom:1px solid #e0e0e0;">Main</td>
                                    <td style="padding:10px 8px;border-bottom:1px solid #e0e0e0;">1:500</td>
                                    <td style="padding:10px 8px;border-bottom:1px solid #e0e0e0;">$5,000.00</td>
                                </tr>
                                <tr>
                                    <td style="padding:10px 8px;border-bottom:1px solid #e0e0e0;">654321</td>
                                    <td style="padding:10px 8px;border-bottom:1px solid #e0e0e0;">Savings</td>
                                    <td style="padding:10px 8px;border-bottom:1px solid #e0e0e0;">1:200</td>
                                    <td style="padding:10px 8px;border-bottom:1px solid #e0e0e0;">$1,200.00</td>
                                </tr>
                                </tbody>
                            </table>
                            </div>
                        `
                    });
                }
                // Profile
                if (text === 'Profile') {
                    createModal({
                        id: 'profileModal',
                        title: 'Profile',
                        content: `
                            <form id="profileForm">
                            <label style="display:block;margin-bottom:8px;font-weight:500;">Full Name:</label>
                            <input type="text" value="John Doe" required style="margin-bottom:12px;width:100%;padding:8px;">
                            <label style="display:block;margin-bottom:8px;font-weight:500;">Email:</label>
                            <input type="email" value="john@example.com" required style="margin-bottom:12px;width:100%;padding:8px;">
                            <label style="display:block;margin-bottom:8px;font-weight:500;">Phone:</label>
                            <input type="tel" value="+256786760152" required style="margin-bottom:20px;width:100%;padding:8px;">
                            <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;font-size:1em;">Update Profile</button>
                            </form>
                            <div id="profileStatus" style="margin-top:16px;color:#3949ab;font-weight:500;display:none;"></div>
                        `,
                        onSubmit: function(ev) {
                            ev.preventDefault();
                            const status = document.getElementById('profileStatus');
                            status.style.display = 'block';
                            status.textContent = 'Profile updated!';
                        }
                    });
                }
                // Settings
                if (text === 'Settings') {
                    createModal({
                        id: 'settingsModal',
                        title: 'Settings',
                        content: `
                            <form id="settingsForm">
                            <label style="display:block;margin-bottom:8px;font-weight:500;">Change Password:</label>
                            <input type="password" placeholder="New Password" style="margin-bottom:12px;width:100%;padding:8px;">
                            <input type="password" placeholder="Confirm Password" style="margin-bottom:20px;width:100%;padding:8px;">
                            <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;font-size:1em;">Save Changes</button>
                            </form>
                            <div id="settingsStatus" style="margin-top:16px;color:#3949ab;font-weight:500;display:none;"></div>
                        `,
                        onSubmit: function(ev) {
                            ev.preventDefault();
                            const status = document.getElementById('settingsStatus');
                            status.style.display = 'block';
                            status.textContent = 'Settings updated!';
                        }
                    });
                }
                // Promotions
                if (text === 'Promotions') {
                    createModal({
                        id: 'promotionsModal',
                        title: 'Promotions',
                        content: `
                            <ul style="padding-left:18px;">
                            <li><b>Welcome Bonus:</b> Get 10% extra on your first deposit.</li>
                            <li><b>Trading Contest:</b> Win prizes by trading the most volume this month.</li>
                            <li><b>Referral Rewards:</b> Invite friends and earn up to $50 per referral.</li>
                            </ul>
                        `
                    });
                }
                // Refer a Friend
                if (text === 'Refer a Friend') {
                    createModal({
                        id: 'referModal',
                        title: 'Refer a Friend',
                        content: `
                            <p>Invite your friends and earn rewards when they join and trade!</p>
                            <form id="referForm">
                            <label style="display:block;margin-bottom:8px;font-weight:500;">Friend's Email:</label>
                            <input type="email" required style="margin-bottom:20px;width:100%;padding:8px;">
                            <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;font-size:1em;">Send Invite</button>
                            </form>
                            <div id="referStatus" style="margin-top:16px;color:#3949ab;font-weight:500;display:none;"></div>
                        `,
                        onSubmit: function(ev) {
                            ev.preventDefault();
                            const status = document.getElementById('referStatus');
                            status.style.display = 'block';
                            status.textContent = 'Invitation sent!';
                        }
                    });
                }
            });
        });


        document.getElementById('openLiveBtn').addEventListener('click', function () {
            // Modal to choose account type, currency, and password
            origCreateHeaderModal({
                id: 'openLiveAccountModal',
                title: 'Open Live Account',
                content: `
                    <form id="openLiveAccountForm">
                        <label style="display:block;margin-bottom:8px;font-weight:500;">Account Type:</label>
                        <select id="liveAccType" required style="margin-bottom:12px;width:100%;padding:8px;">
                            <option value="">Select Type</option>
                            <option value="Standard">Standard</option>
                            <option value="Pro">Pro</option>
                            <option value="Raw Spread">Raw Spread</option>
                        </select>
                        <label style="display:block;margin-bottom:8px;font-weight:500;">Currency:</label>
                        <select id="liveAccCurrency" required style="margin-bottom:12px;width:100%;padding:8px;">
                            <option value="">Select Currency</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="UGX">UGX</option>
                        </select>
                        <label style="display:block;margin-bottom:8px;font-weight:500;">Password (for MetaTrader 5):</label>
                        <input type="password" id="liveAccPassword" required minlength="6" style="margin-bottom:18px;width:100%;padding:8px;" placeholder="Create a password">
                        <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;font-size:1em;">Generate Account</button>
                    </form>
                    <div id="liveAccResult" style="margin-top:18px;color:#3949ab;font-weight:500;display:none;"></div>
                `
            });
            setTimeout(() => {
                document.getElementById('openLiveAccountForm').onsubmit = function(ev) {
                    ev.preventDefault();
                    // Generate fake credentials for demo
                    const type = document.getElementById('liveAccType').value;
                    const currency = document.getElementById('liveAccCurrency').value;
                    const password = document.getElementById('liveAccPassword').value;
                    const accNum = 'MT5' + Math.floor(100000 + Math.random() * 900000);
                    const server = 'BlueTraders-MT5-Live';
                    const result = document.getElementById('liveAccResult');
                    result.style.display = 'block';
                    result.innerHTML = `
                        <div style="background:#f4f7fa;padding:16px 12px;border-radius:6px;margin-bottom:10px;">
                            <b>Your MetaTrader 5 Account has been created!</b><br>
                            <span style="color:#e53935;">Please copy and save these credentials to access MetaTrader 5:</span>
                            <ul style="margin:10px 0 0 18px;">
                                <li><b>Account Number:</b> <span style="color:#3949ab;">${accNum}</span></li>
                                <li><b>Account Type:</b> ${type}</li>
                                <li><b>Currency:</b> ${currency}</li>
                                <li><b>Password:</b> <span style="color:#3949ab;">${password}</span></li>
                                <li><b>Server:</b> ${server}</li>
                            </ul>
                        </div>
                        <button id="copyLiveAccBtn" style="background:#3949ab;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;margin-top:6px;">Copy Credentials</button>
                    `;
                    document.getElementById('copyLiveAccBtn').onclick = function() {
                        const text = `Account Number: ${accNum}\nAccount Type: ${type}\nCurrency: ${currency}\nPassword: ${password}\nServer: ${server}`;
                        navigator.clipboard.writeText(text).then(() => {
                            document.getElementById('copyLiveAccBtn').textContent = 'Copied!';
                        });
                    };
                };
            }, 100);
        });

        document.getElementById('openLiveHeaderBtn') &&
            (document.getElementById('openLiveHeaderBtn').onclick = function () {
                origCreateHeaderModal({
                    id: 'openLiveAccountModal',
                    title: 'Open Live Account',
                    content: `
                        <form id="openLiveAccountForm">
                            <label style="display:block;margin-bottom:8px;font-weight:500;">Account Type:</label>
                            <select id="liveAccType" required style="margin-bottom:12px;width:100%;padding:8px;">
                                <option value="">Select Type</option>
                                <option value="Standard">Standard</option>
                                <option value="Pro">Pro</option>
                                <option value="Raw Spread">Raw Spread</option>
                            </select>
                            <label style="display:block;margin-bottom:8px;font-weight:500;">Currency:</label>
                            <select id="liveAccCurrency" required style="margin-bottom:12px;width:100%;padding:8px;">
                                <option value="">Select Currency</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="UGX">UGX</option>
                            </select>
                            <label style="display:block;margin-bottom:8px;font-weight:500;">Password (for MetaTrader 5):</label>
                            <input type="password" id="liveAccPassword" required minlength="6" style="margin-bottom:18px;width:100%;padding:8px;" placeholder="Create a password">
                            <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;font-size:1em;">Generate Account</button>
                        </form>
                        <div id="liveAccResult" style="margin-top:18px;color:#3949ab;font-weight:500;display:none;"></div>
                    `
                });
                setTimeout(() => {
                    document.getElementById('openLiveAccountForm').onsubmit = function(ev) {
                        ev.preventDefault();
                        const type = document.getElementById('liveAccType').value;
                        const currency = document.getElementById('liveAccCurrency').value;
                        const password = document.getElementById('liveAccPassword').value;
                        const accNum = 'MT5' + Math.floor(100000 + Math.random() * 900000);
                        const server = 'BlueTraders-MT5-Live';
                        const result = document.getElementById('liveAccResult');
                        result.style.display = 'block';
                        result.innerHTML = `
                            <div style="background:#f4f7fa;padding:16px 12px;border-radius:6px;margin-bottom:10px;">
                                <b>Your MetaTrader 5 Account has been created!</b><br>
                                <span style="color:#e53935;">Please copy and save these credentials to access MetaTrader 5:</span>
                                <ul style="margin:10px 0 0 18px;">
                                    <li><b>Account Number:</b> <span style="color:#3949ab;">${accNum}</span></li>
                                    <li><b>Account Type:</b> ${type}</li>
                                    <li><b>Currency:</b> ${currency}</li>
                                    <li><b>Password:</b> <span style="color:#3949ab;">${password}</span></li>
                                    <li><b>Server:</b> ${server}</li>
                                </ul>
                            </div>
                            <button id="copyLiveAccBtn" style="background:#3949ab;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;margin-top:6px;">Copy Credentials</button>
                        `;
                        document.getElementById('copyLiveAccBtn').onclick = function() {
                            const text = `Account Number: ${accNum}\nAccount Type: ${type}\nCurrency: ${currency}\nPassword: ${password}\nServer: ${server}`;
                            navigator.clipboard.writeText(text).then(() => {
                                document.getElementById('copyLiveAccBtn').textContent = 'Copied!';
                            });
                        };
                    };
                }, 100);
            });

        /**
         * Header navigation functionality inspired by Deriv.com:
         * - "Markets": Opens a modal with market info.
         * - "Open Demo/Live A/C": Opens a modal to choose Demo or Live account.
         * - "SignUp/Login": Opens a modal with tabs for Sign Up and Login.
         * - User avatar/profile: Dropdown with Profile, Settings, Logout.
         * - Notifications bell: Shows notifications modal.
         * - Help icon: Opens support/help modal.
         */

        // Add user avatar, notifications, and help to header (Deriv.com style)
        (function enhanceHeader() {
            const header = document.querySelector('header');
            const rightNav = header.querySelector('nav ul');
            // Create container for extra icons
            const extra = document.createElement('div');
            extra.style.display = 'flex';
            extra.style.alignItems = 'center';
            extra.style.gap = '18px';
            extra.innerHTML = `
            <button id="notifBell" title="Notifications" style="background:none;border:none;cursor:pointer;padding:0;">
                <svg width="24" height="24" fill="none" viewBox="0 0 24 24"><path d="M12 22a2 2 0 0 0 2-2h-4a2 2 0 0 0 2 2zm6-6V11a6 6 0 1 0-12 0v5l-2 2v1h16v-1l-2-2z" stroke="#fff" stroke-width="1.5" fill="none"/></svg>
            </button>
            <button id="helpBtn" title="Help" style="background:none;border:none;cursor:pointer;padding:0;">
                <svg width="24" height="24" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="#fff" stroke-width="1.5"/><path d="M12 17h.01M12 13a2 2 0 1 0-2-2" stroke="#fff" stroke-width="1.5"/></svg>
            </button>
            <div id="userDropdown" style="position:relative;">
                <button id="userAvatarBtn" title="Account" style="background:none;border:none;cursor:pointer;padding:0;">
                <img src="https://ui-avatars.com/api/?name=John+Doe&background=158173&color=fff&rounded=true&size=32" alt="User" style="width:32px;height:32px;border-radius:50%;">
                </button>
                <div id="userMenu" style="display:none;position:absolute;right:0;top:40px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.12);border-radius:6px;min-width:160px;z-index:3000;">
                <a href="#" id="profileMenu" style="display:block;padding:10px 18px;color:#158173;text-decoration:none;">Profile</a>
                <a href="#" id="settingsMenu" style="display:block;padding:10px 18px;color:#158173;text-decoration:none;">Settings</a>
                <div style="height:1px;background:#f4f7fa;margin:4px 0;"></div>
                <a href="#" id="logoutMenu" style="display:block;padding:10px 18px;color:#e53935;text-decoration:none;">Logout</a>
                </div>
            </div>
            `;
            rightNav.parentNode.appendChild(extra);
        })();

        // Helper: Modal for header actions
        function createHeaderModal({ id, title, content }) {
            let modal = document.getElementById(id);
            if (!modal) {
            modal = document.createElement('div');
            modal.id = id;
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.background = 'rgba(0,0,0,0.4)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '2000';
            modal.innerHTML = `
                <div style="background:#fff;padding:32px 24px;border-radius:8px;max-width:480px;width:100%;box-shadow:0 4px 24px rgba(0,0,0,0.12);position:relative;">
                <button class="closeHeaderModalBtn" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#3949ab;">&times;</button>
                <h2 style="margin-top:0;color:#158173;">${title}</h2>
                <div class="headerModalContent">${content}</div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('.closeHeaderModalBtn').onclick = () => {
                modal.style.display = 'none';
            };
            }
            modal.style.display = 'flex';
        }

        // Header nav event listeners
        document.querySelectorAll('header nav ul li a').forEach(link => {
            const text = link.textContent.trim();
            link.addEventListener('click', e => {
            if (text === 'Markets') {
                e.preventDefault();
                createHeaderModal({
                id: 'marketsModal',
                title: 'Markets',
                content: `
                    <ul style="padding-left:18px;">
                    <li><b>Forex:</b> Trade major, minor, and exotic currency pairs.</li>
                    <li><b>Commodities:</b> Gold, Silver, Oil and more.</li>
                    <li><b>Indices:</b> Global indices including US, Europe, Asia.</li>
                    <li><b>Cryptocurrencies:</b> Bitcoin, Ethereum, and more.</li>
                    <li><b>Stocks:</b> Top US and global shares.</li>
                    </ul>
                    <p style="margin-top:16px;"><a href="#" style="color:#158173;text-decoration:underline;">See all markets</a></p>
                `
                });
            }
            if (text === 'Open Demo/Live A/C') {
                e.preventDefault();
                createHeaderModal({
                id: 'openAccountModal',
                title: 'Open Account',
                content: `
                    <div style="display:flex;gap:24px;justify-content:center;">
                    <div style="flex:1;text-align:center;">
                        <h3 style="color:#3949ab;">Demo Account</h3>
                        <p>Practice trading with virtual funds.</p>
                        <button id="openDemoBtn" style="background:#3949ab;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;">Open Demo</button>
                    </div>
                    <div style="flex:1;text-align:center;">
                        <h3 style="color:#158173;">Live Account</h3>
                        <p>Trade real markets with real funds.</p>
                        <button id="openLiveHeaderBtn" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;">Open Live</button>
                    </div>
                    </div>
                `
                });
                setTimeout(() => {
                document.getElementById('openDemoBtn').onclick = () => {
                    alert('Redirecting to Demo Account registration...');
                };
                document.getElementById('openLiveHeaderBtn').onclick = () => {
                    alert('Redirecting to Live Account registration...');
                };
                }, 100);
            }
            if (text === 'SignUp/Login') {
                e.preventDefault();
                createHeaderModal({
                id: 'authModal',
                title: 'Sign Up / Login',
                content: `
                    <div style="display:flex;gap:12px;margin-bottom:18px;">
                    <button id="tabSignUp" style="flex:1;background:#158173;color:#fff;border:none;padding:8px 0;border-radius:4px 0 0 4px;cursor:pointer;">Sign Up</button>
                    <button id="tabLogin" style="flex:1;background:#f4f7fa;color:#3949ab;border:none;padding:8px 0;border-radius:0 4px 4px 0;cursor:pointer;">Login</button>
                    </div>
                    <div id="authTabContent"></div>
                `
                });
                // Tab logic
                setTimeout(() => {
                const tabSignUp = document.getElementById('tabSignUp');
                const tabLogin = document.getElementById('tabLogin');
                const tabContent = document.getElementById('authTabContent');
                function showSignUp() {
                    tabSignUp.style.background = '#158173';
                    tabSignUp.style.color = '#fff';
                    tabLogin.style.background = '#f4f7fa';
                    tabLogin.style.color = '#3949ab';
                    tabContent.innerHTML = `
                    <form id="signUpForm">
                        <input type="text" placeholder="Full Name" required style="margin-bottom:10px;width:100%;padding:8px;">
                        <input type="email" placeholder="Email" required style="margin-bottom:10px;width:100%;padding:8px;">
                        <input type="password" placeholder="Password" required style="margin-bottom:16px;width:100%;padding:8px;">
                        <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Sign Up</button>
                    </form>
                    <div id="signUpStatus" style="margin-top:12px;color:#3949ab;font-weight:500;display:none;"></div>
                    `;
                    document.getElementById('signUpForm').onsubmit = function(ev) {
                    ev.preventDefault();
                    const status = document.getElementById('signUpStatus');
                    status.style.display = 'block';
                    status.textContent = 'Account created! Please check your email to verify.';
                    };
                }
                function showLogin() {
                    tabSignUp.style.background = '#f4f7fa';
                    tabSignUp.style.color = '#3949ab';
                    tabLogin.style.background = '#158173';
                    tabLogin.style.color = '#fff';
                    tabContent.innerHTML = `
                    <form id="loginForm">
                        <input type="email" placeholder="Email" required style="margin-bottom:10px;width:100%;padding:8px;">
                        <input type="password" placeholder="Password" required style="margin-bottom:16px;width:100%;padding:8px;">
                        <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Login</button>
                    </form>
                    <div id="loginStatus" style="margin-top:12px;color:#3949ab;font-weight:500;display:none;"></div>
                    `;
                    document.getElementById('loginForm').onsubmit = function(ev) {
                    ev.preventDefault();
                    const status = document.getElementById('loginStatus');
                    status.style.display = 'block';
                    status.textContent = 'Login successful! Redirecting...';
                    };
                }
                tabSignUp.onclick = showSignUp;
                tabLogin.onclick = showLogin;
                showSignUp();
                }, 100);
            }
            });
        });

        // User avatar dropdown logic
        (function userDropdownLogic() {
            const avatarBtn = document.getElementById('userAvatarBtn');
            const menu = document.getElementById('userMenu');
            avatarBtn.onclick = function(e) {
            e.stopPropagation();
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            };
            document.body.addEventListener('click', function() {
            menu.style.display = 'none';
            });
            // Profile/Settings/Logout actions
            document.getElementById('profileMenu').onclick = function(e) {
            e.preventDefault();
            menu.style.display = 'none';
            createHeaderModal({
                id: 'profileModalHeader',
                title: 'Profile',
                content: `
                <form id="profileFormHeader">
                    <label style="display:block;margin-bottom:8px;font-weight:500;">Full Name:</label>
                    <input type="text" value="John Doe" required style="margin-bottom:12px;width:100%;padding:8px;">
                    <label style="display:block;margin-bottom:8px;font-weight:500;">Email:</label>
                    <input type="email" value="john@example.com" required style="margin-bottom:12px;width:100%;padding:8px;">
                    <label style="display:block;margin-bottom:8px;font-weight:500;">Phone:</label>
                    <input type="tel" value="+256786760152" required style="margin-bottom:20px;width:100%;padding:8px;">
                    <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Update Profile</button>
                </form>
                <div id="profileStatusHeader" style="margin-top:16px;color:#3949ab;font-weight:500;display:none;"></div>
                `
            });
            setTimeout(() => {
                document.getElementById('profileFormHeader').onsubmit = function(ev) {
                ev.preventDefault();
                const status = document.getElementById('profileStatusHeader');
                status.style.display = 'block';
                status.textContent = 'Profile updated!';
                };
            }, 100);
            };
            document.getElementById('settingsMenu').onclick = function(e) {
            e.preventDefault();
            menu.style.display = 'none';
            createHeaderModal({
                id: 'settingsModalHeader',
                title: 'Settings',
                content: `
                <form id="settingsFormHeader">
                    <label style="display:block;margin-bottom:8px;font-weight:500;">Change Password:</label>
                    <input type="password" placeholder="New Password" style="margin-bottom:12px;width:100%;padding:8px;">
                    <input type="password" placeholder="Confirm Password" style="margin-bottom:20px;width:100%;padding:8px;">
                    <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Save Changes</button>
                </form>
                <div id="settingsStatusHeader" style="margin-top:16px;color:#3949ab;font-weight:500;display:none;"></div>
                `
            });
            setTimeout(() => {
                document.getElementById('settingsFormHeader').onsubmit = function(ev) {
                ev.preventDefault();
                const status = document.getElementById('settingsStatusHeader');
                status.style.display = 'block';
                status.textContent = 'Settings updated!';
                };
            }, 100);
            };
            document.getElementById('logoutMenu').onclick = function(e) {
            e.preventDefault();
            menu.style.display = 'none';
            alert('You have been logged out.');
            };
        })();

        // Notifications bell logic
        document.getElementById('notifBell').onclick = function() {
            createHeaderModal({
            id: 'notifModal',
            title: 'Notifications',
            content: `
                <ul style="padding-left:18px;">
                <li>No new notifications.</li>
                <li style="color:#3949ab;">Welcome to The blue traders dashboard!</li>
                </ul>
            `
            });
        };

        // Help icon logic
        document.getElementById('helpBtn').onclick = function() {
            createHeaderModal({
            id: 'helpModal',
            title: 'Help & Support',
            content: `
                <p>Need assistance? Contact our support team:</p>
                <ul style="padding-left:18px;">
                <li>Email: <a href="mailto:support@bluetraders.com" style="color:#158173;">support@bluetraders.com</a></li>
                <li>WhatsApp: <a href="https://wa.me/256786760152" target="_blank" style="color:#158173;">+256 786 760 152</a></li>
                <li>Telegram: <a href="https://t.me/+256786760152" target="_blank" style="color:#158173;">+256 786 760 152</a></li>
                </ul>
                <p>Or visit our <a href="https://www.bluetraders.com" target="_blank" style="color:#158173;">website</a> for FAQs.</p>
            `
            });
        };


        document.addEventListener('DOMContentLoaded', function () {
            // Helper to open the "Open Live Account" modal (from homepage)
            function openLiveAccountModal() {
                origCreateHeaderModal({
                    id: 'openLiveAccountModal',
                    title: 'Open Live Account',
                    content: `
                        <form id="openLiveAccountForm">
                            <label style="display:block;margin-bottom:8px;font-weight:500;">Account Type:</label>
                            <select id="liveAccType" required style="margin-bottom:12px;width:100%;padding:8px;">
                                <option value="">Select Type</option>
                                <option value="Standard">Standard</option>
                                <option value="Pro">Pro</option>
                                <option value="Raw Spread">Raw Spread</option>
                            </select>
                            <label style="display:block;margin-bottom:8px;font-weight:500;">Currency:</label>
                            <select id="liveAccCurrency" required style="margin-bottom:12px;width:100%;padding:8px;">
                                <option value="">Select Currency</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="UGX">UGX</option>
                            </select>
                            <label style="display:block;margin-bottom:8px;font-weight:500;">Password (for MetaTrader 5):</label>
                            <input type="password" id="liveAccPassword" required minlength="6" style="margin-bottom:18px;width:100%;padding:8px;" placeholder="Create a password">
                            <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;font-size:1em;">Generate Account</button>
                        </form>
                        <div id="liveAccResult" style="margin-top:18px;color:#3949ab;font-weight:500;display:none;"></div>
                    `
                });
                setTimeout(() => {
                    document.getElementById('openLiveAccountForm').onsubmit = function(ev) {
                        ev.preventDefault();
                        const type = document.getElementById('liveAccType').value;
                        const currency = document.getElementById('liveAccCurrency').value;
                        const password = document.getElementById('liveAccPassword').value;
                        const accNum = 'MT5' + Math.floor(100000 + Math.random() * 900000);
                        const server = 'BlueTraders-MT5-Live';
                        const result = document.getElementById('liveAccResult');
                        result.style.display = 'block';
                        result.innerHTML = `
                            <div style="background:#f4f7fa;padding:16px 12px;border-radius:6px;margin-bottom:10px;">
                                <b>Your MetaTrader 5 Account has been created!</b><br>
                                <span style="color:#e53935;">Please copy and save these credentials to access MetaTrader 5:</span>
                                <ul style="margin:10px 0 0 18px;">
                                    <li><b>Account Number:</b> <span style="color:#3949ab;">${accNum}</span></li>
                                    <li><b>Account Type:</b> ${type}</li>
                                    <li><b>Currency:</b> ${currency}</li>
                                    <li><b>Password:</b> <span style="color:#3949ab;">${password}</span></li>
                                    <li><b>Server:</b> ${server}</li>
                                </ul>
                            </div>
                            <button id="copyLiveAccBtn" style="background:#3949ab;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;margin-top:6px;">Copy Credentials</button>
                        `;
                        document.getElementById('copyLiveAccBtn').onclick = function() {
                            const text = `Account Number: ${accNum}\nAccount Type: ${type}\nCurrency: ${currency}\nPassword: ${password}\nServer: ${server}`;
                            navigator.clipboard.writeText(text).then(() => {
                                document.getElementById('copyLiveAccBtn').textContent = 'Copied!';
                            });
                        };
                    };
                }, 100);
            }

            // Attach to header "Open Demo/Live A/C" link
            document.querySelectorAll('header nav ul li a').forEach(link => {
                if (link.textContent.trim() === 'Open Demo/Live A/C') {
                    link.addEventListener('click', function (e) {
                        e.preventDefault();
                        origCreateHeaderModal({
                            id: 'openAccountModal',
                            title: 'Open Account',
                            content: `
                                <div style="display:flex;gap:24px;justify-content:center;">
                                    <div style="flex:1;text-align:center;">
                                        <h3 style="color:#3949ab;">Demo Account</h3>
                                        <p>Practice trading with virtual funds.</p>
                                        <button id="openDemoBtn" style="background:#3949ab;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;">Open Demo</button>
                                    </div>
                                    <div style="flex:1;text-align:center;">
                                        <h3 style="color:#158173;">Live Account</h3>
                                        <p>Trade real markets with real funds.</p>
                                        <button id="openLiveHeaderBtn" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;">Open Live</button>
                                    </div>
                                </div>
                            `
                        });
                        setTimeout(() => {
                            document.getElementById('openDemoBtn').onclick = () => {
                                alert('Redirecting to Demo Account registration...');
                            };
                            document.getElementById('openLiveHeaderBtn').onclick = () => {
                                openLiveAccountModal();
                            };
                        }, 100);
                    });
                }
            });
        });



        
        /**
         * Add "Synthetics (Volatilities)" to the Markets modal, and clone Deriv.com dashboard features for Synthetics.
         */

        // Enhance Markets modal to include Synthetics
        const origCreateHeaderModal = createHeaderModal;
        createHeaderModal = function(opts) {
            if (opts.id === 'marketsModal') {
                opts.content = `
                    <ul style="padding-left:18px;">
                        <li><b>Forex:</b> Trade major, minor, and exotic currency pairs.</li>
                        <li><b>Commodities:</b> Gold, Silver, Oil and more.</li>
                        <li><b>Indices:</b> Global indices including US, Europe, Asia.</li>
                        <li><b>Cryptocurrencies:</b> Bitcoin, Ethereum, and more.</li>
                        <li><b>Stocks:</b> Top US and global shares.</li>
                        <li><b>Synthetics (Volatilities):</b> Trade synthetic indices that simulate real-world market volatility, available 24/7.</li>
                    </ul>
                    <div style="margin-top:16px;">
                        <button id="syntheticsDashboardBtn" style="background:#3949ab;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;">Go to Synthetics Dashboard</button>
                    </div>
                    <p style="margin-top:16px;"><a href="#" style="color:#158173;text-decoration:underline;">See all markets</a></p>
                `;
            }
            origCreateHeaderModal(opts);

            // Synthetics dashboard button logic
            if (opts.id === 'marketsModal') {
                setTimeout(() => {
                    const btn = document.getElementById('syntheticsDashboardBtn');
                    if (btn) {
                        btn.onclick = function() {
                            document.getElementById('marketsModal').style.display = 'none';
                            showSyntheticsDashboard();
                        };
                    }
                }, 100);
            }
        };

        // Synthetics dashboard modal (Deriv.com style)
        function showSyntheticsDashboard() {
            origCreateHeaderModal({
                id: 'syntheticsDashboardModal',
                title: 'Synthetics (Volatilities) Dashboard',
                content: `
                    <div style="display:flex;gap:24px;flex-wrap:wrap;">
                        <div style="flex:1;min-width:240px;background:#fff;padding:20px 18px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.06);">
                            <h3 style="margin-top:0;color:#3949ab;">Popular Synthetics</h3>
                            <ul style="padding-left:18px;margin-bottom:12px;">
                                <li><b>Volatility 75 Index</b> <span style="color:#158173;">(V75)</span></li>
                                <li><b>Volatility 100 Index</b> <span style="color:#158173;">(V100)</span></li>
                                <li><b>Volatility 50 Index</b> <span style="color:#158173;">(V50)</span></li>
                                <li><b>Crash 1000 / Boom 1000</b></li>
                                <li><b>Crash 500 / Boom 500</b></li>
                            </ul>
                            <button id="tradeSyntheticsBtn" style="background:#158173;color:#fff;border:none;padding:8px 20px;border-radius:4px;cursor:pointer;">Trade Synthetics</button>
                        </div>
                        <div style="flex:1;min-width:240px;background:#f4f7fa;padding:20px 18px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.03);">
                            <h3 style="margin-top:0;color:#158173;">Features</h3>
                            <ul style="padding-left:18px;">
                                <li>Available 24/7</li>
                                <li>Consistent volatility</li>
                                <li>No market gaps</li>
                                <li>Demo & Live trading</li>
                                <li>Fast execution</li>
                            </ul>
                        </div>
                    </div>
                    <div style="margin-top:24px;">
                        <h4 style="color:#3949ab;margin-bottom:8px;">Recent Synthetics Trades</h4>
                        <table style="width:100%;border-collapse:collapse;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
                            <thead>
                                <tr style="background:#f4f7fa;">
                                    <th style="padding:8px 6px;border-bottom:1px solid #e0e0e0;">Asset</th>
                                    <th style="padding:8px 6px;border-bottom:1px solid #e0e0e0;">Type</th>
                                    <th style="padding:8px 6px;border-bottom:1px solid #e0e0e0;">Amount</th>
                                    <th style="padding:8px 6px;border-bottom:1px solid #e0e0e0;">Result</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding:7px 6px;">Volatility 75</td>
                                    <td style="padding:7px 6px;">Buy</td>
                                    <td style="padding:7px 6px;">$10.00</td>
                                    <td style="padding:7px 6px;color:#158173;">+$7.50</td>
                                </tr>
                                <tr>
                                    <td style="padding:7px 6px;">Crash 1000</td>
                                    <td style="padding:7px 6px;">Sell</td>
                                    <td style="padding:7px 6px;">$5.00</td>
                                    <td style="padding:7px 6px;color:#e53935;">-$2.00</td>
                                </tr>
                                <tr>
                                    <td style="padding:7px 6px;">Boom 500</td>
                                    <td style="padding:7px 6px;">Buy</td>
                                    <td style="padding:7px 6px;">$8.00</td>
                                    <td style="padding:7px 6px;color:#158173;">+$3.20</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `
            });
            setTimeout(() => {
                const btn = document.getElementById('tradeSyntheticsBtn');
                if (btn) {
                    btn.onclick = function() {
                        alert('Redirecting to Synthetics trading platform...');
                        // window.location.href = '/synthetics-trading'; // Set your actual URL here
                    };
                }
            }, 100);
        }
         
        document.querySelectorAll('a[href^="https://wa.me/"], a[href^="https://t.me/"]').forEach(link => {
            link.addEventListener('click', function (e) {
                alert('Welcome to The Blue Traders Channel!');
            });
        });

        // --- Exness.com-style Accounts Dashboard Features for Sidebar "Accounts" ---

        // Add Exness  icon for Accounts
        const exnessAccountsIcon = `<svg width="20" height="20" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4" stroke="#158173" stroke-width="1.5"/><path d="M4 20v-1a7 7 0 0 1 14 0v1" stroke="#158173" stroke-width="1.5"/></svg>`;
        document.querySelectorAll('.sidebar ul li a').forEach(link => {
            const text = link.textContent.replace(/<[^>]+>/g, '').trim();
            if (text === 'Accounts' || text === 'Acconts') {
            link.innerHTML = `<span style="vertical-align:middle;display:inline-block;margin-right:10px;">${exnessAccountsIcon}</span><span style="vertical-align:middle;">Accounts</span>`;
            }
        });

        // Helper: Render exness Styles accounts dashboard in a modal
        function showExnessAccountsDashboard() {
            // Sample data (could be dynamic)
            let exnessAccounts = [
            { account: '123456', type: 'Standard', currency: 'USD', leverage: '1:500', balance: '$5,000.00', status: 'Active' },
            { account: '654321', type: 'Pro', currency: 'USD', leverage: '1:200', balance: '$1,200.00', status: 'Active' }
            ];

            function renderExnessTable() {
            let tableRows = exnessAccounts.map((acc, idx) => `
                <tr>
                <td style="padding:10px 8px;border-bottom:1px solid #e0e0e0;">${acc.account}</td>
                <td style="padding:10px 8px;border-bottom:1px solid #e0e0e0;">${acc.type}</td>
                <td style="padding:10px 8px;border-bottom:1px solid #e0e0e0;">${acc.currency}</td>
                <td style="padding:10px 8px;border-bottom:1px solid #e0e0e0;">${acc.leverage}</td>
                <td style="padding:10px 8px;border-bottom:1px solid #e0e0e0;">${acc.balance}</td>
                <td style="padding:10px 8px;border-bottom:1px solid #e0e0e0;">
                    <button class="exnessDepositBtn" data-idx="${idx}" style="background:#158173;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;margin-right:6px;">Deposit</button>
                    <button class="exnessWithdrawBtn" data-idx="${idx}" style="background:#3949ab;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;margin-right:6px;">Withdraw</button>
                    <button class="exnessSettingsBtn" data-idx="${idx}" style="background:#e0e0e0;color:#3949ab;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;">Settings</button>
                </td>
                </tr>
            `).join('');
            return tableRows;
            }

            function showModal() {
            origCreateHeaderModal({
                id: 'exnessAccountsModal',
                title: 'My Accounts-The Blue traders Dashboard',
                content: `
                <div style="margin-bottom:16px;">
                    <button id="exnessAddAccountBtn" style="background:#3949ab;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">+ Open New Account</button>
                </div>
                <div style="overflow-x:auto;">
                    <table style="width:100%;border-collapse:collapse;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                    <thead>
                        <tr style="background:#f4f7fa;">
                        <th style="padding:12px 8px;border-bottom:1px solid #e0e0e0;">Account</th>
                        <th style="padding:12px 8px;border-bottom:1px solid #e0e0e0;">Type</th>
                        <th style="padding:12px 8px;border-bottom:1px solid #e0e0e0;">Currency</th>
                        <th style="padding:12px 8px;border-bottom:1px solid #e0e0e0;">Leverage</th>
                        <th style="padding:12px 8px;border-bottom:1px solid #e0e0e0;">Balance</th>
                        <th style="padding:12px 8px;border-bottom:1px solid #e0e0e0;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="exnessAccountsTableBody">
                        ${renderExnessTable()}
                    </tbody>
                    </table>
                </div>
                <div style="margin-top:18px;color:#3949ab;font-size:0.98em;">
                    <b>Tip:</b> Manage multiple accounts, set leverage, and perform instant transfers, this happens at The blue traders famisly.
                </div>
                `
            });

            setTimeout(() => {
                // Add Account
                document.getElementById('exnessAddAccountBtn').onclick = function () {
                const account = prompt('Account Number:');
                const type = prompt('Account Type (e.g., Standard, Pro):');
                const currency = prompt('Currency (e.g., USD):');
                const leverage = prompt('Leverage (e.g., 1:500):');
                const balance = prompt('Balance (e.g., $1000.00):');
                if (account && type && currency && leverage && balance) {
                    exnessAccounts.push({ account, type, currency, leverage, balance, status: 'Active' });
                    document.getElementById('exnessAccountsTableBody').innerHTML = renderExnessTable();
                    attachRowEvents();
                }
                };
                // Attach row button events
                function attachRowEvents() {
                document.querySelectorAll('.exnessDepositBtn').forEach(btn => {
                    btn.onclick = function () {
                    const idx = btn.getAttribute('data-idx');
                    alert('Deposit to account ' + exnessAccounts[idx].account);
                    };
                });
                document.querySelectorAll('.exnessWithdrawBtn').forEach(btn => {
                    btn.onclick = function () {
                    const idx = btn.getAttribute('data-idx');
                    alert('Withdraw from account ' + exnessAccounts[idx].account);
                    };
                });
                document.querySelectorAll('.exnessSettingsBtn').forEach(btn => {
                    btn.onclick = function () {
                    const idx = btn.getAttribute('data-idx');
                    const acc = exnessAccounts[idx];
                    const newLeverage = prompt('Set new leverage:', acc.leverage);
                    if (newLeverage) {
                        acc.leverage = newLeverage;
                        document.getElementById('exnessAccountsTableBody').innerHTML = renderExnessTable();
                        attachRowEvents();
                    }
                    };
                });
                }
                attachRowEvents();
            }, 100);
            }

            showModal();
        }

        // Sidebar "Accounts" link: open Exness-style dashboard modal
        document.querySelectorAll('.sidebar ul li a').forEach(link => {
            const text = link.textContent.replace(/<[^>]+>/g, '').trim();
            if (text === 'Accounts' || text === 'Acconts') {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                showExnessAccountsDashboard();
            });
            }
        });

        /**
         * Add local currency input and conversion for Deposit and Withdraw modals.
         * Assumes 1 USD = 3800 UGX (Ugandan Shilling) for demo purposes.
         */
        const USD_RATE = 3800;

        // Helper to format as currency
        function formatCurrency(val, currency) {
            if (currency === 'USD') {
                return '$' + Number(val).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
            } else if (currency === 'UGX') {
                return 'UGX ' + Number(val).toLocaleString();
            }
            return val;
        }

        // Enhance Deposit Modal
        document.addEventListener('click', function (e) {
            // Deposit Modal
            if (document.getElementById('depositModal') && document.getElementById('depositForm')) {
                const form = document.getElementById('depositForm');
                if (!form.dataset.enhanced) {
                    form.dataset.enhanced = '1';
                    // Insert local currency input above USD input
                    const usdInput = form.querySelector('input[type="number"]');
                    const label = document.createElement('label');
                    label.style.display = 'block';
                    label.style.marginBottom = '8px';
                    label.style.fontWeight = '500';
                    label.textContent = 'Amount (UGX):';
                    const ugxInput = document.createElement('input');
                    ugxInput.type = 'number';
                    ugxInput.min = '1000';
                    ugxInput.placeholder = 'Enter amount in UGX';
                    ugxInput.style.marginBottom = '10px';
                    ugxInput.style.width = '100%';
                    ugxInput.style.padding = '8px';
                    ugxInput.required = false;
                    usdInput.parentNode.insertBefore(ugxInput, usdInput);
                    usdInput.parentNode.insertBefore(label, ugxInput);

                    // Conversion logic
                    ugxInput.addEventListener('input', function () {
                        if (ugxInput.value) {
                            usdInput.value = (ugxInput.value / USD_RATE).toFixed(2);
                        }
                    });
                    usdInput.addEventListener('input', function () {
                        if (usdInput.value) {
                            ugxInput.value = Math.round(usdInput.value * USD_RATE);
                        }
                    });

                    // Show conversion rate
                    const rateInfo = document.createElement('div');
                    rateInfo.style.fontSize = '0.95em';
                    rateInfo.style.color = '#3949ab';
                    rateInfo.style.marginBottom = '10px';
                    rateInfo.textContent = '1 USD ≈ 3,800 UGX';
                    form.insertBefore(rateInfo, label);
                }
            }
            // Withdraw Modal
            if (document.getElementById('withdrawModal') && document.getElementById('withdrawForm')) {
                const form = document.getElementById('withdrawForm');
                if (!form.dataset.enhanced) {
                    form.dataset.enhanced = '1';
                    // Insert local currency input above USD input
                    const usdInput = form.querySelector('input[type="number"]');
                    const label = document.createElement('label');
                    label.style.display = 'block';
                    label.style.marginBottom = '8px';
                    label.style.fontWeight = '500';
                    label.textContent = 'Amount (UGX):';
                    const ugxInput = document.createElement('input');
                    ugxInput.type = 'number';
                    ugxInput.min = '1000';
                    ugxInput.placeholder = 'Enter amount in UGX';
                    ugxInput.style.marginBottom = '10px';
                    ugxInput.style.width = '100%';
                    ugxInput.style.padding = '8px';
                    ugxInput.required = false;
                    usdInput.parentNode.insertBefore(ugxInput, usdInput);
                    usdInput.parentNode.insertBefore(label, ugxInput);

                    // Conversion logic
                    ugxInput.addEventListener('input', function () {
                        if (ugxInput.value) {
                            usdInput.value = (ugxInput.value / USD_RATE).toFixed(2);
                        }
                    });
                    usdInput.addEventListener('input', function () {
                        if (usdInput.value) {
                            ugxInput.value = Math.round(usdInput.value * USD_RATE);
                        }
                    });

                    // Show conversion rate
                    const rateInfo = document.createElement('div');
                    rateInfo.style.fontSize = '0.95em';
                    rateInfo.style.color = '#3949ab';
                    rateInfo.style.marginBottom = '10px';
                    rateInfo.textContent = '1 USD ≈ 3,800 UGX';
                    form.insertBefore(rateInfo, label);
                }
            }
        });

        /**
         * Ensure Withdraw modal: user enters amount in USD, and UGX is auto-calculated and displayed (read-only).
         */
        document.addEventListener('click', function () {
            const withdrawForm = document.getElementById('withdrawForm');
            if (withdrawForm && !withdrawForm.dataset.usdOnly) {
                withdrawForm.dataset.usdOnly = '1';
                // Remove any previous UGX input if present
                Array.from(withdrawForm.querySelectorAll('input[type="number"] + input[type="number"]')).forEach(el => el.remove());
                Array.from(withdrawForm.querySelectorAll('label')).forEach(label => {
                    if (label.textContent === 'Amount (UGX):') label.remove();
                });
                // Insert UGX display below USD input
                const usdInput = withdrawForm.querySelector('input[type="number"]');
                const ugxLabel = document.createElement('label');
                ugxLabel.style.display = 'block';
                ugxLabel.style.marginBottom = '8px';
                ugxLabel.style.fontWeight = '500';
                ugxLabel.textContent = 'Equivalent (UGX):';
                const ugxDisplay = document.createElement('input');
                ugxDisplay.type = 'text';
                ugxDisplay.readOnly = true;
                ugxDisplay.tabIndex = -1;
                ugxDisplay.style.marginBottom = '10px';
                ugxDisplay.style.width = '100%';
                ugxDisplay.style.padding = '8px';
                ugxDisplay.style.background = '#f4f7fa';
                ugxDisplay.style.border = '1px solid #e0e0e0';
                usdInput.parentNode.insertBefore(ugxLabel, usdInput.nextSibling);
                usdInput.parentNode.insertBefore(ugxDisplay, ugxLabel.nextSibling);

                // Conversion logic
                usdInput.addEventListener('input', function () {
                    if (usdInput.value) {
                        ugxDisplay.value = 'UGX ' + (Math.round(Number(usdInput.value) * USD_RATE)).toLocaleString();
                    } else {
                        ugxDisplay.value = '';
                    }
                });

                // Show conversion rate
                const rateInfo = document.createElement('div');
                rateInfo.style.fontSize = '0.95em';
                rateInfo.style.color = '#3949ab';
                rateInfo.style.marginBottom = '10px';
                rateInfo.textContent = '1 USD ≈ 3,800 UGX';
                withdrawForm.insertBefore(rateInfo, ugxLabel);
            }
        });

        /**
         * Enhance Profile modal: show user profile status, verification, uploaded docs, email, contacts, and more.
         */
        function showFullProfileModal() {
            origCreateHeaderModal({
                id: 'fullProfileModal',
                title: 'My Profile',
                content: `
                    <div style="margin-bottom:18px;">
                        <b>Status:</b> <span style="color:#158173;">Active</span><br>
                        <b>Verification:</b> <span style="color:#3949ab;">Verified</span>
                    </div>
                    <div style="margin-bottom:18px;">
                        <b>Documents Uploaded:</b>
                        <ul style="padding-left:18px;margin:6px 0;">
                            <li>ID Document: <span style="color:#158173;">Uploaded</span></li>
                            <li>Proof of Address: <span style="color:#158173;">Uploaded</span></li>
                        </ul>
                    </div>
                    <div style="margin-bottom:18px;">
                        <b>Full Name:</b> John Doe<br>
                        <b>Email Address:</b> john@example.com<br>
                        <b>Phone:</b> +256786760152<br>
                        <b>Country:</b> Uganda<br>
                        <b>Date of Birth:</b> 1990-01-01
                    </div>
                    <div style="margin-bottom:18px;">
                        <b>Address:</b> 123 Main Street, Kampala, Uganda
                    </div>
                    <div style="margin-bottom:18px;">
                        <b>Account Type:</b> Individual<br>
                        <b>Joined:</b> Jan 2024
                    </div>
                    <button id="editProfileBtn" style="background:#3949ab;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;">Edit Profile</button>
                `
            });
            setTimeout(() => {
                const btn = document.getElementById('editProfileBtn');
                if (btn) {
                    btn.onclick = function() {
                        document.getElementById('fullProfileModal').style.display = 'none';
                        createHeaderModal({
                            id: 'profileEditModal',
                            title: 'Edit Profile',
                            content: `
                                <form id="profileEditForm">
                                    <label style="display:block;margin-bottom:8px;font-weight:500;">Full Name:</label>
                                    <input type="text" value="John Doe" required style="margin-bottom:12px;width:100%;padding:8px;">
                                    <label style="display:block;margin-bottom:8px;font-weight:500;">Email:</label>
                                    <input type="email" value="john@example.com" required style="margin-bottom:12px;width:100%;padding:8px;">
                                    <label style="display:block;margin-bottom:8px;font-weight:500;">Phone:</label>
                                    <input type="tel" value="+256786760152" required style="margin-bottom:12px;width:100%;padding:8px;">
                                    <label style="display:block;margin-bottom:8px;font-weight:500;">Country:</label>
                                    <input type="text" value="Uganda" required style="margin-bottom:12px;width:100%;padding:8px;">
                                    <label style="display:block;margin-bottom:8px;font-weight:500;">Date of Birth:</label>
                                    <input type="date" value="1990-01-01" required style="margin-bottom:12px;width:100%;padding:8px;">
                                    <label style="display:block;margin-bottom:8px;font-weight:500;">Address:</label>
                                    <input type="text" value="123 Main Street, Kampala, Uganda" required style="margin-bottom:20px;width:100%;padding:8px;">
                                    <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Save Changes</button>
                                </form>
                                <div id="profileEditStatus" style="margin-top:16px;color:#3949ab;font-weight:500;display:none;"></div>
                            `
                        });
                        setTimeout(() => {
                            document.getElementById('profileEditForm').onsubmit = function(ev) {
                                ev.preventDefault();
                                const status = document.getElementById('profileEditStatus');
                                status.style.display = 'block';
                                status.textContent = 'Profile updated!';
                            };
                        }, 100);
                    };
                }
            }, 100);
        }

        

        /**
         * Enhance Settings modal: add 2FA, change login email/phone, password, and clone more settings features from Deriv.com.
         */
        function showFullSettingsModal() {
            origCreateHeaderModal({
            id: 'fullSettingsModal',
            title: 'Settings',
            content: `
                <div style="margin-bottom:24px;">
                <h3 style="color:#158173;margin-bottom:8px;">Two-Factor Authentication (2FA)</h3>
                <p style="margin-bottom:10px;">Add an extra layer of security to your account.</p>
                <button id="enable2FABtn" style="background:#3949ab;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">Enable 2FA</button>
                <div id="2faStatus" style="margin-top:10px;color:#3949ab;font-weight:500;display:none;"></div>
                </div>
                <div style="margin-bottom:24px;">
                <h3 style="color:#158173;margin-bottom:8px;">Change Login Email / Phone</h3>
                <form id="changeLoginForm">
                    <label style="display:block;margin-bottom:6px;font-weight:500;">New Email:</label>
                    <input type="email" placeholder="Enter new email" style="margin-bottom:10px;width:100%;padding:8px;">
                    <label style="display:block;margin-bottom:6px;font-weight:500;">New Phone:</label>
                    <input type="tel" placeholder="Enter new phone" style="margin-bottom:14px;width:100%;padding:8px;">
                    <button type="submit" style="background:#158173;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">Update Login Details</button>
                </form>
                <div id="loginChangeStatus" style="margin-top:10px;color:#3949ab;font-weight:500;display:none;"></div>
                </div>
                <div style="margin-bottom:24px;">
                <h3 style="color:#158173;margin-bottom:8px;">Change Password</h3>
                <form id="changePasswordForm">
                    <input type="password" placeholder="Current Password" required style="margin-bottom:10px;width:100%;padding:8px;">
                    <input type="password" placeholder="New Password" required style="margin-bottom:10px;width:100%;padding:8px;">
                    <input type="password" placeholder="Confirm New Password" required style="margin-bottom:14px;width:100%;padding:8px;">
                    <button type="submit" style="background:#3949ab;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">Change Password</button>
                </form>
                <div id="passwordChangeStatus" style="margin-top:10px;color:#3949ab;font-weight:500;display:none;"></div>
                </div>
                <div style="margin-bottom:24px;">
                <h3 style="color:#158173;margin-bottom:8px;">Language & Region</h3>
                <form id="languageForm">
                    <label style="display:block;margin-bottom:6px;font-weight:500;">Language:</label>
                    <select style="margin-bottom:10px;width:100%;padding:8px;">
                    <option>English</option>
                    <option>French</option>
                    <option>Spanish</option>
                    <option>Arabic</option>
                    </select>
                    <label style="display:block;margin-bottom:6px;font-weight:500;">Timezone:</label>
                    <select style="margin-bottom:14px;width:100%;padding:8px;">
                    <option>GMT+3 (Africa/Kampala)</option>
                    <option>GMT+0 (UTC)</option>
                    <option>GMT+1 (Europe/Berlin)</option>
                    <option>GMT-5 (America/New_York)</option>
                    </select>
                    <button type="submit" style="background:#158173;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">Save Preferences</button>
                </form>
                <div id="languageStatus" style="margin-top:10px;color:#3949ab;font-weight:500;display:none;"></div>
                </div>
                <div style="margin-bottom:24px;">
                <h3 style="color:#158173;margin-bottom:8px;">Notifications</h3>
                <form id="notificationsForm">
                    <label style="display:block;margin-bottom:8px;">
                    <input type="checkbox" checked style="margin-right:8px;"> Email notifications
                    </label>
                    <label style="display:block;margin-bottom:8px;">
                    <input type="checkbox" checked style="margin-right:8px;"> SMS notifications
                    </label>
                    <label style="display:block;margin-bottom:8px;">
                    <input type="checkbox" style="margin-right:8px;"> Push notifications
                    </label>
                    <button type="submit" style="background:#158173;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">Update Notifications</button>
                </form>
                <div id="notificationsStatus" style="margin-top:10px;color:#3949ab;font-weight:500;display:none;"></div>
                </div>
                <div>
                <h3 style="color:#e53935;margin-bottom:8px;">Close Account</h3>
                <button id="closeAccountBtn" style="background:#e53935;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">Request Account Closure</button>
                <div id="closeAccountStatus" style="margin-top:10px;color:#e53935;font-weight:500;display:none;"></div>
                </div>
            `
            });
            setTimeout(() => {
            // 2FA logic
            document.getElementById('enable2FABtn').onclick = function() {
                const status = document.getElementById('2faStatus');
                status.style.display = 'block';
                status.textContent = '2FA enabled! Check your email for setup instructions.';
            };
            // Change login email/phone logic
            document.getElementById('changeLoginForm').onsubmit = function(ev) {
                ev.preventDefault();
                const status = document.getElementById('loginChangeStatus');
                status.style.display = 'block';
                status.textContent = 'Login details updated!';
            };
            // Change password logic
            document.getElementById('changePasswordForm').onsubmit = function(ev) {
                ev.preventDefault();
                const status = document.getElementById('passwordChangeStatus');
                status.style.display = 'block';
                status.textContent = 'Password changed successfully!';
            };
            // Language & region logic
            document.getElementById('languageForm').onsubmit = function(ev) {
                ev.preventDefault();
                const status = document.getElementById('languageStatus');
                status.style.display = 'block';
                status.textContent = 'Preferences saved!';
            };
            // Notifications logic
            document.getElementById('notificationsForm').onsubmit = function(ev) {
                ev.preventDefault();
                const status = document.getElementById('notificationsStatus');
                status.style.display = 'block';
                status.textContent = 'Notification preferences updated!';
            };
            // Close account logic
            document.getElementById('closeAccountBtn').onclick = function() {
                const status = document.getElementById('closeAccountStatus');
                status.style.display = 'block';
                status.textContent = 'Account closure request submitted. Our team will contact you.';
            };
            }, 100);
        }

        // Replace Settings modal logic in sidebar/settings menu to show full settings
        document.querySelectorAll('.sidebar ul li a, #settingsMenu').forEach(link => {
            const text = link.textContent.replace(/<[^>]+>/g, '').trim();
            if (text === 'Settings') {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                showFullSettingsModal();
            });
            }
        });
        /**
         * Organize Settings section features into collapsible panels for better UX.
         * Each feature group (2FA, Login, Password, Language, Notifications, Close Account) is a collapsible panel.
         */
        function showOrganizedSettingsModal() {
            origCreateHeaderModal({
                id: 'organizedSettingsModal',
                title: 'Settings',
                content: `
                    <div style="margin-bottom:12px;">
                        <button class="settings-collapse-btn" data-target="panel-2fa" style="width:100%;text-align:left;background:#f4f7fa;color:#158173;border:none;padding:12px 16px;font-size:1.1em;font-weight:600;border-radius:6px;margin-bottom:6px;cursor:pointer;">
                            Two-Factor Authentication (2FA)
                        </button>
                        <div id="panel-2fa" class="settings-panel" style="display:none;padding:12px 16px 0 16px;">
                            <p style="margin-bottom:10px;">Add an extra layer of security to your account.</p>
                            <button id="enable2FABtn" style="background:#3949ab;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">Enable 2FA</button>
                            <div id="2faStatus" style="margin-top:10px;color:#3949ab;font-weight:500;display:none;"></div>
                        </div>
                    </div>
                    <div style="margin-bottom:12px;">
                        <button class="settings-collapse-btn" data-target="panel-login" style="width:100%;text-align:left;background:#f4f7fa;color:#158173;border:none;padding:12px 16px;font-size:1.1em;font-weight:600;border-radius:6px;margin-bottom:6px;cursor:pointer;">
                            Change Login Email / Phone
                        </button>
                        <div id="panel-login" class="settings-panel" style="display:none;padding:12px 16px 0 16px;">
                            <form id="changeLoginForm">
                                <label style="display:block;margin-bottom:6px;font-weight:500;">New Email:</label>
                                <input type="email" placeholder="Enter new email" style="margin-bottom:10px;width:100%;padding:8px;">
                                <label style="display:block;margin-bottom:6px;font-weight:500;">New Phone:</label>
                                <input type="tel" placeholder="Enter new phone" style="margin-bottom:14px;width:100%;padding:8px;">
                                <button type="submit" style="background:#158173;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">Update Login Details</button>
                            </form>
                            <div id="loginChangeStatus" style="margin-top:10px;color:#3949ab;font-weight:500;display:none;"></div>
                        </div>
                    </div>
                    <div style="margin-bottom:12px;">
                        <button class="settings-collapse-btn" data-target="panel-password" style="width:100%;text-align:left;background:#f4f7fa;color:#158173;border:none;padding:12px 16px;font-size:1.1em;font-weight:600;border-radius:6px;margin-bottom:6px;cursor:pointer;">
                            Change Password
                        </button>
                        <div id="panel-password" class="settings-panel" style="display:none;padding:12px 16px 0 16px;">
                            <form id="changePasswordForm">
                                <input type="password" placeholder="Current Password" required style="margin-bottom:10px;width:100%;padding:8px;">
                                <input type="password" placeholder="New Password" required style="margin-bottom:10px;width:100%;padding:8px;">
                                <input type="password" placeholder="Confirm New Password" required style="margin-bottom:14px;width:100%;padding:8px;">
                                <button type="submit" style="background:#3949ab;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">Change Password</button>
                            </form>
                            <div id="passwordChangeStatus" style="margin-top:10px;color:#3949ab;font-weight:500;display:none;"></div>
                        </div>
                    </div>
                    <div style="margin-bottom:12px;">
                        <button class="settings-collapse-btn" data-target="panel-language" style="width:100%;text-align:left;background:#f4f7fa;color:#158173;border:none;padding:12px 16px;font-size:1.1em;font-weight:600;border-radius:6px;margin-bottom:6px;cursor:pointer;">
                            Language & Region
                        </button>
                        <div id="panel-language" class="settings-panel" style="display:none;padding:12px 16px 0 16px;">
                            <form id="languageForm">
                                <label style="display:block;margin-bottom:6px;font-weight:500;">Language:</label>
                                <select style="margin-bottom:10px;width:100%;padding:8px;">
                                    <option>English</option>
                                    <option>French</option>
                                    <option>Spanish</option>
                                    <option>Arabic</option>
                                </select>
                                <label style="display:block;margin-bottom:6px;font-weight:500;">Timezone:</label>
                                <select style="margin-bottom:14px;width:100%;padding:8px;">
                                    <option>GMT+3 (Africa/Kampala)</option>
                                    <option>GMT+0 (UTC)</option>
                                    <option>GMT+1 (Europe/Berlin)</option>
                                    <option>GMT-5 (America/New_York)</option>
                                </select>
                                <button type="submit" style="background:#158173;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">Save Preferences</button>
                            </form>
                            <div id="languageStatus" style="margin-top:10px;color:#3949ab;font-weight:500;display:none;"></div>
                        </div>
                    </div>
                    <div style="margin-bottom:12px;">
                        <button class="settings-collapse-btn" data-target="panel-notifications" style="width:100%;text-align:left;background:#f4f7fa;color:#158173;border:none;padding:12px 16px;font-size:1.1em;font-weight:600;border-radius:6px;margin-bottom:6px;cursor:pointer;">
                            Notifications
                        </button>
                        <div id="panel-notifications" class="settings-panel" style="display:none;padding:12px 16px 0 16px;">
                            <form id="notificationsForm">
                                <label style="display:block;margin-bottom:8px;">
                                    <input type="checkbox" checked style="margin-right:8px;"> Email notifications
                                </label>
                                <label style="display:block;margin-bottom:8px;">
                                    <input type="checkbox" checked style="margin-right:8px;"> SMS notifications
                                </label>
                                <label style="display:block;margin-bottom:8px;">
                                    <input type="checkbox" style="margin-right:8px;"> Push notifications
                                </label>
                                <button type="submit" style="background:#158173;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">Update Notifications</button>
                            </form>
                            <div id="notificationsStatus" style="margin-top:10px;color:#3949ab;font-weight:500;display:none;"></div>
                        </div>
                    </div>
                    <div>
                        <button class="settings-collapse-btn" data-target="panel-close" style="width:100%;text-align:left;background:#f4f7fa;color:#e53935;border:none;padding:12px 16px;font-size:1.1em;font-weight:600;border-radius:6px;margin-bottom:6px;cursor:pointer;">
                            Close Account
                        </button>
                        <div id="panel-close" class="settings-panel" style="display:none;padding:12px 16px 0 16px;">
                            <button id="closeAccountBtn" style="background:#e53935;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">Request Account Closure</button>
                            <div id="closeAccountStatus" style="margin-top:10px;color:#e53935;font-weight:500;display:none;"></div>
                        </div>
                    </div>
                `
            });

            setTimeout(() => {
                // Collapsible logic
                document.querySelectorAll('.settings-collapse-btn').forEach(btn => {
                    btn.onclick = function() {
                        const panel = document.getElementById(btn.dataset.target);
                        if (panel.style.display === 'block') {
                            panel.style.display = 'none';
                        } else {
                            document.querySelectorAll('.settings-panel').forEach(p => p.style.display = 'none');
                            panel.style.display = 'block';
                        }
                    };
                });

                // 2FA logic
                document.getElementById('enable2FABtn').onclick = function() {
                    const status = document.getElementById('2faStatus');
                    status.style.display = 'block';
                    status.textContent = '2FA enabled! Check your email for setup instructions.';
                };
                // Change login email/phone logic
                document.getElementById('changeLoginForm').onsubmit = function(ev) {
                    ev.preventDefault();
                    const status = document.getElementById('loginChangeStatus');
                    status.style.display = 'block';
                    status.textContent = 'Login details updated!';
                };
                // Change password logic
                document.getElementById('changePasswordForm').onsubmit = function(ev) {
                    ev.preventDefault();
                    const status = document.getElementById('passwordChangeStatus');
                    status.style.display = 'block';
                    status.textContent = 'Password changed successfully!';
                };
                // Language & region logic
                document.getElementById('languageForm').onsubmit = function(ev) {
                    ev.preventDefault();
                    const status = document.getElementById('languageStatus');
                    status.style.display = 'block';
                    status.textContent = 'Preferences saved!';
                };
                // Notifications logic
                document.getElementById('notificationsForm').onsubmit = function(ev) {
                    ev.preventDefault();
                    const status = document.getElementById('notificationsStatus');
                    status.style.display = 'block';
                    status.textContent = 'Notification preferences updated!';
                };
                // Close account logic
                document.getElementById('closeAccountBtn').onclick = function() {
                    const status = document.getElementById('closeAccountStatus');
                    status.style.display = 'block';
                    status.textContent = 'Account closure request submitted. Our team will contact you.';
                };
                // Optionally, open the first panel by default
                document.querySelector('.settings-collapse-btn').click();
            }, 100);
        }

        // Replace Settings modal logic in sidebar/settings menu to show organized settings
        document.querySelectorAll('.sidebar ul li a, #settingsMenu').forEach(link => {
            const text = link.textContent.replace(/<[^>]+>/g, '').trim();
            if (text === 'Settings') {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showOrganizedSettingsModal();
                });
            }
        });
    /**
     * Ensure only one settings modal (organized/collapsible) is shown at a time.
     * When opening the organized settings modal, close any other settings modals.
     */
    (function enforceSingleSettingsModal() {
        document.querySelectorAll('.sidebar ul li a, #settingsMenu').forEach(link => {
            const text = link.textContent.replace(/<[^>]+>/g, '').trim();
            if (text === 'Settings') {
                link.addEventListener('click', function(e) {
                    // Close all other settings modals if open
                    ['settingsModal', 'fullSettingsModal', 'organizedSettingsModal'].forEach(id => {
                        const modal = document.getElementById(id);
                        if (modal) modal.style.display = 'none';
                    });
                });
            }
        });
    })();

    /**
     * The settings section is already enhanced and organized above with:
     * - Two-Factor Authentication (2FA)
     * - Change login email/phone
     * - Change password
     * - Language & region
     * - Notifications
     * - Account closure
     * - Collapsible panels for each feature (Deriv.com style)
     * 
     * If you want to add more Deriv.com-like features, add more collapsible panels here.
     * Example: "Session Management", "API Tokens", "Security Logs", etc.
     */

    // Example: Add Session Management panel (Deriv.com style)
    (function addSessionManagementToSettings() {
        const origShowOrganizedSettingsModal = showOrganizedSettingsModal;
        showOrganizedSettingsModal = function() {
            origCreateHeaderModal({
                id: 'organizedSettingsModal',
                title: 'Settings',
                content: `
                    <div style="margin-bottom:12px;">
                        <button class="settings-collapse-btn" data-target="panel-2fa" style="width:100%;text-align:left;background:#f4f7fa;color:#158173;border:none;padding:12px 16px;font-size:1.1em;font-weight:600;border-radius:6px;margin-bottom:6px;cursor:pointer;">
                            Two-Factor Authentication (2FA)
                        </button>
                        <div id="panel-2fa" class="settings-panel" style="display:none;padding:12px 16px 0 16px;">
                            <p style="margin-bottom:10px;">Add an extra layer of security to your account.</p>
                            <button id="enable2FABtn" style="background:#3949ab;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">Enable 2FA</button>
                            <div id="2faStatus" style="margin-top:10px;color:#3949ab;font-weight:500;display:none;"></div>
                        </div>
                    </div>
                    <div style="margin-bottom:12px;">
                        <button class="settings-collapse-btn" data-target="panel-login" style="width:100%;text-align:left;background:#f4f7fa;color:#158173;border:none;padding:12px 16px;font-size:1.1em;font-weight:600;border-radius:6px;margin-bottom:6px;cursor:pointer;">
                            Change Login Email / Phone
                        </button>
                        <div id="panel-login" class="settings-panel" style="display:none;padding:12px 16px 0 16px;">
                            <form id="changeLoginForm">
                                <label style="display:block;margin-bottom:6px;font-weight:500;">New Email:</label>
                                <input type="email" placeholder="Enter new email" style="margin-bottom:10px;width:100%;padding:8px;">
                                <label style="display:block;margin-bottom:6px;font-weight:500;">New Phone:</label>
                                <input type="tel" placeholder="Enter new phone" style="margin-bottom:14px;width:100%;padding:8px;">
                                <button type="submit" style="background:#158173;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">Update Login Details</button>
                            </form>
                            <div id="loginChangeStatus" style="margin-top:10px;color:#3949ab;font-weight:500;display:none;"></div>
                        </div>
                    </div>
                    <div style="margin-bottom:12px;">
                        <button class="settings-collapse-btn" data-target="panel-password" style="width:100%;text-align:left;background:#f4f7fa;color:#158173;border:none;padding:12px 16px;font-size:1.1em;font-weight:600;border-radius:6px;margin-bottom:6px;cursor:pointer;">
                            Change Password
                        </button>
                        <div id="panel-password" class="settings-panel" style="display:none;padding:12px 16px 0 16px;">
                            <form id="changePasswordForm">
                                <input type="password" placeholder="Current Password" required style="margin-bottom:10px;width:100%;padding:8px;">
                                <input type="password" placeholder="New Password" required style="margin-bottom:10px;width:100%;padding:8px;">
                                <input type="password" placeholder="Confirm New Password" required style="margin-bottom:14px;width:100%;padding:8px;">
                                <button type="submit" style="background:#3949ab;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">Change Password</button>
                            </form>
                            <div id="passwordChangeStatus" style="margin-top:10px;color:#3949ab;font-weight:500;display:none;"></div>
                        </div>
                    </div>
                    <div style="margin-bottom:12px;">
                        <button class="settings-collapse-btn" data-target="panel-language" style="width:100%;text-align:left;background:#f4f7fa;color:#158173;border:none;padding:12px 16px;font-size:1.1em;font-weight:600;border-radius:6px;margin-bottom:6px;cursor:pointer;">
                            Language & Region
                        </button>
                        <div id="panel-language" class="settings-panel" style="display:none;padding:12px 16px 0 16px;">
                            <form id="languageForm">
                                <label style="display:block;margin-bottom:6px;font-weight:500;">Language:</label>
                                <select style="margin-bottom:10px;width:100%;padding:8px;">
                                    <option>English</option>
                                    <option>French</option>
                                    <option>Spanish</option>
                                    <option>Arabic</option>
                                </select>
                                <label style="display:block;margin-bottom:6px;font-weight:500;">Timezone:</label>
                                <select style="margin-bottom:14px;width:100%;padding:8px;">
                                    <option>GMT+3 (Africa/Kampala)</option>
                                    <option>GMT+0 (UTC)</option>
                                    <option>GMT+1 (Europe/Berlin)</option>
                                    <option>GMT-5 (America/New_York)</option>
                                </select>
                                <button type="submit" style="background:#158173;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">Save Preferences</button>
                            </form>
                            <div id="languageStatus" style="margin-top:10px;color:#3949ab;font-weight:500;display:none;"></div>
                        </div>
                    </div>
                    <div style="margin-bottom:12px;">
                        <button class="settings-collapse-btn" data-target="panel-notifications" style="width:100%;text-align:left;background:#f4f7fa;color:#158173;border:none;padding:12px 16px;font-size:1.1em;font-weight:600;border-radius:6px;margin-bottom:6px;cursor:pointer;">
                            Notifications
                        </button>
                        <div id="panel-notifications" class="settings-panel" style="display:none;padding:12px 16px 0 16px;">
                            <form id="notificationsForm">
                                <label style="display:block;margin-bottom:8px;">
                                    <input type="checkbox" checked style="margin-right:8px;"> Email notifications
                                </label>
                                <label style="display:block;margin-bottom:8px;">
                                    <input type="checkbox" checked style="margin-right:8px;"> SMS notifications
                                </label>
                                <label style="display:block;margin-bottom:8px;">
                                    <input type="checkbox" style="margin-right:8px;"> Push notifications
                                </label>
                                <button type="submit" style="background:#158173;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">Update Notifications</button>
                            </form>
                            <div id="notificationsStatus" style="margin-top:10px;color:#3949ab;font-weight:500;display:none;"></div>
                        </div>
                    </div>
                    <div style="margin-bottom:12px;">
                        <button class="settings-collapse-btn" data-target="panel-sessions" style="width:100%;text-align:left;background:#f4f7fa;color:#158173;border:none;padding:12px 16px;font-size:1.1em;font-weight:600;border-radius:6px;margin-bottom:6px;cursor:pointer;">
                            Session Management
                        </button>
                        <div id="panel-sessions" class="settings-panel" style="display:none;padding:12px 16px 0 16px;">
                            <p style="margin-bottom:10px;">Manage your active sessions/devices. Log out from other devices for security.</p>
                            <ul style="margin-bottom:10px;">
                                <li>Web - Chrome (Kampala, UG) <span style="color:#158173;">Active</span></li>
                                <li>Mobile - Android (Kampala, UG) <button id="logoutMobileBtn" style="background:#e53935;color:#fff;border:none;padding:2px 8px;border-radius:4px;cursor:pointer;font-size:0.95em;">Log out</button></li>
                            </ul>
                            <div id="sessionStatus" style="margin-top:10px;color:#3949ab;font-weight:500;display:none;"></div>
                        </div>
                    </div>
                    <div>
                        <button class="settings-collapse-btn" data-target="panel-close" style="width:100%;text-align:left;background:#f4f7fa;color:#e53935;border:none;padding:12px 16px;font-size:1.1em;font-weight:600;border-radius:6px;margin-bottom:6px;cursor:pointer;">
                            Close Account
                        </button>
                        <div id="panel-close" class="settings-panel" style="display:none;padding:12px 16px 0 16px;">
                            <button id="closeAccountBtn" style="background:#e53935;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">Request Account Closure</button>
                            <div id="closeAccountStatus" style="margin-top:10px;color:#e53935;font-weight:500;display:none;"></div>
                        </div>
                    </div>
                `
            });

            setTimeout(() => {
                // Collapsible logic
                document.querySelectorAll('.settings-collapse-btn').forEach(btn => {
                    btn.onclick = function() {
                        const panel = document.getElementById(btn.dataset.target);
                        if (panel.style.display === 'block') {
                            panel.style.display = 'none';
                        } else {
                            document.querySelectorAll('.settings-panel').forEach(p => p.style.display = 'none');
                            panel.style.display = 'block';
                        }
                    };
                });

                // 2FA logic
                document.getElementById('enable2FABtn').onclick = function() {
                    const status = document.getElementById('2faStatus');
                    status.style.display = 'block';
                    status.textContent = '2FA enabled! Check your email for setup instructions.';
                };
                // Change login email/phone logic
                document.getElementById('changeLoginForm').onsubmit = function(ev) {
                    ev.preventDefault();
                    const status = document.getElementById('loginChangeStatus');
                    status.style.display = 'block';
                    status.textContent = 'Login details updated!';
                };
                // Change password logic
                document.getElementById('changePasswordForm').onsubmit = function(ev) {
                    ev.preventDefault();
                    const status = document.getElementById('passwordChangeStatus');
                    status.style.display = 'block';
                    status.textContent = 'Password changed successfully!';
                };
                // Language & region logic
                document.getElementById('languageForm').onsubmit = function(ev) {
                    ev.preventDefault();
                    const status = document.getElementById('languageStatus');
                    status.style.display = 'block';
                    status.textContent = 'Preferences saved!';
                };
                // Notifications logic
                document.getElementById('notificationsForm').onsubmit = function(ev) {
                    ev.preventDefault();
                    const status = document.getElementById('notificationsStatus');
                    status.style.display = 'block';
                    status.textContent = 'Notification preferences updated!';
                };
                // Session management logic
                const logoutMobileBtn = document.getElementById('logoutMobileBtn');
                if (logoutMobileBtn) {
                    logoutMobileBtn.onclick = function() {
                        const status = document.getElementById('sessionStatus');
                        status.style.display = 'block';
                        status.textContent = 'Mobile session logged out!';
                        logoutMobileBtn.parentNode.innerHTML = 'Mobile - Android (Kampala, UG) <span style="color:#e53935;">Logged out</span>';
                    };
                }
                // Close account logic
                document.getElementById('closeAccountBtn').onclick = function() {
                    const status = document.getElementById('closeAccountStatus');
                    status.style.display = 'block';
                    status.textContent = 'Account closure request submitted. Our team will contact you.';
                };
                // Open first panel by default
                document.querySelector('.settings-collapse-btn').click();
            }, 100);
        };
        // Replace Settings modal logic in sidebar/settings menu to show organized settings
        document.querySelectorAll('.sidebar ul li a, #settingsMenu').forEach(link => {
            const text = link.textContent.replace(/<[^>]+>/g, '').trim();
            if (text === 'Settings') {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showOrganizedSettingsModal();
                });
            }
        });
    })();

    /**
     * Organize header elements: logo left, nav center, user/tools right.
     */
    (function organizeHeaderElements() {
        const header = document.querySelector('header');
        if (!header) return;

        // Find containers
        const logoContainer = header.querySelector('.logo-container');
        const nav = header.querySelector('nav');
        const navList = nav ? nav.querySelector('ul') : null;
        const accountBalance = nav ? nav.querySelector('#accountBalance') : null;
        const extra = header.querySelector('div[style*="align-items: center"][style*="gap: 18px"]');

        // Create a flex container for header layout
        header.style.display = 'flex';
        header.style.alignItems = 'center';
        header.style.justifyContent = 'space-between';

        // Ensure logo is left, nav center, user/tools right
        logoContainer.style.flex = '0 0 auto';
        nav.style.flex = '1 1 auto';
        nav.style.display = 'flex';
        nav.style.alignItems = 'center';
        nav.style.justifyContent = 'center';
        if (navList) {
            navList.style.flex = '0 0 auto';
            navList.style.margin = '0';
        }
        if (accountBalance) {
            accountBalance.style.marginRight = '24px';
        }
        if (extra) {
            extra.style.flex = '0 0 auto';
            extra.style.marginLeft = '18px';
        }

        // Move extra (user/tools) to the rightmost if not already
        if (extra && extra.parentNode !== header) {
            header.appendChild(extra);
        }
    })();

    /**
     * Display animated Volatility indices (V75, V25, V1001s) below the header.
     * Each index shows a live-like animated chart and the name "The Blue Traders".
     */
    (function showVolatilityAnimations() {
        // Create container
        const header = document.querySelector('header');
        const animContainer = document.createElement('div');
        animContainer.id = 'volatility-animations';
        animContainer.style.display = 'flex';
        animContainer.style.justifyContent = 'center';
        animContainer.style.gap = '32px';
        animContainer.style.background = '#fff';
        animContainer.style.boxShadow = '0 2px 8px rgba(0,0,0,0.04)';
        animContainer.style.padding = '18px 0 10px 0';
        animContainer.style.position = 'relative';
        animContainer.style.zIndex = '800';

        // Volatility indices configs
        const indices = [
            { name: 'Volatility 75 Index', color: '#3949ab', id: 'v75' },
            { name: 'Volatility 25 Index', color: '#158173', id: 'v25' },
            { name: 'Volatility 1001s Index', color: '#e53935', id: 'v1001s' }
        ];

        indices.forEach(idx => {
            const card = document.createElement('div');
            card.style.background = '#f4f7fa';
            card.style.borderRadius = '10px';
            card.style.boxShadow = '0 1px 4px rgba(0,0,0,0.04)';
            card.style.padding = '12px 24px 18px 24px';
            card.style.display = 'flex';
            card.style.flexDirection = 'column';
            card.style.alignItems = 'center';
            card.style.minWidth = '220px';

            // Title
            const title = document.createElement('div');
            title.textContent = idx.name;
            title.style.fontWeight = '700';
            title.style.fontSize = '1.08em';
            title.style.color = idx.color;
            title.style.marginBottom = '6px';
            card.appendChild(title);

            // Canvas for chart
            const canvas = document.createElement('canvas');
            canvas.width = 180;
            canvas.height = 48;
            canvas.style.display = 'block';
            canvas.style.background = '#fff';
            canvas.style.borderRadius = '6px';
            canvas.style.boxShadow = '0 1px 4px rgba(0,0,0,0.03)';
            card.appendChild(canvas);

            // "The Blue Traders" label
            const label = document.createElement('div');
            label.textContent = 'The Blue Traders';
            label.style.fontSize = '0.98em';
            label.style.fontWeight = '600';
            label.style.color = '#774a05';
            label.style.marginTop = '8px';
            card.appendChild(label);

            animContainer.appendChild(card);

            // Animate chart (simple random walk)
            const ctx = canvas.getContext('2d');
            let points = [];
            let y = canvas.height / 2;
            for (let i = 0; i < canvas.width; i++) {
                y += (Math.random() - 0.5) * 3;
                y = Math.max(10, Math.min(canvas.height - 10, y));
                points.push(y);
            }
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.beginPath();
                ctx.moveTo(0, points[0]);
                for (let x = 1; x < points.length; x++) {
                    ctx.lineTo(x, points[x]);
                }
                ctx.strokeStyle = idx.color;
                ctx.lineWidth = 2;
                ctx.stroke();
            }
            function animate() {
                // Shift left, add new point
                points.shift();
                let last = points[points.length - 1];
                let delta = (Math.random() - 0.5) * (idx.id === 'v1001s' ? 7 : idx.id === 'v75' ? 4 : 2);
                let next = last + delta;
                next = Math.max(10, Math.min(canvas.height - 10, next));
                points.push(next);
                draw();
                requestAnimationFrame(animate);
            }
            draw();
            animate();
        });

        // Insert below header, above .main-content
        header.parentNode.insertBefore(animContainer, header.nextSibling);
    })();


    // Enhance Deposit and Withdraw modals: ask for phone/bank/crypto after payment method selection, and for Mobile Money choose MTN/Airtel
    document.addEventListener('click', function () {
        // Deposit Modal
        if (document.getElementById('depositModal') && document.getElementById('depositForm')) {
            const form = document.getElementById('depositForm');
            if (!form.dataset.methodEnhanced) {
                form.dataset.methodEnhanced = '1';
                const methodSelect = form.querySelector('select');
                let extraNodes = [];
                methodSelect.addEventListener('change', function () {
                    // Remove previous extra fields
                    extraNodes.forEach(n => n.parentNode && n.parentNode.removeChild(n));
                    extraNodes = [];
                    if (methodSelect.value === 'Bank Card') {
                        // Bank Account
                        const label = document.createElement('label');
                        label.style.display = 'block';
                        label.style.marginBottom = '8px';
                        label.style.fontWeight = '500';
                        label.textContent = 'Bank Account Number:';
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.required = true;
                        input.placeholder = 'Enter your bank account number';
                        input.style.marginBottom = '16px';
                        input.style.width = '100%';
                        input.style.padding = '8px';
                        methodSelect.parentNode.insertBefore(label, methodSelect.nextSibling);
                        methodSelect.parentNode.insertBefore(input, label.nextSibling);
                        extraNodes = [label, input];
                    } else if (methodSelect.value === 'Crypto') {
                        // Crypto Address
                        const label = document.createElement('label');
                        label.style.display = 'block';
                        label.style.marginBottom = '8px';
                        label.style.fontWeight = '500';
                        label.textContent = 'Crypto Address:';
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.required = true;
                        input.placeholder = 'Enter your crypto address';
                        input.style.marginBottom = '16px';
                        input.style.width = '100%';
                        input.style.padding = '8px';
                        methodSelect.parentNode.insertBefore(label, methodSelect.nextSibling);
                        methodSelect.parentNode.insertBefore(input, label.nextSibling);
                        extraNodes = [label, input];
                    } else if (methodSelect.value === 'Mobile Money') {
                        // Mobile Money Network
                        const netLabel = document.createElement('label');
                        netLabel.style.display = 'block';
                        netLabel.style.marginBottom = '8px';
                        netLabel.style.fontWeight = '500';
                        netLabel.textContent = 'Mobile Money Network:';
                        const netSelect = document.createElement('select');
                        netSelect.required = true;
                        netSelect.style.marginBottom = '10px';
                        netSelect.style.width = '100%';
                        netSelect.style.padding = '8px';
                        const opt1 = document.createElement('option');
                        opt1.value = '';
                        opt1.textContent = 'Select Network';
                        const opt2 = document.createElement('option');
                        opt2.value = 'MTN';
                        opt2.textContent = 'MTN';
                        const opt3 = document.createElement('option');
                        opt3.value = 'Airtel';
                        opt3.textContent = 'Airtel';
                        netSelect.appendChild(opt1);
                        netSelect.appendChild(opt2);
                        netSelect.appendChild(opt3);

                        // Phone Number
                        const label = document.createElement('label');
                        label.style.display = 'block';
                        label.style.marginBottom = '8px';
                        label.style.fontWeight = '500';
                        label.textContent = 'Mobile Money Phone Number:';
                        const input = document.createElement('input');
                        input.type = 'tel';
                        input.required = true;
                        input.placeholder = 'Enter your phone number';
                        input.style.marginBottom = '16px';
                        input.style.width = '100%';
                        input.style.padding = '8px';

                        methodSelect.parentNode.insertBefore(netLabel, methodSelect.nextSibling);
                        methodSelect.parentNode.insertBefore(netSelect, netLabel.nextSibling);
                        methodSelect.parentNode.insertBefore(label, netSelect.nextSibling);
                        methodSelect.parentNode.insertBefore(input, label.nextSibling);
                        extraNodes = [netLabel, netSelect, label, input];
                    }
                });
            }
        }
        // Withdraw Modal
        if (document.getElementById('withdrawModal') && document.getElementById('withdrawForm')) {
            const form = document.getElementById('withdrawForm');
            if (!form.dataset.methodEnhanced) {
                form.dataset.methodEnhanced = '1';
                const methodSelect = form.querySelector('select');
                let extraNodes = [];
                methodSelect.addEventListener('change', function () {
                    // Remove previous extra fields
                    extraNodes.forEach(n => n.parentNode && n.parentNode.removeChild(n));
                    extraNodes = [];
                    if (methodSelect.value === 'Bank Card') {
                        // Bank Account
                        const label = document.createElement('label');
                        label.style.display = 'block';
                        label.style.marginBottom = '8px';
                        label.style.fontWeight = '500';
                        label.textContent = 'Bank Account Number:';
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.required = true;
                        input.placeholder = 'Enter your bank account number';
                        input.style.marginBottom = '16px';
                        input.style.width = '100%';
                        input.style.padding = '8px';
                        methodSelect.parentNode.insertBefore(label, methodSelect.nextSibling);
                        methodSelect.parentNode.insertBefore(input, label.nextSibling);
                        extraNodes = [label, input];
                    } else if (methodSelect.value === 'Crypto') {
                        // Crypto Address
                        const label = document.createElement('label');
                        label.style.display = 'block';
                        label.style.marginBottom = '8px';
                        label.style.fontWeight = '500';
                        label.textContent = 'Crypto Address:';
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.required = true;
                        input.placeholder = 'Enter your crypto address';
                        input.style.marginBottom = '16px';
                        input.style.width = '100%';
                        input.style.padding = '8px';
                        methodSelect.parentNode.insertBefore(label, methodSelect.nextSibling);
                        methodSelect.parentNode.insertBefore(input, label.nextSibling);
                        extraNodes = [label, input];
                    } else if (methodSelect.value === 'Mobile Money') {
                        // Mobile Money Network
                        const netLabel = document.createElement('label');
                        netLabel.style.display = 'block';
                        netLabel.style.marginBottom = '8px';
                        netLabel.style.fontWeight = '500';
                        netLabel.textContent = 'Mobile Money Network:';
                        const netSelect = document.createElement('select');
                        netSelect.required = true;
                        netSelect.style.marginBottom = '10px';
                        netSelect.style.width = '100%';
                        netSelect.style.padding = '8px';
                        const opt1 = document.createElement('option');
                        opt1.value = '';
                        opt1.textContent = 'Select Network';
                        const opt2 = document.createElement('option');
                        opt2.value = 'MTN';
                        opt2.textContent = 'MTN';
                        const opt3 = document.createElement('option');
                        opt3.value = 'Airtel';
                        opt3.textContent = 'Airtel';
                        netSelect.appendChild(opt1);
                        netSelect.appendChild(opt2);
                        netSelect.appendChild(opt3);

                        // Phone Number
                        const label = document.createElement('label');
                        label.style.display = 'block';
                        label.style.marginBottom = '8px';
                        label.style.fontWeight = '500';
                        label.textContent = 'Mobile Money Phone Number:';
                        const input = document.createElement('input');
                        input.type = 'tel';
                        input.required = true;
                        input.placeholder = 'Enter your phone number';
                        input.style.marginBottom = '16px';
                        input.style.width = '100%';
                        input.style.padding = '8px';

                        methodSelect.parentNode.insertBefore(netLabel, methodSelect.nextSibling);
                        methodSelect.parentNode.insertBefore(netSelect, netLabel.nextSibling);
                        methodSelect.parentNode.insertBefore(label, netSelect.nextSibling);
                        methodSelect.parentNode.insertBefore(input, label.nextSibling);
                        extraNodes = [netLabel, netSelect, label, input];
                    }
                });
            }
        }
    });


    /**
     * Enhance Deposit modal: ask for PIN if Mobile Money or Bank Card, then show success message.
     */
    document.addEventListener('click', function () {
        const depositForm = document.getElementById('depositForm');
        if (depositForm && !depositForm.dataset.pinEnhanced) {
            depositForm.dataset.pinEnhanced = '1';
            depositForm.onsubmit = function (ev) {
                ev.preventDefault();
                const methodSelect = depositForm.querySelector('select');
                const method = methodSelect ? methodSelect.value : '';
                // Only require PIN for Mobile Money or Bank Card
                if (method === 'Mobile Money' || method === 'Bank Card') {
                    // Show push notification (simple alert for demo)
                    setTimeout(() => {
                        const pin = prompt('Enter your Mobile Money/Bank PIN to complete the deposit:');
                        if (pin && pin.length >= 4) {
                            // Success message
                            const status = document.getElementById('depositStatus');
                            status.style.display = 'block';
                            status.textContent = 'Congratulations! Your deposit was successful.';
                        } else {
                            alert('PIN entry cancelled or invalid. Deposit not completed.');
                        }
                    }, 100);
                } else {
                    // For other methods, just show success
                    const status = document.getElementById('depositStatus');
                    status.style.display = 'block';
                    status.textContent = 'Congratulations! Your deposit was successful.';
                }
            };
        }
    });
    // Update account balance in header after successful deposit
    function updateHeaderBalance(newBalance) {
        const balanceSpan = document.getElementById('accountBalance');
        if (balanceSpan) {
        balanceSpan.textContent = 'Balance: ' + newBalance;
        }
    }

    // Listen for deposit success and update balance
    document.addEventListener('click', function () {
        const depositForm = document.getElementById('depositForm');
        if (depositForm && !depositForm.dataset.balanceEnhanced) {
        depositForm.dataset.balanceEnhanced = '1';
        depositForm.addEventListener('submit', function (ev) {
            // Wait for depositStatus to show success, then update balance
            setTimeout(() => {
            const status = document.getElementById('depositStatus');
            if (status && status.textContent.includes('Congratulations')) {
                // Get USD amount from form
                const usdInput = depositForm.querySelector('input[type="number"]');
                let amount = parseFloat(usdInput && usdInput.value ? usdInput.value : '0');
                if (!isNaN(amount) && amount > 0) {
                // Get current balance from header
                const balanceSpan = document.getElementById('accountBalance');
                let current = 0;
                if (balanceSpan) {
                    const match = balanceSpan.textContent.match(/[\d,]+\.\d{2}/);
                    if (match) current = parseFloat(match[0].replace(/,/g, ''));
                }
                let newBalance = current + amount;
                updateHeaderBalance('$' + newBalance.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}));
                }
            }
            }, 200);
        });
        }
    });


    /**
     * Organize header: logo left, nav center, user/tools right (responsive).
     */
    (function organizeHeader() {
        const header = document.querySelector('header');
        if (!header) return;
        const logo = header.querySelector('.logo-container');
        const nav = header.querySelector('nav');
        const navList = nav ? nav.querySelector('ul') : null;
        const accountBalance = nav ? nav.querySelector('#accountBalance') : null;
        const extra = header.querySelector('div[style*="align-items: center"][style*="gap: 18px"]');

        // Set up flex layout
        header.style.display = 'flex';
        header.style.alignItems = 'center';
        header.style.justifyContent = 'space-between';

        // Logo left
        logo.style.flex = '0 0 auto';

        // Nav center
        nav.style.flex = '1 1 auto';
        nav.style.display = 'flex';
        nav.style.alignItems = 'center';
        nav.style.justifyContent = 'center';
        if (navList) {
            navList.style.flex = '0 0 auto';
            navList.style.margin = '0';
        }
        if (accountBalance) {
            accountBalance.style.marginRight = '24px';
        }

        // User/tools right
        if (extra) {
            extra.style.flex = '0 0 auto';
            extra.style.marginLeft = '18px';
            if (extra.parentNode !== header) {
                header.appendChild(extra);
            }
        }
    })();

 
 

/**
 * Replace all "Currency" <select> in live account forms with a full list of world currencies.
 */
(function enhanceCurrencySelects() {
    // List of ISO 4217 currencies (code and name)
    const currencies = [
        { code: "USD", name: "US Dollar" },
        { code: "EUR", name: "Euro" },
        { code: "GBP", name: "British Pound" },
        { code: "JPY", name: "Japanese Yen" },
        { code: "CHF", name: "Swiss Franc" },
        { code: "CAD", name: "Canadian Dollar" },
        { code: "AUD", name: "Australian Dollar" },
        { code: "NZD", name: "New Zealand Dollar" },
        { code: "UGX", name: "Ugandan Shilling" },
        { code: "KES", name: "Kenyan Shilling" },
        { code: "TZS", name: "Tanzanian Shilling" },
        { code: "ZAR", name: "South African Rand" },
        { code: "GHS", name: "Ghanaian Cedi" },
        { code: "NGN", name: "Nigerian Naira" },
        { code: "CNY", name: "Chinese Yuan" },
        { code: "SGD", name: "Singapore Dollar" },
        { code: "HKD", name: "Hong Kong Dollar" },
        { code: "SEK", name: "Swedish Krona" },
        { code: "NOK", name: "Norwegian Krone" },
        { code: "DKK", name: "Danish Krone" },
        { code: "RUB", name: "Russian Ruble" },
        { code: "INR", name: "Indian Rupee" },
        { code: "BRL", name: "Brazilian Real" },
        { code: "MXN", name: "Mexican Peso" },
        { code: "TRY", name: "Turkish Lira" },
        { code: "PLN", name: "Polish Zloty" },
        { code: "CZK", name: "Czech Koruna" },
        { code: "HUF", name: "Hungarian Forint" },
        { code: "ILS", name: "Israeli Shekel" },
        { code: "SAR", name: "Saudi Riyal" },
        { code: "AED", name: "UAE Dirham" },
        { code: "QAR", name: "Qatari Riyal" },
        { code: "OMR", name: "Omani Rial" },
        { code: "BHD", name: "Bahraini Dinar" },
        { code: "KWD", name: "Kuwaiti Dinar" },
        { code: "EGP", name: "Egyptian Pound" },
        { code: "PKR", name: "Pakistani Rupee" },
        { code: "BDT", name: "Bangladeshi Taka" },
        { code: "LKR", name: "Sri Lankan Rupee" },
        { code: "MYR", name: "Malaysian Ringgit" },
        { code: "THB", name: "Thai Baht" },
        { code: "IDR", name: "Indonesian Rupiah" },
        { code: "PHP", name: "Philippine Peso" },
        { code: "KRW", name: "South Korean Won" },
        { code: "VND", name: "Vietnamese Dong" },
        { code: "ARS", name: "Argentine Peso" },
        { code: "CLP", name: "Chilean Peso" },
        { code: "COP", name: "Colombian Peso" },
        { code: "PEN", name: "Peruvian Sol" },
        { code: "MAD", name: "Moroccan Dirham" },
        { code: "TND", name: "Tunisian Dinar" },
        { code: "DZD", name: "Algerian Dinar" },
        { code: "XOF", name: "West African CFA franc" },
        { code: "XAF", name: "Central African CFA franc" },
        { code: "GEL", name: "Georgian Lari" },
        { code: "UAH", name: "Ukrainian Hryvnia" },
        { code: "RON", name: "Romanian Leu" },
        { code: "BGN", name: "Bulgarian Lev" },
        { code: "HRK", name: "Croatian Kuna" },
        { code: "ISK", name: "Icelandic Krona" },
        { code: "CZK", name: "Czech Koruna" },
        { code: "RSD", name: "Serbian Dinar" },
        { code: "MKD", name: "Macedonian Denar" },
        { code: "ALL", name: "Albanian Lek" },
        { code: "MDL", name: "Moldovan Leu" },
        { code: "AZN", name: "Azerbaijani Manat" },
        { code: "KZT", name: "Kazakhstani Tenge" },
        { code: "UZS", name: "Uzbekistani Som" },
        { code: "TJS", name: "Tajikistani Somoni" },
        { code: "AFN", name: "Afghan Afghani" },
        { code: "MNT", name: "Mongolian Tögrög" },
        { code: "MMK", name: "Burmese Kyat" },
        { code: "KHR", name: "Cambodian Riel" },
        { code: "LAK", name: "Lao Kip" },
        { code: "BND", name: "Brunei Dollar" },
        { code: "BWP", name: "Botswana Pula" },
        { code: "NAD", name: "Namibian Dollar" },
        { code: "MZN", name: "Mozambican Metical" },
        { code: "ETB", name: "Ethiopian Birr" },
        { code: "SDG", name: "Sudanese Pound" },
        { code: "SSP", name: "South Sudanese Pound" },
        { code: "CDF", name: "Congolese Franc" },
        { code: "AOA", name: "Angolan Kwanza" },
        { code: "ZMW", name: "Zambian Kwacha" },
        { code: "BAM", name: "Bosnia-Herzegovina Convertible Mark" },
        { code: "MUR", name: "Mauritian Rupee" },
        { code: "SCR", name: "Seychellois Rupee" },
        { code: "MVR", name: "Maldivian Rufiyaa" },
        { code: "LKR", name: "Sri Lankan Rupee" },
        { code: "NPR", name: "Nepalese Rupee" },
        { code: "BTN", name: "Bhutanese Ngultrum" },
        { code: "BBD", name: "Barbadian Dollar" },
        { code: "TTD", name: "Trinidad and Tobago Dollar" },
        { code: "JMD", name: "Jamaican Dollar" },
        { code: "XCD", name: "East Caribbean Dollar" },
        { code: "BSD", name: "Bahamian Dollar" },
        { code: "BZD", name: "Belize Dollar" },
        { code: "HTG", name: "Haitian Gourde" },
        { code: "DOP", name: "Dominican Peso" },
        { code: "GTQ", name: "Guatemalan Quetzal" },
        { code: "HNL", name: "Honduran Lempira" },
        { code: "NIO", name: "Nicaraguan Córdoba" },
        { code: "CRC", name: "Costa Rican Colón" },
        { code: "PYG", name: "Paraguayan Guaraní" },
        { code: "UYU", name: "Uruguayan Peso" },
        { code: "BOB", name: "Bolivian Boliviano" },
        { code: "VEF", name: "Venezuelan Bolívar" },
        { code: "SRD", name: "Surinamese Dollar" },
        { code: "GYD", name: "Guyanese Dollar" },
        { code: "SBD", name: "Solomon Islands Dollar" },
        { code: "PGK", name: "Papua New Guinean Kina" },
        { code: "FJD", name: "Fijian Dollar" },
        { code: "TOP", name: "Tongan Paʻanga" },
        { code: "WST", name: "Samoan Tala" },
        { code: "VUV", name: "Vanuatu Vatu" },
        { code: "XPF", name: "CFP Franc" },
        { code: "KMF", name: "Comorian Franc" },
        { code: "MGA", name: "Malagasy Ariary" },
        { code: "DJF", name: "Djiboutian Franc" },
        { code: "SOS", name: "Somali Shilling" },
        { code: "SZL", name: "Swazi Lilangeni" },
        { code: "LSL", name: "Lesotho Loti" },
        { code: "MWK", name: "Malawian Kwacha" },
        { code: "GMD", name: "Gambian Dalasi" },
        { code: "SLL", name: "Sierra Leonean Leone" },
        { code: "GNF", name: "Guinean Franc" },
        { code: "XOF", name: "West African CFA franc" },
        { code: "XAF", name: "Central African CFA franc" },
        { code: "CVE", name: "Cape Verdean Escudo" },
        { code: "STD", name: "São Tomé and Príncipe Dobra" },
        { code: "MRO", name: "Mauritanian Ouguiya" },
        { code: "TND", name: "Tunisian Dinar" },
        { code: "LYD", name: "Libyan Dinar" },
        { code: "MRU", name: "Mauritanian Ouguiya (new)" },
        { code: "ZWL", name: "Zimbabwean Dollar" }
        // ... add more as needed
    ];

    // Helper to replace currency selects
    function replaceCurrencySelects() {
        document.querySelectorAll('select[id*="Currency"]').forEach(sel => {
            // Only replace if not already enhanced
            if (sel.dataset.enhanced) return;
            sel.dataset.enhanced = "1";
            // Save current value if any
            const current = sel.value;
            sel.innerHTML = '<option value="">Select Currency</option>' +
                currencies.map(cur =>
                    `<option value="${cur.code}"${cur.code === current ? ' selected' : ''}>${cur.code} - ${cur.name}</option>`
                ).join('');
        });
    }

    // Enhance on modal open (live account forms)
    document.addEventListener('click', function () {
        setTimeout(replaceCurrencySelects, 120);
    });
    // Also enhance on DOMContentLoaded for any already present
    document.addEventListener('DOMContentLoaded', function () {
        setTimeout(replaceCurrencySelects, 120);
    });
})();


/**
 * Admin/User dashboard switch and admin dashboard features.
 */

// --- Admin/User Switch UI ---
(function adminUserSwitch() {
    // Add switch button to header right (user/tools area)
    const header = document.querySelector('header');
    const extra = header && header.querySelector('div[style*="align-items: center"][style*="gap: 18px"]');
    const switchBtn = document.createElement('button');
    switchBtn.id = 'dashboardSwitchBtn';
    switchBtn.style.background = '#ffd600';
    switchBtn.style.color = '#3949ab';
    switchBtn.style.border = 'none';
    switchBtn.style.borderRadius = '18px';
    switchBtn.style.padding = '6px 18px';
    switchBtn.style.fontWeight = '700';
    switchBtn.style.marginLeft = '8px';
    switchBtn.style.cursor = 'pointer';
    switchBtn.style.fontSize = '1em';
    switchBtn.style.boxShadow = '0 1px 4px rgba(0,0,0,0.08)';
    switchBtn.textContent = 'Switch to Admin';
    if (extra) extra.appendChild(switchBtn);

    // Simulate admin login state (for demo, use localStorage)
    let isAdmin = localStorage.getItem('isAdmin') === '1';

    function setAdminMode(admin) {
        isAdmin = admin;
        localStorage.setItem('isAdmin', admin ? '1' : '0');
        switchBtn.textContent = admin ? 'Switch to User' : 'Switch to Admin';
        document.body.classList.toggle('admin-mode', admin);
        // Show/hide admin dashboard
        const adminDash = document.getElementById('adminDashboard');
        if (adminDash) adminDash.style.display = admin ? 'block' : 'none';
        // Hide user main-content if admin
        const mainContent = document.querySelector('.main-content');
        if (mainContent) mainContent.style.display = admin ? 'none' : '';
        // Hide admin switch if not admin and not logged in as admin
        if (!admin && !isAdmin) {
            // nothing to do, always show switch for demo
        }
    }

    switchBtn.onclick = function () {
        if (!isAdmin) {
            // For demo, prompt for admin password
            const pwd = prompt('Enter admin password:');
            if (pwd === 'admin123') {
                setAdminMode(true);
                showAdminDashboard();
            } else {
                alert('Incorrect password.');
            }
        } else {
            setAdminMode(false);
        }
    };

    // On load, show admin dashboard if admin
    if (isAdmin) {
        setAdminMode(true);
        showAdminDashboard();
    }
})();

// --- Admin Dashboard ---
function showAdminDashboard() {
    // Remove if already present
    let adminDash = document.getElementById('adminDashboard');
    if (adminDash) adminDash.remove();

    // Create admin dashboard container
    adminDash = document.createElement('div');
    adminDash.id = 'adminDashboard';
    adminDash.style.position = 'relative';
    adminDash.style.marginLeft = '220px';
    adminDash.style.padding = '32px 24px';
    adminDash.style.background = '#fff';
    adminDash.style.minHeight = 'calc(100vh - 60px)';
    adminDash.style.zIndex = '1';
    adminDash.style.display = 'block';

    // Responsive for mobile
    if (window.innerWidth < 900) adminDash.style.marginLeft = '0';

    // Admin dashboard HTML
    adminDash.innerHTML = `
        <h2 style="color:#3949ab;margin-top:0;">Admin Dashboard</h2>
        <div style="display:flex;gap:32px;flex-wrap:wrap;">
            <div style="flex:1;min-width:260px;background:#f4f7fa;padding:18px 20px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
                <h3 style="color:#158173;margin-top:0;">User Management</h3>
                <button id="viewAllUsersBtn" style="background:#3949ab;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;margin-bottom:8px;">View All Users</button>
                <button id="addUserBtn" style="background:#158173;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">Add User</button>
            </div>
            <div style="flex:1;min-width:260px;background:#f4f7fa;padding:18px 20px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
                <h3 style="color:#3949ab;margin-top:0;">Accounts & Transactions</h3>
                <button id="viewAllAccountsBtn" style="background:#3949ab;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;margin-bottom:8px;">View All Accounts</button>
                <button id="viewAllTransactionsBtn" style="background:#158173;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">View Transactions</button>
            </div>
            <div style="flex:1;min-width:260px;background:#f4f7fa;padding:18px 20px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
                <h3 style="color:#e53935;margin-top:0;">Admin Tools</h3>
                <button id="siteSettingsBtn" style="background:#e53935;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;margin-bottom:8px;">Site Settings</button>
                <button id="adminReportsBtn" style="background:#3949ab;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">Reports</button>
            </div>
        </div>
        <div style="margin-top:32px;">
            <h3 style="color:#158173;">Quick Actions</h3>
            <button id="impersonateUserBtn" style="background:#ffd600;color:#3949ab;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;margin-right:10px;">Impersonate User</button>
            <button id="broadcastMsgBtn" style="background:#3949ab;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">Broadcast Message</button>
        </div>
        <div id="adminDashContent" style="margin-top:32px;"></div>
    `;
    document.body.appendChild(adminDash);

    // Hide user main-content
    const mainContent = document.querySelector('.main-content');
    if (mainContent) mainContent.style.display = 'none';

    // --- Admin features logic ---
    // Dummy users/accounts/transactions for demo
    const users = [
        { id: 1, name: 'John Doe', email: 'john@example.com', status: 'Active', role: 'User' },
        { id: 2, name: 'Jane Smith', email: 'jane@demo.com', status: 'Pending', role: 'User' },
        { id: 3, name: 'Admin User', email: 'admin@demo.com', status: 'Active', role: 'Admin' }
    ];
    const accounts = [
        { id: '123456', user: 'John Doe', type: 'Standard', balance: '$5,000.00', status: 'Active' },
        { id: '654321', user: 'Jane Smith', type: 'Pro', balance: '$1,200.00', status: 'Active' }
    ];
    const transactions = [
        { id: 'T001', user: 'John Doe', type: 'Deposit', amount: '$500', date: '2024-06-01', status: 'Completed' },
        { id: 'T002', user: 'Jane Smith', type: 'Withdraw', amount: '$200', date: '2024-06-02', status: 'Pending' }
    ];

    // View All Users
    document.getElementById('viewAllUsersBtn').onclick = function () {
        const content = document.getElementById('adminDashContent');
        content.innerHTML = `
            <h4 style="color:#3949ab;">All Users</h4>
            <table style="width:100%;border-collapse:collapse;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
                <thead>
                    <tr style="background:#f4f7fa;">
                        <th style="padding:8px 6px;">ID</th>
                        <th style="padding:8px 6px;">Name</th>
                        <th style="padding:8px 6px;">Email</th>
                        <th style="padding:8px 6px;">Status</th>
                        <th style="padding:8px 6px;">Role</th>
                        <th style="padding:8px 6px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${users.map(u => `
                        <tr>
                            <td style="padding:7px 6px;">${u.id}</td>
                            <td style="padding:7px 6px;">${u.name}</td>
                            <td style="padding:7px 6px;">${u.email}</td>
                            <td style="padding:7px 6px;">${u.status}</td>
                            <td style="padding:7px 6px;">${u.role}</td>
                            <td style="padding:7px 6px;">
                                <button style="background:#158173;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:0.95em;">Edit</button>
                                <button style="background:#e53935;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:0.95em;">Delete</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    };

    // Add User
    document.getElementById('addUserBtn').onclick = function () {
        const content = document.getElementById('adminDashContent');
        content.innerHTML = `
            <h4 style="color:#3949ab;">Add New User</h4>
            <form id="adminAddUserForm" style="max-width:340px;">
                <input type="text" placeholder="Full Name" required style="margin-bottom:10px;width:100%;padding:8px;">
                <input type="email" placeholder="Email" required style="margin-bottom:10px;width:100%;padding:8px;">
                <select required style="margin-bottom:10px;width:100%;padding:8px;">
                    <option value="">Select Role</option>
                    <option>User</option>
                    <option>Admin</option>
                </select>
                <button type="submit" style="background:#158173;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;width:100%;">Add User</button>
            </form>
            <div id="adminAddUserStatus" style="margin-top:10px;color:#3949ab;font-weight:500;display:none;"></div>
        `;
        setTimeout(() => {
            document.getElementById('adminAddUserForm').onsubmit = function (ev) {
                ev.preventDefault();
                document.getElementById('adminAddUserStatus').style.display = 'block';
                document.getElementById('adminAddUserStatus').textContent = 'User added (demo only).';
            };
        }, 100);
    };

    // View All Accounts
    document.getElementById('viewAllAccountsBtn').onclick = function () {
        const content = document.getElementById('adminDashContent');
        content.innerHTML = `
            <h4 style="color:#3949ab;">All Accounts</h4>
            <table style="width:100%;border-collapse:collapse;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
                <thead>
                    <tr style="background:#f4f7fa;">
                        <th style="padding:8px 6px;">Account ID</th>
                        <th style="padding:8px 6px;">User</th>
                        <th style="padding:8px 6px;">Type</th>
                        <th style="padding:8px 6px;">Balance</th>
                        <th style="padding:8px 6px;">Status</th>
                        <th style="padding:8px 6px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${accounts.map(a => `
                        <tr>
                            <td style="padding:7px 6px;">${a.id}</td>
                            <td style="padding:7px 6px;">${a.user}</td>
                            <td style="padding:7px 6px;">${a.type}</td>
                            <td style="padding:7px 6px;">${a.balance}</td>
                            <td style="padding:7px 6px;">${a.status}</td>
                            <td style="padding:7px 6px;">
                                <button style="background:#158173;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:0.95em;">Edit</button>
                                <button style="background:#e53935;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:0.95em;">Delete</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    };

    // View Transactions
    document.getElementById('viewAllTransactionsBtn').onclick = function () {
        const content = document.getElementById('adminDashContent');
        content.innerHTML = `
            <h4 style="color:#3949ab;">All Transactions</h4>
            <table style="width:100%;border-collapse:collapse;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
                <thead>
                    <tr style="background:#f4f7fa;">
                        <th style="padding:8px 6px;">ID</th>
                        <th style="padding:8px 6px;">User</th>
                        <th style="padding:8px 6px;">Type</th>
                        <th style="padding:8px 6px;">Amount</th>
                        <th style="padding:8px 6px;">Date</th>
                        <th style="padding:8px 6px;">Status</th>
                        <th style="padding:8px 6px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${transactions.map(t => `
                        <tr>
                            <td style="padding:7px 6px;">${t.id}</td>
                            <td style="padding:7px 6px;">${t.user}</td>
                            <td style="padding:7px 6px;">${t.type}</td>
                            <td style="padding:7px 6px;">${t.amount}</td>
                            <td style="padding:7px 6px;">${t.date}</td>
                            <td style="padding:7px 6px;">${t.status}</td>
                            <td style="padding:7px 6px;">
                                <button style="background:#158173;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:0.95em;">View</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    };

    // Site Settings
    document.getElementById('siteSettingsBtn').onclick = function () {
        const content = document.getElementById('adminDashContent');
        content.innerHTML = `
            <h4 style="color:#e53935;">Site Settings</h4>
            <form id="adminSiteSettingsForm" style="max-width:340px;">
                <label style="font-weight:500;">Site Name:</label>
                <input type="text" value="The Blue Traders" style="margin-bottom:10px;width:100%;padding:8px;">
                <label style="font-weight:500;">Support Email:</label>
                <input type="email" value="support@bluetraders.com" style="margin-bottom:10px;width:100%;padding:8px;">
                <label style="font-weight:500;">Maintenance Mode:</label>
                <select style="margin-bottom:10px;width:100%;padding:8px;">
                    <option>Off</option>
                    <option>On</option>
                </select>
                <button type="submit" style="background:#e53935;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;width:100%;">Save Settings</button>
            </form>
            <div id="adminSiteSettingsStatus" style="margin-top:10px;color:#3949ab;font-weight:500;display:none;"></div>
        `;
        setTimeout(() => {
            document.getElementById('adminSiteSettingsForm').onsubmit = function (ev) {
                ev.preventDefault();
                document.getElementById('adminSiteSettingsStatus').style.display = 'block';
                document.getElementById('adminSiteSettingsStatus').textContent = 'Settings saved (demo only).';
            };
        }, 100);
    };

    // Reports
    document.getElementById('adminReportsBtn').onclick = function () {
        const content = document.getElementById('adminDashContent');
        content.innerHTML = `
            <h4 style="color:#3949ab;">Reports</h4>
            <ul style="padding-left:18px;">
                <li><a href="#" style="color:#158173;text-decoration:underline;">User Registrations Report</a></li>
                <li><a href="#" style="color:#158173;text-decoration:underline;">Deposits/Withdrawals Report</a></li>
                <li><a href="#" style="color:#158173;text-decoration:underline;">Account Activity Report</a></li>
            </ul>
            <div style="margin-top:12px;color:#3949ab;">(Demo: Reports not implemented)</div>
        `;
    };

    // Impersonate User
    document.getElementById('impersonateUserBtn').onclick = function () {
        const user = prompt('Enter user email to impersonate:');
        if (user) {
            alert('Now impersonating: ' + user + ' (demo only)');
        }
    };

    // Broadcast Message
    document.getElementById('broadcastMsgBtn').onclick = function () {
        const msg = prompt('Enter message to broadcast to all users:');
        if (msg) {
            alert('Broadcast sent: ' + msg + ' (live and demo)');
        }
    };
}

// Hide admin dashboard if not admin on page load
document.addEventListener('DOMContentLoaded', function () {
    if (localStorage.getItem('isAdmin') !== '1') {
        const adminDash = document.getElementById('adminDashboard');
        if (adminDash) adminDash.style.display = 'none';
    }
});

/**
 * Hide the admin/user switch button for normal users.
 * Only show it for admin (isAdmin in localStorage).
 * Allow admin login from user section using the correct email.
 */

// Hide switch button for non-admins
(function hideAdminSwitchForUsers() {
    function updateSwitchVisibility() {
        const switchBtn = document.getElementById('dashboardSwitchBtn');
        if (!switchBtn) return;
        const isAdmin = localStorage.getItem('isAdmin') === '1';
        switchBtn.style.display = isAdmin ? '' : 'none';
    }
    document.addEventListener('DOMContentLoaded', updateSwitchVisibility);
    window.addEventListener('storage', updateSwitchVisibility);
    setTimeout(updateSwitchVisibility, 200);
})();

// Allow admin login from user section (SignUp/Login modal)
(function enableAdminLoginFromUserSection() {
    // Patch the login form logic to allow admin login
    document.addEventListener('click', function () {
        setTimeout(() => {
            const loginForm = document.getElementById('loginForm');
            if (loginForm && !loginForm.dataset.adminEnhanced) {
                loginForm.dataset.adminEnhanced = '1';
                loginForm.onsubmit = function(ev) {
                    ev.preventDefault();
                    const email = loginForm.querySelector('input[type="email"]').value.trim().toLowerCase();
                    const password = loginForm.querySelector('input[type="password"]').value;
                    const status = document.getElementById('loginStatus');
                    if (email === 'thebluetraders1@gamil.com') {
                        // You can change this password as needed
                        const adminPassword = localStorage.getItem('adminPassword') || '25633';
                        if (password === 'admin123') {
                            localStorage.setItem('isAdmin', '1');
                            status.style.display = 'block';
                            status.textContent = 'Admin login successful! Redirecting to admin dashboard...';
                            setTimeout(() => {
                                // Hide modal, show admin dashboard
                                const modal = loginForm.closest('[id$="Modal"]');
                                if (modal) modal.style.display = 'none';
                                showAdminDashboard();
                                // Show switch button
                                const switchBtn = document.getElementById('dashboardSwitchBtn');
                                if (switchBtn) switchBtn.style.display = '';
                            }, 800);
                        } else {
                            status.style.display = 'block';
                            status.textContent = 'Incorrect admin password.';
                        }
                    } else {
                        status.style.display = 'block';
                        status.textContent = 'Login successful! Redirecting...';
                        setTimeout(() => {
                            status.style.display = 'none';
                        }, 1200);
                    }
                };
            }
        }, 120);
    });
})();


/**
 * Add more standard features to the admin dashboard: Announcements, KYC/Verification, Support Tickets, System Logs, and Analytics.
 */
function addMoreAdminFeatures() {
    const adminDash = document.getElementById('adminDashboard');
    if (!adminDash) return;
    // Add new feature buttons if not already present
    let extraRow = adminDash.querySelector('#adminExtraFeatures');
    if (!extraRow) {
        extraRow = document.createElement('div');
        extraRow.id = 'adminExtraFeatures';
        extraRow.style.display = 'flex';
        extraRow.style.gap = '32px';
        extraRow.style.flexWrap = 'wrap';
        extraRow.style.marginTop = '32px';
        extraRow.innerHTML = `
            <div style="flex:1;min-width:260px;background:#f4f7fa;padding:18px 20px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
                <h3 style="color:#3949ab;margin-top:0;">Announcements</h3>
                <button id="adminAnnouncementsBtn" style="background:#158173;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">Manage Announcements</button>
            </div>
            <div style="flex:1;min-width:260px;background:#f4f7fa;padding:18px 20px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
                <h3 style="color:#3949ab;margin-top:0;">KYC / Verification</h3>
                <button id="adminKycBtn" style="background:#3949ab;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">Review KYC Requests</button>
            </div>
            <div style="flex:1;min-width:260px;background:#f4f7fa;padding:18px 20px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
                <h3 style="color:#158173;margin-top:0;">Support Tickets</h3>
                <button id="adminSupportBtn" style="background:#158173;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">View Tickets</button>
            </div>
            <div style="flex:1;min-width:260px;background:#f4f7fa;padding:18px 20px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
                <h3 style="color:#3949ab;margin-top:0;">System Logs</h3>
                <button id="adminLogsBtn" style="background:#3949ab;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">View Logs</button>
            </div>
            <div style="flex:1;min-width:260px;background:#f4f7fa;padding:18px 20px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
                <h3 style="color:#e53935;margin-top:0;">Analytics</h3>
                <button id="adminAnalyticsBtn" style="background:#e53935;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;">View Analytics</button>
            </div>
        `;
        adminDash.insertBefore(extraRow, adminDash.querySelector('#adminDashContent'));
    }

    // Feature logic
    const content = adminDash.querySelector('#adminDashContent');
    // Announcements
    document.getElementById('adminAnnouncementsBtn').onclick = function () {
        content.innerHTML = `
            <h4 style="color:#3949ab;">Announcements</h4>
            <form id="adminAnnounceForm" style="max-width:340px;">
                <input type="text" placeholder="Title" required style="margin-bottom:10px;width:100%;padding:8px;">
                <textarea placeholder="Announcement message" required style="margin-bottom:10px;width:100%;padding:8px;height:60px;"></textarea>
                <button type="submit" style="background:#158173;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;width:100%;">Post Announcement</button>
            </form>
            <div id="adminAnnounceStatus" style="margin-top:10px;color:#3949ab;font-weight:500;display:none;"></div>
            <div style="margin-top:18px;">
                <b>Recent Announcements:</b>
                <ul style="padding-left:18px;">
                    <li>System maintenance scheduled for 2024-06-10.</li>
                    <li>Welcome to the new dashboard!</li>
                </ul>
            </div>
        `;
        setTimeout(() => {
            document.getElementById('adminAnnounceForm').onsubmit = function (ev) {
                ev.preventDefault();
                document.getElementById('adminAnnounceStatus').style.display = 'block';
                document.getElementById('adminAnnounceStatus').textContent = 'Announcement posted (demo only).';
            };
        }, 100);
    };
    // KYC / Verification
    document.getElementById('adminKycBtn').onclick = function () {
        content.innerHTML = `
            <h4 style="color:#3949ab;">KYC / Verification Requests</h4>
            <table style="width:100%;border-collapse:collapse;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
                <thead>
                    <tr style="background:#f4f7fa;">
                        <th style="padding:8px 6px;">User</th>
                        <th style="padding:8px 6px;">Document</th>
                        <th style="padding:8px 6px;">Status</th>
                        <th style="padding:8px 6px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding:7px 6px;">Jane Smith</td>
                        <td style="padding:7px 6px;">ID, Proof of Address</td>
                        <td style="padding:7px 6px;">Pending</td>
                        <td style="padding:7px 6px;">
                            <button style="background:#158173;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:0.95em;">Approve</button>
                            <button style="background:#e53935;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:0.95em;">Reject</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        `;
    };
    // Support Tickets
    document.getElementById('adminSupportBtn').onclick = function () {
        content.innerHTML = `
            <h4 style="color:#3949ab;">Support Tickets</h4>
            <table style="width:100%;border-collapse:collapse;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
                <thead>
                    <tr style="background:#f4f7fa;">
                        <th style="padding:8px 6px;">Ticket ID</th>
                        <th style="padding:8px 6px;">User</th>
                        <th style="padding:8px 6px;">Subject</th>
                        <th style="padding:8px 6px;">Status</th>
                        <th style="padding:8px 6px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding:7px 6px;">TK001</td>
                        <td style="padding:7px 6px;">John Doe</td>
                        <td style="padding:7px 6px;">Deposit not received</td>
                        <td style="padding:7px 6px;">Open</td>
                        <td style="padding:7px 6px;">
                            <button style="background:#158173;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:0.95em;">View</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        `;
    };
    // System Logs
    document.getElementById('adminLogsBtn').onclick = function () {
        content.innerHTML = `
            <h4 style="color:#3949ab;">System Logs</h4>
            <pre style="background:#232b3b;color:#e0e6ef;padding:12px;border-radius:6px;max-height:180px;overflow:auto;font-size:0.98em;">
[2024-06-01 10:00] User login: john@example.com
[2024-06-01 10:05] Deposit: $500 by John Doe
[2024-06-01 10:10] Admin login: admin@demo.com
[2024-06-01 10:15] KYC approved: Jane Smith
            </pre>
        `;
    };
    // Analytics
    document.getElementById('adminAnalyticsBtn').onclick = function () {
        content.innerHTML = `
            <h4 style="color:#e53935;">Analytics</h4>
            <div style="display:flex;gap:32px;flex-wrap:wrap;">
                <div style="flex:1;min-width:180px;background:#f4f7fa;padding:14px 12px;border-radius:8px;text-align:center;">
                    <div style="font-size:2em;font-weight:700;color:#3949ab;">1,234</div>
                    <div style="color:#158173;">Total Users</div>
                </div>
                <div style="flex:1;min-width:180px;background:#f4f7fa;padding:14px 12px;border-radius:8px;text-align:center;">
                    <div style="font-size:2em;font-weight:700;color:#3949ab;">$45,000</div>
                    <div style="color:#158173;">Total Deposits</div>
                </div>
                <div style="flex:1;min-width:180px;background:#f4f7fa;padding:14px 12px;border-radius:8px;text-align:center;">
                    <div style="font-size:2em;font-weight:700;color:#3949ab;">$12,000</div>
                    <div style="color:#158173;">Total Withdrawals</div>
                </div>
                <div style="flex:1;min-width:180px;background:#f4f7fa;padding:14px 12px;border-radius:8px;text-align:center;">
                    <div style="font-size:2em;font-weight:700;color:#3949ab;">98%</div>
                    <div style="color:#158173;">KYC Approved</div>
                </div>
            </div>
        `;
    };
}

// Attach features when admin dashboard is shown
document.addEventListener('DOMContentLoaded', function () {
    if (localStorage.getItem('isAdmin') === '1') setTimeout(addMoreAdminFeatures, 300);
});
window.addEventListener('click', function () {
    if (document.getElementById('adminDashboard')) setTimeout(addMoreAdminFeatures, 300);
});

/**
 * Add more features to Site Settings in Admin Dashboard.
 * Features: logo upload, theme color, enable/disable features, custom footer, and save settings.
 */
function enhanceAdminSiteSettings() {
    document.addEventListener('click', function () {
        setTimeout(() => {
            const form = document.getElementById('adminSiteSettingsForm');
            if (form && !form.dataset.enhanced) {
                form.dataset.enhanced = '1';

                // Logo upload
                const logoLabel = document.createElement('label');
                logoLabel.style.fontWeight = '500';
                logoLabel.textContent = 'Site Logo:';
                logoLabel.style.display = 'block';
                logoLabel.style.marginTop = '10px';
                const logoInput = document.createElement('input');
                logoInput.type = 'file';
                logoInput.accept = 'image/*';
                logoInput.style.marginBottom = '10px';
                logoInput.style.display = 'block';
                logoInput.style.width = '100%';
                const logoPreview = document.createElement('img');
                logoPreview.style.maxWidth = '120px';
                logoPreview.style.maxHeight = '60px';
                logoPreview.style.display = 'none';
                logoPreview.style.marginBottom = '10px';
                logoInput.onchange = function () {
                    if (logoInput.files && logoInput.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            logoPreview.src = e.target.result;
                            logoPreview.style.display = 'block';
                        };
                        reader.readAsDataURL(logoInput.files[0]);
                    }
                };
                form.insertBefore(logoLabel, form.children[2]);
                form.insertBefore(logoInput, logoLabel.nextSibling);
                form.insertBefore(logoPreview, logoInput.nextSibling);

                // Theme color
                const colorLabel = document.createElement('label');
                colorLabel.style.fontWeight = '500';
                colorLabel.textContent = 'Theme Color:';
                colorLabel.style.display = 'block';
                colorLabel.style.marginTop = '10px';
                const colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.value = '#158173';
                colorInput.style.marginBottom = '10px';
                colorInput.style.display = 'block';
                colorInput.style.width = '60px';
                form.insertBefore(colorLabel, form.children[5]);
                form.insertBefore(colorInput, colorLabel.nextSibling);

                // Feature toggles
                const featuresLabel = document.createElement('label');
                featuresLabel.style.fontWeight = '500';
                featuresLabel.textContent = 'Enable/Disable Features:';
                featuresLabel.style.display = 'block';
                featuresLabel.style.marginTop = '10px';
                const featuresDiv = document.createElement('div');
                featuresDiv.style.marginBottom = '10px';
                featuresDiv.innerHTML = `
                    <label style="display:block;margin-bottom:4px;">
                        <input type="checkbox" checked id="enableDeposit"> Enable Deposits
                    </label>
                    <label style="display:block;margin-bottom:4px;">
                        <input type="checkbox" checked id="enableWithdraw"> Enable Withdrawals
                    </label>
                    <label style="display:block;margin-bottom:4px;">
                        <input type="checkbox" checked id="enableKYC"> Enable KYC/Verification
                    </label>
                    <label style="display:block;margin-bottom:4px;">
                        <input type="checkbox" checked id="enablePromotions"> Enable Promotions
                    </label>
                `;
                form.insertBefore(featuresLabel, form.children[8]);
                form.insertBefore(featuresDiv, featuresLabel.nextSibling);

                // Custom footer
                const footerLabel = document.createElement('label');
                footerLabel.style.fontWeight = '500';
                footerLabel.textContent = 'Custom Footer Text:';
                footerLabel.style.display = 'block';
                footerLabel.style.marginTop = '10px';
                const footerInput = document.createElement('textarea');
                footerInput.placeholder = 'Enter custom footer text';
                footerInput.style.marginBottom = '10px';
                footerInput.style.width = '100%';
                footerInput.style.padding = '8px';
                footerInput.rows = 2;
                form.insertBefore(footerLabel, form.children[form.children.length - 2]);
                form.insertBefore(footerInput, footerLabel.nextSibling);

                // Save settings logic (demo)
                form.onsubmit = function (ev) {
                    ev.preventDefault();
                    const status = document.getElementById('adminSiteSettingsStatus');
                    status.style.display = 'block';
                    status.textContent = 'Settings saved (demo only).';
                };
            }
        }, 120);
    });
}
enhanceAdminSiteSettings();


/**
 * Show "Switch to User Dashboard" button in admin dashboard, visible only to admin.
 */
(function addSwitchToUserInAdminDashboard() {
    function renderSwitchBtn() {
        // Only show if admin
        if (localStorage.getItem('isAdmin') === '1') {
            let adminDash = document.getElementById('adminDashboard');
            if (!adminDash) return;
            let btn = document.getElementById('switchToUserBtn');
            if (!btn) {
                btn = document.createElement('button');
                btn.id = 'switchToUserBtn';
                btn.textContent = 'Switch to User Dashboard';
                btn.style.position = 'absolute';
                btn.style.top = '18px';
                btn.style.right = '32px';
                btn.style.background = '#3949ab';
                btn.style.color = '#fff';
                btn.style.border = 'none';
                btn.style.borderRadius = '18px';
                btn.style.padding = '7px 20px';
                btn.style.fontWeight = '700';
                btn.style.cursor = 'pointer';
                btn.style.zIndex = '10';
                btn.onclick = function () {
                    adminDash.style.display = 'none';
                    const mainContent = document.querySelector('.main-content');
                    if (mainContent) mainContent.style.display = '';
                };
                adminDash.appendChild(btn);
            } else {
                btn.style.display = '';
            }
        } else {
            // Hide if not admin
            const btn = document.getElementById('switchToUserBtn');
            if (btn) btn.style.display = 'none';
        }
    }
    // Run on admin dashboard show
    document.addEventListener('DOMContentLoaded', function () {
        setTimeout(renderSwitchBtn, 400);
    });
    window.addEventListener('click', function () {
        setTimeout(renderSwitchBtn, 400);
    });
})();

/**
 * Accept "25633" as password for switching back to admin dashboard.
 */
(function accept25633ForAdminSwitch() {
    const switchBtn = document.getElementById('dashboardSwitchBtn');
    if (switchBtn && !switchBtn.dataset.patched25633) {
        switchBtn.dataset.patched25633 = '1';
        switchBtn.onclick = function () {
            const isAdmin = localStorage.getItem('isAdmin') === '1';
            if (!isAdmin) {
                const pwd = prompt('Enter admin password:');
                if (pwd === 'admin123' || pwd === '25633') {
                    localStorage.setItem('isAdmin', '1');
                    switchBtn.textContent = 'Switch to User';
                    document.body.classList.add('admin-mode');
                    const adminDash = document.getElementById('adminDashboard');
                    if (adminDash) adminDash.style.display = 'block';
                    const mainContent = document.querySelector('.main-content');
                    if (mainContent) mainContent.style.display = 'none';
                    showAdminDashboard();
                } else {
                    alert('Incorrect password.');
                }
            } else {
                localStorage.setItem('isAdmin', '0');
                switchBtn.textContent = 'Switch to Admin';
                document.body.classList.remove('admin-mode');
                const adminDash = document.getElementById('adminDashboard');
                if (adminDash) adminDash.style.display = 'none';
                const mainContent = document.querySelector('.main-content');
                if (mainContent) mainContent.style.display = '';
            }
        };
    }
})();


/**
 * Add a "Logout" section to the admin dashboard.
 * Shows a logout button at the bottom of the admin dashboard.
 */
(function addAdminLogoutSection() {
    function renderLogoutSection() {
        const adminDash = document.getElementById('adminDashboard');
        if (!adminDash) return;
        let logoutDiv = document.getElementById('adminLogoutSection');
        if (!logoutDiv) {
            logoutDiv = document.createElement('div');
            logoutDiv.id = 'adminLogoutSection';
            logoutDiv.style.marginTop = '48px';
            logoutDiv.style.textAlign = 'center';
            logoutDiv.innerHTML = `
                <button id="adminLogoutBtn" style="background:#e53935;color:#fff;border:none;padding:10px 32px;border-radius:6px;font-size:1.1em;font-weight:700;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,0.08);">
                    Logout
                </button>
            `;
            adminDash.appendChild(logoutDiv);
        }
        // Attach logout logic
        const btn = document.getElementById('adminLogoutBtn');
        if (btn && !btn.dataset.bound) {
            btn.dataset.bound = '1';
            btn.onclick = function () {
                if (confirm('Are you sure you want to log out of the admin dashboard?')) {
                    localStorage.setItem('isAdmin', '0');
                    // Hide admin dashboard, show user dashboard
                    adminDash.style.display = 'none';
                    const mainContent = document.querySelector('.main-content');
                    if (mainContent) mainContent.style.display = '';
                    // Hide switch button if needed
                    const switchBtn = document.getElementById('dashboardSwitchBtn');
                    if (switchBtn) switchBtn.style.display = 'none';
                    alert('Logged out from admin dashboard.');
                }
            };
        }
    }
    // Render on admin dashboard show
    document.addEventListener('DOMContentLoaded', function () {
        setTimeout(renderLogoutSection, 500);
    });
    window.addEventListener('click', function () {
        setTimeout(renderLogoutSection, 500);
    });
})();


/**
 * Add a Market Watch panel to the right side of the home page.
 * Groups: Forex, Indices, Synthetics (Volatilities).
 * Each symbol shows price, Buy/Sell buttons.
 */
(function addMarketWatchPanel() {
    // Market data (demo, random prices)
    const forexPairs = [
        { symbol: "EUR/USD", price: 1.0852 },
        { symbol: "GBP/USD", price: 1.2741 },
        { symbol: "USD/JPY", price: 157.32 },
        { symbol: "USD/CHF", price: 0.8991 },
        { symbol: "AUD/USD", price: 0.6642 },
        { symbol: "USD/CAD", price: 1.3678 },
        { symbol: "NZD/USD", price: 0.6135 }
    ];
    const indices = [
        { symbol: "NASDAQ", price: 17650 },
        { symbol: "S&P 500", price: 5350 },
        { symbol: "US30", price: 38800 },
        { symbol: "DAX", price: 18600 },
        { symbol: "FTSE 100", price: 8250 }
    ];
    const synthetics = [
        { symbol: "VIX75", price: 21250 },
        { symbol: "VIX25", price: 10250 },
        { symbol: "VIX1001s", price: 30500 },
        { symbol: "Crash 1000", price: 14500 },
        { symbol: "Boom 1000", price: 14600 }
    ];

    // Create panel
    const panel = document.createElement('aside');
    panel.id = 'marketWatchPanel';
    panel.style.position = 'fixed';
    panel.style.top = '70px';
    panel.style.right = '0';
    panel.style.width = '320px';
    panel.style.maxWidth = '90vw';
    panel.style.height = 'calc(100vh - 80px)';
    panel.style.overflowY = 'auto';
    panel.style.background = '#fff';
    panel.style.boxShadow = '0 2px 12px rgba(0,0,0,0.08)';
    panel.style.borderRadius = '12px 0 0 12px';
    panel.style.zIndex = '1200';
    panel.style.padding = '18px 14px 18px 18px';
    panel.style.display = 'flex';
    panel.style.flexDirection = 'column';
    panel.style.gap = '18px';

    // Responsive: hide on small screens
    const style = document.createElement('style');
    style.textContent = `
        @media (max-width: 1100px) {
            #marketWatchPanel { display: none !important; }
        }
    `;
    document.head.appendChild(style);

    // Helper to render a group
    function renderGroup(title, items, color) {
        return `
            <div style="margin-bottom:8px;">
                <div style="font-weight:700;font-size:1.08em;color:${color};margin-bottom:6px;">${title}</div>
                <table style="width:100%;border-collapse:collapse;">
                    <thead>
                        <tr style="background:#f4f7fa;">
                            <th style="padding:6px 4px;font-size:0.98em;text-align:left;">Symbol</th>
                            <th style="padding:6px 4px;font-size:0.98em;text-align:right;">Price</th>
                            <th colspan="2" style="padding:6px 4px;text-align:center;">Trade</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map((item, i) => `
                            <tr>
                                <td style="padding:6px 4px;font-weight:600;color:${color};">${item.symbol}</td>
                                <td style="padding:6px 4px;text-align:right;" id="${title.replace(/\s/g,'')}-price-${i}">${item.price}</td>
                                <td style="padding:6px 2px;">
                                    <button class="marketBuyBtn" data-symbol="${item.symbol}" style="background:#158173;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:0.97em;">Buy</button>
                                </td>
                                <td style="padding:6px 2px;">
                                    <button class="marketSellBtn" data-symbol="${item.symbol}" style="background:#e53935;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:0.97em;">Sell</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    panel.innerHTML = `
        <div style="font-size:1.18em;font-weight:700;color:#3949ab;margin-bottom:8px;text-align:center;">
            Market Watch
        </div>
        ${renderGroup('Forex', forexPairs, '#158173')}
        ${renderGroup('Indices', indices, '#3949ab')}
        ${renderGroup('Synthetics', synthetics, '#e53935')}
    `;

    document.body.appendChild(panel);

    // Animate prices (random walk)
    function animatePrices(list, prefix, minStep, maxStep) {
        setInterval(() => {
            list.forEach((item, i) => {
                let step = (Math.random() - 0.5) * (maxStep - minStep) + minStep;
                if (typeof item.price === 'number') {
                    item.price += step;
                    if (item.symbol.includes('/')) {
                        // Forex: 4 or 5 decimals
                        item.price = Math.round(item.price * 10000) / 10000;
                    } else {
                        item.price = Math.round(item.price * 10) / 10;
                    }
                    const el = document.getElementById(`${prefix}-price-${i}`);
                    if (el) el.textContent = item.price;
                }
            });
        }, 1800);
    }
    animatePrices(forexPairs, 'Forex', 0.0005, 0.002);
    animatePrices(indices, 'Indices', 2, 12);
    animatePrices(synthetics, 'Synthetics', 5, 30);

    // Buy/Sell button logic
    panel.addEventListener('click', function (e) {
        if (e.target.classList.contains('marketBuyBtn') || e.target.classList.contains('marketSellBtn')) {
            const symbol = e.target.getAttribute('data-symbol');
            const action = e.target.classList.contains('marketBuyBtn') ? 'Buy' : 'Sell';
            // Show trade modal
            let modal = document.getElementById('marketTradeModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'marketTradeModal';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100vw';
                modal.style.height = '100vh';
                modal.style.background = 'rgba(0,0,0,0.32)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '4000';
                modal.innerHTML = `
                    <div style="background:#fff;padding:32px 24px;border-radius:10px;max-width:340px;width:100%;box-shadow:0 4px 24px rgba(0,0,0,0.14);position:relative;">
                        <button id="closeMarketTradeModalBtn" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#3949ab;">&times;</button>
                        <h2 style="margin-top:0;color:#158173;font-size:1.1em;" id="marketTradeTitle"></h2>
                        <form id="marketTradeForm">
                            <label style="display:block;margin-bottom:8px;font-weight:500;">Volume (lots):</label>
                            <input type="number" min="0.01" step="0.01" value="0.10" required style="margin-bottom:14px;width:100%;padding:8px;">
                            <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;font-size:1em;">Confirm Trade</button>
                        </form>
                        <div id="marketTradeStatus" style="margin-top:14px;color:#3949ab;font-weight:500;display:none;"></div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.querySelector('#closeMarketTradeModalBtn').onclick = () => {
                    modal.style.display = 'none';
                };
            }
            // Set title
            modal.querySelector('#marketTradeTitle').textContent = `${action} ${symbol}`;
            modal.style.display = 'flex';
            // Form logic
            const form = modal.querySelector('#marketTradeForm');
            const status = modal.querySelector('#marketTradeStatus');
            form.onsubmit = function(ev) {
                ev.preventDefault();
                status.style.display = 'block';
                status.textContent = `Order placed: ${action} ${symbol} (${form.querySelector('input').value} lots)`;
                setTimeout(() => { modal.style.display = 'none'; }, 1200);
            };
        }
    });
})();


/**
 * Organize the home page layout: add a hero section, features grid, and testimonials.
 * Place these above the accounts table/main dashboard.
 */
(function organizeHomePage() {
    const main = document.querySelector('main');
    if (!main) return;

    // Hero section
    const hero = document.createElement('section');
    hero.style.background = 'linear-gradient(90deg, #158173 0%, #3949ab 100%)';
    hero.style.color = '#fff';
    hero.style.padding = '48px 24px 36px 24px';
    hero.style.borderRadius = '0 0 18px 18px';
    hero.style.boxShadow = '0 2px 12px rgba(0,0,0,0.06)';
    hero.style.textAlign = 'center';
    hero.innerHTML = `
        <h1 style="font-size:2.2em;font-weight:800;margin-bottom:12px;letter-spacing:1px;">Welcome to The Blue Traders</h1>
        <p style="font-size:1.18em;max-width:600px;margin:0 auto 18px auto;">
            Trade Forex, Indices, Synthetics, and more with a secure, modern platform. Fast deposits, instant withdrawals, and 24/7 support.
        </p>
        <div style="margin-top:22px;">
            <button id="heroOpenAccountBtn" style="background:#ffd600;color:#3949ab;border:none;padding:14px 36px;border-radius:24px;font-size:1.1em;font-weight:700;box-shadow:0 2px 8px rgba(0,0,0,0.08);cursor:pointer;margin-right:18px;">Open Live Account</button>
            <button id="heroDemoBtn" style="background:#fff;color:#158173;border:none;padding:14px 36px;border-radius:24px;font-size:1.1em;font-weight:700;box-shadow:0 2px 8px rgba(0,0,0,0.08);cursor:pointer;">Try Demo</button>
        </div>
    `;
    main.parentNode.insertBefore(hero, main);

    // Features grid
    const features = document.createElement('section');
    features.style.display = 'flex';
    features.style.flexWrap = 'wrap';
    features.style.justifyContent = 'center';
    features.style.gap = '32px';
    features.style.margin = '36px 0 24px 0';
    features.innerHTML = `
        <div style="flex:1;min-width:220px;max-width:320px;background:#fff;padding:24px 18px;border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,0.04);text-align:center;">
            <svg width="36" height="36" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="#158173" stroke-width="2"/><path d="M8 12l2 2 4-4" stroke="#3949ab" stroke-width="2"/></svg>
            <div style="font-weight:700;font-size:1.1em;margin-top:10px;">Secure & Regulated</div>
            <div style="font-size:0.98em;color:#555;margin-top:6px;">Your funds and data are protected with industry-leading security.</div>
        </div>
        <div style="flex:1;min-width:220px;max-width:320px;background:#fff;padding:24px 18px;border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,0.04);text-align:center;">
            <svg width="36" height="36" fill="none" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="10" rx="2" stroke="#3949ab" stroke-width="2"/><path d="M7 7V5a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2" stroke="#158173" stroke-width="2"/></svg>
            <div style="font-weight:700;font-size:1.1em;margin-top:10px;">Fast Deposits & Withdrawals</div>
            <div style="font-size:0.98em;color:#555;margin-top:6px;">Enjoy instant funding and quick payouts via bank, mobile money, or crypto.</div>
        </div>
        <div style="flex:1;min-width:220px;max-width:320px;background:#fff;padding:24px 18px;border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,0.04);text-align:center;">
            <svg width="36" height="36" fill="none" viewBox="0 0 24 24"><path d="M12 2l7 4v6c0 5.25-3.5 10-7 10s-7-4.75-7-10V6l7-4z" stroke="#3949ab" stroke-width="2"/><path d="M9 12l2 2 4-4" stroke="#158173" stroke-width="2"/></svg>
            <div style="font-weight:700;font-size:1.1em;margin-top:10px;">24/7 Trading & Support</div>
            <div style="font-size:0.98em;color:#555;margin-top:6px;">Trade anytime, anywhere. Our team is always here to help you succeed.</div>
        </div>
    `;
    main.parentNode.insertBefore(features, main);

    // Testimonials
    const testimonials = document.createElement('section');
    testimonials.style.background = '#f4f7fa';
    testimonials.style.borderRadius = '10px';
    testimonials.style.padding = '28px 18px 18px 18px';
    testimonials.style.margin = '0 0 32px 0';
    testimonials.innerHTML = `
        <div style="font-size:1.15em;font-weight:700;color:#3949ab;text-align:center;margin-bottom:18px;">What our clients say</div>
        <div style="display:flex;flex-wrap:wrap;gap:24px;justify-content:center;">
            <div style="flex:1;min-width:220px;max-width:340px;background:#fff;padding:18px 14px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
                <div style="font-size:1.05em;color:#158173;font-weight:600;">"Super fast withdrawals and friendly support!"</div>
                <div style="margin-top:8px;font-size:0.97em;color:#555;">— Sarah K., Uganda</div>
            </div>
            <div style="flex:1;min-width:220px;max-width:340px;background:#fff;padding:18px 14px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
                <div style="font-size:1.05em;color:#3949ab;font-weight:600;">"Best platform for trading synthetics and forex."</div>
                <div style="margin-top:8px;font-size:0.97em;color:#555;">— Daniel M., Kenya</div>
            </div>
            <div style="flex:1;min-width:220px;max-width:340px;background:#fff;padding:18px 14px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
                <div style="font-size:1.05em;color:#e53935;font-weight:600;">"Easy to use and great mobile experience."</div>
                <div style="margin-top:8px;font-size:0.97em;color:#555;">— Grace T., Tanzania</div>
            </div>
        </div>
    `;
    main.parentNode.insertBefore(testimonials, main);

    // Hero buttons logic
    document.getElementById('heroOpenAccountBtn').onclick = function () {
        // Open Live Account modal
        if (typeof origCreateHeaderModal === 'function') {
            origCreateHeaderModal({
                id: 'openLiveAccountModal',
                title: 'Open Live Account',
                content: `
                    <form id="openLiveAccountForm">
                        <label style="display:block;margin-bottom:8px;font-weight:500;">Account Type:</label>
                        <select id="liveAccType" required style="margin-bottom:12px;width:100%;padding:8px;">
                            <option value="">Select Type</option>
                            <option value="Standard">Standard</option>
                            <option value="Pro">Pro</option>
                            <option value="Raw Spread">Raw Spread</option>
                        </select>
                        <label style="display:block;margin-bottom:8px;font-weight:500;">Currency:</label>
                        <select id="liveAccCurrency" required style="margin-bottom:12px;width:100%;padding:8px;">
                            <option value="">Select Currency</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="UGX">UGX</option>
                        </select>
                        <label style="display:block;margin-bottom:8px;font-weight:500;">Password (for MetaTrader 5):</label>
                        <input type="password" id="liveAccPassword" required minlength="6" style="margin-bottom:18px;width:100%;padding:8px;" placeholder="Create a password">
                        <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;font-size:1em;">Generate Account</button>
                    </form>
                    <div id="liveAccResult" style="margin-top:18px;color:#3949ab;font-weight:500;display:none;"></div>
                `
            });
            setTimeout(() => {
                document.getElementById('openLiveAccountForm').onsubmit = function(ev) {
                    ev.preventDefault();
                    const type = document.getElementById('liveAccType').value;
                    const currency = document.getElementById('liveAccCurrency').value;
                    const password = document.getElementById('liveAccPassword').value;
                    const accNum = 'MT5' + Math.floor(100000 + Math.random() * 900000);
                    const server = 'BlueTraders-MT5-Live';
                    const result = document.getElementById('liveAccResult');
                    result.style.display = 'block';
                    result.innerHTML = `
                        <div style="background:#f4f7fa;padding:16px 12px;border-radius:6px;margin-bottom:10px;">
                            <b>Your MetaTrader 5 Account has been created!</b><br>
                            <span style="color:#e53935;">Please copy and save these credentials to access MetaTrader 5:</span>
                            <ul style="margin:10px 0 0 18px;">
                                <li><b>Account Number:</b> <span style="color:#3949ab;">${accNum}</span></li>
                                <li><b>Account Type:</b> ${type}</li>
                                <li><b>Currency:</b> ${currency}</li>
                                <li><b>Password:</b> <span style="color:#3949ab;">${password}</span></li>
                                <li><b>Server:</b> ${server}</li>
                            </ul>
                        </div>
                        <button id="copyLiveAccBtn" style="background:#3949ab;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;margin-top:6px;">Copy Credentials</button>
                    `;
                    document.getElementById('copyLiveAccBtn').onclick = function() {
                        const text = `Account Number: ${accNum}\nAccount Type: ${type}\nCurrency: ${currency}\nPassword: ${password}\nServer: ${server}`;
                        navigator.clipboard.writeText(text).then(() => {
                            document.getElementById('copyLiveAccBtn').textContent = 'Copied!';
                        });
                    };
                };
            }, 100);
        }
    };
    document.getElementById('heroDemoBtn').onclick = function () {
        alert('Redirecting to Demo Account registration...');
    };
})();

/**
 * Add a menu drawer toggle for the Market Watch panel (show/hide).
 */
(function addMarketWatchDrawer() {
    // Create drawer toggle button
    const drawerBtn = document.createElement('button');
    drawerBtn.id = 'marketWatchDrawerBtn';
    drawerBtn.title = 'Show/Hide Market Watch';
    drawerBtn.style.position = 'fixed';
    drawerBtn.style.top = '120px';
    drawerBtn.style.right = '0';
    drawerBtn.style.width = '44px';
    drawerBtn.style.height = '44px';
    drawerBtn.style.background = '#158173';
    drawerBtn.style.color = '#fff';
    drawerBtn.style.border = 'none';
    drawerBtn.style.borderRadius = '12px 0 0 12px';
    drawerBtn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.12)';
    drawerBtn.style.cursor = 'pointer';
    drawerBtn.style.zIndex = '1300';
    drawerBtn.style.display = 'flex';
    drawerBtn.style.alignItems = 'center';
    drawerBtn.style.justifyContent = 'center';
    drawerBtn.style.fontSize = '1.6em';
    drawerBtn.innerHTML = `<svg width="28" height="28" fill="none" viewBox="0 0 24 24"><path d="M9 6l6 6-6 6" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

    document.body.appendChild(drawerBtn);

    // Drawer logic
    function setDrawerState(open) {
        const panel = document.getElementById('marketWatchPanel');
        if (!panel) return;
        if (open) {
            panel.style.transform = 'translateX(0)';
            drawerBtn.innerHTML = `<svg width="28" height="28" fill="none" viewBox="0 0 24 24"><path d="M15 6l-6 6 6 6" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
        } else {
            panel.style.transform = 'translateX(100%)';
            drawerBtn.innerHTML = `<svg width="28" height="28" fill="none" viewBox="0 0 24 24"><path d="M9 6l6 6-6 6" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
        }
        localStorage.setItem('marketWatchOpen', open ? '1' : '0');
    }

    // Initial state
    const panel = document.getElementById('marketWatchPanel');
    if (panel) {
        panel.style.transition = 'transform 0.3s cubic-bezier(.4,0,.2,1)';
        panel.style.willChange = 'transform';
        const open = localStorage.getItem('marketWatchOpen') !== '0';
        setDrawerState(open);
    }

    // Toggle on button click
    drawerBtn.onclick = function () {
        const panel = document.getElementById('marketWatchPanel');
        if (!panel) return;
        const isOpen = panel.style.transform !== 'translateX(100%)';
        setDrawerState(!isOpen);
    };

    // Responsive: hide drawer button if panel hidden by media query
    function updateDrawerBtnVisibility() {
        const panel = document.getElementById('marketWatchPanel');
        if (!panel) return;
        const style = window.getComputedStyle(panel);
        drawerBtn.style.display = style.display === 'none' ? 'none' : '';
    }
    window.addEventListener('resize', updateDrawerBtnVisibility);
    document.addEventListener('DOMContentLoaded', updateDrawerBtnVisibility);
    setTimeout(updateDrawerBtnVisibility, 300);
})();


/**
 * Add a search toggle to the Market Watch panel for searching symbols.
 */
(function addMarketWatchSearch() {
    const panel = document.getElementById('marketWatchPanel');
    if (!panel) return;

    // Create search toggle button
    const searchToggle = document.createElement('button');
    searchToggle.id = 'marketWatchSearchToggle';
    searchToggle.title = 'Search Market Symbols';
    searchToggle.style.background = '#3949ab';
    searchToggle.style.color = '#fff';
    searchToggle.style.border = 'none';
    searchToggle.style.borderRadius = '8px';
    searchToggle.style.padding = '6px 12px';
    searchToggle.style.fontWeight = '600';
    searchToggle.style.fontSize = '1em';
    searchToggle.style.cursor = 'pointer';
    searchToggle.style.marginBottom = '10px';
    searchToggle.style.display = 'flex';
    searchToggle.style.alignItems = 'center';
    searchToggle.style.gap = '6px';
    searchToggle.innerHTML = `<svg width="18" height="18" fill="none" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7" stroke="#fff" stroke-width="2"/><path d="M20 20l-3-3" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg> Search`;

    // Create search input (hidden by default)
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.id = 'marketWatchSearchInput';
    searchInput.placeholder = 'Search symbol (e.g. EUR/USD, VIX75)...';
    searchInput.style.display = 'none';
    searchInput.style.width = '100%';
    searchInput.style.padding = '8px 10px';
    searchInput.style.marginBottom = '10px';
    searchInput.style.border = '1px solid #e0e0e0';
    searchInput.style.borderRadius = '6px';
    searchInput.style.fontSize = '1em';

    // Insert at top of panel
    panel.insertBefore(searchToggle, panel.firstChild.nextSibling);
    panel.insertBefore(searchInput, searchToggle.nextSibling);

    // Toggle search input
    searchToggle.onclick = function () {
        searchInput.style.display = searchInput.style.display === 'none' ? '' : 'none';
        if (searchInput.style.display !== 'none') {
            searchInput.focus();
        } else {
            // Reset filter when closed
            filterMarketWatch('');
        }
    };

    // Filter function
    function filterMarketWatch(query) {
        query = query.trim().toLowerCase();
        // Find all table rows in panel
        panel.querySelectorAll('tbody tr').forEach(row => {
            const symbolCell = row.querySelector('td');
            if (!symbolCell) return;
            const symbol = symbolCell.textContent.trim().toLowerCase();
            if (!query || symbol.includes(query)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Listen for input
    searchInput.addEventListener('input', function () {
        filterMarketWatch(searchInput.value);
    });
})();




/**
 * Responsive enhancements for mobile/tablet:
 * - Sidebar toggle overlays content on mobile/tablet.
 * - Market Watch panel is hidden on small screens.
 * - Add a floating menu toggle for sidebar on mobile/tablet.
 * - Adjust layouts for main sections, hero, features, testimonials, admin dashboard.
 */

// Responsive sidebar toggle for mobile/tablet
(function responsiveSidebar() {
    function isMobile() {
        return window.innerWidth <= 900;
    }
    // Show/hide sidebar overlay on mobile
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggleSidebar');
    let overlay = document.getElementById('sidebarOverlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'sidebarOverlay';
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100vw';
        overlay.style.height = '100vh';
        overlay.style.background = 'rgba(0,0,0,0.32)';
        overlay.style.zIndex = '999';
        overlay.style.display = 'none';
        overlay.onclick = function () {
            sidebar.classList.remove('hide');
            overlay.style.display = 'none';
        };
        document.body.appendChild(overlay);
    }
    function showSidebar() {
        sidebar.classList.add('hide');
        overlay.style.display = 'block';
    }
    function hideSidebar() {
        sidebar.classList.remove('hide');
        overlay.style.display = 'none';
    }
    // Toggle button logic
    toggleBtn.onclick = function () {
        if (sidebar.classList.contains('hide')) {
            hideSidebar();
        } else {
            showSidebar();
        }
    };
    // Hide sidebar when resizing to desktop
    window.addEventListener('resize', function () {
        if (!isMobile()) {
            hideSidebar();
        }
    });
    // Hide sidebar on nav link click (mobile)
    document.querySelectorAll('.sidebar ul li a').forEach(link => {
        link.addEventListener('click', function () {
            if (isMobile()) hideSidebar();
        });
    });
})();

// Floating menu toggle for sidebar (hamburger) on mobile/tablet
(function mobileMenuToggle() {
    function isMobile() {
        return window.innerWidth <= 900;
    }
    let menuBtn = document.getElementById('mobileMenuBtn');
    if (!menuBtn) {
        menuBtn = document.createElement('button');
        menuBtn.id = 'mobileMenuBtn';
        menuBtn.title = 'Menu';
        menuBtn.style.position = 'fixed';
        menuBtn.style.left = '18px';
        menuBtn.style.top = '18px';
        menuBtn.style.width = '48px';
        menuBtn.style.height = '48px';
        menuBtn.style.background = '#158173';
        menuBtn.style.color = '#fff';
        menuBtn.style.border = 'none';
        menuBtn.style.borderRadius = '12px';
        menuBtn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.12)';
        menuBtn.style.cursor = 'pointer';
        menuBtn.style.zIndex = '1201';
        menuBtn.style.display = 'none';
        menuBtn.innerHTML = `<svg width="32" height="32" fill="none" viewBox="0 0 24 24"><rect y="4" width="24" height="2" rx="1" fill="#fff"/><rect y="11" width="24" height="2" rx="1" fill="#fff"/><rect y="18" width="24" height="2" rx="1" fill="#fff"/></svg>`;
        document.body.appendChild(menuBtn);
    }
    function updateMenuBtn() {
        menuBtn.style.display = isMobile() ? '' : 'none';
    }
    menuBtn.onclick = function () {
        document.getElementById('toggleSidebar').click();
    };
    window.addEventListener('resize', updateMenuBtn);
    document.addEventListener('DOMContentLoaded', updateMenuBtn);
    setTimeout(updateMenuBtn, 200);
})();

// Responsive adjustments for main content and sections
(function responsiveMainLayout() {
    function applyResponsiveStyles() {
        // Main content padding
        const mainContent = document.querySelector('.main-content');
        if (mainContent) {
            if (window.innerWidth <= 900) {
                mainContent.style.marginLeft = '0';
                mainContent.style.padding = '12px 4vw';
            } else {
                mainContent.style.marginLeft = '220px';
                mainContent.style.padding = '32px 32px';
            }
        }
        // Hero section
        const hero = document.querySelector('section[style*="linear-gradient"]');
        if (hero) {
            hero.style.padding = window.innerWidth <= 600 ? '32px 8px 24px 8px' : '48px 24px 36px 24px';
            hero.style.fontSize = window.innerWidth <= 600 ? '1em' : '';
        }
        // Features grid
        const features = document.querySelectorAll('section');
        features.forEach(sec => {
            if (sec.style.display === 'flex') {
                sec.style.flexDirection = window.innerWidth <= 900 ? 'column' : 'row';
                sec.style.gap = window.innerWidth <= 600 ? '18px' : '32px';
            }
        });
        // Testimonials
        const testimonials = document.querySelector('section[style*="What our clients say"]');
        if (testimonials) {
            testimonials.style.padding = window.innerWidth <= 600 ? '18px 4px 10px 4px' : '28px 18px 18px 18px';
        }
        // Admin dashboard
        const adminDash = document.getElementById('adminDashboard');
        if (adminDash) {
            adminDash.style.marginLeft = window.innerWidth <= 900 ? '0' : '220px';
            adminDash.style.padding = window.innerWidth <= 600 ? '18px 4vw' : '32px 24px';
        }
    }
    window.addEventListener('resize', applyResponsiveStyles);
    document.addEventListener('DOMContentLoaded', applyResponsiveStyles);
    setTimeout(applyResponsiveStyles, 200);
})();

// Responsive CSS (media queries)
(function addResponsiveCss() {
    const style = document.createElement('style');
    style.textContent = `
        @media (max-width: 900px) {
            .sidebar {
                width: 220px;
                transform: translateX(-100%);
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 1202;
            }
            .sidebar.hide {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0 !important;
                padding: 12px 4vw !important;
            }
            header {
                padding: 0 12px !important;
            }
            #volatility-animations {
                flex-direction: column !important;
                gap: 18px !important;
                padding: 10px 0 10px 0 !important;
            }
            #marketWatchPanel, #marketWatchDrawerBtn {
                display: none !important;
            }
            #mobileMenuBtn {
                display: block !important;
            }
        }
        @media (max-width: 600px) {
            .main-content {
                padding: 8px 2vw !important;
            }
            section[style*="linear-gradient"] {
                padding: 32px 8px 24px 8px !important;
                font-size: 1em !important;
            }
            section[style*="display: flex"] {
                flex-direction: column !important;
                gap: 18px !important;
            }
            section[style*="What our clients say"] {
                padding: 18px 4px 10px 4px !important;
            }
            #themeColorShowcase {
                padding: 18px 4vw 12px 4vw !important;
            }
        }
    `;
    document.head.appendChild(style);
})();


/**
 * Add spacing between the logo/title and the account balance in the header.
 */
(function addHeaderSpacing() {
    const header = document.querySelector('header');
    if (!header) return;
    const logoContainer = header.querySelector('.logo-container');
    const nav = header.querySelector('nav');
    if (logoContainer && nav) {
        // Add margin-right to logo/title container
        logoContainer.style.marginRight = '36px';
        // Optionally, add margin-left to account balance for extra space
        const accountBalance = nav.querySelector('#accountBalance');
        if (accountBalance) {
            accountBalance.style.marginLeft = '36px';
        }
    }
})();



/**
 * Add metals to the Market Watch panel.
 */
(function addMetalsToMarketWatch() {
    // Metals data (demo, random prices)
    const metals = [
        { symbol: "XAU/USD", price: 2350.25 }, // Gold
        { symbol: "XAG/USD", price: 29.45 },   // Silver
        { symbol: "XPT/USD", price: 1020.10 }, // Platinum
        { symbol: "XPD/USD", price: 1350.80 }  // Palladium
    ];

    // Find the Market Watch panel
    const panel = document.getElementById('marketWatchPanel');
    if (!panel) return;

    // Helper to render metals group
    function renderMetalsGroup() {
        return `
            <div style="margin-bottom:8px;">
                <div style="font-weight:700;font-size:1.08em;color:#b8860b;margin-bottom:6px;">Metals</div>
                <table style="width:100%;border-collapse:collapse;">
                    <thead>
                        <tr style="background:#f4f7fa;">
                            <th style="padding:6px 4px;font-size:0.98em;text-align:left;">Symbol</th>
                            <th style="padding:6px 4px;font-size:0.98em;text-align:right;">Price</th>
                            <th colspan="2" style="padding:6px 4px;text-align:center;">Trade</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${metals.map((item, i) => `
                            <tr>
                                <td style="padding:6px 4px;font-weight:600;color:#b8860b;">${item.symbol}</td>
                                <td style="padding:6px 4px;text-align:right;" id="Metals-price-${i}">${item.price}</td>
                                <td style="padding:6px 2px;">
                                    <button class="marketBuyBtn" data-symbol="${item.symbol}" style="background:#158173;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:0.97em;">Buy</button>
                                </td>
                                <td style="padding:6px 2px;">
                                    <button class="marketSellBtn" data-symbol="${item.symbol}" style="background:#e53935;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:0.97em;">Sell</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    // Insert metals group before or after synthetics
    const syntheticsHeader = Array.from(panel.querySelectorAll('div')).find(div =>
        div.textContent && div.textContent.includes('Synthetics')
    );
    if (syntheticsHeader) {
        syntheticsHeader.insertAdjacentHTML('afterend', renderMetalsGroup());
    } else {
        // If not found, append at end
        panel.insertAdjacentHTML('beforeend', renderMetalsGroup());
    }

    // Animate metals prices (random walk)
    function animateMetalsPrices() {
        setInterval(() => {
            metals.forEach((item, i) => {
                let step;
                if (item.symbol === "XAU/USD") step = (Math.random() - 0.5) * 2;
                else if (item.symbol === "XAG/USD") step = (Math.random() - 0.5) * 0.1;
                else step = (Math.random() - 0.5) * 1.5;
                item.price = Math.max(0, Math.round((item.price + step) * 100) / 100);
                const el = document.getElementById(`Metals-price-${i}`);
                if (el) el.textContent = item.price;
            });
        }, 2200);
    }
    animateMetalsPrices();
})();

/**
 * Add a password input box for admin when switching to admin dashboard.
 * The prompt is replaced with a modal that hides the password.
 */
(function adminSwitchPasswordBox() {
    const switchBtn = document.getElementById('dashboardSwitchBtn');
    if (!switchBtn || switchBtn.dataset.pwbox) return;
    switchBtn.dataset.pwbox = '1';

    // Helper to show password modal
    function showPasswordModal(onSubmit) {
        let modal = document.getElementById('adminSwitchPwModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'adminSwitchPwModal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.background = 'rgba(0,0,0,0.32)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '5000';
            modal.innerHTML = `
                <div style="background:#fff;padding:32px 24px;border-radius:10px;max-width:340px;width:100%;box-shadow:0 4px 24px rgba(0,0,0,0.14);position:relative;">
                    <button id="closeAdminSwitchPwModalBtn" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#3949ab;">&times;</button>
                    <h2 style="margin-top:0;color:#158173;font-size:1.1em;">Admin Password</h2>
                    <form id="adminSwitchPwForm">
                        <label style="display:block;margin-bottom:8px;font-weight:500;">Enter admin password:</label>
                        <input type="password" id="adminSwitchPwInput" required minlength="4" style="margin-bottom:16px;width:100%;padding:8px;">
                        <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;font-size:1em;">Switch to Admin</button>
                    </form>
                    <div id="adminSwitchPwStatus" style="margin-top:14px;color:#e53935;font-weight:500;display:none;"></div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('#closeAdminSwitchPwModalBtn').onclick = () => {
                modal.style.display = 'none';
            };
        }
        modal.style.display = 'flex';
        const form = modal.querySelector('#adminSwitchPwForm');
        const input = modal.querySelector('#adminSwitchPwInput');
        const status = modal.querySelector('#adminSwitchPwStatus');
        status.style.display = 'none';
        input.value = '';
        input.focus();
        form.onsubmit = function(ev) {
            ev.preventDefault();
            onSubmit(input.value, status, modal);
        };
    }

    switchBtn.onclick = function () {
        const isAdmin = localStorage.getItem('isAdmin') === '1';
        if (!isAdmin) {
            showPasswordModal(function(pw, status, modal) {
                if (pw === 'admin123' || pw === '25633') {
                    localStorage.setItem('isAdmin', '1');
                    switchBtn.textContent = 'Switch to User';
                    document.body.classList.add('admin-mode');
                    const adminDash = document.getElementById('adminDashboard');
                    if (adminDash) adminDash.style.display = 'block';
                    const mainContent = document.querySelector('.main-content');
                    if (mainContent) mainContent.style.display = 'none';
                    showAdminDashboard();
                    modal.style.display = 'none';
                } else {
                    status.style.display = 'block';
                    status.textContent = 'Incorrect password.';
                }
            });
        } else {
            localStorage.setItem('isAdmin', '0');
            switchBtn.textContent = 'Switch to Admin';
            document.body.classList.remove('admin-mode');
            const adminDash = document.getElementById('adminDashboard');
            if (adminDash) adminDash.style.display = 'none';
            const mainContent = document.querySelector('.main-content');
            if (mainContent) mainContent.style.display = '';
        }
    };
})();




/**
 * Add a "Main Account" row in the admin dashboard to display total volume in the system.
 * The main account is shown at the top of the "All Accounts" table.
 */
(function addMainAccountRowToAdminDashboard() {
    // Helper to calculate total volume (sum of balances)
    function getTotalVolume(accounts) {
        let total = 0;
        accounts.forEach(acc => {
            // Extract numeric value from balance string (e.g., "$5,000.00")
            const match = acc.balance && acc.balance.match(/[\d,]+\.\d{2}/);
            if (match) {
                total += parseFloat(match[0].replace(/,/g, ""));
            }
        });
        return total;
    }

    // Patch the "View All Accounts" button logic
    document.addEventListener('click', function () {
        setTimeout(() => {
            const content = document.getElementById('adminDashContent');
            if (!content) return;
            const table = content.querySelector('table');
            if (!table || table.dataset.mainAccount) return;
            if (!content.querySelector('h4') || !/All Accounts/i.test(content.querySelector('h4').textContent)) return;
            table.dataset.mainAccount = '1';

            // Find accounts data from the table
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            let accounts = [];
            rows.forEach(row => {
                const tds = row.querySelectorAll('td');
                if (tds.length >= 5) {
                    accounts.push({
                        id: tds[0].textContent.trim(),
                        user: tds[1].textContent.trim(),
                        type: tds[2].textContent.trim(),
                        balance: tds[3].textContent.trim(),
                        status: tds[4].textContent.trim()
                    });
                }
            });

            // Calculate total volume
            const total = getTotalVolume(accounts);

            // Create main account row
            const mainRow = document.createElement('tr');
            mainRow.style.background = '#fffde7';
            mainRow.innerHTML = `
                <td style="padding:7px 6px;font-weight:700;color:#3949ab;">MAIN</td>
                <td style="padding:7px 6px;font-weight:700;color:#3949ab;">System Total</td>
                <td style="padding:7px 6px;">—</td>
                <td style="padding:7px 6px;font-weight:700;color:#158173;">$${total.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                <td style="padding:7px 6px;">—</td>
                <td style="padding:7px 6px;">—</td>
            `;
            // Insert as first row in tbody
            const tbody = table.querySelector('tbody');
            if (tbody) {
                tbody.insertBefore(mainRow, tbody.firstChild);
            }
        }, 120);
    });
})();

/**
 * If admin clicks Withdraw in admin dashboard, ask from which account (including user accounts).
 */
(function adminWithdrawAccountSelection() {
    document.addEventListener('click', function (e) {
        // Only patch if admin and Withdraw modal is open
        if (localStorage.getItem('isAdmin') === '1' && document.getElementById('withdrawModal') && document.getElementById('withdrawForm')) {
            const form = document.getElementById('withdrawForm');
            if (!form.dataset.adminWithdrawEnhanced) {
                form.dataset.adminWithdrawEnhanced = '1';
                // Fetch accounts from admin dashboard table if available, else use demo data
                let accounts = [];
                const adminDash = document.getElementById('adminDashboard');
                if (adminDash) {
                    const table = adminDash.querySelector('table');
                    if (table && table.querySelector('tbody')) {
                        accounts = Array.from(table.querySelectorAll('tbody tr')).map(row => {
                            const tds = row.querySelectorAll('td');
                            return {
                                id: tds[0]?.textContent.trim(),
                                user: tds[1]?.textContent.trim(),
                                type: tds[2]?.textContent.trim(),
                                balance: tds[3]?.textContent.trim()
                            };
                        }).filter(acc => acc.id && acc.user && acc.id !== 'MAIN');
                    }
                }
                // Fallback demo accounts if none found
                if (!accounts.length) {
                    accounts = [
                        { id: '123456', user: 'John Doe', type: 'Standard', balance: '$5,000.00' },
                        { id: '654321', user: 'Jane Smith', type: 'Pro', balance: '$1,200.00' }
                    ];
                }
                // Insert "From Account" select at top of form
                const label = document.createElement('label');
                label.style.display = 'block';
                label.style.marginBottom = '8px';
                label.style.fontWeight = '500';
                label.textContent = 'From Account:';
                const select = document.createElement('select');
                select.required = true;
                select.style.marginBottom = '14px';
                select.style.width = '100%';
                select.style.padding = '8px';
                select.innerHTML = `<option value="">Select Account</option>` +
                    accounts.map(acc =>
                        `<option value="${acc.id}">${acc.id} - ${acc.user} (${acc.type}) ${acc.balance ? '- ' + acc.balance : ''}</option>`
                    ).join('');
                form.insertBefore(label, form.firstChild);
                form.insertBefore(select, label.nextSibling);

                // Optionally, handle submit to show which account was chosen
                const origSubmit = form.onsubmit;
                form.onsubmit = function(ev) {
                    if (!select.value) {
                        alert('Please select an account to withdraw from.');
                        select.focus();
                        ev.preventDefault();
                        return false;
                    }
                    if (typeof origSubmit === 'function') return origSubmit.call(this, ev);
                };
            }
        }
    });
})();


/**
 * Ensure "MAIN" account is included in withdraw "From Account" select for admin.
 */
(function includeMainAccountForAdminWithdraw() {
    document.addEventListener('click', function () {
        if (
            localStorage.getItem('isAdmin') === '1' &&
            document.getElementById('withdrawModal') &&
            document.getElementById('withdrawForm')
        ) {
            const form = document.getElementById('withdrawForm');
            // Only patch if not already done
            if (!form.dataset.mainAccountPatched) {
                form.dataset.mainAccountPatched = '1';
                // Find the "From Account" select
                const selects = form.querySelectorAll('select');
                let fromAccountSelect = null;
                selects.forEach(sel => {
                    if (
                        Array.from(sel.options).some(
                            o => o.textContent && o.textContent.includes('Select Account')
                        )
                    ) {
                        fromAccountSelect = sel;
                    }
                });
                if (fromAccountSelect) {
                    // Check if MAIN already present
                    let hasMain = Array.from(fromAccountSelect.options).some(
                        o => o.value === 'MAIN'
                    );
                    if (!hasMain) {
                        // Insert MAIN as first option after "Select Account"
                        const mainOption = document.createElement('option');
                        mainOption.value = 'MAIN';
                        mainOption.textContent = 'MAIN - System Total';
                        fromAccountSelect.insertBefore(
                            mainOption,
                            fromAccountSelect.options.length > 1
                                ? fromAccountSelect.options[1]
                                : null
                        );
                    }
                }
            }
        }
    });
})();

/**
 * Allow users to trade all pairs in Market Watch with access to a live market chart.
 * When Buy/Sell is clicked, show a modal with a live chart for the selected symbol.
 */
(function enableMarketWatchLiveChart() {
    // Chart rendering using Canvas (simple random walk for demo)
    function renderLiveChart(container, symbol, color) {
        // Remove previous chart if any
        container.innerHTML = '';
        // Title
        const title = document.createElement('div');
        title.textContent = symbol + ' - Live Chart';
        title.style.fontWeight = '700';
        title.style.fontSize = '1.08em';
        title.style.color = color || '#3949ab';
        title.style.marginBottom = '8px';
        container.appendChild(title);

        // Canvas
        const canvas = document.createElement('canvas');
        canvas.width = 320;
        canvas.height = 120;
        canvas.style.display = 'block';
        canvas.style.background = '#fff';
        canvas.style.borderRadius = '8px';
        canvas.style.boxShadow = '0 1px 4px rgba(0,0,0,0.06)';
        container.appendChild(canvas);

        // Chart logic (random walk)
        const ctx = canvas.getContext('2d');
        let points = [];
        let y = canvas.height / 2;
        for (let i = 0; i < canvas.width; i++) {
            y += (Math.random() - 0.5) * 3;
            y = Math.max(18, Math.min(canvas.height - 18, y));
            points.push(y);
        }
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.moveTo(0, points[0]);
            for (let x = 1; x < points.length; x++) {
                ctx.lineTo(x, points[x]);
            }
            ctx.strokeStyle = color || '#3949ab';
            ctx.lineWidth = 2;
            ctx.stroke();
        }
        function animate() {
            points.shift();
            let last = points[points.length - 1];
            let delta = (Math.random() - 0.5) * 3;
            let next = last + delta;
            next = Math.max(18, Math.min(canvas.height - 18, next));
            points.push(next);
            draw();
            requestAnimationFrame(animate);
        }
        draw();
        animate();
    }

    // Patch Market Watch Buy/Sell logic to show chart
    document.body.addEventListener('click', function (e) {
        if (
            (e.target.classList.contains('marketBuyBtn') || e.target.classList.contains('marketSellBtn')) &&
            !e.target.dataset.chartEnhanced
        ) {
            e.target.dataset.chartEnhanced = '1';
            setTimeout(() => {
                let modal = document.getElementById('marketTradeModal');
                if (!modal) return;
                // Insert chart container if not present
                let chartDiv = modal.querySelector('#marketTradeChart');
                if (!chartDiv) {
                    chartDiv = document.createElement('div');
                    chartDiv.id = 'marketTradeChart';
                    chartDiv.style.margin = '18px 0 0 0';
                    modal.querySelector('form').insertAdjacentElement('afterend', chartDiv);
                }
                // Get symbol and color
                const symbol = modal.querySelector('#marketTradeTitle')?.textContent?.replace(/^(Buy|Sell)\s+/, '') || '';
                let color = '#3949ab';
                if (/forex/i.test(symbol)) color = '#158173';
                else if (/synthetics|vix|crash|boom/i.test(symbol)) color = '#e53935';
                else if (/gold|xau|xag|xpt|xpd|metal/i.test(symbol)) color = '#b8860b';
                renderLiveChart(chartDiv, symbol, color);
            }, 120);
        }
    });
})();



/**
 * Add a TradingView chart widget modal for any symbol.
 * When "View TradingView Chart" is called, show a modal with the TradingView widget.
 */
function showTradingViewChart(symbol = "EURUSD") {
    // Remove previous modal if any
    let modal = document.getElementById('tradingViewChartModal');
    if (modal) modal.remove();

    modal = document.createElement('div');
    modal.id = 'tradingViewChartModal';
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.width = '100vw';
    modal.style.height = '100vh';
    modal.style.background = 'rgba(0,0,0,0.32)';
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
    modal.style.zIndex = '6000';
    modal.innerHTML = `
        <div style="background:#fff;padding:0 0 24px 0;border-radius:12px;max-width:820px;width:98vw;box-shadow:0 4px 24px rgba(0,0,0,0.14);position:relative;">
            <button id="closeTradingViewChartModalBtn" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#3949ab;z-index:2;">&times;</button>
            <div style="padding:18px 24px 0 24px;">
                <h2 style="margin-top:0;color:#158173;font-size:1.1em;">TradingView Chart: ${symbol}</h2>
            </div>
            <div id="tradingview-widget-container" style="width:800px;max-width:96vw;">
                <div id="tradingview_chart"></div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    modal.querySelector('#closeTradingViewChartModalBtn').onclick = () => {
        modal.style.display = 'none';
    };

    // Load TradingView widget script if not present
    if (!window.TradingView) {
        const script = document.createElement('script');
        script.src = "https://s3.tradingview.com/tv.js";
        script.onload = () => renderTVWidget(symbol);
        document.head.appendChild(script);
    } else {
        renderTVWidget(symbol);
    }

    function renderTVWidget(sym) {
        // Remove previous widget if any
        document.getElementById('tradingview_chart').innerHTML = '';
        // Map symbol to TradingView format
        let tvSymbol = sym.replace('/', '').replace(' ', '').toUpperCase();
        // Common mappings
        if (tvSymbol === 'VIX75' || tvSymbol === 'V75') tvSymbol = 'DERIV:V75USD';
        else if (tvSymbol === 'VIX25' || tvSymbol === 'V25') tvSymbol = 'DERIV:V25USD';
        else if (tvSymbol === 'VIX1001S' || tvSymbol === 'V1001S') tvSymbol = 'DERIV:V1001SUSD';
        else if (tvSymbol === 'XAUUSD') tvSymbol = 'OANDA:XAUUSD';
        else if (tvSymbol === 'XAGUSD') tvSymbol = 'OANDA:XAGUSD';
        else if (/^[A-Z]{6,}$/.test(tvSymbol)) tvSymbol = 'OANDA:' + tvSymbol;
        // else leave as is

        new window.TradingView.widget({
            "width": "100%",
            "height": 420,
            "symbol": tvSymbol,
            "interval": "15",
            "timezone": "Etc/UTC",
            "theme": document.body.classList.contains('dark-mode') ? "dark" : "light",
            "style": "1",
            "locale": "en",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "hide_top_toolbar": false,
            "hide_legend": false,
            "container_id": "tradingview_chart"
        });
    }
}

// Add "TradingView Chart" button to Market Watch trade modal
document.body.addEventListener('click', function (e) {
    setTimeout(() => {
        const modal = document.getElementById('marketTradeModal');
        if (modal && !modal.querySelector('#viewTradingViewChartBtn')) {
            const title = modal.querySelector('#marketTradeTitle');
            if (!title) return;
            const symbol = title.textContent.replace(/^(Buy|Sell)\s+/, '').trim();
            const btn = document.createElement('button');
            btn.id = 'viewTradingViewChartBtn';
            btn.textContent = 'View TradingView Chart';
            btn.style.background = '#3949ab';
            btn.style.color = '#fff';
            btn.style.border = 'none';
            btn.style.padding = '8px 18px';
            btn.style.borderRadius = '4px';
            btn.style.cursor = 'pointer';
            btn.style.marginTop = '14px';
            btn.style.width = '100%';
            btn.onclick = function () {
                showTradingViewChart(symbol);
            };
            modal.appendChild(btn);
        }
    }, 120);
});

/**
 * Sync all Market Watch pairs with TradingView chart modal.
 * When a symbol row is clicked (not just Buy/Sell), open TradingView chart for that symbol.
 */
(function syncMarketWatchRowsWithTradingView() {
    document.body.addEventListener('click', function (e) {
        // Only act if clicking a Market Watch table row (not a button)
        const row = e.target.closest('#marketWatchPanel tbody tr');
        if (
            row &&
            !e.target.classList.contains('marketBuyBtn') &&
            !e.target.classList.contains('marketSellBtn') &&
            !e.target.closest('button')
        ) {
            // Get symbol from first cell
            const symbolCell = row.querySelector('td');
            if (symbolCell) {
                const symbol = symbolCell.textContent.trim();
                showTradingViewChart(symbol);
            }
        }
    });
    // Add pointer cursor to rows for UX
    setTimeout(() => {
        document.querySelectorAll('#marketWatchPanel tbody tr').forEach(row => {
            row.style.cursor = 'pointer';
        });
    }, 400);
})();

/**
 * Map index symbols to TradingView symbols for Market Watch sync.
 */
const indexSymbolMap = {
    "NASDAQ": "NASDAQ:NDX",
    "S&P 500": "SP:SPX",
    "US30": "CBOT_MINI:YM1!",
    "DAX": "XETR:DAX",
    "FTSE 100": "LSE:UKX"
};

// Patch syncMarketWatchRowsWithTradingView to support indices mapping
(function syncMarketWatchRowsWithTradingViewIndices() {
    document.body.addEventListener('click', function (e) {
        const row = e.target.closest('#marketWatchPanel tbody tr');
        if (
            row &&
            !e.target.classList.contains('marketBuyBtn') &&
            !e.target.classList.contains('marketSellBtn') &&
            !e.target.closest('button')
        ) {
            const symbolCell = row.querySelector('td');
            if (symbolCell) {
                let symbol = symbolCell.textContent.trim();
                // Map index symbols if needed
                if (indexSymbolMap[symbol]) {
                    showTradingViewChart(indexSymbolMap[symbol]);
                } else {
                    showTradingViewChart(symbol);
                }
            }
        }
    });
    setTimeout(() => {
        document.querySelectorAll('#marketWatchPanel tbody tr').forEach(row => {
            row.style.cursor = 'pointer';
        });
    }, 400);
})();

/**
 * Integrate TradingView-like charts using   for volatilities.
 * When a Synthetics/Volatility symbol is clicked in Market Watch, open a modal with an iframe to Deriv charts.
 * Add a "Wider View" button to open the chart in a new tab.
 */
(function enableDerivChartsForVolatilities() {
    // List of volatility/synthetics symbols to match
    const volSymbols = [
        "VIX75", "V75", "Volatility 75", "Volatility 75 Index",
        "VIX25", "V25", "Volatility 25", "Volatility 25 Index",
        "VIX1001S", "V1001S", "Volatility 1001s", "Volatility 1001s Index",
        "Crash 1000", "Crash 1000", "Crash 1000 index", 
         "Boom 1000", "Boom 1000", "Boom 1000","Boom 1000 Index",
         "Crash 500", "Crash 500", "Crash 500 Index",
         "Boom 500", "Boom 500", "Boom 500 Index",
    ];

    // Helper to check if symbol is a volatility/synthetics
    function isVolatilitySymbol(symbol) {
        symbol = symbol.toUpperCase();
        return volSymbols.some(v => symbol.includes(v.replace(/\s+/g, '').toUpperCase()));
    }

    // Helper to map symbol to Deriv chart symbol
    function toDerivChartSymbol(symbol) {
        // Map common names to Deriv chart symbols
        symbol = symbol.toUpperCase().replace(/\s+/g, '');
        if (symbol === "VIX75" || symbol === "V75" || symbol === "VOLATILITY75" || symbol === "VOLATILITY75INDEX") return "R_75";
        if (symbol === "VIX25" || symbol === "V25" || symbol === "VOLATILITY25" || symbol === "VOLATILITY25INDEX") return "R_25";
        if (symbol === "VIX1001S" || symbol === "V1001S" || symbol === "VOLATILITY1001S" || symbol === "VOLATILITY1001SINDEX") return "R_100_1HZ";
        if (symbol === "CRASH1000") return "CRASH_1000";
        if (symbol === "BOOM1000") return "BOOM_1000";
        if (symbol === "CRASH500") return "CRASH_500";
        if (symbol === "BOOM500") return "BOOM_500";
        // fallback: just return symbol
        return symbol;
    }

    // Show Deriv chart modal
    function showDerivChart(symbol) {
        // Remove previous modal if any
        let modal = document.getElementById('derivChartModal');
        if (modal) modal.remove();

        // Build Deriv chart URL
        const chartSymbol = toDerivChartSymbol(symbol);
        const chartUrl = `https://charts.deriv.com/deriv?lang=en&market=synthetic&symbol=${encodeURIComponent(chartSymbol)}`;

        modal = document.createElement('div');
        modal.id = 'derivChartModal';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100vw';
        modal.style.height = '100vh';
        modal.style.background = 'rgba(0,0,0,0.32)';
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.style.zIndex = '7000';
        modal.innerHTML = `
            <div style="background:#fff;padding:0 0 24px 0;border-radius:12px;max-width:900px;width:98vw;box-shadow:0 4px 24px rgba(0,0,0,0.14);position:relative;">
                <button id="closeDerivChartModalBtn" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#3949ab;z-index:2;">&times;</button>
                <div style="padding:18px 24px 0 24px;">
                    <h2 style="margin-top:0;color:#158173;font-size:1.1em;">Deriv Chart: ${symbol}</h2>
                </div>
                <div style="width:860px;max-width:96vw;height:480px;">
                    <iframe src="${chartUrl}" style="width:100%;height:100%;border:0;border-radius:8px;" allowfullscreen loading="lazy"></iframe>
                </div>
                <div style="padding:0 24px;">
                    <button id="openDerivWiderViewBtn" style="background:#3949ab;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;margin-top:14px;width:100%;">Wider View</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        modal.querySelector('#closeDerivChartModalBtn').onclick = () => {
            modal.style.display = 'none';
        };
        modal.querySelector('#openDerivWiderViewBtn').onclick = () => {
            window.open(chartUrl, '_blank');
        };
    }

    // Patch Market Watch row click for volatilities
    document.body.addEventListener('click', function (e) {
        const row = e.target.closest('#marketWatchPanel tbody tr');
        if (
            row &&
            !e.target.classList.contains('marketBuyBtn') &&
            !e.target.classList.contains('marketSellBtn') &&
            !e.target.closest('button')
        ) {
            const symbolCell = row.querySelector('td');
            if (symbolCell) {
                const symbol = symbolCell.textContent.trim();
                if (isVolatilitySymbol(symbol)) {
                    showDerivChart(symbol);
                }
            }
        }
    });

    // Also add "View Deriv Chart" button to Market Watch trade modal for volatilities
    document.body.addEventListener('click', function (e) {
        setTimeout(() => {
            const modal = document.getElementById('marketTradeModal');
            if (modal && !modal.querySelector('#viewDerivChartBtn')) {
                const title = modal.querySelector('#marketTradeTitle');
                if (!title) return;
                const symbol = title.textContent.replace(/^(Buy|Sell)\s+/, '').trim();
                if (isVolatilitySymbol(symbol)) {
                    const btn = document.createElement('button');
                    btn.id = 'viewDerivChartBtn';
                    btn.textContent = 'View Deriv Chart';
                    btn.style.background = '#158173';
                    btn.style.color = '#fff';
                    btn.style.border = 'none';
                    btn.style.padding = '8px 18px';
                    btn.style.borderRadius = '4px';
                    btn.style.cursor = 'pointer';
                    btn.style.marginTop = '10px';
                    btn.style.width = '100%';
                    btn.onclick = function () {
                        showDerivChart(symbol);
                    };
                    modal.appendChild(btn);
                }
            }
        }, 120);
    });
})();


/**
 * Navigate to Synthetics Dashboard and then to Deriv charts on "Trade Synthetics".
 */
(function enhanceSyntheticsNavigation() {
    // Patch the Synthetics Dashboard modal logic
    window.showSyntheticsDashboard = function () {
        // Remove any previous modal
        let modal = document.getElementById('syntheticsDashboardModal');
        if (modal) modal.remove();

        // Create modal
        origCreateHeaderModal({
            id: 'syntheticsDashboardModal',
            title: 'Synthetics (Volatilities) Dashboard',
            content: `
                <div style="display:flex;gap:24px;flex-wrap:wrap;">
                    <div style="flex:1;min-width:240px;background:#fff;padding:20px 18px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.06);">
                        <h3 style="margin-top:0;color:#3949ab;">Popular Synthetics</h3>
                        <ul style="padding-left:18px;margin-bottom:12px;">
                            <li><b>Volatility 75 Index</b> <span style="color:#158173;">(V75)</span></li>
                            <li><b>Volatility 100 Index</b> <span style="color:#158173;">(V100)</span></li>
                            <li><b>Volatility 50 Index</b> <span style="color:#158173;">(V50)</span></li>
                            <li><b>Crash 1000 / Boom 1000</b></li>
                            <li><b>Crash 500 / Boom 500</b></li>
                        </ul>
                        <button id="tradeSyntheticsBtn" style="background:#158173;color:#fff;border:none;padding:8px 20px;border-radius:4px;cursor:pointer;">Trade Synthetics</button>
                    </div>
                    <div style="flex:1;min-width:240px;background:#f4f7fa;padding:20px 18px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.03);">
                        <h3 style="margin-top:0;color:#158173;">Features</h3>
                        <ul style="padding-left:18px;">
                            <li>Available 24/7</li>
                            <li>Consistent volatility</li>
                            <li>No market gaps</li>
                            <li>Demo & Live trading</li>
                            <li>Fast execution</li>
                        </ul>
                    </div>
                </div>
                <div style="margin-top:24px;">
                    <h4 style="color:#3949ab;margin-bottom:8px;">Recent Synthetics Trades</h4>
                    <table style="width:100%;border-collapse:collapse;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
                        <thead>
                            <tr style="background:#f4f7fa;">
                                <th style="padding:8px 6px;border-bottom:1px solid #e0e0e0;">Asset</th>
                                <th style="padding:8px 6px;border-bottom:1px solid #e0e0e0;">Type</th>
                                <th style="padding:8px 6px;border-bottom:1px solid #e0e0e0;">Amount</th>
                                <th style="padding:8px 6px;border-bottom:1px solid #e0e0e0;">Result</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding:7px 6px;">Volatility 75</td>
                                <td style="padding:7px 6px;">Buy</td>
                                <td style="padding:7px 6px;">$10.00</td>
                                <td style="padding:7px 6px;color:#158173;">+$7.50</td>
                            </tr>
                            <tr>
                                <td style="padding:7px 6px;">Crash 1000</td>
                                <td style="padding:7px 6px;">Sell</td>
                                <td style="padding:7px 6px;">$5.00</td>
                                <td style="padding:7px 6px;color:#e53935;">-$2.00</td>
                            </tr>
                            <tr>
                                <td style="padding:7px 6px;">Boom 500</td>
                                <td style="padding:7px 6px;">Buy</td>
                                <td style="padding:7px 6px;">$8.00</td>
                                <td style="padding:7px 6px;color:#158173;">+$3.20</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `
        });

        setTimeout(() => {
            const btn = document.getElementById('tradeSyntheticsBtn');
            if (btn) {
                btn.onclick = function () {
                    window.location.href = "https://charts.deriv.com/deriv";
                };
            }
        }, 100);
    };

    // Patch Markets modal "Go to Synthetics Dashboard" button
    document.addEventListener('click', function () {
        setTimeout(() => {
            const btn = document.getElementById('syntheticsDashboardBtn');
            if (btn && !btn.dataset.navigated) {
                btn.dataset.navigated = '1';
                btn.onclick = function () {
                    // Close Markets modal
                    const modal = document.getElementById('marketsModal');
                    if (modal) modal.style.display = 'none';
                    // Open Synthetics Dashboard modal
                    window.showSyntheticsDashboard();
                };
            }
        }, 120);
    });
})();

/**
 * Enhance "See all markets" link to show a full markets modal with more features.
 */
(function enhanceSeeAllMarkets() {
    document.body.addEventListener('click', function (e) {
        // Delegate for all "See all markets" links
        if (
            e.target.tagName === 'A' &&
            /see all markets/i.test(e.target.textContent)
        ) {
            e.preventDefault();
            // Show a modal with all market categories and features
            let modal = document.getElementById('allMarketsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'allMarketsModal';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100vw';
                modal.style.height = '100vh';
                modal.style.background = 'rgba(0,0,0,0.32)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '5000';
                modal.innerHTML = `
                    <div style="background:#fff;padding:32px 24px 24px 24px;border-radius:12px;max-width:900px;width:98vw;box-shadow:0 4px 24px rgba(0,0,0,0.14);position:relative;overflow-y:auto;max-height:90vh;">
                        <button id="closeAllMarketsModalBtn" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#3949ab;">&times;</button>
                        <h2 style="margin-top:0;color:#158173;font-size:1.3em;">All Markets</h2>
                        <div style="display:flex;flex-wrap:wrap;gap:32px;">
                            <div style="flex:1;min-width:220px;">
                                <h3 style="color:#158173;">Forex</h3>
                                <ul style="padding-left:18px;">
                                    <li>Major, minor, and exotic pairs</li>
                                    <li>24/5 trading</li>
                                    <li>Low spreads, high leverage</li>
                                    <li>Popular pairs: EUR/USD, GBP/USD, USD/JPY</li>
                                </ul>
                                <button class="marketQuickTradeBtn" data-market="Forex" style="background:#158173;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;margin-top:8px;">Trade Forex</button>
                            </div>
                            <div style="flex:1;min-width:220px;">
                                <h3 style="color:#3949ab;">Indices</h3>
                                <ul style="padding-left:18px;">
                                    <li>Global stock indices</li>
                                    <li>US30, NASDAQ, S&P 500, DAX, FTSE 100</li>
                                    <li>Competitive margin requirements</li>
                                </ul>
                                <button class="marketQuickTradeBtn" data-market="Indices" style="background:#3949ab;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;margin-top:8px;">Trade Indices</button>
                            </div>
                            <div style="flex:1;min-width:220px;">
                                <h3 style="color:#e53935;">Synthetics</h3>
                                <ul style="padding-left:18px;">
                                    <li>Volatility indices (V75, V25, V1001s, etc.)</li>
                                    <li>Crash/Boom, Step Index</li>
                                    <li>Available 24/7</li>
                                    <li>Consistent volatility, no gaps</li>
                                </ul>
                                <button class="marketQuickTradeBtn" data-market="Synthetics" style="background:#e53935;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;margin-top:8px;">Trade Synthetics</button>
                            </div>
                        </div>
                        <div style="display:flex;flex-wrap:wrap;gap:32px;margin-top:28px;">
                            <div style="flex:1;min-width:220px;">
                                <h3 style="color:#b8860b;">Metals</h3>
                                <ul style="padding-left:18px;">
                                    <li>Gold (XAU/USD), Silver (XAG/USD)</li>
                                    <li>Platinum, Palladium</li>
                                    <li>Safe haven assets</li>
                                </ul>
                                <button class="marketQuickTradeBtn" data-market="Metals" style="background:#b8860b;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;margin-top:8px;">Trade Metals</button>
                            </div>
                            <div style="flex:1;min-width:220px;">
                                <h3 style="color:#158173;">Commodities</h3>
                                <ul style="padding-left:18px;">
                                    <li>Oil, Natural Gas</li>
                                    <li>Coffee, Cocoa, Corn</li>
                                    <li>Diversify your portfolio</li>
                                </ul>
                                <button class="marketQuickTradeBtn" data-market="Commodities" style="background:#158173;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;margin-top:8px;">Trade Commodities</button>
                            </div>
                            <div style="flex:1;min-width:220px;">
                                <h3 style="color:#3949ab;">Cryptocurrencies</h3>
                                <ul style="padding-left:18px;">
                                    <li>Bitcoin, Ethereum, Litecoin</li>
                                    <li>24/7 trading</li>
                                    <li>High volatility, tight spreads</li>
                                </ul>
                                <button class="marketQuickTradeBtn" data-market="Crypto" style="background:#3949ab;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;margin-top:8px;">Trade Crypto</button>
                            </div>
                        </div>
                        <div style="margin-top:32px;">
                            <h3 style="color:#158173;">Why Trade with Us?</h3>
                            <ul style="padding-left:18px;">
                                <li>Ultra-fast execution and low latency</li>
                                <li>Advanced charting tools (TradingView, Deriv charts)</li>
                                <li>Demo & live accounts, instant deposits/withdrawals</li>
                                <li>24/7 support and education resources</li>
                                <li>Mobile, tablet, and desktop access</li>
                            </ul>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.querySelector('#closeAllMarketsModalBtn').onclick = () => {
                    modal.style.display = 'none';
                };
            } else {
                modal.style.display = 'flex';
            }

            // Quick trade buttons: open Market Watch and scroll to group
            setTimeout(() => {
                modal.querySelectorAll('.marketQuickTradeBtn').forEach(btn => {
                    btn.onclick = function () {
                        modal.style.display = 'none';
                        // Open Market Watch panel if hidden
                        const panel = document.getElementById('marketWatchPanel');
                        if (panel && panel.style.transform === 'translateX(100%)') {
                            const drawerBtn = document.getElementById('marketWatchDrawerBtn');
                            if (drawerBtn) drawerBtn.click();
                        }
                        // Scroll to group in Market Watch
                        setTimeout(() => {
                            let color = '#158173';
                            let group = '';
                            switch (btn.dataset.market) {
                                case 'Forex': group = 'Forex'; color = '#158173'; break;
                                case 'Indices': group = 'Indices'; color = '#3949ab'; break;
                                case 'Synthetics': group = 'Synthetics'; color = '#e53935'; break;
                                case 'Metals': group = 'Metals'; color = '#b8860b'; break;
                                case 'Commodities': group = 'Commodities'; color = '#158173'; break;
                                case 'Crypto': group = 'Cryptocurrencies'; color = '#3949ab'; break;
                            }
                            // Find group header in Market Watch
                            const panel = document.getElementById('marketWatchPanel');
                            if (panel) {
                                const headers = Array.from(panel.querySelectorAll('div')).filter(div =>
                                    div.textContent && div.textContent.includes(group)
                                );
                                if (headers.length) {
                                    headers[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    // Optionally, highlight
                                    headers[0].style.boxShadow = `0 0 0 3px ${color}55`;
                                    setTimeout(() => { headers[0].style.boxShadow = ''; }, 1200);
                                }
                            }
                        }, 300);
                    };
                });
            }, 120);
        }
    });
})();

/**
 * Show anti-money laundering message below Deposit and Withdraw forms.
 */
(function addAMLMessage() {
    function insertAML(form) {
        if (!form || form.querySelector('.aml-message')) return;
        const msg = document.createElement('div');
        msg.className = 'aml-message';
        msg.style.marginTop = '12px';
        msg.style.background = '#0d6b6e';
        msg.style.color = '#e53935';
        msg.style.border = '1.5px solid #e53935';
        msg.style.fontWeight = '600';
        msg.style.fontSize = '0.98em';
        msg.style.padding = '10px 12px';
        msg.style.borderRadius = '6px';
        msg.style.boxShadow = '0 1px 4px rgba(0,0,0,0.04)';
        msg.innerHTML = '⚠️ <b>Anti-Money Laundering Notice:</b> All deposits and withdrawals are monitored and must comply with AML regulations. Please use only accounts in your name. Suspicious transactions may be reported and/or blocked.';
        form.appendChild(msg);
    }
    document.addEventListener('click', function () {
        setTimeout(() => {
            const depositForm = document.getElementById('depositForm');
            if (depositForm) insertAML(depositForm);
            const withdrawForm = document.getElementById('withdrawForm');
            if (withdrawForm) insertAML(withdrawForm);
        }, 120);
    });
    document.addEventListener('DOMContentLoaded', function () {
        setTimeout(() => {
            const depositForm = document.getElementById('depositForm');
            if (depositForm) insertAML(depositForm);
            const withdrawForm = document.getElementById('withdrawForm');
            if (withdrawForm) insertAML(withdrawForm);
        }, 120);
    });
})();

/**
 * Add an Investment Plan section to the home page.
 * Shows plan options, features, and a "Start Investing" button.
 */
(function addInvestmentPlanSection() {
    const main = document.querySelector('main');
    if (!main) return;

    // Create investment plan section
    const section = document.createElement('section');
    section.id = 'investmentPlanSection';
    section.style.background = '#fff';
    section.style.borderRadius = '12px';
    section.style.boxShadow = '0 2px 12px rgba(0,0,0,0.06)';
    section.style.padding = '32px 18px 24px 18px';
    section.style.margin = '0 0 32px 0';
    section.style.maxWidth = '900px';
    section.style.marginLeft = 'auto';
    section.style.marginRight = 'auto';

    section.innerHTML = `
        <h2 style="color:#158173;font-size:1.5em;font-weight:800;margin-top:0;margin-bottom:10px;text-align:center;">
            Investment Plans
        </h2>
        <p style="text-align:center;font-size:1.08em;color:#3949ab;margin-bottom:24px;">
            Grow your wealth with our flexible investment plans. Choose a plan, invest, and watch your money work for you!
        </p>
        <div style="display:flex;flex-wrap:wrap;gap:28px;justify-content:center;">
            <div style="flex:1;min-width:220px;max-width:280px;background:#f4f7fa;padding:22px 16px;border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,0.04);text-align:center;">
                <div style="font-weight:700;font-size:1.1em;color:#3949ab;margin-bottom:6px;">Starter Plan</div>
                <div style="font-size:2em;font-weight:800;color:#158173;margin-bottom:8px;">$100+</div>
                <ul style="padding-left:18px;text-align:left;font-size:0.98em;color:#555;margin-bottom:10px;">
                    <li>Duration: 1 month</li>
                    <li>Expected Return: <b>5%</b></li>
                    <li>Low risk</li>
                </ul>
            </div>
            <div style="flex:1;min-width:220px;max-width:280px;background:#fffde7;padding:22px 16px;border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,0.04);text-align:center;">
                <div style="font-weight:700;font-size:1.1em;color:#e53935;margin-bottom:6px;">Growth Plan</div>
                <div style="font-size:2em;font-weight:800;color:#e53935;margin-bottom:8px;">$500+</div>
                <ul style="padding-left:18px;text-align:left;font-size:0.98em;color:#555;margin-bottom:10px;">
                    <li>Duration: 3 months</li>
                    <li>Expected Return: <b>18%</b></li>
                    <li>Medium risk</li>
                </ul>
            </div>
            <div style="flex:1;min-width:220px;max-width:280px;background:#e3fcec;padding:22px 16px;border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,0.04);text-align:center;">
                <div style="font-weight:700;font-size:1.1em;color:#158173;margin-bottom:6px;">Pro Plan</div>
                <div style="font-size:2em;font-weight:800;color:#3949ab;margin-bottom:8px;">$2,000+</div>
                <ul style="padding-left:18px;text-align:left;font-size:0.98em;color:#555;margin-bottom:10px;">
                    <li>Duration: 6 months</li>
                    <li>Expected Return: <b>40%</b></li>
                    <li>Higher risk, higher reward</li>
                </ul>
            </div>
        </div>
        <div style="text-align:center;margin-top:24px;">
            <button id="startInvestingBtn" style="background:#158173;color:#fff;border:none;padding:14px 36px;border-radius:24px;font-size:1.1em;font-weight:700;box-shadow:0 2px 8px rgba(0,0,0,0.08);cursor:pointer;">
                Start Investing
            </button>
        </div>
    `;

    // Insert above accounts table/dashboard
    main.parentNode.insertBefore(section, main);

    // Modal for investing
    document.getElementById('startInvestingBtn').onclick = function () {
        let modal = document.getElementById('investPlanModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'investPlanModal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.background = 'rgba(0,0,0,0.32)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '5000';
            modal.innerHTML = `
                <div style="background:#fff;padding:32px 24px;border-radius:12px;max-width:380px;width:100%;box-shadow:0 4px 24px rgba(0,0,0,0.14);position:relative;">
                    <button id="closeInvestPlanModalBtn" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#3949ab;">&times;</button>
                    <h2 style="margin-top:0;color:#158173;font-size:1.2em;">Start Investing</h2>
                    <form id="investPlanForm">
                        <label style="display:block;margin-bottom:8px;font-weight:500;">Choose Plan:</label>
                        <select id="investPlanSelect" required style="margin-bottom:12px;width:100%;padding:8px;">
                            <option value="">Select Plan</option>
                            <option value="Starter">Starter Plan ($100+, 1 month, 5%)</option>
                            <option value="Growth">Growth Plan ($500+, 3 months, 18%)</option>
                            <option value="Pro">Pro Plan ($2,000+, 6 months, 40%)</option>
                        </select>
                        <label style="display:block;margin-bottom:8px;font-weight:500;">Amount (USD):</label>
                        <input type="number" id="investAmount" min="100" required style="margin-bottom:18px;width:100%;padding:8px;" placeholder="Enter amount">
                        <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;font-size:1em;">Invest Now</button>
                    </form>
                    <div id="investPlanStatus" style="margin-top:18px;color:#3949ab;font-weight:500;display:none;"></div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('#closeInvestPlanModalBtn').onclick = () => {
                modal.style.display = 'none';
            };
        }
        modal.style.display = 'flex';
        const form = modal.querySelector('#investPlanForm');
        const select = modal.querySelector('#investPlanSelect');
        const amountInput = modal.querySelector('#investAmount');
        const status = modal.querySelector('#investPlanStatus');
        status.style.display = 'none';
        form.onsubmit = function(ev) {
            ev.preventDefault();
            const plan = select.value;
            const amount = parseFloat(amountInput.value);
            let min = 100;
            if (plan === 'Growth') min = 500;
            if (plan === 'Pro') min = 2000;
            if (!plan) {
                status.style.display = 'block';
                status.style.color = '#e53935';
                status.textContent = 'Please select a plan.';
                return;
            }
            if (isNaN(amount) || amount < min) {
                status.style.display = 'block';
                status.style.color = '#e53935';
                status.textContent = `Minimum for ${plan} Plan is $${min}.`;
                return;
            }
            status.style.display = 'block';
            status.style.color = '#158173';
            status.textContent = `Investment of $${amount.toLocaleString()} in ${plan} Plan submitted! Our team will contact you.`;
            setTimeout(() => { modal.style.display = 'none'; }, 1800);
        };
    };
})();

(function addMonitorInvestmentsButton() {
    document.addEventListener('DOMContentLoaded', function () {
        const investSection = document.getElementById('investmentPlanSection');
        if (!investSection) return;
        const btnRow = investSection.querySelector('div[style*="text-align:center"]');
        if (!btnRow || btnRow.querySelector('#monitorInvestmentsBtn')) return;

        // Create the button
        const monitorBtn = document.createElement('button');
        monitorBtn.id = 'monitorInvestmentsBtn';
        monitorBtn.textContent = 'Monitor your investments';
        monitorBtn.style.background = '#3949ab';
        monitorBtn.style.color = '#fff';
        monitorBtn.style.border = 'none';
        monitorBtn.style.padding = '14px 36px';
        monitorBtn.style.borderRadius = '24px';
        monitorBtn.style.fontSize = '1.1em';
        monitorBtn.style.fontWeight = '700';
        monitorBtn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
        monitorBtn.style.cursor = 'pointer';
        monitorBtn.style.marginLeft = '18px';

        btnRow.appendChild(monitorBtn);

        // Modal logic for monitoring investments
        monitorBtn.onclick = function () {
            let modal = document.getElementById('monitorInvestmentsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'monitorInvestmentsModal';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100vw';
                modal.style.height = '100vh';
                modal.style.background = 'rgba(0,0,0,0.32)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '5000';
                modal.innerHTML = `
                    <div style="background:#fff;padding:32px 24px;border-radius:12px;max-width:480px;width:100%;box-shadow:0 4px 24px rgba(0,0,0,0.14);position:relative;">
                        <button id="closeMonitorInvestmentsModalBtn" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#3949ab;">&times;</button>
                        <h2 style="margin-top:0;color:#158173;font-size:1.2em;">Your Investments</h2>
                        <div style="margin-bottom:18px;color:#3949ab;font-weight:600;">(Demo) Here is a summary of your active investment plans:</div>
                        <table style="width:100%;border-collapse:collapse;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,0.04);margin-bottom:12px;">
                            <thead>
                                <tr style="background:#f4f7fa;">
                                    <th style="padding:8px 6px;">Plan</th>
                                    <th style="padding:8px 6px;">Amount</th>
                                    <th style="padding:8px 6px;">Start Date</th>
                                    <th style="padding:8px 6px;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding:7px 6px;">Growth Plan</td>
                                    <td style="padding:7px 6px;">$1,000</td>
                                    <td style="padding:7px 6px;">2024-05-01</td>
                                    <td style="padding:7px 6px;color:#158173;">Active</td>
                                </tr>
                                <tr>
                                    <td style="padding:7px 6px;">Starter Plan</td>
                                    <td style="padding:7px 6px;">$200</td>
                                    <td style="padding:7px 6px;">2024-04-10</td>
                                    <td style="padding:7px 6px;color:#3949ab;">Completed</td>
                                </tr>
                            </tbody>
                        </table>
                        <div style="color:#555;font-size:0.98em;">For a detailed statement or to withdraw, please contact support.</div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.querySelector('#closeMonitorInvestmentsModalBtn').onclick = () => {
                    modal.style.display = 'none';
                };
            }
            modal.style.display = 'flex';
        };
    });
})();



/**
 * Add commodities to the Market Watch panel.
 */
(function addCommoditiesToMarketWatch() {
    // Commodities data (demo, random prices)
    const commodities = [
        { symbol: "USOIL", price: 78.25 },    // WTI Oil
        { symbol: "UKOIL", price: 82.10 },    // Brent Oil
        { symbol: "NGAS", price: 2.85 },      // Natural Gas
        { symbol: "COFFEE", price: 225.40 },  // Coffee
        { symbol: "COCOA", price: 950.20 },   // Cocoa
        { symbol: "CORN", price: 480.50 }     // Corn
    ];

    // Find the Market Watch panel
    const panel = document.getElementById('marketWatchPanel');
    if (!panel) return;

    // Helper to render commodities group
    function renderCommoditiesGroup() {
        return `
            <div style="margin-bottom:8px;">
                <div style="font-weight:700;font-size:1.08em;color:#158173;margin-bottom:6px;">Commodities</div>
                <table style="width:100%;border-collapse:collapse;">
                    <thead>
                        <tr style="background:#f4f7fa;">
                            <th style="padding:6px 4px;font-size:0.98em;text-align:left;">Symbol</th>
                            <th style="padding:6px 4px;font-size:0.98em;text-align:right;">Price</th>
                            <th colspan="2" style="padding:6px 4px;text-align:center;">Trade</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${commodities.map((item, i) => `
                            <tr>
                                <td style="padding:6px 4px;font-weight:600;color:#158173;">${item.symbol}</td>
                                <td style="padding:6px 4px;text-align:right;" id="Commodities-price-${i}">${item.price}</td>
                                <td style="padding:6px 2px;">
                                    <button class="marketBuyBtn" data-symbol="${item.symbol}" style="background:#158173;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:0.97em;">Buy</button>
                                </td>
                                <td style="padding:6px 2px;">
                                    <button class="marketSellBtn" data-symbol="${item.symbol}" style="background:#e53935;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:0.97em;">Sell</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    // Insert commodities group after metals (if present), else after synthetics, else at end
    const metalsHeader = Array.from(panel.querySelectorAll('div')).find(div =>
        div.textContent && div.textContent.includes('Metals')
    );
    const syntheticsHeader = Array.from(panel.querySelectorAll('div')).find(div =>
        div.textContent && div.textContent.includes('Synthetics')
    );
    if (metalsHeader) {
        metalsHeader.insertAdjacentHTML('afterend', renderCommoditiesGroup());
    } else if (syntheticsHeader) {
        syntheticsHeader.insertAdjacentHTML('afterend', renderCommoditiesGroup());
    } else {
        panel.insertAdjacentHTML('beforeend', renderCommoditiesGroup());
    }

    // Animate commodities prices (random walk)
    function animateCommoditiesPrices() {
        setInterval(() => {
            commodities.forEach((item, i) => {
                let step;
                if (item.symbol === "USOIL" || item.symbol === "UKOIL") step = (Math.random() - 0.5) * 0.6;
                else if (item.symbol === "NGAS") step = (Math.random() - 0.5) * 0.08;
                else step = (Math.random() - 0.5) * 2.5;
                item.price = Math.max(0, Math.round((item.price + step) * 100) / 100);
                const el = document.getElementById(`Commodities-price-${i}`);
                if (el) el.textContent = item.price;
            });
        }, 2100);
    }
    animateCommoditiesPrices();
})();

/**
 * Add leverage selection to all "Open Live Account" forms.
 */
(function enhanceLeverageSelects() {
    // Leverage options
    const leverages = [
        { value: "", label: "Select Leverage" },
        { value: "1:50", label: "1:50" },
        { value: "1:100", label: "1:100" },
        { value: "1:200", label: "1:200" },
        { value: "1:500", label: "1:500" },
        { value: "1:1000", label: "1:1000" },
        { value: "1:2000", label: "1:2000" },
        { value: "Unlimited", label: "Unlimited" }
    ];

    function insertLeverageSelect(form) {
        if (form && !form.querySelector('#liveAccLeverage')) {
            // Find currency select to insert after
            const currencySel = form.querySelector('select[id*="Currency"]');
            if (currencySel) {
                // Label
                const levLabel = document.createElement('label');
                levLabel.style.display = 'block';
                levLabel.style.marginBottom = '8px';
                levLabel.style.fontWeight = '500';
                levLabel.textContent = 'Leverage:';
                // Select
                const levSel = document.createElement('select');
                levSel.id = 'liveAccLeverage';
                levSel.required = true;
                levSel.style.marginBottom = '12px';
                levSel.style.width = '100%';
                levSel.style.padding = '8px';
                levSel.innerHTML = leverages.map(l => `<option value="${l.value}">${l.label}</option>`).join('');
                // Insert after currency select
                currencySel.parentNode.insertBefore(levLabel, currencySel.nextSibling);
                currencySel.parentNode.insertBefore(levSel, levLabel.nextSibling);
            }
        }
    }

    // Patch all open live account forms on modal open
    document.addEventListener('click', function () {
        setTimeout(() => {
            document.querySelectorAll('form#openLiveAccountForm').forEach(insertLeverageSelect);
        }, 120);
    });

    // Validate leverage on submit
    document.addEventListener('submit', function (e) {
        const form = e.target;
        if (form && form.id === 'openLiveAccountForm') {
            const levSel = form.querySelector('#liveAccLeverage');
            if (levSel && !levSel.value) {
                e.preventDefault();
                levSel.focus();
                levSel.style.border = '2px solid #e53935';
                setTimeout(() => { levSel.style.border = ''; }, 1200);
            }
        }
    });
})();

/**
 * Add a "Get Demo Account" button for users to receive demo account credentials from a Google Sheet (demo).
 * When clicked, fetches a random demo account from a public Google Sheet and displays it in a modal.
 */
(function addGetDemoAccountFeature() {
    // Add button to hero section and Open Demo/Live modal
    document.addEventListener('DOMContentLoaded', function () {
        // Add to hero section if not present
        const hero = document.querySelector('section[style*="linear-gradient"]');
        if (hero && !document.getElementById('getDemoAccountBtn')) {
            const btn = document.createElement('button');
            btn.id = 'getDemoAccountBtn';
            btn.textContent = 'Get Demo Account';
            btn.style.background = '#3949ab';
            btn.style.color = '#fff';
            btn.style.border = 'none';
            btn.style.padding = '14px 36px';
            btn.style.borderRadius = '24px';
            btn.style.fontSize = '1.1em';
            btn.style.fontWeight = '700';
            btn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
            btn.style.cursor = 'pointer';
            btn.style.marginLeft = '18px';
            // Insert after Open Live/Demo buttons
            const btnRow = hero.querySelector('div[style*="margin-top"]');
            if (btnRow) btnRow.appendChild(btn);

            btn.onclick = showDemoAccountModal;
        }
    });

    // Add to Open Demo/Live modal (patch after modal opens)
    document.body.addEventListener('click', function () {
        setTimeout(() => {
            const modal = document.getElementById('openAccountModal');
            if (modal && !modal.querySelector('#getDemoAccountBtn')) {
                const btn = document.createElement('button');
                btn.id = 'getDemoAccountBtn';
                btn.textContent = 'Get Demo Account';
                btn.style.background = '#3949ab';
                btn.style.color = '#fff';
                btn.style.border = 'none';
                btn.style.padding = '10px 24px';
                btn.style.borderRadius = '4px';
                btn.style.cursor = 'pointer';
                btn.style.marginTop = '18px';
                btn.style.width = '100%';
                modal.querySelector('.headerModalContent')?.appendChild(btn);
                btn.onclick = showDemoAccountModal;
            }
        }, 120);
    });

    // Show modal and fetch demo account from Google Sheets (public CSV)
    function showDemoAccountModal() {
        // Demo Google Sheet published as CSV (replace with your own if needed)
        // Example: https://docs.google.com/spreadsheets/d/1wQvQwXkQwXkQwXkQwXkQwXkQwXkQwXkQwXkQwXkQwXk/export?format=csv
        const sheetUrl = 'https://docs.google.com/spreadsheets/d/1QwQvQwXkQwXkQwXkQwXkQwXkQwXkQwXkQwXkQwXkQwXk/export?format=csv';
        // For demo, use fallback data if fetch fails
        const fallbackAccounts = [
            { account: 'DEMO100001', password: 'demo123', server: 'BlueTraders-Demo', balance: '$10,000', type: 'Demo', currency: 'USD' },
            { account: 'DEMO100002', password: 'demo456', server: 'BlueTraders-Demo', balance: '$5,000', type: 'Demo', currency: 'USD' },
            { account: 'DEMO100003', password: 'demo789', server: 'BlueTraders-Demo', balance: '$20,000', type: 'Demo', currency: 'USD' }
        ];

        // Modal HTML
        let modal = document.getElementById('getDemoAccountModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'getDemoAccountModal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.background = 'rgba(0,0,0,0.32)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '5000';
            modal.innerHTML = `
                <div style="background:#fff;padding:32px 24px;border-radius:12px;max-width:380px;width:100%;box-shadow:0 4px 24px rgba(0,0,0,0.14);position:relative;">
                    <button id="closeGetDemoAccountModalBtn" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#3949ab;">&times;</button>
                    <h2 style="margin-top:0;color:#158173;font-size:1.2em;">Your Demo Account</h2>
                    <div id="demoAccountContent" style="min-height:80px;display:flex;align-items:center;justify-content:center;">
                        <span style="color:#3949ab;">Fetching a demo account...</span>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('#closeGetDemoAccountModalBtn').onclick = () => {
                modal.style.display = 'none';
            };
        }
        modal.style.display = 'flex';
        const content = modal.querySelector('#demoAccountContent');
        content.innerHTML = `<span style="color:#3949ab;">Fetching a demo account...</span>`;

        // Fetch CSV from Google Sheets
        fetch(sheetUrl)
            .then(r => r.ok ? r.text() : Promise.reject())
            .then(csv => {
                // Parse CSV (assume header row: Account,Password,Server,Balance,Type,Currency)
                const rows = csv.trim().split('\n').map(line => line.split(','));
                const header = rows[0].map(h => h.trim().toLowerCase());
                const accounts = rows.slice(1).map(row => {
                    const obj = {};
                    header.forEach((h, i) => obj[h] = row[i] || '');
                    return {
                        account: obj.account || obj['account number'] || '',
                        password: obj.password || '',
                        server: obj.server || '',
                        balance: obj.balance || '',
                        type: obj.type || '',
                        currency: obj.currency || ''
                    };
                }).filter(a => a.account && a.password);
                if (accounts.length) {
                    showDemoAccountDetails(content, accounts);
                } else {
                    showDemoAccountDetails(content, fallbackAccounts);
                }
            })
            .catch(() => {
                // On error, use fallback
                showDemoAccountDetails(content, fallbackAccounts);
            });
    }

    function showDemoAccountDetails(content, accounts) {
        // Pick a random account
        const acc = accounts[Math.floor(Math.random() * accounts.length)];
        content.innerHTML = `
            <div style="background:#f4f7fa;padding:16px 12px;border-radius:6px;margin-bottom:10px;">
                <b>Your Demo Account is ready!</b><br>
                <span style="color:#e53935;">Copy these credentials to log in to MetaTrader 5:</span>
                <ul style="margin:10px 0 0 18px;">
                    <li><b>Account Number:</b> <span style="color:#3949ab;">${acc.account}</span></li>
                    <li><b>Password:</b> <span style="color:#3949ab;">${acc.password}</span></li>
                    <li><b>Server:</b> ${acc.server}</li>
                    <li><b>Balance:</b> ${acc.balance}</li>
                    <li><b>Type:</b> ${acc.type}</li>
                    <li><b>Currency:</b> ${acc.currency}</li>
                </ul>
            </div>
            <button id="copyDemoAccBtn" style="background:#3949ab;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;margin-top:6px;width:100%;">Copy Credentials</button>
        `;
        content.querySelector('#copyDemoAccBtn').onclick = function () {
            const text = `Account Number: ${acc.account}\nPassword: ${acc.password}\nServer: ${acc.server}\nBalance: ${acc.balance}\nType: ${acc.type}\nCurrency: ${acc.currency}`;
            navigator.clipboard.writeText(text).then(() => {
                content.querySelector('#copyDemoAccBtn').textContent = 'Copied!';
            });
        };
    }
})();



/**s
 * Enhance KYC/Verification: allow users to upload Proof of Residence, and allow admin to view Proof of Residence for all users.
 */

// --- User Side: Add Proof of Residence upload to KYC/Verification modal ---
(function enhanceKycProofOfResidence() {
    document.addEventListener('click', function () {
        setTimeout(() => {
            const verifyForm = document.getElementById('verifyForm');
            if (verifyForm && !verifyForm.dataset.proofResidence) {
                verifyForm.dataset.proofResidence = '1';
                // Insert Proof of Residence field after Proof of Address
                const proofAddrInput = verifyForm.querySelectorAll('input[type="file"]')[1];
                if (proofAddrInput) {
                    // Label
                    const label = document.createElement('label');
                    label.style.display = 'block';
                    label.style.marginBottom = '8px';
                    label.style.fontWeight = '500';
                    label.textContent = 'Proof of Residence (PDF/JPG/PNG):';
                    // Input
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.pdf,.jpg,.jpeg,.png';
                    input.required = true;
                    input.style.marginBottom = '20px';
                    input.style.width = '100%';
                    // Insert after Proof of Address input
                    proofAddrInput.parentNode.insertBefore(label, proofAddrInput.nextSibling);
                    proofAddrInput.parentNode.insertBefore(input, label.nextSibling);
                }
            }
        }, 120);
    });
})();

// --- Admin Side: Show Proof of Residence in KYC table ---
(function adminViewProofOfResidence() {
    document.addEventListener('click', function () {
        setTimeout(() => {
            const content = document.getElementById('adminDashContent');
            if (!content) return;
            // Only patch if KYC table is present and not already enhanced for proof of residence
            const table = content.querySelector('table');
            if (!table || table.dataset.proofResidence) return;
            if (!content.querySelector('h4') || !/KYC/i.test(content.querySelector('h4').textContent)) return;
            table.dataset.proofResidence = '1';
            // Add "Proof of Residence" column header
            const theadRow = table.querySelector('thead tr');
            if (theadRow && theadRow.children.length < 5) {
                const th = document.createElement('th');
                th.style.padding = '8px 6px';
                th.textContent = 'Proof of Residence';
                theadRow.insertBefore(th, theadRow.children[2]);
            }
            // Add dummy Proof of Residence links to each row (demo)
            table.querySelectorAll('tbody tr').forEach(row => {
                const td = document.createElement('td');
                td.style.padding = '7px 6px';
                td.innerHTML = `<a href="#" style="color:#3949ab;text-decoration:underline;" onclick="alert('Viewing Proof of Residence (demo file)');return false;">View</a>`;
                row.insertBefore(td, row.children[2]);
            });
        }, 120);
    });
})();


(function enhanceAdminKycViewButton() {
    document.addEventListener('click', function () {
        setTimeout(() => {
            const content = document.getElementById('adminDashContent');
            if (!content) return;
            // Only patch if KYC table is present
            const table = content.querySelector('table');
            if (!table) return;
            // Attach logic to all "View" buttons in Proof of Residence and Document columns
            table.querySelectorAll('a').forEach(link => {
                if (link.textContent.trim().toLowerCase() === 'view' && !link.dataset.kycViewEnhanced) {
                    link.dataset.kycViewEnhanced = '1';
                    link.onclick = function (e) {
                        e.preventDefault();
                        // For demo: simulate fetching uploaded documents for the user in this row
                        const row = link.closest('tr');
                        const user = row ? row.querySelector('td')?.textContent.trim() : 'User';
                        // Simulate uploaded files (replace with real file URLs in production)
                        const uploadedDocs = [
                            { type: 'ID Document', url: '#', name: 'ID_card.pdf' },
                            { type: 'Proof of Address', url: '#', name: 'utility_bill.jpg' },
                            { type: 'Proof of Residence', url: '#', name: 'residence_letter.png' }
                        ];
                        // Show modal with all documents
                        let modal = document.getElementById('kycDocsModal');
                        if (!modal) {
                            modal = document.createElement('div');
                            modal.id = 'kycDocsModal';
                            modal.style.position = 'fixed';
                            modal.style.top = '0';
                            modal.style.left = '0';
                            modal.style.width = '100vw';
                            modal.style.height = '100vh';
                            modal.style.background = 'rgba(0,0,0,0.32)';
                            modal.style.display = 'flex';
                            modal.style.alignItems = 'center';
                            modal.style.justifyContent = 'center';
                            modal.style.zIndex = '9999';
                            modal.innerHTML = `
                                <div style="background:#fff;padding:32px 24px;border-radius:12px;max-width:420px;width:96vw;box-shadow:0 4px 24px rgba(0,0,0,0.14);position:relative;">
                                    <button id="closeKycDocsModalBtn" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#3949ab;">&times;</button>
                                    <h2 style="margin-top:0;color:#158173;font-size:1.2em;">Uploaded Documents</h2>
                                    <div id="kycDocsList"></div>
                                </div>
                            `;
                            document.body.appendChild(modal);
                            modal.querySelector('#closeKycDocsModalBtn').onclick = () => {
                                modal.style.display = 'none';
                            };
                        }
                        // Render docs
                        const docsList = modal.querySelector('#kycDocsList');
                        docsList.innerHTML = `<div style="margin-bottom:10px;font-weight:600;color:#3949ab;">${user}'s Uploaded Documents:</div>` +
                            uploadedDocs.map(doc =>
                                `<div style="margin-bottom:10px;">
                                    <span style="font-weight:500;">${doc.type}:</span>
                                    <a href="${doc.url}" target="_blank" style="color:#158173;text-decoration:underline;">${doc.name}</a>
                                </div>`
                            ).join('');
                        modal.style.display = 'flex';
                    };
                }
            });
        }, 120);
    });
})();


/**
 * Display all KYC documents uploaded by new users in the admin dashboard,
 * and prompt admin to approve. After approval, show "Verified"; before approval, show "Pending" to all new users.
 */
(function adminKycApprovalWorkflow() {
    // Demo: store KYC status and uploaded docs in localStorage per user email
    function getKycUsers() {
        // For demo, use a static list; in real app, fetch from backend
        let users = JSON.parse(localStorage.getItem('kycUsers') || '[]');
        if (!users.length) {
            users = [
                {
                    email: 'jane@demo.com',
                    name: 'Jane Smith',
                    docs: [
                        { type: 'ID Document', name: 'jane_id.pdf', url: '#' },
                        { type: 'Proof of Address', name: 'jane_address.jpg', url: '#' },
                        { type: 'Proof of Residence', name: 'jane_residence.png', url: '#' }
                    ],
                    status: localStorage.getItem('kycStatus-jane@demo.com') || 'pending'
                },
                {
                    email: 'john@example.com',
                    name: 'John Doe',
                    docs: [
                        { type: 'ID Document', name: 'john_id.pdf', url: '#' },
                        { type: 'Proof of Address', name: 'john_address.jpg', url: '#' },
                        { type: 'Proof of Residence', name: 'john_residence.png', url: '#' }
                    ],
                    status: localStorage.getItem('kycStatus-john@example.com') || 'pending'
                }
            ];
            localStorage.setItem('kycUsers', JSON.stringify(users));
        }
        // Update status from localStorage
        users.forEach(u => {
            u.status = localStorage.getItem('kycStatus-' + u.email) || u.status || 'pending';
        });
        return users;
    }
    function setKycStatus(email, status) {
        localStorage.setItem('kycStatus-' + email, status);
        // Also update in kycUsers array
        let users = getKycUsers();
        users.forEach(u => { if (u.email === email) u.status = status; });
        localStorage.setItem('kycUsers', JSON.stringify(users));
    }
    // Patch admin dashboard KYC section
    document.addEventListener('click', function () {
        setTimeout(() => {
            const content = document.getElementById('adminDashContent');
            if (!content) return;
            // Only patch if KYC table is present and not already enhanced
            if (!content.querySelector('h4') || !/KYC/i.test(content.querySelector('h4').textContent)) return;
            if (content.dataset.kycEnhanced) return;
            content.dataset.kycEnhanced = '1';
            // Render KYC users table
            const users = getKycUsers();
            content.innerHTML = `
                <h4 style="color:#3949ab;">KYC / Verification Requests</h4>
                <table style="width:100%;border-collapse:collapse;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
                    <thead>
                        <tr style="background:#f4f7fa;">
                            <th style="padding:8px 6px;">User</th>
                            <th style="padding:8px 6px;">Email</th>
                            <th style="padding:8px 6px;">Documents</th>
                            <th style="padding:8px 6px;">Status</th>
                            <th style="padding:8px 6px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(u => `
                            <tr>
                                <td style="padding:7px 6px;">${u.name}</td>
                                <td style="padding:7px 6px;">${u.email}</td>
                                <td style="padding:7px 6px;">
                                    ${u.docs.map(doc =>
                                        `<a href="${doc.url}" target="_blank" style="color:#158173;text-decoration:underline;margin-right:8px;">${doc.type}</a>`
                                    ).join('')}
                                </td>
                                <td style="padding:7px 6px;">
                                    <span class="kyc-status-label" style="font-weight:700;padding:2px 10px;border-radius:8px;${u.status === 'verified'
                                        ? 'background:#e3fcec;color:#158173;'
                                        : 'background:#fffde7;color:#e53935;'}">
                                        ${u.status === 'verified' ? 'Verified' : 'Pending'}
                                    </span>
                                </td>
                                <td style="padding:7px 6px;">
                                    ${u.status === 'pending'
                                        ? `<button class="approveKycBtn" data-email="${u.email}" style="background:#158173;color:#fff;border:none;padding:6px 14px;border-radius:4px;cursor:pointer;">Approve</button>`
                                        : `<span style="color:#158173;font-weight:600;">—</span>`
                                    }
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            // Approve button logic
            content.querySelectorAll('.approveKycBtn').forEach(btn => {
                btn.onclick = function () {
                    const email = btn.getAttribute('data-email');
                    setKycStatus(email, 'verified');
                    // Update UI
                    btn.parentNode.parentNode.querySelector('.kyc-status-label').textContent = 'Verified';
                    btn.parentNode.parentNode.querySelector('.kyc-status-label').style.background = '#e3fcec';
                    btn.parentNode.parentNode.querySelector('.kyc-status-label').style.color = '#158173';
                    btn.parentNode.innerHTML = `<span style="color:#158173;font-weight:600;">—</span>`;
                    // Also update user view if needed
                    localStorage.setItem('kycStatus', 'verified');
                };
            });
        }, 120);
    });
    // Show status to user in sidebar (already handled by updateVerifySidebarStatus)
})();

/**
 * Add a floating support chat icon at the bottom left of the sidebar for direct chat with the internal team.
 */
(function addSupportChatIcon() {
    // Create chat button
    const chatBtn = document.createElement('button');
    chatBtn.id = 'supportChatBtn';
    chatBtn.title = 'Chat with Support';
    chatBtn.style.position = 'fixed';
    chatBtn.style.left = '24px';
    chatBtn.style.bottom = '32px';
    chatBtn.style.background = '#158173';
    chatBtn.style.color = '#fff';
    chatBtn.style.border = 'none';
    chatBtn.style.borderRadius = '50%';
    chatBtn.style.width = '54px';
    chatBtn.style.height = '54px';
    chatBtn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.16)';
    chatBtn.style.cursor = 'pointer';
    chatBtn.style.zIndex = '2001';
    chatBtn.style.display = 'flex';
    chatBtn.style.alignItems = 'center';
    chatBtn.style.justifyContent = 'center';
    chatBtn.style.fontSize = '2em';
    chatBtn.innerHTML = `<svg width="28" height="28" fill="none" viewBox="0 0 24 24"><path d="M21 19V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14l4-4h12a2 2 0 0 0 2-2z" stroke="#fff" stroke-width="2" fill="#158173"/><circle cx="8" cy="11" r="1" fill="#fff"/><circle cx="12" cy="11" r="1" fill="#fff"/><circle cx="16" cy="11" r="1" fill="#fff"/></svg>`;

    // Only show on desktop/tablet (hide on mobile)
    const style = document.createElement('style');
    style.textContent = `
        @media (max-width: 900px) {
            #supportChatBtn { display: none !important; }
        }
    `;
    document.head.appendChild(style);

    document.body.appendChild(chatBtn);

    // Chat modal logic
    function showChatModal() {
        let modal = document.getElementById('supportChatModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'supportChatModal';
            modal.style.position = 'fixed';
            modal.style.bottom = '90px';
            modal.style.left = '32px';
            modal.style.width = '340px';
            modal.style.maxWidth = '96vw';
            modal.style.background = '#fff';
            modal.style.borderRadius = '14px';
            modal.style.boxShadow = '0 4px 24px rgba(0,0,0,0.18)';
            modal.style.zIndex = '3001';
            modal.style.display = 'flex';
            modal.style.flexDirection = 'column';
            modal.innerHTML = `
                <div style="background:#158173;color:#fff;padding:14px 18px;border-radius:14px 14px 0 0;font-weight:700;display:flex;align-items:center;justify-content:space-between;">
                    <span>Support Chat</span>
                    <button id="closeSupportChatModalBtn" style="background:none;border:none;color:#fff;font-size:1.3em;cursor:pointer;">&times;</button>
                </div>
                <div id="supportChatMessages" style="flex:1;min-height:120px;max-height:220px;overflow-y:auto;padding:14px 12px 8px 12px;background:#f4f7fa;"></div>
                <form id="supportChatForm" style="display:flex;gap:6px;padding:10px 10px 10px 10px;background:#fff;border-radius:0 0 14px 14px;">
                    <input type="text" id="supportChatInput" placeholder="Type your message..." required style="flex:1;padding:8px 10px;border-radius:6px;border:1px solid #e0e0e0;">
                    <button type="submit" style="background:#158173;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-weight:700;">Send</button>
                </form>
            `;
            document.body.appendChild(modal);

            // Close logic
            modal.querySelector('#closeSupportChatModalBtn').onclick = () => {
                modal.style.display = 'none';
            };

            // Simple chat logic (demo)
            const messages = modal.querySelector('#supportChatMessages');
            const form = modal.querySelector('#supportChatForm');
            form.onsubmit = function(ev) {
                ev.preventDefault();
                const input = modal.querySelector('#supportChatInput');
                const msg = input.value.trim();
                if (!msg) return;
                // User message
                const userMsg = document.createElement('div');
                userMsg.style.margin = '6px 0';
                userMsg.style.textAlign = 'right';
                userMsg.innerHTML = `<span style="background:#158173;color:#fff;padding:7px 12px;border-radius:12px 12px 2px 12px;display:inline-block;max-width:80%;">${msg}</span>`;
                messages.appendChild(userMsg);
                messages.scrollTop = messages.scrollHeight;
                input.value = '';
                // Simulate support reply
                setTimeout(() => {
                    const supportMsg = document.createElement('div');
                    supportMsg.style.margin = '6px 0';
                    supportMsg.style.textAlign = 'left';
                    supportMsg.innerHTML = `<span style="background:#3949ab;color:#fff;padding:7px 12px;border-radius:12px 12px 12px 2px;display:inline-block;max-width:80%;">Thank you for contacting support. We'll reply shortly.</span>`;
                    messages.appendChild(supportMsg);
                    messages.scrollTop = messages.scrollHeight;
                }, 900);
            };
        }
        modal.style.display = 'flex';
    }

    chatBtn.onclick = showChatModal;
})();



/**
 * Force all users to Sign Up or Login before accessing services.
 * Show a modal with both Sign Up and Login buttons if not authenticated.
 * Demo: uses localStorage "isLoggedIn" to simulate authentication.
 */
(function enforceAuthBeforeAccess() {
    // Helper: show auth modal
    function showAuthModal() {
        // Prevent multiple modals
        if (document.getElementById('forceAuthModal')) return;
        const modal = document.createElement('div');
        modal.id = 'forceAuthModal';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100vw';
        modal.style.height = '100vh';
        modal.style.background = 'rgba(0,0,0,0.32)';
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.style.zIndex = '9999';
        modal.innerHTML = `
            <div style="background:#fff;padding:36px 28px 28px 28px;border-radius:14px;max-width:380px;width:96vw;box-shadow:0 4px 24px rgba(0,0,0,0.14);position:relative;text-align:center;">
                <h2 style="color:#158173;margin-top:0;font-size:1.3em;">Welcome to The Blue Traders</h2>
                <p style="color:#3949ab;font-size:1.08em;margin-bottom:24px;">
                    Please <b>Sign Up</b> or <b>Login</b> to access our services.
                </p>
                <div style="display:flex;gap:18px;justify-content:center;">
                    <button id="forceAuthSignUpBtn" style="background:#158173;color:#fff;border:none;padding:12px 28px;border-radius:8px;font-size:1.08em;font-weight:700;cursor:pointer;">Sign Up</button>
                    <button id="forceAuthLoginBtn" style="background:#3949ab;color:#fff;border:none;padding:12px 28px;border-radius:8px;font-size:1.08em;font-weight:700;cursor:pointer;">Login</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // Button logic: open Sign Up/Login modal
        modal.querySelector('#forceAuthSignUpBtn').onclick = function () {
            modal.style.display = 'none';
            // Open Sign Up/Login modal, default to Sign Up tab
            if (typeof createHeaderModal === 'function') {
                createHeaderModal({
                    id: 'authModal',
                    title: 'Sign Up / Login',
                    content: `
                        <div style="display:flex;gap:12px;margin-bottom:18px;">
                        <button id="tabSignUp" style="flex:1;background:#158173;color:#fff;border:none;padding:8px 0;border-radius:4px 0 0 4px;cursor:pointer;">Sign Up</button>
                        <button id="tabLogin" style="flex:1;background:#f4f7fa;color:#3949ab;border:none;padding:8px 0;border-radius:0 4px 4px 0;cursor:pointer;">Login</button>
                        </div>
                        <div id="authTabContent"></div>
                    `
                });
                setTimeout(() => {
                    const tabSignUp = document.getElementById('tabSignUp');
                    const tabLogin = document.getElementById('tabLogin');
                    const tabContent = document.getElementById('authTabContent');
                    function showSignUp() {
                        tabSignUp.style.background = '#158173';
                        tabSignUp.style.color = '#fff';
                        tabLogin.style.background = '#f4f7fa';
                        tabLogin.style.color = '#3949ab';
                        tabContent.innerHTML = `
                        <form id="signUpForm">
                            <input type="text" placeholder="Full Name" required style="margin-bottom:10px;width:100%;padding:8px;">
                            <input type="email" placeholder="Email" required style="margin-bottom:10px;width:100%;padding:8px;">
                            <input type="password" placeholder="Password" required style="margin-bottom:16px;width:100%;padding:8px;">
                            <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Sign Up</button>
                        </form>
                        <div id="signUpStatus" style="margin-top:12px;color:#3949ab;font-weight:500;display:none;"></div>
                        `;
                        document.getElementById('signUpForm').onsubmit = function(ev) {
                            ev.preventDefault();
                            localStorage.setItem('isLoggedIn', '1');
                            document.getElementById('signUpStatus').style.display = 'block';
                            document.getElementById('signUpStatus').textContent = 'Account created! You are now logged in.';
                            setTimeout(() => {
                                document.getElementById('authModal').style.display = 'none';
                            }, 1000);
                        };
                    }
                    function showLogin() {
                        tabSignUp.style.background = '#f4f7fa';
                        tabSignUp.style.color = '#3949ab';
                        tabLogin.style.background = '#158173';
                        tabLogin.style.color = '#fff';
                        tabContent.innerHTML = `
                        <form id="loginForm">
                            <input type="email" placeholder="Email" required style="margin-bottom:10px;width:100%;padding:8px;">
                            <input type="password" placeholder="Password" required style="margin-bottom:16px;width:100%;padding:8px;">
                            <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Login</button>
                        </form>
                        <div id="loginStatus" style="margin-top:12px;color:#3949ab;font-weight:500;display:none;"></div>
                        `;
                        document.getElementById('loginForm').onsubmit = function(ev) {
                            ev.preventDefault();
                            localStorage.setItem('isLoggedIn', '1');
                            document.getElementById('loginStatus').style.display = 'block';
                            document.getElementById('loginStatus').textContent = 'Login successful! You are now logged in.';
                            setTimeout(() => {
                                document.getElementById('authModal').style.display = 'none';
                            }, 1000);
                        };
                    }
                    tabSignUp.onclick = showSignUp;
                    tabLogin.onclick = showLogin;
                    showSignUp();
                }, 100);
            }
        };
        modal.querySelector('#forceAuthLoginBtn').onclick = function () {
            modal.style.display = 'none';
            // Open Sign Up/Login modal, default to Login tab
            if (typeof createHeaderModal === 'function') {
                createHeaderModal({
                    id: 'authModal',
                    title: 'Sign Up / Login',
                    content: `
                        <div style="display:flex;gap:12px;margin-bottom:18px;">
                        <button id="tabSignUp" style="flex:1;background:#f4f7fa;color:#3949ab;border:none;padding:8px 0;border-radius:4px 0 0 4px;cursor:pointer;">Sign Up</button>
                        <button id="tabLogin" style="flex:1;background:#158173;color:#fff;border:none;padding:8px 0;border-radius:0 4px 4px 0;cursor:pointer;">Login</button>
                        </div>
                        <div id="authTabContent"></div>
                    `
                });
                setTimeout(() => {
                    const tabSignUp = document.getElementById('tabSignUp');
                    const tabLogin = document.getElementById('tabLogin');
                    const tabContent = document.getElementById('authTabContent');
                    function showSignUp() {
                        tabSignUp.style.background = '#158173';
                        tabSignUp.style.color = '#fff';
                        tabLogin.style.background = '#f4f7fa';
                        tabLogin.style.color = '#3949ab';
                        tabContent.innerHTML = `
                        <form id="signUpForm">
                            <input type="text" placeholder="Full Name" required style="margin-bottom:10px;width:100%;padding:8px;">
                            <input type="email" placeholder="Email" required style="margin-bottom:10px;width:100%;padding:8px;">
                            <input type="password" placeholder="Password" required style="margin-bottom:16px;width:100%;padding:8px;">
                            <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Sign Up</button>
                        </form>
                        <div id="signUpStatus" style="margin-top:12px;color:#3949ab;font-weight:500;display:none;"></div>
                        `;
                        document.getElementById('signUpForm').onsubmit = function(ev) {
                            ev.preventDefault();
                            localStorage.setItem('isLoggedIn', '1');
                            document.getElementById('signUpStatus').style.display = 'block';
                            document.getElementById('signUpStatus').textContent = 'Account created! You are now logged in.';
                            setTimeout(() => {
                                document.getElementById('authModal').style.display = 'none';
                            }, 1000);
                        };
                    }
                    function showLogin() {
                        tabSignUp.style.background = '#f4f7fa';
                        tabSignUp.style.color = '#3949ab';
                        tabLogin.style.background = '#158173';
                        tabLogin.style.color = '#fff';
                        tabContent.innerHTML = `
                        <form id="loginForm">
                            <input type="email" placeholder="Email" required style="margin-bottom:10px;width:100%;padding:8px;">
                            <input type="password" placeholder="Password" required style="margin-bottom:16px;width:100%;padding:8px;">
                            <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Login</button>
                        </form>
                        <div id="loginStatus" style="margin-top:12px;color:#3949ab;font-weight:500;display:none;"></div>
                        `;
                        document.getElementById('loginForm').onsubmit = function(ev) {
                            ev.preventDefault();
                            localStorage.setItem('isLoggedIn', '1');
                            document.getElementById('loginStatus').style.display = 'block';
                            document.getElementById('loginStatus').textContent = 'Login successful! You are now logged in.';
                            setTimeout(() => {
                                document.getElementById('authModal').style.display = 'none';
                            }, 1000);
                        };
                    }
                    tabSignUp.onclick = showSignUp;
                    tabLogin.onclick = showLogin;
                    showLogin();
                }, 100);
            }
        };
    }

    // Check login status
    function checkAuth() {
        // Allow admin dashboard access for admin
        if (localStorage.getItem('isAdmin') === '1') return;
        // If not logged in, show modal and block UI
        if (localStorage.getItem('isLoggedIn') !== '1') {
            showAuthModal();
        } else {
            // Remove modal if present
            const modal = document.getElementById('forceAuthModal');
            if (modal) modal.remove();
        }
    }

    // Run on page load
    document.addEventListener('DOMContentLoaded', checkAuth);
    // Also run on navigation/clicks (simulate SPA)
    document.addEventListener('click', function () {
        setTimeout(checkAuth, 100);
    });
})();


/**
 * Enhance Sign Up form to include Full Name, Email, Country, Phone Number, and Date of Birth.
 * Date of Birth should match information in their IDs.
 */
(function enhanceSignUpFormFields() {
    // Patch all sign up forms on modal open
    document.addEventListener('click', function () {
        setTimeout(() => {
            document.querySelectorAll('form#signUpForm').forEach(form => {
                if (form.dataset.enhanced) return;
                form.dataset.enhanced = '1';
                // Clear form and rebuild with required fields
                form.innerHTML = `
                    <input type="text" name="fullname" placeholder="Full Name" required style="margin-bottom:10px;width:100%;padding:8px;">
                    <input type="email" name="email" placeholder="Email Address" required style="margin-bottom:10px;width:100%;padding:8px;">
                    <input type="text" name="country" placeholder="Country of Residence" required style="margin-bottom:10px;width:100%;padding:8px;">
                    <input type="tel" name="phone" placeholder="Phone Number" required style="margin-bottom:10px;width:100%;padding:8px;">
                    <input type="date" name="dob" placeholder="Date of Birth" required style="margin-bottom:10px;width:100%;padding:8px;">
                    <div style="font-size:0.97em;color:#3949ab;margin-bottom:10px;">
                        <b>Note:</b> Date of Birth must match your ID for verification.
                    </div>
                    <input type="password" name="password" placeholder="Password" required style="margin-bottom:16px;width:100%;padding:8px;">
                    <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Sign Up</button>
                `;
            });
        }, 120);
    });
})();

(function enhanceCountrySelectInSignUp() {
    // List of countries (ISO 3166, short list for demo; expand as needed)
    const countries = [
        "Uganda", "Kenya", "Tanzania", "Rwanda", "Burundi", "South Sudan", "Nigeria", "Ghana", "South Africa", "Egypt",
        "United States", "United Kingdom", "Canada", "Australia", "Germany", "France", "India", "China", "Japan", "Brazil",
        "Zimbabwe", "Zambia", "Ethiopia", "Cameroon", "Senegal", "Morocco", "Algeria", "Tunisia", "Turkey", "Russia"
    ];
    // Patch all sign up forms on modal open
    document.addEventListener('click', function () {
        setTimeout(() => {
            document.querySelectorAll('form#signUpForm').forEach(form => {
                if (form.dataset.countryEnhanced) return;
                form.dataset.countryEnhanced = '1';
                // Find country input
                const countryInput = form.querySelector('input[name="country"]');
                if (countryInput) {
                    // Create wrapper div for search + select
                    const wrapper = document.createElement('div');
                    wrapper.style.position = 'relative';
                    wrapper.style.marginBottom = '10px';

                    // Create search input
                    const search = document.createElement('input');
                    search.type = 'text';
                    search.placeholder = 'Search country...';
                    search.autocomplete = 'off';
                    search.style.width = '100%';
                    search.style.padding = '8px';
                    search.style.marginBottom = '6px';
                    search.style.boxSizing = 'border-box';

                    // Create select
                    const select = document.createElement('select');
                    select.name = 'country';
                    select.required = true;
                    select.style.width = '100%';
                    select.style.padding = '8px';
                    select.innerHTML = `<option value="">Select Country</option>` +
                        countries.map(c => `<option value="${c}">${c}</option>`).join('');

                    // Replace input with wrapper
                    countryInput.parentNode.replaceChild(wrapper, countryInput);
                    wrapper.appendChild(search);
                    wrapper.appendChild(select);

                    // Filter select options as user types
                    search.addEventListener('input', function () {
                        const val = search.value.trim().toLowerCase();
                        select.innerHTML = `<option value="">Select Country</option>` +
                            countries
                                .filter(c => c.toLowerCase().startsWith(val))
                                .map(c => `<option value="${c}">${c}</option>`)
                                .join('');
                    });

                    // When select changes, update search input
                    select.addEventListener('change', function () {
                        if (select.value) search.value = select.value;
                    });
                }
            });
        }, 120);
    });
})();

document.addEventListener('click', function () {
    setTimeout(() => {
        document.querySelectorAll('form#signUpForm').forEach(form => {
            if (form.dataset.redirectEnhanced) return;
            form.dataset.redirectEnhanced = '1';
            form.onsubmit = function(ev) {
                ev.preventDefault();
                localStorage.setItem('isLoggedIn', '1');
                // Hide modal if present
                const modal = form.closest('[id$="Modal"]');
                if (modal) modal.style.display = 'none';
                // Show push notification
                const notif = document.createElement('div');
                notif.textContent = 'Sign up successful! Please verify your account by uploading your documents.';
                notif.style.position = 'fixed';
                notif.style.top = '24px';
                notif.style.right = '24px';
                notif.style.background = '#ffd600';
                notif.style.color = '#3949ab';
                notif.style.padding = '18px 28px';
                notif.style.borderRadius = '10px';
                notif.style.fontWeight = '700';
                notif.style.fontSize = '1.1em';
                notif.style.boxShadow = '0 2px 12px #3949ab22';
                notif.style.zIndex = '9999';
                notif.style.transition = 'opacity 0.5s';
                notif.style.opacity = '1';
                document.body.appendChild(notif);
                setTimeout(() => {
                    notif.style.opacity = '0';
                    setTimeout(() => notif.remove(), 800);
                }, 3500);
                // Redirect to home page (simulate by reloading)
                setTimeout(() => {
                    window.location.href = window.location.origin + window.location.pathname;
                }, 1200);
            };
        });
    }, 120);
});

/**
 * Enhance login form: check credentials, analyze email/password, and redirect to dashboard if recognized.
 * Demo: uses a simple in-memory user list and admin logic.
 */
(function enhanceLoginFormAuth() {
    // Demo user database (replace with real backend in production)
    const users = [
        { email: 'john@example.com', password: 'john123', role: 'user' },
        { email: 'jane@demo.com', password: 'jane456', role: 'user' },
        { email: 'thebluetraders1@gmail.com', password: '25633', role: 'admin' },
        { email: 'admin@demo.com', password: 'admin123', role: 'admin' }
    ];

    document.addEventListener('click', function () {
        setTimeout(() => {
            const loginForm = document.getElementById('loginForm');
            if (loginForm && !loginForm.dataset.credentialEnhanced) {
                loginForm.dataset.credentialEnhanced = '1';
                loginForm.onsubmit = function(ev) {
                    ev.preventDefault();
                    const email = loginForm.querySelector('input[type="email"]').value.trim().toLowerCase();
                    const password = loginForm.querySelector('input[type="password"]').value;
                    const status = document.getElementById('loginStatus');
                    // Find user in demo database
                    const user = users.find(u => u.email === email && u.password === password);
                    if (user) {
                        localStorage.setItem('isLoggedIn', '1');
                        if (user.role === 'admin') {
                            localStorage.setItem('isAdmin', '1');
                            status.style.display = 'block';
                            status.textContent = 'Admin login successful! Redirecting to admin dashboard...';
                            setTimeout(() => {
                                const modal = loginForm.closest('[id$="Modal"]');
                                if (modal) modal.style.display = 'none';
                                showAdminDashboard();
                                const switchBtn = document.getElementById('dashboardSwitchBtn');
                                if (switchBtn) switchBtn.style.display = '';
                            }, 800);
                        } else {
                            localStorage.setItem('isAdmin', '0');
                            status.style.display = 'block';
                            status.textContent = 'Login successful! Redirecting to dashboard...';
                            setTimeout(() => {
                                status.style.display = 'none';
                                const modal = loginForm.closest('[id$="Modal"]');
                                if (modal) modal.style.display = 'none';
                                // Optionally reload or redirect to dashboard
                                window.location.href = window.location.origin + window.location.pathname;
                            }, 1000);
                        }
                    } else {
                        status.style.display = 'block';
                        status.textContent = 'Incorrect email or password.';
                    }
                };
            }
        }, 120);
    });
})();

/**
 * Change header "SignUp/Login" button to "Signed In" if user is logged in.
 */
(function updateHeaderAuthButton() {
    function updateButton() {
        // Find header nav ul
        const navUl = document.querySelector('header nav ul');
        if (!navUl) return;
        // Find the SignUp/Login link
        const links = navUl.querySelectorAll('li a');
        links.forEach(link => {
            if (link.textContent.trim() === 'SignUp/Login') {
                if (localStorage.getItem('isLoggedIn') === '1') {
                    link.textContent = 'Signed In';
                    link.style.pointerEvents = 'none';
                    link.style.opacity = '0.7';
                } else {
                    link.textContent = 'SignUp/Login';
                    link.style.pointerEvents = '';
                    link.style.opacity = '';
                }
            }
        });
    }
    document.addEventListener('DOMContentLoaded', updateButton);
    document.addEventListener('click', function () {
        setTimeout(updateButton, 150);
    });
    window.addEventListener('storage', updateButton);
})();

/**
 * Show "Pending" or "Verified" status on "Verify your Account" sidebar link.
 * - Pending: user has not uploaded all credentials (simulate with localStorage).
 * - Verified: user has uploaded all credentials (simulate with localStorage).
 */
(function updateVerifySidebarStatus() {
    // Helper: check verification status (simulate with localStorage)
    function isVerified() {
        // For demo: localStorage 'kycStatus' = 'verified' or 'pending'
        return localStorage.getItem('kycStatus') === 'verified';
    }
    function updateSidebar() {
        document.querySelectorAll('.sidebar ul li a').forEach(link => {
            const text = link.textContent.replace(/<[^>]+>/g, '').trim();
            if (text === 'Verify your Account') {
                // Remove previous status span if any
                const oldStatus = link.querySelector('.verify-status');
                if (oldStatus) oldStatus.remove();
                // Add status
                const status = document.createElement('span');
                status.className = 'verify-status';
                status.style.marginLeft = '10px';
                status.style.fontSize = '0.98em';
                status.style.fontWeight = '700';
                status.style.borderRadius = '8px';
                status.style.padding = '2px 10px';
                status.style.verticalAlign = 'middle';
                if (isVerified()) {
                    status.textContent = 'Verified';
                    status.style.background = '#e3fcec';
                    status.style.color = '#158173';
                } else {
                    status.textContent = 'Pending';
                    status.style.background = '#fffde7';
                    status.style.color = '#e53935';
                }
                link.appendChild(status);
            }
        });
    }
    // Patch verify form to set status on submit (simulate upload)
    document.addEventListener('click', function () {
        setTimeout(() => {
            const verifyForm = document.getElementById('verifyForm');
            if (verifyForm && !verifyForm.dataset.statusEnhanced) {
                verifyForm.dataset.statusEnhanced = '1';
                verifyForm.onsubmit = function(ev) {
                    ev.preventDefault();
                    // Simulate: set verified in localStorage
                    localStorage.setItem('kycStatus', 'verified');
                    updateSidebar();
                    // Show success message
                    const status = document.getElementById('verifyStatus');
                    if (status) {
                        status.style.display = 'block';
                        status.textContent = 'Verification documents uploaded! Your account will be reviewed.';
                    }
                    // Optionally close modal after delay
                    setTimeout(() => {
                        const modal = verifyForm.closest('[id$="Modal"]');
                        if (modal) modal.style.display = 'none';
                    }, 1200);
                };
            }
        }, 120);
    });
    // On page load, default to pending if not set
    document.addEventListener('DOMContentLoaded', function () {
        if (!localStorage.getItem('kycStatus')) {
            localStorage.setItem('kycStatus', 'pending');
        }
        updateSidebar();
    });
    // Update on click (simulate SPA navigation)
    document.addEventListener('click', function () {
        setTimeout(updateSidebar, 120);
    });
    // Listen for storage changes (multi-tab)
    window.addEventListener('storage', updateSidebar);
})();


/**
 * Hide all main services (main-content, admin dashboard, sidebar, etc.) until user is authenticated.
 * Show only the auth modal (Sign Up/Login) until login/signup is complete.
 */
(function hideServicesUntilAuth() {
    function hideServices() {
        // Hide main content, sidebar, admin dashboard, market watch, etc.
        const mainContent = document.querySelector('.main-content');
        const sidebar = document.getElementById('sidebar');
        const adminDash = document.getElementById('adminDashboard');
        const marketWatch = document.getElementById('marketWatchPanel');
        const marketDrawer = document.getElementById('marketWatchDrawerBtn');
        const shareBtn = document.getElementById('sharePageBtn');
        const chatBtn = document.getElementById('supportChatBtn');
        if (mainContent) mainContent.style.display = 'none';
        if (sidebar) sidebar.style.display = 'none';
        if (adminDash) adminDash.style.display = 'none';
        if (marketWatch) marketWatch.style.display = 'none';
        if (marketDrawer) marketDrawer.style.display = 'none';
        if (shareBtn) shareBtn.style.display = 'none';
        if (chatBtn) chatBtn.style.display = 'none';
    }
    function showServices() {
        const mainContent = document.querySelector('.main-content');
        const sidebar = document.getElementById('sidebar');
        const adminDash = document.getElementById('adminDashboard');
        const marketWatch = document.getElementById('marketWatchPanel');
        const marketDrawer = document.getElementById('marketWatchDrawerBtn');
        const shareBtn = document.getElementById('sharePageBtn');
        const chatBtn = document.getElementById('supportChatBtn');
        if (sidebar) sidebar.style.display = '';
        if (mainContent && localStorage.getItem('isAdmin') !== '1') mainContent.style.display = '';
        if (adminDash && localStorage.getItem('isAdmin') === '1') adminDash.style.display = '';
        if (marketWatch) marketWatch.style.display = '';
        if (marketDrawer) marketDrawer.style.display = '';
        if (shareBtn) shareBtn.style.display = '';
        if (chatBtn) chatBtn.style.display = '';
    }
    function checkAuthAndToggle() {
        // Allow admin dashboard if admin
        if (localStorage.getItem('isAdmin') === '1') {
            showServices();
            return;
        }
        if (localStorage.getItem('isLoggedIn') === '1') {
            showServices();
        } else {
            hideServices();
        }
    }
    document.addEventListener('DOMContentLoaded', checkAuthAndToggle);
    document.addEventListener('click', function () {
        setTimeout(checkAuthAndToggle, 120);
    });
    window.addEventListener('storage', checkAuthAndToggle);
})();


/**
 * Prevent access to all services unless the user is registered (signed up/logged in).
 * If not authenticated, show only the Sign Up/Login modal and hide all main UI.
 * Uses localStorage "isLoggedIn" as the registration/authentication flag.
 */
(function enforceRegisteredUserAccess() {
    function hideAllServices() {
        const elements = [
            document.querySelector('.main-content'),
            document.getElementById('sidebar'),
            document.getElementById('adminDashboard'),
            document.getElementById('marketWatchPanel'),
            document.getElementById('marketWatchDrawerBtn'),
            document.getElementById('sharePageBtn'),
            document.getElementById('supportChatBtn')
        ];
        elements.forEach(el => { if (el) el.style.display = 'none'; });
    }
    function showAllServices() {
        const isAdmin = localStorage.getItem('isAdmin') === '1';
        const mainContent = document.querySelector('.main-content');
        const sidebar = document.getElementById('sidebar');
        const adminDash = document.getElementById('adminDashboard');
        const marketWatch = document.getElementById('marketWatchPanel');
        const marketDrawer = document.getElementById('marketWatchDrawerBtn');
        const shareBtn = document.getElementById('sharePageBtn');
        const chatBtn = document.getElementById('supportChatBtn');
        if (sidebar) sidebar.style.display = '';
        if (mainContent && !isAdmin) mainContent.style.display = '';
        if (adminDash) adminDash.style.display = isAdmin ? '' : 'none';
        if (marketWatch) marketWatch.style.display = '';
        if (marketDrawer) marketDrawer.style.display = '';
        if (shareBtn) shareBtn.style.display = '';
        if (chatBtn) chatBtn.style.display = '';
    }
    function showAuthModalIfNeeded() {
        if (localStorage.getItem('isLoggedIn') === '1' || localStorage.getItem('isAdmin') === '1') {
            // Authenticated: show UI, remove modal if present
            showAllServices();
            const modal = document.getElementById('forceAuthModal');
            if (modal) modal.remove();
        } else {
            // Not authenticated: hide UI, show modal
            hideAllServices();
            if (!document.getElementById('forceAuthModal')) {
                const modal = document.createElement('div');
                modal.id = 'forceAuthModal';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100vw';
                modal.style.height = '100vh';
                modal.style.background = 'rgba(0,0,0,0.32)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '9999';
                modal.innerHTML = `
                    <div style="background:#fff;padding:36px 28px 28px 28px;border-radius:14px;max-width:380px;width:96vw;box-shadow:0 4px 24px rgba(0,0,0,0.14);position:relative;text-align:center;">
                        <h2 style="color:#158173;margin-top:0;font-size:1.3em;">Registered Users Only</h2>
                        <p style="color:#3949ab;font-size:1.08em;margin-bottom:24px;">
                            Please <b>Sign Up</b> or <b>Login</b> to access our services.
                        </p>
                        <div style="display:flex;gap:18px;justify-content:center;">
                            <button id="forceAuthSignUpBtn" style="background:#158173;color:#fff;border:none;padding:12px 28px;border-radius:8px;font-size:1.08em;font-weight:700;cursor:pointer;">Sign Up</button>
                            <button id="forceAuthLoginBtn" style="background:#3949ab;color:#fff;border:none;padding:12px 28px;border-radius:8px;font-size:1.08em;font-weight:700;cursor:pointer;">Login</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                // Button logic: open Sign Up/Login modal
                modal.querySelector('#forceAuthSignUpBtn').onclick = function () {
                    modal.style.display = 'none';
                    if (typeof createHeaderModal === 'function') {
                        createHeaderModal({
                            id: 'authModal',
                            title: 'Sign Up / Login',
                            content: `
                                <div style="display:flex;gap:12px;margin-bottom:18px;">
                                <button id="tabSignUp" style="flex:1;background:#158173;color:#fff;border:none;padding:8px 0;border-radius:4px 0 0 4px;cursor:pointer;">Sign Up</button>
                                <button id="tabLogin" style="flex:1;background:#f4f7fa;color:#3949ab;border:none;padding:8px 0;border-radius:0 4px 4px 0;cursor:pointer;">Login</button>
                                </div>
                                <div id="authTabContent"></div>
                            `
                        });
                        setTimeout(() => {
                            const tabSignUp = document.getElementById('tabSignUp');
                            const tabLogin = document.getElementById('tabLogin');
                            const tabContent = document.getElementById('authTabContent');
                            function showSignUp() {
                                tabSignUp.style.background = '#158173';
                                tabSignUp.style.color = '#fff';
                                tabLogin.style.background = '#f4f7fa';
                                tabLogin.style.color = '#3949ab';
                                tabContent.innerHTML = `
                                <form id="signUpForm">
                                    <input type="text" name="fullname" placeholder="Full Name" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="email" name="email" placeholder="Email Address" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="text" name="country" placeholder="Country of Residence" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="tel" name="phone" placeholder="Phone Number" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="date" name="dob" placeholder="Date of Birth" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <div style="font-size:0.97em;color:#3949ab;margin-bottom:10px;">
                                        <b>Note:</b> Date of Birth must match your ID for verification.
                                    </div>
                                    <input type="password" name="password" placeholder="Password" required style="margin-bottom:16px;width:100%;padding:8px;">
                                    <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Sign Up</button>
                                </form>
                                <div id="signUpStatus" style="margin-top:12px;color:#3949ab;font-weight:500;display:none;"></div>
                                `;
                                document.getElementById('signUpForm').onsubmit = function(ev) {
                                    ev.preventDefault();
                                    localStorage.setItem('isLoggedIn', '1');
                                    document.getElementById('signUpStatus').style.display = 'block';
                                    document.getElementById('signUpStatus').textContent = 'Account created! You are now logged in.';
                                    setTimeout(() => {
                                        document.getElementById('authModal').style.display = 'none';
                                        showAllServices();
                                        const modal = document.getElementById('forceAuthModal');
                                        if (modal) modal.remove();
                                    }, 1000);
                                };
                            }
                            function showLogin() {
                                tabSignUp.style.background = '#f4f7fa';
                                tabSignUp.style.color = '#3949ab';
                                tabLogin.style.background = '#158173';
                                tabLogin.style.color = '#fff';
                                tabContent.innerHTML = `
                                <form id="loginForm">
                                    <input type="email" placeholder="Email" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="password" placeholder="Password" required style="margin-bottom:16px;width:100%;padding:8px;">
                                    <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Login</button>
                                </form>
                                <div id="loginStatus" style="margin-top:12px;color:#3949ab;font-weight:500;display:none;"></div>
                                `;
                                document.getElementById('loginForm').onsubmit = function(ev) {
                                    ev.preventDefault();
                                    localStorage.setItem('isLoggedIn', '1');
                                    document.getElementById('loginStatus').style.display = 'block';
                                    document.getElementById('loginStatus').textContent = 'Login successful! You are now logged in.';
                                    setTimeout(() => {
                                        document.getElementById('authModal').style.display = 'none';
                                        showAllServices();
                                        const modal = document.getElementById('forceAuthModal');
                                        if (modal) modal.remove();
                                    }, 1000);
                                };
                            }
                            tabSignUp.onclick = showSignUp;
                            tabLogin.onclick = showLogin;
                            showSignUp();
                        }, 100);
                    }
                };
                modal.querySelector('#forceAuthLoginBtn').onclick = function () {
                    modal.style.display = 'none';
                    if (typeof createHeaderModal === 'function') {
                        createHeaderModal({
                            id: 'authModal',
                            title: 'Sign Up / Login',
                            content: `
                                <div style="display:flex;gap:12px;margin-bottom:18px;">
                                <button id="tabSignUp" style="flex:1;background:#f4f7fa;color:#3949ab;border:none;padding:8px 0;border-radius:4px 0 0 4px;cursor:pointer;">Sign Up</button>
                                <button id="tabLogin" style="flex:1;background:#158173;color:#fff;border:none;padding:8px 0;border-radius:0 4px 4px 0;cursor:pointer;">Login</button>
                                </div>
                                <div id="authTabContent"></div>
                            `
                        });
                        setTimeout(() => {
                            const tabSignUp = document.getElementById('tabSignUp');
                            const tabLogin = document.getElementById('tabLogin');
                            const tabContent = document.getElementById('authTabContent');
                            function showSignUp() {
                                tabSignUp.style.background = '#158173';
                                tabSignUp.style.color = '#fff';
                                tabLogin.style.background = '#f4f7fa';
                                tabLogin.style.color = '#3949ab';
                                tabContent.innerHTML = `
                                <form id="signUpForm">
                                    <input type="text" name="fullname" placeholder="Full Name" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="email" name="email" placeholder="Email Address" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="text" name="country" placeholder="Country of Residence" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="tel" name="phone" placeholder="Phone Number" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="date" name="dob" placeholder="Date of Birth" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <div style="font-size:0.97em;color:#3949ab;margin-bottom:10px;">
                                        <b>Note:</b> Date of Birth must match your ID for verification.
                                    </div>
                                    <input type="password" name="password" placeholder="Password" required style="margin-bottom:16px;width:100%;padding:8px;">
                                    <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Sign Up</button>
                                </form>
                                <div id="signUpStatus" style="margin-top:12px;color:#3949ab;font-weight:500;display:none;"></div>
                                `;
                                document.getElementById('signUpForm').onsubmit = function(ev) {
                                    ev.preventDefault();
                                    localStorage.setItem('isLoggedIn', '1');
                                    document.getElementById('signUpStatus').style.display = 'block';
                                    document.getElementById('signUpStatus').textContent = 'Account created! You are now logged in.';
                                    setTimeout(() => {
                                        document.getElementById('authModal').style.display = 'none';
                                        showAllServices();
                                        const modal = document.getElementById('forceAuthModal');
                                        if (modal) modal.remove();
                                    }, 1000);
                                };
                            }
                            function showLogin() {
                                tabSignUp.style.background = '#f4f7fa';
                                tabSignUp.style.color = '#3949ab';
                                tabLogin.style.background = '#158173';
                                tabLogin.style.color = '#fff';
                                tabContent.innerHTML = `
                                <form id="loginForm">
                                    <input type="email" placeholder="Email" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="password" placeholder="Password" required style="margin-bottom:16px;width:100%;padding:8px;">
                                    <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Login</button>
                                </form>
                                <div id="loginStatus" style="margin-top:12px;color:#3949ab;font-weight:500;display:none;"></div>
                                `;
                                document.getElementById('loginForm').onsubmit = function(ev) {
                                    ev.preventDefault();
                                    localStorage.setItem('isLoggedIn', '1');
                                    document.getElementById('loginStatus').style.display = 'block';
                                    document.getElementById('loginStatus').textContent = 'Login successful! You are now logged in.';
                                    setTimeout(() => {
                                        document.getElementById('authModal').style.display = 'none';
                                        showAllServices();
                                        const modal = document.getElementById('forceAuthModal');
                                        if (modal) modal.remove();
                                    }, 1000);
                                };
                            }
                            tabSignUp.onclick = showSignUp;
                            tabLogin.onclick = showLogin;
                            showLogin();
                        }, 100);
                    }
                };
            }
        }
    }
    document.addEventListener('DOMContentLoaded', showAuthModalIfNeeded);
    document.addEventListener('click', function () {
        setTimeout(showAuthModalIfNeeded, 120);
    });
    window.addEventListener('storage', showAuthModalIfNeeded);
})();


/**
 * After logout, show the Sign Up/Login modal so user can access homepage again.
 */
(function showAuthAfterLogout() {
    // Patch all logout actions to show auth modal
    function openAuthModal() {
        if (typeof createHeaderModal === 'function') {
            createHeaderModal({
                id: 'authModal',
                title: 'Sign Up / Login',
                content: `
                    <div style="display:flex;gap:12px;margin-bottom:18px;">
                    <button id="tabSignUp" style="flex:1;background:#158173;color:#fff;border:none;padding:8px 0;border-radius:4px 0 0 4px;cursor:pointer;">Sign Up</button>
                    <button id="tabLogin" style="flex:1;background:#f4f7fa;color:#3949ab;border:none;padding:8px 0;border-radius:0 4px 4px 0;cursor:pointer;">Login</button>
                    </div>
                    <div id="authTabContent"></div>
                `
            });
            setTimeout(() => {
                const tabSignUp = document.getElementById('tabSignUp');
                const tabLogin = document.getElementById('tabLogin');
                const tabContent = document.getElementById('authTabContent');
                function showSignUp() {
                    tabSignUp.style.background = '#158173';
                    tabSignUp.style.color = '#fff';
                    tabLogin.style.background = '#f4f7fa';
                    tabLogin.style.color = '#3949ab';
                    tabContent.innerHTML = `
                    <form id="signUpForm">
                        <input type="text" name="fullname" placeholder="Full Name" required style="margin-bottom:10px;width:100%;padding:8px;">
                        <input type="email" name="email" placeholder="Email Address" required style="margin-bottom:10px;width:100%;padding:8px;">
                        <input type="text" name="country" placeholder="Country of Residence" required style="margin-bottom:10px;width:100%;padding:8px;">
                        <input type="tel" name="phone" placeholder="Phone Number" required style="margin-bottom:10px;width:100%;padding:8px;">
                        <input type="date" name="dob" placeholder="Date of Birth" required style="margin-bottom:10px;width:100%;padding:8px;">
                        <div style="font-size:0.97em;color:#3949ab;margin-bottom:10px;">
                            <b>Note:</b> Date of Birth must match your ID for verification.
                        </div>
                        <input type="password" name="password" placeholder="Password" required style="margin-bottom:16px;width:100%;padding:8px;">
                        <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Sign Up</button>
                    </form>
                    <div id="signUpStatus" style="margin-top:12px;color:#3949ab;font-weight:500;display:none;"></div>
                    `;
                    document.getElementById('signUpForm').onsubmit = function(ev) {
                        ev.preventDefault();
                        localStorage.setItem('isLoggedIn', '1');
                        document.getElementById('signUpStatus').style.display = 'block';
                        document.getElementById('signUpStatus').textContent = 'Account created! You are now logged in.';
                        setTimeout(() => {
                            document.getElementById('authModal').style.display = 'none';
                        }, 1000);
                    };
                }
                function showLogin() {
                    tabSignUp.style.background = '#f4f7fa';
                    tabSignUp.style.color = '#3949ab';
                    tabLogin.style.background = '#158173';
                    tabLogin.style.color = '#fff';
                    tabContent.innerHTML = `
                    <form id="loginForm">
                        <input type="email" placeholder="Email" required style="margin-bottom:10px;width:100%;padding:8px;">
                        <input type="password" placeholder="Password" required style="margin-bottom:16px;width:100%;padding:8px;">
                        <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Login</button>
                    </form>
                    <div id="loginStatus" style="margin-top:12px;color:#3949ab;font-weight:500;display:none;"></div>
                    `;
                    document.getElementById('loginForm').onsubmit = function(ev) {
                        ev.preventDefault();
                        localStorage.setItem('isLoggedIn', '1');
                        document.getElementById('loginStatus').style.display = 'block';
                        document.getElementById('loginStatus').textContent = 'Login successful! You are now logged in.';
                        setTimeout(() => {
                            document.getElementById('authModal').style.display = 'none';
                        }, 1000);
                    };
                }
                tabSignUp.onclick = showSignUp;
                tabLogin.onclick = showLogin;
                showLogin();
            }, 100);
        }
    }

    // Patch all logout buttons/links
    document.addEventListener('click', function (e) {
        // Sidebar/user menu logout
        if (e.target && (e.target.id === 'logoutMenu' || e.target.id === 'adminLogoutBtn')) {
            setTimeout(openAuthModal, 400);
        }
    });
})();

/**
 * Enforce authentication before accessing any services.
 * If not logged in, show only the Sign Up/Login modal and hide all main UI.
 * Uses localStorage "isLoggedIn" as the registration/authentication flag.
 */
(function enforceRegisteredUserAccess() {
    function hideAllServices() {
        const elements = [
            document.querySelector('.main-content'),
            document.getElementById('sidebar'),
            document.getElementById('adminDashboard'),
            document.getElementById('marketWatchPanel'),
            document.getElementById('marketWatchDrawerBtn'),
            document.getElementById('sharePageBtn'),
            document.getElementById('supportChatBtn')
        ];
        elements.forEach(el => { if (el) el.style.display = 'none'; });
    }
    function showAllServices() {
        const isAdmin = localStorage.getItem('isAdmin') === '1';
        const mainContent = document.querySelector('.main-content');
        const sidebar = document.getElementById('sidebar');
        const adminDash = document.getElementById('adminDashboard');
        const marketWatch = document.getElementById('marketWatchPanel');
        const marketDrawer = document.getElementById('marketWatchDrawerBtn');
        const shareBtn = document.getElementById('sharePageBtn');
        const chatBtn = document.getElementById('supportChatBtn');
        if (sidebar) sidebar.style.display = '';
        if (mainContent && !isAdmin) mainContent.style.display = '';
        if (adminDash) adminDash.style.display = isAdmin ? '' : 'none';
        if (marketWatch) marketWatch.style.display = '';
        if (marketDrawer) marketDrawer.style.display = '';
        if (shareBtn) shareBtn.style.display = '';
        if (chatBtn) chatBtn.style.display = '';
    }
    function showAuthModalIfNeeded() {
        if (localStorage.getItem('isLoggedIn') === '1' || localStorage.getItem('isAdmin') === '1') {
            // Authenticated: show UI, remove modal if present
            showAllServices();
            const modal = document.getElementById('forceAuthModal');
            if (modal) modal.remove();
        } else {
            // Not authenticated: hide UI, show modal
            hideAllServices();
            if (!document.getElementById('forceAuthModal')) {
                const modal = document.createElement('div');
                modal.id = 'forceAuthModal';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100vw';
                modal.style.height = '100vh';
                modal.style.background = 'rgba(0,0,0,0.32)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '9999';
                modal.innerHTML = `
                    <div style="background:#fff;padding:36px 28px 28px 28px;border-radius:14px;max-width:380px;width:96vw;box-shadow:0 4px 24px rgba(0,0,0,0.14);position:relative;text-align:center;">
                        <h2 style="color:#158173;margin-top:0;font-size:1.3em;">Registered Users Only</h2>
                        <p style="color:#3949ab;font-size:1.08em;margin-bottom:24px;">
                            Please <b>Sign Up</b> or <b>Login</b> to access our services.
                        </p>
                        <div style="display:flex;gap:18px;justify-content:center;">
                            <button id="forceAuthSignUpBtn" style="background:#158173;color:#fff;border:none;padding:12px 28px;border-radius:8px;font-size:1.08em;font-weight:700;cursor:pointer;">Sign Up</button>
                            <button id="forceAuthLoginBtn" style="background:#3949ab;color:#fff;border:none;padding:12px 28px;border-radius:8px;font-size:1.08em;font-weight:700;cursor:pointer;">Login</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                // Button logic: open Sign Up/Login modal
                modal.querySelector('#forceAuthSignUpBtn').onclick = function () {
                    modal.style.display = 'none';
                    if (typeof createHeaderModal === 'function') {
                        createHeaderModal({
                            id: 'authModal',
                            title: 'Sign Up / Login',
                            content: `
                                <div style="display:flex;gap:12px;margin-bottom:18px;">
                                <button id="tabSignUp" style="flex:1;background:#158173;color:#fff;border:none;padding:8px 0;border-radius:4px 0 0 4px;cursor:pointer;">Sign Up</button>
                                <button id="tabLogin" style="flex:1;background:#f4f7fa;color:#3949ab;border:none;padding:8px 0;border-radius:0 4px 4px 0;cursor:pointer;">Login</button>
                                </div>
                                <div id="authTabContent"></div>
                            `
                        });
                        setTimeout(() => {
                            const tabSignUp = document.getElementById('tabSignUp');
                            const tabLogin = document.getElementById('tabLogin');
                            const tabContent = document.getElementById('authTabContent');
                            function showSignUp() {
                                tabSignUp.style.background = '#158173';
                                tabSignUp.style.color = '#fff';
                                tabLogin.style.background = '#f4f7fa';
                                tabLogin.style.color = '#3949ab';
                                tabContent.innerHTML = `
                                <form id="signUpForm">
                                    <input type="text" name="fullname" placeholder="Full Name" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="email" name="email" placeholder="Email Address" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="text" name="country" placeholder="Country of Residence" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="tel" name="phone" placeholder="Phone Number" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="date" name="dob" placeholder="Date of Birth" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <div style="font-size:0.97em;color:#3949ab;margin-bottom:10px;">
                                        <b>Note:</b> Date of Birth must match your ID for verification.
                                    </div>
                                    <input type="password" name="password" placeholder="Password" required style="margin-bottom:16px;width:100%;padding:8px;">
                                    <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Sign Up</button>
                                </form>
                                <div id="signUpStatus" style="margin-top:12px;color:#3949ab;font-weight:500;display:none;"></div>
                                `;
                                document.getElementById('signUpForm').onsubmit = function(ev) {
                                    ev.preventDefault();
                                    localStorage.setItem('isLoggedIn', '1');
                                    document.getElementById('signUpStatus').style.display = 'block';
                                    document.getElementById('signUpStatus').textContent = 'Account created! You are now logged in.';
                                    setTimeout(() => {
                                        document.getElementById('authModal').style.display = 'none';
                                        showAllServices();
                                        const modal = document.getElementById('forceAuthModal');
                                        if (modal) modal.remove();
                                    }, 1000);
                                };
                            }
                            function showLogin() {
                                tabSignUp.style.background = '#f4f7fa';
                                tabSignUp.style.color = '#3949ab';
                                tabLogin.style.background = '#158173';
                                tabLogin.style.color = '#fff';
                                tabContent.innerHTML = `
                                <form id="loginForm">
                                    <input type="email" placeholder="Email" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="password" placeholder="Password" required style="margin-bottom:16px;width:100%;padding:8px;">
                                    <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Login</button>
                                </form>
                                <div id="loginStatus" style="margin-top:12px;color:#3949ab;font-weight:500;display:none;"></div>
                                `;
                                document.getElementById('loginForm').onsubmit = function(ev) {
                                    ev.preventDefault();
                                    localStorage.setItem('isLoggedIn', '1');
                                    document.getElementById('loginStatus').style.display = 'block';
                                    document.getElementById('loginStatus').textContent = 'Login successful! You are now logged in.';
                                    setTimeout(() => {
                                        document.getElementById('authModal').style.display = 'none';
                                        showAllServices();
                                        const modal = document.getElementById('forceAuthModal');
                                        if (modal) modal.remove();
                                    }, 1000);
                                };
                            }
                            tabSignUp.onclick = showSignUp;
                            tabLogin.onclick = showLogin;
                            showSignUp();
                        }, 100);
                    }
                };
                modal.querySelector('#forceAuthLoginBtn').onclick = function () {
                    modal.style.display = 'none';
                    if (typeof createHeaderModal === 'function') {
                        createHeaderModal({
                            id: 'authModal',
                            title: 'Sign Up / Login',
                            content: `
                                <div style="display:flex;gap:12px;margin-bottom:18px;">
                                <button id="tabSignUp" style="flex:1;background:#f4f7fa;color:#3949ab;border:none;padding:8px 0;border-radius:4px 0 0 4px;cursor:pointer;">Sign Up</button>
                                <button id="tabLogin" style="flex:1;background:#158173;color:#fff;border:none;padding:8px 0;border-radius:0 4px 4px 0;cursor:pointer;">Login</button>
                                </div>
                                <div id="authTabContent"></div>
                            `
                        });
                        setTimeout(() => {
                            const tabSignUp = document.getElementById('tabSignUp');
                            const tabLogin = document.getElementById('tabLogin');
                            const tabContent = document.getElementById('authTabContent');
                            function showSignUp() {
                                tabSignUp.style.background = '#158173';
                                tabSignUp.style.color = '#fff';
                                tabLogin.style.background = '#f4f7fa';
                                tabLogin.style.color = '#3949ab';
                                tabContent.innerHTML = `
                                <form id="signUpForm">
                                    <input type="text" name="fullname" placeholder="Full Name" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="email" name="email" placeholder="Email Address" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="text" name="country" placeholder="Country of Residence" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="tel" name="phone" placeholder="Phone Number" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="date" name="dob" placeholder="Date of Birth" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <div style="font-size:0.97em;color:#3949ab;margin-bottom:10px;">
                                        <b>Note:</b> Date of Birth must match your ID for verification.
                                    </div>
                                    <input type="password" name="password" placeholder="Password" required style="margin-bottom:16px;width:100%;padding:8px;">
                                    <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Sign Up</button>
                                </form>
                                <div id="signUpStatus" style="margin-top:12px;color:#3949ab;font-weight:500;display:none;"></div>
                                `;
                                document.getElementById('signUpForm').onsubmit = function(ev) {
                                    ev.preventDefault();
                                    localStorage.setItem('isLoggedIn', '1');
                                    document.getElementById('signUpStatus').style.display = 'block';
                                    document.getElementById('signUpStatus').textContent = 'Account created! You are now logged in.';
                                    setTimeout(() => {
                                        document.getElementById('authModal').style.display = 'none';
                                        showAllServices();
                                        const modal = document.getElementById('forceAuthModal');
                                        if (modal) modal.remove();
                                    }, 1000);
                                };
                            }
                            function showLogin() {
                                tabSignUp.style.background = '#f4f7fa';
                                tabSignUp.style.color = '#3949ab';
                                tabLogin.style.background = '#158173';
                                tabLogin.style.color = '#fff';
                                tabContent.innerHTML = `
                                <form id="loginForm">
                                    <input type="email" placeholder="Email" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="password" placeholder="Password" required style="margin-bottom:16px;width:100%;padding:8px;">
                                    <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Login</button>
                                </form>
                                <div id="loginStatus" style="margin-top:12px;color:#3949ab;font-weight:500;display:none;"></div>
                                `;
                                document.getElementById('loginForm').onsubmit = function(ev) {
                                    ev.preventDefault();
                                    localStorage.setItem('isLoggedIn', '1');
                                    document.getElementById('loginStatus').style.display = 'block';
                                    document.getElementById('loginStatus').textContent = 'Login successful! You are now logged in.';
                                    setTimeout(() => {
                                        document.getElementById('authModal').style.display = 'none';
                                        showAllServices();
                                        const modal = document.getElementById('forceAuthModal');
                                        if (modal) modal.remove();
                                    }, 1000);
                                };
                            }
                            tabSignUp.onclick = showSignUp;
                            tabLogin.onclick = showLogin;
                            showLogin();
                        }, 100);
                    }
                };
            }
        }
    }
    document.addEventListener('DOMContentLoaded', showAuthModalIfNeeded);
    document.addEventListener('click', function () {
        setTimeout(showAuthModalIfNeeded, 120);
    });
    window.addEventListener('storage', showAuthModalIfNeeded);
})();



/**
 * Prevent access to all services unless the user is registered (signed up/logged in).
 * If not authenticated, show only the Sign Up/Login modal and hide all main UI.
 * Uses localStorage "isLoggedIn" as the registration/authentication flag.
 */
(function enforceRegisteredUserAccess() {
    function hideAllServices() {
        const elements = [
            document.querySelector('.main-content'),
            document.getElementById('sidebar'),
            document.getElementById('adminDashboard'),
            document.getElementById('marketWatchPanel'),
            document.getElementById('marketWatchDrawerBtn'),
            document.getElementById('sharePageBtn'),
            document.getElementById('supportChatBtn')
        ];
        elements.forEach(el => { if (el) el.style.display = 'none'; });
    }
    function showAllServices() {
        const isAdmin = localStorage.getItem('isAdmin') === '1';
        const mainContent = document.querySelector('.main-content');
        const sidebar = document.getElementById('sidebar');
        const adminDash = document.getElementById('adminDashboard');
        const marketWatch = document.getElementById('marketWatchPanel');
        const marketDrawer = document.getElementById('marketWatchDrawerBtn');
        const shareBtn = document.getElementById('sharePageBtn');
        const chatBtn = document.getElementById('supportChatBtn');
        if (sidebar) sidebar.style.display = '';
        if (mainContent && !isAdmin) mainContent.style.display = '';
        if (adminDash) adminDash.style.display = isAdmin ? '' : 'none';
        if (marketWatch) marketWatch.style.display = '';
        if (marketDrawer) marketDrawer.style.display = '';
        if (shareBtn) shareBtn.style.display = '';
        if (chatBtn) chatBtn.style.display = '';
    }
    function showAuthModalIfNeeded() {
        if (localStorage.getItem('isLoggedIn') === '1' || localStorage.getItem('isAdmin') === '1') {
            // Authenticated: show UI, remove modal if present
            showAllServices();
            const modal = document.getElementById('forceAuthModal');
            if (modal) modal.remove();
        } else {
            // Not authenticated: hide UI, show modal
            hideAllServices();
            if (!document.getElementById('forceAuthModal')) {
                const modal = document.createElement('div');
                modal.id = 'forceAuthModal';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100vw';
                modal.style.height = '100vh';
                modal.style.background = 'rgba(0,0,0,0.32)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '9999';
                modal.innerHTML = `
                    <div style="background:#fff;padding:36px 28px 28px 28px;border-radius:14px;max-width:380px;width:96vw;box-shadow:0 4px 24px rgba(0,0,0,0.14);position:relative;text-align:center;">
                        <h2 style="color:#158173;margin-top:0;font-size:1.3em;">Registered Users Only</h2>
                        <p style="color:#3949ab;font-size:1.08em;margin-bottom:24px;">
                            Please <b>Sign Up</b> or <b>Login</b> to access our services.
                        </p>
                        <div style="display:flex;gap:18px;justify-content:center;">
                            <button id="forceAuthSignUpBtn" style="background:#158173;color:#fff;border:none;padding:12px 28px;border-radius:8px;font-size:1.08em;font-weight:700;cursor:pointer;">Sign Up</button>
                            <button id="forceAuthLoginBtn" style="background:#3949ab;color:#fff;border:none;padding:12px 28px;border-radius:8px;font-size:1.08em;font-weight:700;cursor:pointer;">Login</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                // Button logic: open Sign Up/Login modal
                modal.querySelector('#forceAuthSignUpBtn').onclick = function () {
                    modal.style.display = 'none';
                    if (typeof createHeaderModal === 'function') {
                        createHeaderModal({
                            id: 'authModal',
                            title: 'Sign Up / Login',
                            content: `
                                <div style="display:flex;gap:12px;margin-bottom:18px;">
                                <button id="tabSignUp" style="flex:1;background:#158173;color:#fff;border:none;padding:8px 0;border-radius:4px 0 0 4px;cursor:pointer;">Sign Up</button>
                                <button id="tabLogin" style="flex:1;background:#f4f7fa;color:#3949ab;border:none;padding:8px 0;border-radius:0 4px 4px 0;cursor:pointer;">Login</button>
                                </div>
                                <div id="authTabContent"></div>
                            `
                        });
                        setTimeout(() => {
                            const tabSignUp = document.getElementById('tabSignUp');
                            const tabLogin = document.getElementById('tabLogin');
                            const tabContent = document.getElementById('authTabContent');
                            function showSignUp() {
                                tabSignUp.style.background = '#158173';
                                tabSignUp.style.color = '#fff';
                                tabLogin.style.background = '#f4f7fa';
                                tabLogin.style.color = '#3949ab';
                                tabContent.innerHTML = `
                                <form id="signUpForm">
                                    <input type="text" name="fullname" placeholder="Full Name" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="email" name="email" placeholder="Email Address" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="text" name="country" placeholder="Country of Residence" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="tel" name="phone" placeholder="Phone Number" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="date" name="dob" placeholder="Date of Birth" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <div style="font-size:0.97em;color:#3949ab;margin-bottom:10px;">
                                        <b>Note:</b> Date of Birth must match your ID for verification.
                                    </div>
                                    <input type="password" name="password" placeholder="Password" required style="margin-bottom:16px;width:100%;padding:8px;">
                                    <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Sign Up</button>
                                </form>
                                <div id="signUpStatus" style="margin-top:12px;color:#3949ab;font-weight:500;display:none;"></div>
                                `;
                                document.getElementById('signUpForm').onsubmit = function(ev) {
                                    ev.preventDefault();
                                    localStorage.setItem('isLoggedIn', '1');
                                    document.getElementById('signUpStatus').style.display = 'block';
                                    document.getElementById('signUpStatus').textContent = 'Account created! You are now logged in.';
                                    setTimeout(() => {
                                        document.getElementById('authModal').style.display = 'none';
                                        showAllServices();
                                        const modal = document.getElementById('forceAuthModal');
                                        if (modal) modal.remove();
                                    }, 1000);
                                };
                            }
                            function showLogin() {
                                tabSignUp.style.background = '#f4f7fa';
                                tabSignUp.style.color = '#3949ab';
                                tabLogin.style.background = '#158173';
                                tabLogin.style.color = '#fff';
                                tabContent.innerHTML = `
                                <form id="loginForm">
                                    <input type="email" placeholder="Email" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="password" placeholder="Password" required style="margin-bottom:16px;width:100%;padding:8px;">
                                    <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Login</button>
                                </form>
                                <div id="loginStatus" style="margin-top:12px;color:#3949ab;font-weight:500;display:none;"></div>
                                `;
                                document.getElementById('loginForm').onsubmit = function(ev) {
                                    ev.preventDefault();
                                    localStorage.setItem('isLoggedIn', '1');
                                    document.getElementById('loginStatus').style.display = 'block';
                                    document.getElementById('loginStatus').textContent = 'Login successful! You are now logged in.';
                                    setTimeout(() => {
                                        document.getElementById('authModal').style.display = 'none';
                                        showAllServices();
                                        const modal = document.getElementById('forceAuthModal');
                                        if (modal) modal.remove();
                                    }, 1000);
                                };
                            }
                            tabSignUp.onclick = showSignUp;
                            tabLogin.onclick = showLogin;
                            showSignUp();
                        }, 100);
                    }
                };
                modal.querySelector('#forceAuthLoginBtn').onclick = function () {
                    modal.style.display = 'none';
                    if (typeof createHeaderModal === 'function') {
                        createHeaderModal({
                            id: 'authModal',
                            title: 'Sign Up / Login',
                            content: `
                                <div style="display:flex;gap:12px;margin-bottom:18px;">
                                <button id="tabSignUp" style="flex:1;background:#f4f7fa;color:#3949ab;border:none;padding:8px 0;border-radius:4px 0 0 4px;cursor:pointer;">Sign Up</button>
                                <button id="tabLogin" style="flex:1;background:#158173;color:#fff;border:none;padding:8px 0;border-radius:0 4px 4px 0;cursor:pointer;">Login</button>
                                </div>
                                <div id="authTabContent"></div>
                            `
                        });
                        setTimeout(() => {
                            const tabSignUp = document.getElementById('tabSignUp');
                            const tabLogin = document.getElementById('tabLogin');
                            const tabContent = document.getElementById('authTabContent');
                            function showSignUp() {
                                tabSignUp.style.background = '#158173';
                                tabSignUp.style.color = '#fff';
                                tabLogin.style.background = '#f4f7fa';
                                tabLogin.style.color = '#3949ab';
                                tabContent.innerHTML = `
                                <form id="signUpForm">
                                    <input type="text" name="fullname" placeholder="Full Name" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="email" name="email" placeholder="Email Address" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="text" name="country" placeholder="Country of Residence" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="tel" name="phone" placeholder="Phone Number" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="date" name="dob" placeholder="Date of Birth" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <div style="font-size:0.97em;color:#3949ab;margin-bottom:10px;">
                                        <b>Note:</b> Date of Birth must match your ID for verification.
                                    </div>
                                    <input type="password" name="password" placeholder="Password" required style="margin-bottom:16px;width:100%;padding:8px;">
                                    <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Sign Up</button>
                                </form>
                                <div id="signUpStatus" style="margin-top:12px;color:#3949ab;font-weight:500;display:none;"></div>
                                `;
                                document.getElementById('signUpForm').onsubmit = function(ev) {
                                    ev.preventDefault();
                                    localStorage.setItem('isLoggedIn', '1');
                                    document.getElementById('signUpStatus').style.display = 'block';
                                    document.getElementById('signUpStatus').textContent = 'Account created! You are now logged in.';
                                    setTimeout(() => {
                                        document.getElementById('authModal').style.display = 'none';
                                        showAllServices();
                                        const modal = document.getElementById('forceAuthModal');
                                        if (modal) modal.remove();
                                    }, 1000);
                                };
                            }
                            function showLogin() {
                                tabSignUp.style.background = '#f4f7fa';
                                tabSignUp.style.color = '#3949ab';
                                tabLogin.style.background = '#158173';
                                tabLogin.style.color = '#fff';
                                tabContent.innerHTML = `
                                <form id="loginForm">
                                    <input type="email" placeholder="Email" required style="margin-bottom:10px;width:100%;padding:8px;">
                                    <input type="password" placeholder="Password" required style="margin-bottom:16px;width:100%;padding:8px;">
                                    <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Login</button>
                                </form>
                                <div id="loginStatus" style="margin-top:12px;color:#3949ab;font-weight:500;display:none;"></div>
                                `;
                                document.getElementById('loginForm').onsubmit = function(ev) {
                                    ev.preventDefault();
                                    localStorage.setItem('isLoggedIn', '1');
                                    document.getElementById('loginStatus').style.display = 'block';
                                    document.getElementById('loginStatus').textContent = 'Login successful! You are now logged in.';
                                    setTimeout(() => {
                                        document.getElementById('authModal').style.display = 'none';
                                        showAllServices();
                                        const modal = document.getElementById('forceAuthModal');
                                        if (modal) modal.remove();
                                    }, 1000);
                                };
                            }
                            tabSignUp.onclick = showSignUp;
                            tabLogin.onclick = showLogin;
                            showLogin();
                        }, 100);
                    }
                };
            }
        }
    }
    document.addEventListener('DOMContentLoaded', showAuthModalIfNeeded);
    document.addEventListener('click', function () {
        setTimeout(showAuthModalIfNeeded, 120);
    });
    window.addEventListener('storage', showAuthModalIfNeeded);
})();

/**
 * If login fails (user not recognized), prompt user to sign up.
 * If login succeeds, redirect to homepage.
 */
(function handleUnknownUserLogin() {
    document.addEventListener('click', function () {
        setTimeout(() => {
            const loginForm = document.getElementById('loginForm');
            if (loginForm && !loginForm.dataset.unknownUserHandled) {
                loginForm.dataset.unknownUserHandled = '1';
                const origSubmit = loginForm.onsubmit;
                loginForm.onsubmit = function(ev) {
                    ev.preventDefault();
                    const email = loginForm.querySelector('input[type="email"]').value.trim().toLowerCase();
                    const password = loginForm.querySelector('input[type="password"]').value;
                    const status = document.getElementById('loginStatus');
                    // Demo user database (should match the one in enhanceLoginFormAuth)
                    const users = [
                        { email: 'john@example.com', password: 'john123', role: 'user' },
                        { email: 'jane@demo.com', password: 'jane456', role: 'user' },
                        { email: 'thebluetraders1@gmail.com', password: '25633', role: 'admin' },
                        { email: 'admin@demo.com', password: 'admin123', role: 'admin' }
                    ];
                    const user = users.find(u => u.email === email && u.password === password);
                    if (user) {
                        // Recognized user: proceed as normal
                        if (typeof origSubmit === 'function') return origSubmit.call(this, ev);
                    } else {
                        // Not recognized: prompt to sign up
                        status.style.display = 'block';
                        status.style.color = '#e53935';
                        status.textContent = 'User not found. Please sign up to create an account.';
                        setTimeout(() => {
                            // Open Sign Up tab/modal
                            if (typeof createHeaderModal === 'function') {
                                createHeaderModal({
                                    id: 'authModal',
                                    title: 'Sign Up / Login',
                                    content: `
                                        <div style="display:flex;gap:12px;margin-bottom:18px;">
                                        <button id="tabSignUp" style="flex:1;background:#158173;color:#fff;border:none;padding:8px 0;border-radius:4px 0 0 4px;cursor:pointer;">Sign Up</button>
                                        <button id="tabLogin" style="flex:1;background:#f4f7fa;color:#3949ab;border:none;padding:8px 0;border-radius:0 4px 4px 0;cursor:pointer;">Login</button>
                                        </div>
                                        <div id="authTabContent"></div>
                                    `
                                });
                                setTimeout(() => {
                                    const tabSignUp = document.getElementById('tabSignUp');
                                    const tabLogin = document.getElementById('tabLogin');
                                    const tabContent = document.getElementById('authTabContent');
                                    function showSignUp() {
                                        tabSignUp.style.background = '#158173';
                                        tabSignUp.style.color = '#fff';
                                        tabLogin.style.background = '#f4f7fa';
                                        tabLogin.style.color = '#3949ab';
                                        tabContent.innerHTML = `
                                        <form id="signUpForm">
                                            <input type="text" name="fullname" placeholder="Full Name" required style="margin-bottom:10px;width:100%;padding:8px;">
                                            <input type="email" name="email" placeholder="Email Address" required style="margin-bottom:10px;width:100%;padding:8px;" value="${email}">
                                            <input type="text" name="country" placeholder="Country of Residence" required style="margin-bottom:10px;width:100%;padding:8px;">
                                            <input type="tel" name="phone" placeholder="Phone Number" required style="margin-bottom:10px;width:100%;padding:8px;">
                                            <input type="date" name="dob" placeholder="Date of Birth" required style="margin-bottom:10px;width:100%;padding:8px;">
                                            <div style="font-size:0.97em;color:#3949ab;margin-bottom:10px;">
                                                <b>Note:</b> Date of Birth must match your ID for verification.
                                            </div>
                                            <input type="password" name="password" placeholder="Password" required style="margin-bottom:16px;width:100%;padding:8px;">
                                            <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Sign Up</button>
                                        </form>
                                        <div id="signUpStatus" style="margin-top:12px;color:#3949ab;font-weight:500;display:none;"></div>
                                        `;
                                        document.getElementById('signUpForm').onsubmit = function(ev) {
                                            ev.preventDefault();
                                            localStorage.setItem('isLoggedIn', '1');
                                            document.getElementById('signUpStatus').style.display = 'block';
                                            document.getElementById('signUpStatus').textContent = 'Account created! You are now logged in.';
                                            setTimeout(() => {
                                                document.getElementById('authModal').style.display = 'none';
                                                window.location.href = window.location.origin + window.location.pathname;
                                            }, 1000);
                                        };
                                    }
                                    function showLogin() {
                                        tabSignUp.style.background = '#f4f7fa';
                                        tabSignUp.style.color = '#3949ab';
                                        tabLogin.style.background = '#158173';
                                        tabLogin.style.color = '#fff';
                                        tabContent.innerHTML = `
                                        <form id="loginForm">
                                            <input type="email" placeholder="Email" required style="margin-bottom:10px;width:100%;padding:8px;">
                                            <input type="password" placeholder="Password" required style="margin-bottom:16px;width:100%;padding:8px;">
                                            <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Login</button>
                                        </form>
                                        <div id="loginStatus" style="margin-top:12px;color:#3949ab;font-weight:500;display:none;"></div>
                                        `;
                                    }
                                    tabSignUp.onclick = showSignUp;
                                    tabLogin.onclick = showLogin;
                                    showSignUp();
                                }, 100);
                            }
                        }, 800);
                    }
                };
            }
        }, 120);
    });
})();


/**
 * Add "Forgot Password?" option to login form for registered users.
 * When clicked, send a reset link to their registered email and allow password reset.
 */
(function enhanceForgotPassword() {
    // Helper: show forgot password modal
    function showForgotPasswordModal(emailPrefill = "") {
        // Prevent multiple modals
        if (document.getElementById('forgotPasswordModal')) return;
        const modal = document.createElement('div');
        modal.id = 'forgotPasswordModal';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100vw';
        modal.style.height = '100vh';
        modal.style.background = 'rgba(0,0,0,0.32)';
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.style.zIndex = '9999';
        modal.innerHTML = `
            <div style="background:#fff;padding:32px 24px;border-radius:12px;max-width:380px;width:100%;box-shadow:0 4px 24px rgba(0,0,0,0.14);position:relative;">
                <button id="closeForgotPasswordModalBtn" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#3949ab;">&times;</button>
                <h2 style="margin-top:0;color:#158173;font-size:1.2em;">Forgot Password</h2>
                <form id="forgotPasswordForm">
                    <label style="display:block;margin-bottom:8px;font-weight:500;">Enter your registered email:</label>
                    <input type="email" id="forgotPasswordEmail" required style="margin-bottom:16px;width:100%;padding:8px;" value="${emailPrefill}">
                    <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Send Reset Link</button>
                </form>
                <div id="forgotPasswordStatus" style="margin-top:14px;color:#3949ab;font-weight:500;display:none;"></div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.querySelector('#closeForgotPasswordModalBtn').onclick = () => {
            modal.style.display = 'none';
        };
        // Form logic
        modal.querySelector('#forgotPasswordForm').onsubmit = function(ev) {
            ev.preventDefault();
            const email = modal.querySelector('#forgotPasswordEmail').value.trim().toLowerCase();
            // Demo: check if email is registered (simulate with localStorage or demo users)
            const demoUsers = [
                'john@example.com',
                'jane@demo.com',
                'thebluetraders1@gmail.com',
                'admin@demo.com'
            ];
            const status = modal.querySelector('#forgotPasswordStatus');
            if (!demoUsers.includes(email)) {
                status.style.display = 'block';
                status.style.color = '#e53935';
                status.textContent = 'Email not found. Please check your email address.';
                return;
            }
            // Simulate sending reset link
            status.style.display = 'block';
            status.style.color = '#158173';
            status.textContent = 'A password reset link has been sent to your email.';
            // Store a reset token in localStorage (for demo)
            const token = 'reset-' + Math.random().toString(36).slice(2, 10);
            localStorage.setItem('resetToken-' + email, token);
            // Simulate email by showing a clickable link (for demo)
            setTimeout(() => {
                status.innerHTML = `A password reset link has been sent to <b>${email}</b>.<br>
                <span style="color:#3949ab;">(Demo: <a href="#" id="openResetLink" style="color:#158173;text-decoration:underline;">Click here to reset your password</a>)</span>`;
                // Attach click to open reset modal
                status.querySelector('#openResetLink').onclick = function(e) {
                    e.preventDefault();
                    modal.style.display = 'none';
                    showResetPasswordModal(email, token);
                };
            }, 1200);
        };
    }

    // Helper: show reset password modal
    function showResetPasswordModal(email, token) {
        // Validate token (demo)
        if (localStorage.getItem('resetToken-' + email) !== token) {
            alert('Invalid or expired reset link.');
            return;
        }
        // Prevent multiple modals
        if (document.getElementById('resetPasswordModal')) return;
        const modal = document.createElement('div');
        modal.id = 'resetPasswordModal';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100vw';
        modal.style.height = '100vh';
        modal.style.background = 'rgba(0,0,0,0.32)';
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.style.zIndex = '9999';
        modal.innerHTML = `
            <div style="background:#fff;padding:32px 24px;border-radius:12px;max-width:380px;width:100%;box-shadow:0 4px 24px rgba(0,0,0,0.14);position:relative;">
                <button id="closeResetPasswordModalBtn" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#3949ab;">&times;</button>
                <h2 style="margin-top:0;color:#158173;font-size:1.2em;">Reset Password</h2>
                <form id="resetPasswordForm">
                    <label style="display:block;margin-bottom:8px;font-weight:500;">New Password:</label>
                    <input type="password" id="resetNewPassword" required minlength="6" style="margin-bottom:12px;width:100%;padding:8px;">
                    <label style="display:block;margin-bottom:8px;font-weight:500;">Confirm Password:</label>
                    <input type="password" id="resetConfirmPassword" required minlength="6" style="margin-bottom:16px;width:100%;padding:8px;">
                    <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Reset Password</button>
                </form>
                <div id="resetPasswordStatus" style="margin-top:14px;color:#3949ab;font-weight:500;display:none;"></div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.querySelector('#closeResetPasswordModalBtn').onclick = () => {
            modal.style.display = 'none';
        };
        // Form logic
        modal.querySelector('#resetPasswordForm').onsubmit = function(ev) {
            ev.preventDefault();
            const newPass = modal.querySelector('#resetNewPassword').value;
            const confirmPass = modal.querySelector('#resetConfirmPassword').value;
            const status = modal.querySelector('#resetPasswordStatus');
            if (newPass !== confirmPass) {
                status.style.display = 'block';
                status.style.color = '#e53935';
                status.textContent = 'Passwords do not match.';
                return;
            }
            // Demo: update password in demo users (in real app, call backend)
            // For demo, just show success and clear token
            status.style.display = 'block';
            status.style.color = '#158173';
            status.textContent = 'Password reset successful! You can now log in with your new password.';
            localStorage.removeItem('resetToken-' + email);
            setTimeout(() => {
                modal.style.display = 'none';
            }, 1500);
        };
    }

    // Patch login form to add "Forgot Password?" link
    document.addEventListener('click', function () {
        setTimeout(() => {
            document.querySelectorAll('form#loginForm').forEach(form => {
                if (form.dataset.forgotEnhanced) return;
                form.dataset.forgotEnhanced = '1';
                // Only show for registered users (simulate: always show if login form is present)
                // Add "Forgot Password?" link below password input
                const pwdInput = form.querySelector('input[type="password"]');
                if (pwdInput && !form.querySelector('.forgot-password-link')) {
                    const link = document.createElement('a');
                    link.href = '#';
                    link.className = 'forgot-password-link';
                    link.textContent = 'Forgot Password?';
                    link.style.display = 'block';
                    link.style.margin = '0 0 12px 0';
                    link.style.color = '#158173';
                    link.style.fontWeight = '600';
                    link.style.textDecoration = 'underline';
                    link.style.fontSize = '0.98em';
                    pwdInput.parentNode.insertBefore(link, pwdInput.nextSibling);
                    link.onclick = function (e) {
                        e.preventDefault();
                        // Prefill email if entered
                        const emailInput = form.querySelector('input[type="email"]');
                        const emailVal = emailInput ? emailInput.value.trim() : "";
                        showForgotPasswordModal(emailVal);
                    };
                }
            });
        }, 120);
    });

    // For demo: allow direct access to reset modal via URL hash (simulate email link)
    window.addEventListener('DOMContentLoaded', function () {
        if (location.hash.startsWith('#reset-password-')) {
            const email = decodeURIComponent(location.hash.replace('#reset-password-', ''));
            const token = localStorage.getItem('resetToken-' + email);
            if (token) showResetPasswordModal(email, token);
        }
    });
})();

/**
 * Persist user authentication across system updates/reloads.
 * If the system is updated/reloaded, keep users logged in if they were already registered.
 * Uses localStorage "isLoggedIn" and "isAdmin" to persist login state.
 */
(function persistUserAuthOnUpdate() {
    // On page load, check if user was logged in before reload/update
    document.addEventListener('DOMContentLoaded', function () {
        // If user was logged in, keep them logged in
        if (localStorage.getItem('isLoggedIn') === '1' || localStorage.getItem('isAdmin') === '1') {
            // No action needed; UI logic elsewhere will show services
        }
        // If not logged in, show auth modal (handled by other logic)
    });

    // Listen for storage changes (multi-tab support)
    window.addEventListener('storage', function () {
        // If user logs in/out in another tab, update UI accordingly
        if (localStorage.getItem('isLoggedIn') === '1' || localStorage.getItem('isAdmin') === '1') {
            // No action needed; UI logic elsewhere will show services
        }
    });

    // Prevent accidental logout on reload/update
    window.addEventListener('beforeunload', function () {
        // Do not clear login state on reload/update
        // (No-op: login state is kept in localStorage)
    });
})();

(function recognizeAdminLogin2563() {
    document.addEventListener('click', function () {
        setTimeout(() => {
            const loginForm = document.getElementById('loginForm');
            if (loginForm && !loginForm.dataset.admin2563) {
                loginForm.dataset.admin2563 = '1';
                const origSubmit = loginForm.onsubmit;
                loginForm.onsubmit = function(ev) {
                    ev.preventDefault();
                    const email = loginForm.querySelector('input[type="email"]').value.trim().toLowerCase();
                    const password = loginForm.querySelector('input[type="password"]').value;
                    const status = document.getElementById('loginStatus');
                    if (email === 'thebluetraders1@gmail.com' && password === '2563') {
                        localStorage.setItem('isLoggedIn', '1');
                        localStorage.setItem('isAdmin', '1');
                        status.style.display = 'block';
                        status.textContent = 'Admin login successful! Redirecting to admin dashboard...';
                        setTimeout(() => {
                            const modal = loginForm.closest('[id$="Modal"]');
                            if (modal) modal.style.display = 'none';
                            if (typeof showAdminDashboard === 'function') showAdminDashboard();
                            const switchBtn = document.getElementById('dashboardSwitchBtn');
                            if (switchBtn) switchBtn.style.display = '';
                        }, 800);
                    } else if (typeof origSubmit === 'function') {
                        return origSubmit.call(this, ev);
                    }
                };
            }
        }, 120);
    });
})();


/**
 * After successful "Open Live Account", add the new account to the user's accounts table in "My Accounts" section.
 */
(function reflectNewLiveAccountInTable() {
    document.addEventListener('click', function () {
        setTimeout(() => {
            // Listen for account creation result
            const result = document.getElementById('liveAccResult');
            if (result && result.style.display !== 'none' && !result.dataset.accountReflected) {
                result.dataset.accountReflected = '1';
                // Extract account info from result HTML (as set in the modal)
                // We'll look for the account number, type, currency, leverage, and status
                // For demo, we assume the modal form had these fields:
                // #liveAccType, #liveAccCurrency, #liveAccLeverage, #liveAccPassword
                const type = document.getElementById('liveAccType')?.value || 'Standard';
                const currency = document.getElementById('liveAccCurrency')?.value || 'USD';
                const leverage = document.getElementById('liveAccLeverage')?.value || '1:500';
                // Account number and server are shown in the result
                const accNumMatch = result.innerHTML.match(/Account Number:\s*([A-Z0-9]+)/i);
                const accNum = accNumMatch ? accNumMatch[1] : 'MT5' + Math.floor(100000 + Math.random() * 900000);
                // Set initial balance for demo
                const balance = '$0.00';
                const status = 'Active';

                // Find the accounts table in main-content (My Accounts section)
                // Try to find a table with headings like "Account", "Type", etc.
                let table = null;
                document.querySelectorAll('.main-content table').forEach(t => {
                    const ths = t.querySelectorAll('thead th');
                    if (ths.length && Array.from(ths).some(th => /account/i.test(th.textContent))) {
                        table = t;
                    }
                });
                if (!table) return;

                // Check if account already exists in table
                const exists = Array.from(table.querySelectorAll('tbody tr')).some(tr =>
                    tr.textContent.includes(accNum)
                );
                if (exists) return;

                // Insert new row at top of tbody
                const tbody = table.querySelector('tbody');
                if (tbody) {
                    const row = document.createElement('tr');
                    // Try to match columns: Account, Type, Currency, Leverage, Balance, Status
                    row.innerHTML = `
                        <td style="padding:7px 6px;">${accNum}</td>
                        <td style="padding:7px 6px;">${type}</td>
                        <td style="padding:7px 6px;">${currency}</td>
                        <td style="padding:7px 6px;">${leverage}</td>
                        <td style="padding:7px 6px;">${balance}</td>
                        <td style="padding:7px 6px;">${status}</td>
                    `;
                    tbody.insertBefore(row, tbody.firstChild);
                }
            }
        }, 200);
    });
})();


/**
 * Add "View Details" button for each account in the user's accounts table.
 * When clicked, show a modal with account details.
 */
(function addAccountViewDetailsButton() {
    document.addEventListener('DOMContentLoaded', function () {
        setTimeout(() => {
            // Find the accounts table in main-content (My Accounts section)
            let table = null;
            document.querySelectorAll('.main-content table').forEach(t => {
                const ths = t.querySelectorAll('thead th');
                if (ths.length && Array.from(ths).some(th => /account/i.test(th.textContent))) {
                    table = t;
                }
            });
            if (!table || table.dataset.detailsEnhanced) return;
            table.dataset.detailsEnhanced = '1';

            // Add "View Details" button to each row (if not already present)
            table.querySelectorAll('tbody tr').forEach(row => {
                // Avoid duplicate buttons
                if (row.querySelector('.view-account-details-btn')) return;
                const td = document.createElement('td');
                const btn = document.createElement('button');
                btn.className = 'view-account-details-btn';
                btn.textContent = 'View Details';
                btn.style.background = '#158173';
                btn.style.color = '#fff';
                btn.style.border = 'none';
                btn.style.padding = '6px 16px';
                btn.style.borderRadius = '6px';
                btn.style.cursor = 'pointer';
                btn.style.fontWeight = '600';
                btn.onclick = function () {
                    // Gather account info from row
                    const tds = row.querySelectorAll('td');
                    const accNum = tds[0]?.textContent || '';
                    const type = tds[1]?.textContent || '';
                    const currency = tds[2]?.textContent || '';
                    const leverage = tds[3]?.textContent || '';
                    const balance = tds[4]?.textContent || '';
                    const status = tds[5]?.textContent || '';
                    // Show modal
                    let modal = document.getElementById('accountDetailsModal');
                    if (!modal) {
                        modal = document.createElement('div');
                        modal.id = 'accountDetailsModal';
                        modal.style.position = 'fixed';
                        modal.style.top = '0';
                        modal.style.left = '0';
                        modal.style.width = '100vw';
                        modal.style.height = '100vh';
                        modal.style.background = 'rgba(0,0,0,0.32)';
                        modal.style.display = 'flex';
                        modal.style.alignItems = 'center';
                        modal.style.justifyContent = 'center';
                        modal.style.zIndex = '5000';
                        modal.innerHTML = `
                            <div style="background:#fff;padding:32px 24px;border-radius:12px;max-width:380px;width:100%;box-shadow:0 4px 24px rgba(0,0,0,0.14);position:relative;">
                                <button id="closeAccountDetailsModalBtn" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#3949ab;">&times;</button>
                                <h2 style="margin-top:0;color:#158173;font-size:1.2em;">Account Details</h2>
                                <div id="accountDetailsContent"></div>
                            </div>
                        `;
                        document.body.appendChild(modal);
                        modal.querySelector('#closeAccountDetailsModalBtn').onclick = () => {
                            modal.style.display = 'none';
                        };
                    }
                    const content = modal.querySelector('#accountDetailsContent');
                    content.innerHTML = `
                        <ul style="list-style:none;padding:0;margin:0;">
                            <li><b>Account Number:</b> <span style="color:#3949ab;">${accNum}</span></li>
                            <li><b>Type:</b> ${type}</li>
                            <li><b>Currency:</b> ${currency}</li>
                            <li><b>Leverage:</b> ${leverage}</li>
                            <li><b>Balance:</b> ${balance}</li>
                            <li><b>Status:</b> ${status}</li>
                        </ul>
                    `;
                    modal.style.display = 'flex';
                };
                td.appendChild(btn);
                row.appendChild(td);
            });

            // Add header for the new column if not present
            const theadRow = table.querySelector('thead tr');
            if (theadRow && theadRow.children.length === table.querySelector('tbody tr')?.children.length - 1) {
                const th = document.createElement('th');
                th.textContent = 'Action';
                th.style.padding = '6px 4px';
                th.style.fontSize = '0.98em';
                th.style.textAlign = 'center';
                theadRow.appendChild(th);
            }
        }, 200);
    });
})();


/**
 * Clone features from sidebar "Accounts" table to main "My Accounts" table,
 * and allow users to view details of their created accounts.
 */
(function enhanceMyAccountsTable() {
    document.addEventListener('DOMContentLoaded', function () {
        setTimeout(() => {
            // Find sidebar accounts table (for features)
            let sidebarTable = null;
            document.querySelectorAll('#sidebar table').forEach(t => {
                const ths = t.querySelectorAll('thead th');
                if (ths.length && Array.from(ths).some(th => /account/i.test(th.textContent))) {
                    sidebarTable = t;
                }
            });
            // Find main accounts table
            let mainTable = null;
            document.querySelectorAll('.main-content table').forEach(t => {
                const ths = t.querySelectorAll('thead th');
                if (ths.length && Array.from(ths).some(th => /account/i.test(th.textContent))) {
                    mainTable = t;
                }
            });
            if (!mainTable) return;

            // Clone features: add status badge, action buttons, etc.
            if (!mainTable.dataset.sidebarFeatures) {
                mainTable.dataset.sidebarFeatures = '1';
                // Add status badge to each row
                mainTable.querySelectorAll('tbody tr').forEach(row => {
                    const tds = row.querySelectorAll('td');
                    if (tds.length >= 6 && !tds[5].querySelector('.acc-status-badge')) {
                        const status = tds[5].textContent.trim();
                        const badge = document.createElement('span');
                        badge.className = 'acc-status-badge';
                        badge.style.marginLeft = '8px';
                        badge.style.fontSize = '0.95em';
                        badge.style.fontWeight = '700';
                        badge.style.borderRadius = '8px';
                        badge.style.padding = '2px 10px';
                        badge.style.verticalAlign = 'middle';
                        if (/active/i.test(status)) {
                            badge.textContent = 'Active';
                            badge.style.background = '#e3fcec';
                            badge.style.color = '#158173';
                        } else if (/pending/i.test(status)) {
                            badge.textContent = 'Pending';
                            badge.style.background = '#fffde7';
                            badge.style.color = '#e53935';
                        } else {
                            badge.textContent = status;
                            badge.style.background = '#f4f7fa';
                            badge.style.color = '#3949ab';
                        }
                        tds[5].appendChild(badge);
                    }
                });
                // Add "View Details" button if not present
                mainTable.querySelectorAll('tbody tr').forEach(row => {
                    if (row.querySelector('.view-account-details-btn')) return;
                    const td = document.createElement('td');
                    const btn = document.createElement('button');
                    btn.className = 'view-account-details-btn';
                    btn.textContent = 'View Details';
                    btn.style.background = '#158173';
                    btn.style.color = '#fff';
                    btn.style.border = 'none';
                    btn.style.padding = '6px 16px';
                    btn.style.borderRadius = '6px';
                    btn.style.cursor = 'pointer';
                    btn.style.fontWeight = '600';
                    btn.onclick = function () {
                        const tds = row.querySelectorAll('td');
                        const accNum = tds[0]?.textContent || '';
                        const type = tds[1]?.textContent || '';
                        const currency = tds[2]?.textContent || '';
                        const leverage = tds[3]?.textContent || '';
                        const balance = tds[4]?.textContent || '';
                        const status = tds[5]?.textContent || '';
                        let modal = document.getElementById('accountDetailsModal');
                        if (!modal) {
                            modal = document.createElement('div');
                            modal.id = 'accountDetailsModal';
                            modal.style.position = 'fixed';
                            modal.style.top = '0';
                            modal.style.left = '0';
                            modal.style.width = '100vw';
                            modal.style.height = '100vh';
                            modal.style.background = 'rgba(0,0,0,0.32)';
                            modal.style.display = 'flex';
                            modal.style.alignItems = 'center';
                            modal.style.justifyContent = 'center';
                            modal.style.zIndex = '5000';
                            modal.innerHTML = `
                                <div style="background:#fff;padding:32px 24px;border-radius:12px;max-width:380px;width:100%;box-shadow:0 4px 24px rgba(0,0,0,0.14);position:relative;">
                                    <button id="closeAccountDetailsModalBtn" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#3949ab;">&times;</button>
                                    <h2 style="margin-top:0;color:#158173;font-size:1.2em;">Account Details</h2>
                                    <div id="accountDetailsContent"></div>
                                </div>
                            `;
                            document.body.appendChild(modal);
                            modal.querySelector('#closeAccountDetailsModalBtn').onclick = () => {
                                modal.style.display = 'none';
                            };
                        }
                        const content = modal.querySelector('#accountDetailsContent');
                        content.innerHTML = `
                            <ul style="list-style:none;padding:0;margin:0;">
                                <li><b>Account Number:</b> <span style="color:#3949ab;">${accNum}</span></li>
                                <li><b>Type:</b> ${type}</li>
                                <li><b>Currency:</b> ${currency}</li>
                                <li><b>Leverage:</b> ${leverage}</li>
                                <li><b>Balance:</b> ${balance}</li>
                                <li><b>Status:</b> ${status}</li>
                            </ul>
                        `;
                        modal.style.display = 'flex';
                    };
                    td.appendChild(btn);
                    row.appendChild(td);
                });
                // Add header for the new column if not present
                const theadRow = mainTable.querySelector('thead tr');
                if (theadRow && theadRow.children.length === mainTable.querySelector('tbody tr')?.children.length - 1) {
                    const th = document.createElement('th');
                    th.textContent = 'Action';
                    th.style.padding = '6px 4px';
                    th.style.fontSize = '0.98em';
                    th.style.textAlign = 'center';
                    theadRow.appendChild(th);
                }
            }
        }, 200);
    });
})();


/**
 * Hide demo accounts and total balance for new users until they create their own accounts.
 * - On My Accounts table (homepage): show only user's created accounts.
 * - On sidebar accounts section: show only user's created accounts.
 * - In header: hide total balance if user has no accounts.
 * If user has not created any account, show empty tables and hide balances.
 */
(function hideDemoAndTotalForNewUsers() {
    // Helper: check if user has created any account (simulate by checking main table rows that are not demo)
    function userHasOwnAccounts() {
        let hasOwn = false;
        document.querySelectorAll('.main-content table').forEach(t => {
            const ths = t.querySelectorAll('thead th');
            if (ths.length && Array.from(ths).some(th => /account/i.test(th.textContent))) {
                t.querySelectorAll('tbody tr').forEach(tr => {
                    // If row is not demo (e.g., not contains DEMO or Demo in account number/type)
                    const tds = tr.querySelectorAll('td');
                    if (tds.length && !/demo/i.test(tds[0].textContent + ' ' + (tds[1]?.textContent || ''))) {
                        hasOwn = true;
                    }
                });
            }
        });
        return hasOwn;
    }

    // Remove demo accounts from tables
    function filterTables() {
        // Main accounts table
        document.querySelectorAll('.main-content table').forEach(t => {
            const ths = t.querySelectorAll('thead th');
            if (ths.length && Array.from(ths).some(th => /account/i.test(th.textContent))) {
                let anyOwn = false;
                t.querySelectorAll('tbody tr').forEach(tr => {
                    const tds = tr.querySelectorAll('td');
                    // Hide row if demo
                    if (tds.length && /demo/i.test(tds[0].textContent + ' ' + (tds[1]?.textContent || ''))) {
                        tr.style.display = 'none';
                    } else {
                        // Show only user's own accounts
                        tr.style.display = '';
                        anyOwn = true;
                    }
                });
                // If no own accounts, show empty message
                if (!anyOwn) {
                    let emptyRow = t.querySelector('tbody .no-accounts-row');
                    if (!emptyRow) {
                        emptyRow = document.createElement('tr');
                        emptyRow.className = 'no-accounts-row';
                        const td = document.createElement('td');
                        td.colSpan = ths.length;
                        td.style.textAlign = 'center';
                        td.style.color = '#3949ab';
                        td.style.fontWeight = '600';
                        td.style.padding = '24px 0';
                        td.textContent = 'No accounts found. Create your first account to get started.';
                        emptyRow.appendChild(td);
                        t.querySelector('tbody').appendChild(emptyRow);
                    }
                } else {
                    // Remove empty message if present
                    const emptyRow = t.querySelector('tbody .no-accounts-row');
                    if (emptyRow) emptyRow.remove();
                }
            }
        });

        // Sidebar accounts table
        document.querySelectorAll('#sidebar table').forEach(t => {
            const ths = t.querySelectorAll('thead th');
            if (ths.length && Array.from(ths).some(th => /account/i.test(th.textContent))) {
                let anyOwn = false;
                t.querySelectorAll('tbody tr').forEach(tr => {
                    const tds = tr.querySelectorAll('td');
                    if (tds.length && /demo/i.test(tds[0].textContent + ' ' + (tds[1]?.textContent || ''))) {
                        tr.style.display = 'none';
                    } else {
                        tr.style.display = '';
                        anyOwn = true;
                    }
                });
                // If no own accounts, show empty message
                if (!anyOwn) {
                    let emptyRow = t.querySelector('tbody .no-accounts-row');
                    if (!emptyRow) {
                        emptyRow = document.createElement('tr');
                        emptyRow.className = 'no-accounts-row';
                        const td = document.createElement('td');
                        td.colSpan = ths.length;
                        td.style.textAlign = 'center';
                        td.style.color = '#3949ab';
                        td.style.fontWeight = '600';
                        td.style.padding = '18px 0';
                        td.textContent = 'No accounts yet.';
                        emptyRow.appendChild(td);
                        t.querySelector('tbody').appendChild(emptyRow);
                    }
                } else {
                    const emptyRow = t.querySelector('tbody .no-accounts-row');
                    if (emptyRow) emptyRow.remove();
                }
            }
        });
    }

    // Hide total balance in header if user has no accounts
    function updateHeaderBalance() {
        const hasOwn = userHasOwnAccounts();
        const balanceSpan = document.getElementById('accountBalance');
        if (balanceSpan) {
            balanceSpan.style.display = hasOwn ? '' : 'none';
        }
    }

    // Run on load and after account creation
    function run() {
        filterTables();
        updateHeaderBalance();
    }

    document.addEventListener('DOMContentLoaded', run);
    document.addEventListener('click', function () {
        setTimeout(run, 200);
    });
    window.addEventListener('storage', run);
})();

/**
 * Organize accounts tables in both main-content (homepage) and sidebar.
 * - Add consistent columns: Account Number, Type, Currency, Leverage, Balance, Status, Action.
 * - Add table headers if missing.
 * - Apply consistent styles.
 * - Sort accounts by creation (newest first).
 */
(function organizeAccountsTables() {
    function organizeTable(table) {
        if (!table || table.dataset.organized) return;
        table.dataset.organized = '1';

        // Define columns
        const columns = [
            { key: 'account', label: 'Account Number' },
            { key: 'type', label: 'Type' },
            { key: 'currency', label: 'Currency' },
            { key: 'leverage', label: 'Leverage' },
            { key: 'balance', label: 'Balance' },
            { key: 'status', label: 'Status' },
            { key: 'action', label: 'Action' }
        ];

        // Add thead if missing
        let thead = table.querySelector('thead');
        if (!thead) {
            thead = document.createElement('thead');
            const tr = document.createElement('tr');
            columns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col.label;
                th.style.padding = '8px 6px';
                th.style.background = '#f4f7fa';
                th.style.fontWeight = '700';
                th.style.color = '#3949ab';
                th.style.fontSize = '1.02em';
                tr.appendChild(th);
            });
            thead.appendChild(tr);
            table.insertBefore(thead, table.firstChild);
        }

        // Style table
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.style.background = '#fff';
        table.style.boxShadow = '0 1px 4px rgba(0,0,0,0.04)';
        table.style.borderRadius = '8px';
        table.style.overflow = 'hidden';

        // Organize tbody rows
        let tbody = table.querySelector('tbody');
        if (!tbody) {
            tbody = document.createElement('tbody');
            table.appendChild(tbody);
        }
        // Gather rows and sort by account number (descending, newest first if numeric)
        let rows = Array.from(tbody.querySelectorAll('tr')).filter(tr => !tr.classList.contains('no-accounts-row'));
        rows.sort((a, b) => {
            const aNum = a.querySelector('td')?.textContent.match(/\d+/);
            const bNum = b.querySelector('td')?.textContent.match(/\d+/);
            return (bNum ? +bNum[0] : 0) - (aNum ? +aNum[0] : 0);
        });
        // Re-append sorted rows
        rows.forEach(tr => tbody.appendChild(tr));

        // Style rows and cells
        rows.forEach(tr => {
            tr.style.background = '#fff';
            tr.querySelectorAll('td').forEach(td => {
                td.style.padding = '7px 6px';
                td.style.fontSize = '1em';
                td.style.borderBottom = '1px solid #f4f7fa';
            });
        });
    }

    // Organize main-content accounts table(s)
    document.querySelectorAll('.main-content table').forEach(organizeTable);
    // Organize sidebar accounts table(s)
    document.querySelectorAll('#sidebar table').forEach(organizeTable);
    // Re-run after DOM changes
    document.addEventListener('click', function () {
        setTimeout(() => {
            document.querySelectorAll('.main-content table').forEach(organizeTable);
            document.querySelectorAll('#sidebar table').forEach(organizeTable);
        }, 200);
    });
})();



/**
 * Make the platform fully responsive for all devices (Android, iPhone, tablets, etc.).
 * Show a sidebar toggle (hamburger) on small screens, and ensure all features are accessible.
 */
(function responsivePlatformUniversal() {
    // Responsive CSS for all devices
    const style = document.createElement('style');
    style.textContent = `
        @media (max-width: 900px) {
            .sidebar {
                width: 220px;
                transform: translateX(-100%);
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 1202;
                position: fixed !important;
                background: #fff !important;
                box-shadow: 2px 0 12px #3949ab11;
                transition: transform 0.3s cubic-bezier(.4,0,.2,1);
            }
            .sidebar.show {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0 !important;
                padding: 12px 4vw !important;
            }
            header {
                padding: 0 12px !important;
            }
            #volatility-animations {
                flex-direction: column !important;
                gap: 18px !important;
                padding: 10px 0 10px 0 !important;
            }
            #marketWatchPanel, #marketWatchDrawerBtn {
                display: none !important;
            }
            #mobileMenuBtn {
                display: block !important;
            }
        }
        @media (max-width: 600px) {
            .main-content {
                padding: 8px 2vw !important;
            }
            section[style*="linear-gradient"] {
                padding: 32px 8px 24px 8px !important;
                font-size: 1em !important;
            }
            section[style*="display: flex"] {
                flex-direction: column !important;
                gap: 18px !important;
            }
            section[style*="What our clients say"] {
                padding: 18px 4px 10px 4px !important;
            }
            #themeColorShowcase {
                padding: 18px 4vw 12px 4vw !important;
            }
        }
    `;
    document.head.appendChild(style);

    // Sidebar overlay for mobile/tablet
    let overlay = document.getElementById('sidebarOverlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'sidebarOverlay';
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100vw';
        overlay.style.height = '100vh';
        overlay.style.background = 'rgba(0,0,0,0.32)';
        overlay.style.zIndex = '1201';
        overlay.style.display = 'none';
        overlay.onclick = function () {
            document.querySelector('.sidebar')?.classList.remove('show');
            overlay.style.display = 'none';
        };
        document.body.appendChild(overlay);
    }

    // Hamburger menu toggle for sidebar
    let menuBtn = document.getElementById('mobileMenuBtn');
    if (!menuBtn) {
        menuBtn = document.createElement('button');
        menuBtn.id = 'mobileMenuBtn';
        menuBtn.title = 'Menu';
        menuBtn.style.position = 'fixed';
        menuBtn.style.left = '18px';
        menuBtn.style.top = '18px';
        menuBtn.style.width = '48px';
        menuBtn.style.height = '48px';
        menuBtn.style.background = '#158173';
        menuBtn.style.color = '#fff';
        menuBtn.style.border = 'none';
        menuBtn.style.borderRadius = '12px';
        menuBtn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.12)';
        menuBtn.style.cursor = 'pointer';
        menuBtn.style.zIndex = '1203';
        menuBtn.style.display = 'none';
        menuBtn.innerHTML = `<svg width="32" height="32" fill="none" viewBox="0 0 24 24"><rect y="4" width="24" height="2" rx="1" fill="#fff"/><rect y="11" width="24" height="2" rx="1" fill="#fff"/><rect y="18" width="24" height="2" rx="1" fill="#fff"/></svg>`;
        document.body.appendChild(menuBtn);
    }

    // Show/hide sidebar logic
    menuBtn.onclick = function () {
        const sidebar = document.querySelector('.sidebar');
        if (!sidebar) return;
        if (sidebar.classList.contains('show')) {
            sidebar.classList.remove('show');
            overlay.style.display = 'none';
        } else {
            sidebar.classList.add('show');
            overlay.style.display = 'block';
        }
    };

    // Hide sidebar when resizing to desktop
    window.addEventListener('resize', function () {
        if (window.innerWidth > 900) {
            document.querySelector('.sidebar')?.classList.remove('show');
            overlay.style.display = 'none';
        }
    });

    // Hide sidebar on nav link click (mobile)
    document.querySelectorAll('.sidebar ul li a').forEach(link => {
        link.addEventListener('click', function () {
            if (window.innerWidth <= 900) {
                document.querySelector('.sidebar')?.classList.remove('show');
                overlay.style.display = 'none';
            }
        });
    });

    // Show/hide menu button based on screen size
    function updateMenuBtn() {
        menuBtn.style.display = window.innerWidth <= 900 ? '' : 'none';
    }
    window.addEventListener('resize', updateMenuBtn);
    document.addEventListener('DOMContentLoaded', updateMenuBtn);
    setTimeout(updateMenuBtn, 200);
})();




/**
 * Monetize site visits: convert user internet usage (MB) to USD and credit to main system account.
 * - Estimate MBs used per visit/activity (demo: random 1-5 MB per page load/click).
 * - Convert MBs to USD (e.g., 1MB = $0.01, configurable).
 * - Add to "Main System Account" in admin dashboard.
 * - Show earnings details in admin dashboard: total earned, recent site visit earnings.
 */
(function monetizeInternetUsage() {
    // Conversion rate: 1 MB = $0.01 (adjust as needed)
    const MB_TO_USD = 0.01;

    // Helper: simulate MBs used for an activity
    function estimateMBsUsed() {
        // For demo, random between 1 and 5 MB per activity
        return Math.floor(Math.random() * 5) + 1;
    }

    // Helper: record earning in localStorage
    function recordSiteEarning(mb, usd, activity) {
        const now = new Date();
        const earning = {
            date: now.toISOString(),
            mb,
            usd,
            activity
        };
        let earnings = [];
        try {
            earnings = JSON.parse(localStorage.getItem('siteVisitEarnings') || '[]');
        } catch {}
        earnings.unshift(earning);
        // Keep only last 50 records
        earnings = earnings.slice(0, 50);
        localStorage.setItem('siteVisitEarnings', JSON.stringify(earnings));
        // Update total
        let total = parseFloat(localStorage.getItem('siteVisitEarningsTotal') || '0');
        total += usd;
        localStorage.setItem('siteVisitEarningsTotal', total.toFixed(2));
    }

    // On each page load/activity, simulate earning
    function creditEarning(activity) {
        const mb = estimateMBsUsed();
        const usd = +(mb * MB_TO_USD).toFixed(2);
        recordSiteEarning(mb, usd, activity);
    }

    // Credit on page load
    document.addEventListener('DOMContentLoaded', function () {
        creditEarning('Page Load');
    });
    // Credit on major user actions (clicks)
    document.addEventListener('click', function (e) {
        // Only count meaningful actions (not every click)
        const tag = (e.target.tagName || '').toLowerCase();
        if (['button', 'a', 'input', 'form', 'select'].includes(tag)) {
            creditEarning('User Action: ' + tag);
        }
    });

    // Patch admin dashboard to show site earnings in "Main System Account"
    function updateAdminMainAccountEarnings() {
        // Only if admin dashboard is present
        const adminDash = document.getElementById('adminDashboard');
        if (!adminDash) return;
        // Find "All Accounts" table and main account row
        const table = Array.from(adminDash.querySelectorAll('table')).find(t =>
            t.querySelector('thead') && /Account/i.test(t.querySelector('thead').textContent)
        );
        if (!table) return;
        const mainRow = Array.from(table.querySelectorAll('tbody tr')).find(tr =>
            tr.textContent.includes('MAIN') || tr.textContent.includes('System Total')
        );
        if (!mainRow) return;
        // Get total earnings
        const total = parseFloat(localStorage.getItem('siteVisitEarningsTotal') || '0');
        // Add/Update "Earned from Site Visits" cell
        let cell = mainRow.querySelector('.site-earnings-cell');
        if (!cell) {
            cell = document.createElement('td');
            cell.className = 'site-earnings-cell';
            cell.colSpan = 2;
            cell.style.fontWeight = '700';
            cell.style.color = '#158173';
            mainRow.appendChild(cell);
        }
        cell.innerHTML = `Site Visits: <span style="color:#e53935;">$${total.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</span>`;

        // Add "View Details" button if not present
        if (!adminDash.querySelector('#viewSiteEarningsBtn')) {
            const btn = document.createElement('button');
            btn.id = 'viewSiteEarningsBtn';
            btn.textContent = 'View Site Earnings Details';
            btn.style.background = '#3949ab';
            btn.style.color = '#fff';
            btn.style.border = 'none';
            btn.style.padding = '7px 18px';
            btn.style.borderRadius = '6px';
            btn.style.cursor = 'pointer';
            btn.style.fontWeight = '700';
            btn.style.marginLeft = '18px';
            cell.appendChild(btn);

            btn.onclick = function () {
                // Show modal with earnings details
                let modal = document.getElementById('siteEarningsModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'siteEarningsModal';
                    modal.style.position = 'fixed';
                    modal.style.top = '0';
                    modal.style.left = '0';
                    modal.style.width = '100vw';
                    modal.style.height = '100vh';
                    modal.style.background = 'rgba(0,0,0,0.32)';
                    modal.style.display = 'flex';
                    modal.style.alignItems = 'center';
                    modal.style.justifyContent = 'center';
                    modal.style.zIndex = '9999';
                    modal.innerHTML = `
                        <div style="background:#fff;padding:32px 24px;border-radius:12px;max-width:520px;width:96vw;box-shadow:0 4px 24px rgba(0,0,0,0.14);position:relative;">
                            <button id="closeSiteEarningsModalBtn" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#3949ab;">&times;</button>
                            <h2 style="margin-top:0;color:#158173;font-size:1.2em;">Site Visit Earnings</h2>
                            <div id="siteEarningsContent"></div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    modal.querySelector('#closeSiteEarningsModalBtn').onclick = () => {
                        modal.style.display = 'none';
                    };
                }
                // Fill details
                const earnings = JSON.parse(localStorage.getItem('siteVisitEarnings') || '[]');
                const total = parseFloat(localStorage.getItem('siteVisitEarningsTotal') || '0');
                let html = `<div style="margin-bottom:10px;font-weight:600;color:#3949ab;">
                    Total earned from site visits: <span style="color:#e53935;">$${total.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</span>
                </div>`;
                if (earnings.length) {
                    html += `<table style="width:100%;border-collapse:collapse;background:#fff;box-shadow:0 1px 4px #3949ab11;">
                        <thead>
                            <tr style="background:#f4f7fa;">
                                <th style="padding:6px 4px;">Date</th>
                                <th style="padding:6px 4px;">Activity</th>
                                <th style="padding:6px 4px;">MB Used</th>
                                <th style="padding:6px 4px;">USD Earned</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${earnings.slice(0, 30).map(e => `
                                <tr>
                                    <td style="padding:6px 4px;">${new Date(e.date).toLocaleString()}</td>
                                    <td style="padding:6px 4px;">${e.activity}</td>
                                    <td style="padding:6px 4px;text-align:right;">${e.mb}</td>
                                    <td style="padding:6px 4px;text-align:right;color:#158173;">$${e.usd.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>`;
                } else {
                    html += `<div style="color:#3949ab;">No site visit earnings recorded yet.</div>`;
                }
                document.getElementById('siteEarningsContent').innerHTML = html;
                document.getElementById('siteEarningsModal').style.display = 'flex';
            };
        }
    }

    // Update admin dashboard when shown
    document.addEventListener('DOMContentLoaded', function () {
        setTimeout(updateAdminMainAccountEarnings, 400);
    });
    document.addEventListener('click', function () {
        setTimeout(updateAdminMainAccountEarnings, 400);
    });
    window.addEventListener('storage', updateAdminMainAccountEarnings);
})();

/**
 * Enhance Site Earnings Details modal: add Exit button and scrollable content.
 */
(function enhanceSiteEarningsModal() {
    document.addEventListener('click', function () {
        setTimeout(() => {
            const modal = document.getElementById('siteEarningsModal');
            if (modal && !modal.dataset.enhanced) {
                modal.dataset.enhanced = '1';
                // Add Exit button if not present
                if (!modal.querySelector('#exitSiteEarningsModalBtn')) {
                    const exitBtn = document.createElement('button');
                    exitBtn.id = 'exitSiteEarningsModalBtn';
                    exitBtn.textContent = 'Exit';
                    exitBtn.style.background = '#e53935';
                    exitBtn.style.color = '#fff';
                    exitBtn.style.border = 'none';
                    exitBtn.style.padding = '8px 24px';
                    exitBtn.style.borderRadius = '6px';
                    exitBtn.style.fontWeight = '700';
                    exitBtn.style.cursor = 'pointer';
                    exitBtn.style.position = 'absolute';
                    exitBtn.style.bottom = '18px';
                    exitBtn.style.right = '32px';
                    exitBtn.style.zIndex = '2';
                    exitBtn.onclick = function () {
                        modal.style.display = 'none';
                    };
                    modal.appendChild(exitBtn);
                }
                // Make content scrollable if not already
                const content = modal.querySelector('#siteEarningsContent');
                if (content) {
                    content.style.maxHeight = '340px';
                    content.style.overflowY = 'auto';
                    content.style.marginBottom = '48px';
                }
            }
        }, 120);
    });
})();


/**
 * Show actual withdrawable balance for MAIN account (excluding demo funds) in admin Withdraw modal.
 */
(function showMainAccountWithdrawableBalance() {
    document.addEventListener('click', function () {
        setTimeout(() => {
            if (
                localStorage.getItem('isAdmin') === '1' &&
                document.getElementById('withdrawModal') &&
                document.getElementById('withdrawForm')
            ) {
                const form = document.getElementById('withdrawForm');
                // Only patch if not already done
                if (!form.dataset.mainBalanceShown) {
                    form.dataset.mainBalanceShown = '1';
                    // Find the "From Account" select
                    const selects = form.querySelectorAll('select');
                    let fromAccountSelect = null;
                    selects.forEach(sel => {
                        if (
                            Array.from(sel.options).some(opt => /main/i.test(opt.textContent))
                        ) {
                            fromAccountSelect = sel;
                        }
                    });
                    if (fromAccountSelect) {
                        fromAccountSelect.addEventListener('change', function () {
                            // Remove previous balance info
                            let info = form.querySelector('.main-account-balance-info');
                            if (info) info.remove();
                            // If MAIN selected, show actual withdrawable balance
                            if (/main/i.test(fromAccountSelect.value)) {
                                // Calculate actual withdrawable balance (exclude demo funds)
                                let total = 0;
                                // Find all accounts in admin dashboard table
                                let adminDash = document.getElementById('adminDashboard');
                                let table = adminDash && Array.from(adminDash.querySelectorAll('table')).find(t =>
                                    t.querySelector('thead') && /Account/i.test(t.querySelector('thead').textContent)
                                );
                                if (table) {
                                    table.querySelectorAll('tbody tr').forEach(row => {
                                        const tds = row.querySelectorAll('td');
                                        if (tds.length >= 4) {
                                            const accNum = tds[0].textContent.trim();
                                            const type = tds[1]?.textContent.trim() || '';
                                            const balanceStr = tds[3]?.textContent || tds[4]?.textContent || '';
                                            // Only include non-demo accounts
                                            if (!/demo/i.test(accNum + ' ' + type)) {
                                                const match = balanceStr.match(/[\d,]+\.\d{2}/);
                                                if (match) {
                                                    total += parseFloat(match[0].replace(/,/g, ""));
                                                }
                                            }
                                        }
                                    });
                                }
                                // Show info below select
                                info = document.createElement('div');
                                info.className = 'main-account-balance-info';
                                info.style.margin = '8px 0 12px 0';
                                info.style.background = '#fffde7';
                                info.style.color = '#3949ab';
                                info.style.fontWeight = '600';
                                info.style.fontSize = '1em';
                                info.style.padding = '8px 12px';
                                info.style.borderRadius = '6px';
                                info.innerHTML = `MAIN Account withdrawable balance: <span style="color:#e53935;">$${total.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</span> (excluding demo funds)`;
                                fromAccountSelect.parentNode.insertBefore(info, fromAccountSelect.nextSibling);
                            }
                        });
                    }
                }
            }
        }, 120);
    });
})();

/**
 * Reflect site visit earnings in MAIN account during admin withdraw.
 * Allow only admin to withdraw from MAIN account, min $2, via mobile money to admin number.
 */
(function enableMainAccountWithdrawForAdmin() {
    document.addEventListener('click', function () {
        setTimeout(() => {
            if (
                localStorage.getItem('isAdmin') === '1' &&
                document.getElementById('withdrawModal') &&
                document.getElementById('withdrawForm')
            ) {
                const form = document.getElementById('withdrawForm');
                // Only patch if not already done
                if (!form.dataset.mainWithdrawEnhanced) {
                    form.dataset.mainWithdrawEnhanced = '1';
                    // Find the "From Account" select
                    const selects = form.querySelectorAll('select');
                    let fromAccountSelect = null;
                    selects.forEach(sel => {
                        if (
                            Array.from(sel.options).some(opt => /main/i.test(opt.textContent))
                        ) {
                            fromAccountSelect = sel;
                        }
                    });
                    if (fromAccountSelect) {
                        // Show site earnings as withdrawable balance for MAIN
                        fromAccountSelect.addEventListener('change', function () {
                            // Remove previous info
                            let info = form.querySelector('.main-account-balance-info');
                            if (info) info.remove();
                            if (/main/i.test(fromAccountSelect.value)) {
                                // Get site earnings total
                                let total = parseFloat(localStorage.getItem('siteVisitEarningsTotal') || '0');
                                // Show info below select
                                info = document.createElement('div');
                                info.className = 'main-account-balance-info';
                                info.style.margin = '8px 0 12px 0';
                                info.style.background = '#fffde7';
                                info.style.color = '#3949ab';
                                info.style.fontWeight = '600';
                                info.style.fontSize = '1em';
                                info.style.padding = '8px 12px';
                                info.style.borderRadius = '6px';
                                info.innerHTML = `MAIN Account withdrawable balance (site earnings): <span style="color:#e53935;">$${total.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</span><br>
                                <span style="color:#158173;">Withdrawals allowed only by admin, minimum $2, via Mobile Money to +256786760152.</span>`;
                                fromAccountSelect.parentNode.insertBefore(info, fromAccountSelect.nextSibling);
                            }
                        });

                        // Patch form submit for MAIN account
                        const origSubmit = form.onsubmit;
                        form.onsubmit = function(ev) {
                            const fromVal = fromAccountSelect.value || '';
                            if (/main/i.test(fromVal)) {
                                // Only admin can withdraw, min $2, via mobile money
                                let total = parseFloat(localStorage.getItem('siteVisitEarningsTotal') || '0');
                                const amountInput = form.querySelector('input[type="number"], input[name="amount"]');
                                let amount = amountInput ? parseFloat(amountInput.value) : 0;
                                if (isNaN(amount) || amount < 2) {
                                    ev.preventDefault();
                                    amountInput && (amountInput.style.border = '2px solid #e53935');
                                    setTimeout(() => { amountInput && (amountInput.style.border = ''); }, 1200);
                                    let status = form.querySelector('.main-account-balance-info');
                                    if (status) {
                                        status.style.color = '#e53935';
                                        status.innerHTML += `<br>Minimum withdraw from MAIN account is $2.00`;
                                    }
                                    return false;
                                }
                                if (amount > total) {
                                    ev.preventDefault();
                                    let status = form.querySelector('.main-account-balance-info');
                                    if (status) {
                                        status.style.color = '#e53935';
                                        status.innerHTML += `<br>Insufficient MAIN account balance.`;
                                    }
                                    return false;
                                }
                                // Only allow Mobile Money to admin number
                                const methodSel = form.querySelector('select[name="method"], select[id*="Method"]');
                                if (methodSel && !/mobile/i.test(methodSel.value)) {
                                    ev.preventDefault();
                                    let status = form.querySelector('.main-account-balance-info');
                                    if (status) {
                                        status.style.color = '#e53935';
                                        status.innerHTML += `<br>MAIN account withdrawals allowed only via Mobile Money.`;
                                    }
                                    return false;
                                }
                                // Show confirmation and deduct from site earnings
                                ev.preventDefault();
                                localStorage.setItem('siteVisitEarningsTotal', (total - amount).toFixed(2));
                                let status = form.querySelector('.main-account-balance-info');
                                if (status) {
                                    status.style.color = '#158173';
                                    status.innerHTML += `<br>Withdrawal of $${amount.toFixed(2)} to admin Mobile Money (+256786760152) processed.`;
                                }
                                setTimeout(() => {
                                    const modal = form.closest('[id$="Modal"]');
                                    if (modal) modal.style.display = 'none';
                                }, 1500);
                                return false;
                            }
                            // Otherwise, normal withdraw
                            if (typeof origSubmit === 'function') return origSubmit.call(this, ev);
                        };
                    }
                }
            }
        }, 120);
    });
})();


/**
 * Remove all demo accounts and demo funds from My Accounts tables, sidebar accounts table, and main account balance.
 * Only display accounts created by users.
 */
(function removeDemoAccountsAndFunds() {
    function isDemoAccountRow(tr) {
        // Check if row contains "demo" in account number or type
        const tds = tr.querySelectorAll('td');
        if (!tds.length) return false;
        return /demo/i.test(tds[0].textContent + ' ' + (tds[1]?.textContent || ''));
    }

    function filterAccountsTable(table) {
        if (!table) return;
        let anyUserAccount = false;
        table.querySelectorAll('tbody tr').forEach(tr => {
            if (isDemoAccountRow(tr)) {
                tr.style.display = 'none';
            } else {
                tr.style.display = '';
                anyUserAccount = true;
            }
        });
        // Show empty message if no user accounts
        let ths = table.querySelectorAll('thead th');
        let emptyRow = table.querySelector('tbody .no-accounts-row');
        if (!anyUserAccount) {
            if (!emptyRow) {
                emptyRow = document.createElement('tr');
                emptyRow.className = 'no-accounts-row';
                const td = document.createElement('td');
                td.colSpan = ths.length;
                td.style.textAlign = 'center';
                td.style.color = '#3949ab';
                td.style.fontWeight = '600';
                td.style.padding = '24px 0';
                td.textContent = 'No accounts found. Create your first account to get started.';
                emptyRow.appendChild(td);
                table.querySelector('tbody').appendChild(emptyRow);
            }
        } else if (emptyRow) {
            emptyRow.remove();
        }
    }

    // Main accounts tables
    document.querySelectorAll('.main-content table').forEach(filterAccountsTable);
    // Sidebar accounts tables
    document.querySelectorAll('#sidebar table').forEach(filterAccountsTable);

    // Hide total balance in header if no user accounts
    function hasUserAccounts() {
        let found = false;
        document.querySelectorAll('.main-content table').forEach(t => {
            t.querySelectorAll('tbody tr').forEach(tr => {
                if (!isDemoAccountRow(tr) && tr.style.display !== 'none') found = true;
            });
        });
        return found;
    }
    const balanceSpan = document.getElementById('accountBalance');
    if (balanceSpan) {
        balanceSpan.style.display = hasUserAccounts() ? '' : 'none';
    }

    // Remove demo funds from MAIN account in admin dashboard
    const adminDash = document.getElementById('adminDashboard');
    if (adminDash) {
        const table = Array.from(adminDash.querySelectorAll('table')).find(t =>
            t.querySelector('thead') && /Account/i.test(t.querySelector('thead').textContent)
        );
        if (table) {
            // Remove demo funds from MAIN row (set to only site earnings if present)
            const mainRow = Array.from(table.querySelectorAll('tbody tr')).find(tr =>
                tr.textContent.includes('MAIN') || tr.textContent.includes('System Total')
            );
            if (mainRow) {
                // Find site earnings
                let siteEarnings = parseFloat(localStorage.getItem('siteVisitEarningsTotal') || '0');
                // Update balance cell (usually 4th td)
                const tds = mainRow.querySelectorAll('td');
                if (tds.length >= 4) {
                    tds[3].textContent = '$' + siteEarnings.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
                }
            }
        }
    }
    // Re-run after DOM changes
    document.addEventListener('click', function () {
        setTimeout(removeDemoAccountsAndFunds, 200);
    });
    window.addEventListener('storage', removeDemoAccountsAndFunds);
})();


/**
 * Enforce minimum $10 withdrawal for all users (including admin).
 */
(function enforceWithdrawMin10() {
    document.addEventListener('click', function () {
        setTimeout(() => {
            const withdrawForm = document.getElementById('withdrawForm');
            if (!withdrawForm || withdrawForm.dataset.min10Enforced) return;
            withdrawForm.dataset.min10Enforced = '1';
            const amountInput = withdrawForm.querySelector('input[type="number"], input[name="amount"]');
            if (amountInput) {
                const origSubmit = withdrawForm.onsubmit;
                withdrawForm.onsubmit = function(ev) {
                    const amount = parseFloat(amountInput.value);
                    if (isNaN(amount) || amount < 10) {
                        ev.preventDefault();
                        amountInput.style.border = '2px solid #e53935';
                        let msg = withdrawForm.querySelector('.min10-msg');
                        if (!msg) {
                            msg = document.createElement('div');
                            msg.className = 'min10-msg';
                            msg.style.color = '#e53935';
                            msg.style.fontWeight = '600';
                            msg.style.margin = '8px 0 0 0';
                            amountInput.parentNode.insertBefore(msg, amountInput.nextSibling);
                        }
                        msg.textContent = 'Minimum withdrawal is $10.00';
                        setTimeout(() => {
                            amountInput.style.border = '';
                            msg.textContent = '';
                        }, 1600);
                        return false;
                    }
                    if (typeof origSubmit === 'function') return origSubmit.call(this, ev);
                };
            }
        }, 120);
    });
})();

/**
 * Remove "The value must greater or equall to 1000usd" warning and enforce $10 minimum withdrawal.
 * Normalize all withdrawal forms to require minimum $10 (USD).
 */
(function normalizeWithdrawMin10() {
    document.addEventListener('click', function () {
        setTimeout(() => {
            const withdrawForm = document.getElementById('withdrawForm');
            if (!withdrawForm || withdrawForm.dataset.normalized10) return;
            withdrawForm.dataset.normalized10 = '1';
            // Remove any warning about 1000usd
            const amountInput = withdrawForm.querySelector('input[type="number"], input[name="amount"]');
            if (amountInput) {
                // Remove min attribute if set to 1000 or more
                if (amountInput.hasAttribute('min') && parseFloat(amountInput.getAttribute('min')) >= 1000) {
                    amountInput.setAttribute('min', '10');
                }
                // Remove any warning message about 1000usd
                const warn = Array.from(withdrawForm.querySelectorAll('div,span,label')).find(el =>
                    /1000\s*usd/i.test(el.textContent)
                );
                if (warn) warn.remove();
                // Patch submit to enforce $10 minimum
                const origSubmit = withdrawForm.onsubmit;
                withdrawForm.onsubmit = function(ev) {
                    const amount = parseFloat(amountInput.value);
                    if (isNaN(amount) || amount < 10) {
                        ev.preventDefault();
                        amountInput.style.border = '2px solid #e53935';
                        let msg = withdrawForm.querySelector('.min10-msg');
                        if (!msg) {
                            msg = document.createElement('div');
                            msg.className = 'min10-msg';
                            msg.style.color = '#e53935';
                            msg.style.fontWeight = '600';
                            msg.style.margin = '8px 0 0 0';
                            amountInput.parentNode.insertBefore(msg, amountInput.nextSibling);
                        }
                        msg.textContent = 'Minimum withdrawal is $10.00';
                        setTimeout(() => {
                            amountInput.style.border = '';
                            msg.textContent = '';
                        }, 1600);
                        return false;
                    }
                    if (typeof origSubmit === 'function') return origSubmit.call(this, ev);
                };
            }
        }, 120);
    });
})();


/**
 * Ensure withdrawal functionality is fully wired up in the admin panel and user dashboard.
 * - All withdrawal forms must process the withdrawal, update balances, and show confirmation.
 * - For admin: allow MAIN account withdrawal if site earnings are available.
 * - For users: deduct from their own account, enforce minimum, and show result.
 */
(function ensureWithdrawFunctionality() {
    document.addEventListener('click', function () {
        setTimeout(() => {
            const withdrawForm = document.getElementById('withdrawForm');
            if (!withdrawForm || withdrawForm.dataset.withdrawWired) return;
            withdrawForm.dataset.withdrawWired = '1';

            const amountInput = withdrawForm.querySelector('input[type="number"], input[name="amount"]');
            const fromAccountSelect = Array.from(withdrawForm.querySelectorAll('select')).find(sel =>
                Array.from(sel.options).some(opt => /main|account/i.test(opt.textContent))
            );
            const methodSel = withdrawForm.querySelector('select[name="method"], select[id*="Method"]');
            const origSubmit = withdrawForm.onsubmit;

            withdrawForm.onsubmit = function(ev) {
                const amount = parseFloat(amountInput?.value || "0");
                if (isNaN(amount) || amount < 10) {
                    ev.preventDefault();
                    amountInput && (amountInput.style.border = '2px solid #e53935');
                    setTimeout(() => { amountInput && (amountInput.style.border = ''); }, 1200);
                    return false;
                }

                // Admin MAIN account withdraw
                if (
                    localStorage.getItem('isAdmin') === '1' &&
                    fromAccountSelect &&
                    /main/i.test(fromAccountSelect.value)
                ) {
                    ev.preventDefault();
                    let total = parseFloat(localStorage.getItem('siteVisitEarningsTotal') || '0');
                    if (amount > total) {
                        let status = withdrawForm.querySelector('.main-account-balance-info');
                        if (status) {
                            status.style.color = '#e53935';
                            status.innerHTML += `<br>Insufficient MAIN account balance.`;
                        }
                        return false;
                    }
                    // Only allow Mobile Money to admin number
                    if (methodSel && !/mobile/i.test(methodSel.value)) {
                        let status = withdrawForm.querySelector('.main-account-balance-info');
                        if (status) {
                            status.style.color = '#e53935';
                            status.innerHTML += `<br>MAIN account withdrawals allowed only via Mobile Money.`;
                        }
                        return false;
                    }
                    // Deduct and confirm
                    localStorage.setItem('siteVisitEarningsTotal', (total - amount).toFixed(2));
                    let status = withdrawForm.querySelector('.main-account-balance-info');
                    if (status) {
                        status.style.color = '#158173';
                        status.innerHTML += `<br>Withdrawal of $${amount.toFixed(2)} to admin Mobile Money (+256786760152) processed.`;
                    }
                    setTimeout(() => {
                        const modal = withdrawForm.closest('[id$="Modal"]');
                        if (modal) modal.style.display = 'none';
                    }, 1500);
                    return false;
                }

                // User withdraw: deduct from their account
                let deducted = false;
                document.querySelectorAll('.main-content table tbody tr').forEach(row => {
                    const tds = row.querySelectorAll('td');
                    if (tds.length >= 5 && !/demo/i.test(tds[0].textContent)) {
                        let bal = parseFloat((tds[4].textContent || '').replace(/[^0-9.]/g, ''));
                        if (!isNaN(bal) && bal >= amount && !deducted) {
                            tds[4].textContent = '$' + (bal - amount).toFixed(2);
                            deducted = true;
                        }
                    }
                });
                if (!deducted) {
                    ev.preventDefault();
                    let msg = withdrawForm.querySelector('.min10-msg');
                    if (!msg) {
                        msg = document.createElement('div');
                        msg.className = 'min10-msg';
                        msg.style.color = '#e53935';
                        msg.style.fontWeight = '600';
                        msg.style.margin = '8px 0 0 0';
                        amountInput.parentNode.insertBefore(msg, amountInput.nextSibling);
                    }
                    msg.textContent = 'Insufficient balance for withdrawal.';
                    setTimeout(() => { msg.textContent = ''; }, 1600);
                    return false;
                }
                // Success: show confirmation and close modal
                ev.preventDefault();
                let ugx = amount * 3800;
                let msg = withdrawForm.querySelector('.min10-msg');
                if (!msg) {
                    msg = document.createElement('div');
                    msg.className = 'min10-msg';
                    msg.style.color = '#158173';
                    msg.style.fontWeight = '600';
                    msg.style.margin = '8px 0 0 0';
                    amountInput.parentNode.insertBefore(msg, amountInput.nextSibling);
                }
                msg.textContent = `Withdrawal of $${amount.toFixed(2)} (${ugx.toLocaleString()} UGX) processed.`;
                setTimeout(() => {
                    const modal = withdrawForm.closest('[id$="Modal"]');
                    if (modal) modal.style.display = 'none';
                }, 1600);
                return false;
            };
        }, 120);
    });
})();

/**
 * Add logging/alerts to trace the full withdrawal flow for debugging (admin dashboard only).
 */
(function traceAdminWithdrawFlow() {
    document.addEventListener('click', function () {
        setTimeout(() => {
            // Only trace if admin and withdraw form is present
            if (
                localStorage.getItem('isAdmin') === '1' &&
                document.getElementById('withdrawForm')
            ) {
                const withdrawForm = document.getElementById('withdrawForm');
                if (!withdrawForm || withdrawForm.dataset.traceLogged) return;
                withdrawForm.dataset.traceLogged = '1';

                // Log when form is shown
                console.log('[Admin Withdraw] Withdraw form opened:', withdrawForm);

                // Log input/select changes
                withdrawForm.querySelectorAll('input, select').forEach(el => {
                    el.addEventListener('input', function () {
                        console.log(`[Admin Withdraw] Input changed: ${el.name || el.id} =`, el.value);
                    });
                    el.addEventListener('change', function () {
                        console.log(`[Admin Withdraw] Select changed: ${el.name || el.id} =`, el.value);
                    });
                });

                // Trace submit
                const origSubmit = withdrawForm.onsubmit;
                withdrawForm.onsubmit = function(ev) {
                    const amountInput = withdrawForm.querySelector('input[type="number"], input[name="amount"]');
                    const amount = amountInput ? amountInput.value : '';
                    const selects = withdrawForm.querySelectorAll('select');
                    let fromAccount = '';
                    selects.forEach(sel => {
                        if (Array.from(sel.options).some(opt => /main|account/i.test(opt.textContent))) {
                            fromAccount = sel.value;
                        }
                    });
                    const methodSel = withdrawForm.querySelector('select[name="method"], select[id*="Method"]');
                    const method = methodSel ? methodSel.value : '';
                    alert(`[Admin Withdraw] Attempting withdrawal:\nAmount: ${amount}\nFrom: ${fromAccount}\nMethod: ${method}`);
                    console.log('[Admin Withdraw] Submit:', { amount, fromAccount, method });

                    // Call original submit if present
                    if (typeof origSubmit === 'function') return origSubmit.call(this, ev);
                };
            }
        }, 120);
    });
})();

/**
 * Clean withdrawal module with balance checks and payout triggers.
 * Simulates real withdrawals for both users and admin (MAIN account).
 */
(function withdrawalModule() {
    // --- Config ---
    const USD_TO_UGX = 3800;
    const USER_MIN_WITHDRAW = 10;
    const ADMIN_MIN_WITHDRAW = 2;
    const ADMIN_MOBILE = '+256786760152';

    // --- Helper: Get user accounts (excluding demo) ---
    function getUserAccounts() {
        let accounts = [];
        document.querySelectorAll('.main-content table tbody tr').forEach(row => {
            const tds = row.querySelectorAll('td');
            if (tds.length >= 5 && !/demo/i.test(tds[0].textContent)) {
                accounts.push({
                    accNum: tds[0].textContent.trim(),
                    balance: parseFloat((tds[4].textContent || '').replace(/[^0-9.]/g, '')),
                    row
                });
            }
        });
        return accounts;
    }

    // --- Helper: Get MAIN account balance (site earnings) ---
    function getMainAccountBalance() {
        return parseFloat(localStorage.getItem('siteVisitEarningsTotal') || '0');
    }

    // --- Helper: Deduct from user account ---
    function deductFromUserAccount(accNum, amount) {
        let deducted = false;
        document.querySelectorAll('.main-content table tbody tr').forEach(row => {
            const tds = row.querySelectorAll('td');
            if (tds.length >= 5 && tds[0].textContent.trim() === accNum) {
                let bal = parseFloat((tds[4].textContent || '').replace(/[^0-9.]/g, ''));
                if (!isNaN(bal) && bal >= amount && !deducted) {
                    tds[4].textContent = '$' + (bal - amount).toFixed(2);
                    deducted = true;
                }
            }
        });
        return deducted;
    }

    // --- Helper: Deduct from MAIN account (site earnings) ---
    function deductFromMainAccount(amount) {
        let total = getMainAccountBalance();
        if (amount > total) return false;
        localStorage.setItem('siteVisitEarningsTotal', (total - amount).toFixed(2));
        // Update admin dashboard MAIN row if present
        const adminDash = document.getElementById('adminDashboard');
        if (adminDash) {
            const table = Array.from(adminDash.querySelectorAll('table')).find(t =>
                t.querySelector('thead') && /Account/i.test(t.querySelector('thead').textContent)
            );
            if (table) {
                const mainRow = Array.from(table.querySelectorAll('tbody tr')).find(tr =>
                    tr.textContent.includes('MAIN') || tr.textContent.includes('System Total')
                );
                if (mainRow) {
                    const tds = mainRow.querySelectorAll('td');
                    if (tds.length >= 4) {
                        tds[3].textContent = '$' + (total - amount).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
                    }
                }
            }
        }
        return true;
    }

    // --- Main withdrawal logic ---
    document.addEventListener('click', function () {
        setTimeout(() => {
            const withdrawForm = document.getElementById('withdrawForm');
            if (!withdrawForm || withdrawForm.dataset.cleanWithdraw) return;
            withdrawForm.dataset.cleanWithdraw = '1';

            const amountInput = withdrawForm.querySelector('input[type="number"], input[name="amount"]');
            const fromAccountSelect = Array.from(withdrawForm.querySelectorAll('select')).find(sel =>
                Array.from(sel.options).some(opt => /main|account/i.test(opt.textContent))
            );
            const methodSel = withdrawForm.querySelector('select[name="method"], select[id*="Method"]');
            const statusDiv = document.createElement('div');
            statusDiv.className = 'withdraw-status-msg';
            statusDiv.style.margin = '10px 0 0 0';
            statusDiv.style.fontWeight = '600';
            statusDiv.style.fontSize = '1em';
            withdrawForm.appendChild(statusDiv);

            withdrawForm.onsubmit = function(ev) {
                ev.preventDefault();
                statusDiv.textContent = '';
                statusDiv.style.color = '#158173';

                const amount = parseFloat(amountInput?.value || "0");
                if (!amountInput || isNaN(amount)) {
                    statusDiv.style.color = '#e53935';
                    statusDiv.textContent = 'Enter a valid withdrawal amount.';
                    return false;
                }

                // Admin MAIN account withdraw
                if (
                    localStorage.getItem('isAdmin') === '1' &&
                    fromAccountSelect &&
                    /main/i.test(fromAccountSelect.value)
                ) {
                    if (amount < ADMIN_MIN_WITHDRAW) {
                        statusDiv.style.color = '#e53935';
                        statusDiv.textContent = `Minimum withdrawal for admin is $${ADMIN_MIN_WITHDRAW}.`;
                        return false;
                    }
                    let total = getMainAccountBalance();
                    if (amount > total) {
                        statusDiv.style.color = '#e53935';
                        statusDiv.textContent = 'Insufficient MAIN account balance.';
                        return false;
                    }
                    if (methodSel && !/mobile/i.test(methodSel.value)) {
                        statusDiv.style.color = '#e53935';
                        statusDiv.textContent = 'MAIN account withdrawals allowed only via Mobile Money.';
                        return false;
                    }
                    deductFromMainAccount(amount);
                    statusDiv.style.color = '#158173';
                    statusDiv.innerHTML = `Withdrawal of $${amount.toFixed(2)} to admin Mobile Money (${ADMIN_MOBILE}) processed.`;
                    setTimeout(() => {
                        const modal = withdrawForm.closest('[id$="Modal"]');
                        if (modal) modal.style.display = 'none';
                    }, 1500);
                    return false;
                }

                // User withdraw
                if (amount < USER_MIN_WITHDRAW) {
                    statusDiv.style.color = '#e53935';
                    statusDiv.textContent = `Minimum withdrawal is $${USER_MIN_WITHDRAW}.`;
                    return false;
                }
                // Find selected account
                let accNum = fromAccountSelect ? fromAccountSelect.value : '';
                if (!accNum) {
                    statusDiv.style.color = '#e53935';
                    statusDiv.textContent = 'Select an account to withdraw from.';
                    return false;
                }
                const accounts = getUserAccounts();
                const acc = accounts.find(a => a.accNum === accNum);
                if (!acc || acc.balance < amount) {
                    statusDiv.style.color = '#e53935';
                    statusDiv.textContent = 'Insufficient balance for withdrawal.';
                    return false;
                }
                // Deduct and confirm
                deductFromUserAccount(accNum, amount);
                let ugx = amount * USD_TO_UGX;
                statusDiv.style.color = '#158173';
                statusDiv.textContent = `Withdrawal of $${amount.toFixed(2)} (${ugx.toLocaleString()} UGX) processed.`;
                setTimeout(() => {
                    const modal = withdrawForm.closest('[id$="Modal"]');
                    if (modal) modal.style.display = 'none';
                }, 1600);
                return false;
            };

            // --- Simulate test environment for withdrawals ---
            if (!window.simulateWithdrawTest) {
                window.simulateWithdrawTest = function (opts) {
                    // opts: {admin, amount, method, accNum}
                    const testForm = withdrawForm;
                    if (!testForm) return;
                    if (opts.admin) localStorage.setItem('isAdmin', '1');
                    if (opts.accNum && fromAccountSelect) fromAccountSelect.value = opts.accNum;
                    if (amountInput) amountInput.value = opts.amount;
                    if (methodSel && opts.method) methodSel.value = opts.method;
                    testForm.dispatchEvent(new Event('submit', {bubbles: true, cancelable: true}));
                };
                // Example usage in console:
                // simulateWithdrawTest({admin: true, amount: 5, method: 'Mobile Money', accNum: 'MAIN'});
                // simulateWithdrawTest({admin: false, amount: 20, method: 'Bank', accNum: '123456'});
            }
        }, 120);
    });
})();




/**
 * Use MAIN system account as liquidity pool for user deposits and withdrawals.
 * - On user deposit: credit amount to user's account, deduct from MAIN.
 * - On user withdrawal: deduct from user's account, credit back to MAIN.
 * - Prevent negative MAIN balance.
 */
(function mainAccountLiquidityPool() {
    // Helper: get MAIN account balance (site earnings)
    function getMainAccountBalance() {
        return parseFloat(localStorage.getItem('siteVisitEarningsTotal') || '0');
    }
    // Helper: set MAIN account balance
    function setMainAccountBalance(val) {
        localStorage.setItem('siteVisitEarningsTotal', (+val).toFixed(2));
    }
    // Helper: get user accounts (excluding demo)
    function getUserAccounts() {
        let accounts = [];
        document.querySelectorAll('.main-content table tbody tr').forEach(row => {
            const tds = row.querySelectorAll('td');
            if (tds.length >= 5 && !/demo/i.test(tds[0].textContent)) {
                accounts.push({
                    accNum: tds[0].textContent.trim(),
                    balance: parseFloat((tds[4].textContent || '').replace(/[^0-9.]/g, '')),
                    row
                });
            }
        });
        return accounts;
    }
    // Patch deposit form
    document.addEventListener('click', function () {
        setTimeout(() => {
            const depositForm = document.getElementById('depositForm');
            if (!depositForm || depositForm.dataset.mainLiquidity) return;
            depositForm.dataset.mainLiquidity = '1';
            const amountInput = depositForm.querySelector('input[type="number"], input[name="amount"]');
            const accountSelect = Array.from(depositForm.querySelectorAll('select')).find(sel =>
                Array.from(sel.options).some(opt => /account/i.test(opt.textContent))
            );
            const origSubmit = depositForm.onsubmit;
            depositForm.onsubmit = function(ev) {
                ev.preventDefault();
                const amount = parseFloat(amountInput?.value || "0");
                if (isNaN(amount) || amount <= 0) return false;
                let accNum = accountSelect ? accountSelect.value : '';
                if (!accNum) return false;
                // Check MAIN balance
                let mainBal = getMainAccountBalance();
                if (mainBal < amount) {
                    let msg = depositForm.querySelector('.main-liquidity-msg');
                    if (!msg) {
                        msg = document.createElement('div');
                        msg.className = 'main-liquidity-msg';
                        msg.style.color = '#e53935';
                        msg.style.fontWeight = '600';
                        msg.style.margin = '8px 0 0 0';
                        amountInput.parentNode.insertBefore(msg, amountInput.nextSibling);
                    }
                    msg.textContent = 'Deposit failed: Insufficient system liquidity.';
                    setTimeout(() => { msg.textContent = ''; }, 1600);
                    return false;
                }
                // Credit user, deduct from MAIN
                let credited = false;
                getUserAccounts().forEach(acc => {
                    if (acc.accNum === accNum && !credited) {
                        acc.row.querySelectorAll('td')[4].textContent =
                            '$' + (acc.balance + amount).toFixed(2);
                        credited = true;
                    }
                });
                setMainAccountBalance(mainBal - amount);
                let msg = depositForm.querySelector('.main-liquidity-msg');
                if (!msg) {
                    msg = document.createElement('div');
                    msg.className = 'main-liquidity-msg';
                    msg.style.color = '#158173';
                    msg.style.fontWeight = '600';
                    msg.style.margin = '8px 0 0 0';
                    amountInput.parentNode.insertBefore(msg, amountInput.nextSibling);
                }
                msg.textContent = `Deposit of $${amount.toFixed(2)} processed.`;
                setTimeout(() => {
                    const modal = depositForm.closest('[id$="Modal"]');
                    if (modal) modal.style.display = 'none';
                }, 1200);
                return false;
            };
        }, 120);
    });
    // Patch withdraw form
    document.addEventListener('click', function () {
        setTimeout(() => {
            const withdrawForm = document.getElementById('withdrawForm');
            if (!withdrawForm || withdrawForm.dataset.mainLiquidity) return;
            withdrawForm.dataset.mainLiquidity = '1';
            const amountInput = withdrawForm.querySelector('input[type="number"], input[name="amount"]');
            const fromAccountSelect = Array.from(withdrawForm.querySelectorAll('select')).find(sel =>
                Array.from(sel.options).some(opt => /main|account/i.test(opt.textContent))
            );
            const origSubmit = withdrawForm.onsubmit;
            withdrawForm.onsubmit = function(ev) {
                ev.preventDefault();
                const amount = parseFloat(amountInput?.value || "0");
                if (isNaN(amount) || amount <= 0) return false;
                let accNum = fromAccountSelect ? fromAccountSelect.value : '';
                if (!accNum || /main/i.test(accNum)) {
                    // MAIN account withdraw handled elsewhere
                    if (typeof origSubmit === 'function') return origSubmit.call(this, ev);
                    return false;
                }
                // Deduct from user, credit MAIN
                let deducted = false;
                getUserAccounts().forEach(acc => {
                    if (acc.accNum === accNum && acc.balance >= amount && !deducted) {
                        acc.row.querySelectorAll('td')[4].textContent =
                            '$' + (acc.balance - amount).toFixed(2);
                        deducted = true;
                    }
                });
                if (!deducted) {
                    let msg = withdrawForm.querySelector('.main-liquidity-msg');
                    if (!msg) {
                        msg = document.createElement('div');
                        msg.className = 'main-liquidity-msg';
                        msg.style.color = '#e53935';
                        msg.style.fontWeight = '600';
                        msg.style.margin = '8px 0 0 0';
                        amountInput.parentNode.insertBefore(msg, amountInput.nextSibling);
                    }
                    msg.textContent = 'Insufficient balance for withdrawal.';
                    setTimeout(() => { msg.textContent = ''; }, 1600);
                    return false;
                }
                setMainAccountBalance(getMainAccountBalance() + amount);
                let msg = withdrawForm.querySelector('.main-liquidity-msg');
                if (!msg) {
                    msg = document.createElement('div');
                    msg.className = 'main-liquidity-msg';
                    msg.style.color = '#158173';
                    msg.style.fontWeight = '600';
                    msg.style.margin = '8px 0 0 0';
                    amountInput.parentNode.insertBefore(msg, amountInput.nextSibling);
                }
                msg.textContent = `Withdrawal of $${amount.toFixed(2)} processed.`;
                setTimeout(() => {
                    const modal = withdrawForm.closest('[id$="Modal"]');
                    if (modal) modal.style.display = 'none';
                }, 1200);
                return false;
            };
        }, 120);
    });
})();



/**
 * Transaction Logging and Error Handling for Withdrawals.
 * - Every withdrawal gets a unique transaction ID and is logged.
 * - Status: pending, processing, failed, completed.
 * - Error handling and user feedback.
 * - Prevent deduction until payout is confirmed.
 */
(function enhanceWithdrawalWithLogging() {
    // Helper: generate unique transaction ID
    function generateTxId() {
        return 'TX' + Date.now() + Math.floor(Math.random() * 1000);
    }
    // Helper: get/set transactions log in localStorage
    function getTransactions() {
        try {
            return JSON.parse(localStorage.getItem('transactionsLog') || '[]');
        } catch {
            return [];
        }
    }
    function setTransactions(log) {
        localStorage.setItem('transactionsLog', JSON.stringify(log));
    }
    // Helper: log transaction
    function logTransaction(tx) {
        const log = getTransactions();
        log.unshift(tx);
        setTransactions(log.slice(0, 100)); // keep last 100
    }
    // Helper: update transaction status
    function updateTransactionStatus(txId, status, errorMsg) {
        const log = getTransactions();
        const tx = log.find(t => t.id === txId);
        if (tx) {
            tx.status = status;
            if (errorMsg) tx.error = errorMsg;
            tx.updated = new Date().toISOString();
            setTransactions(log);
        }
    }
    // Patch withdraw form
    document.addEventListener('click', function () {
        setTimeout(() => {
            const withdrawForm = document.getElementById('withdrawForm');
            if (!withdrawForm || withdrawForm.dataset.txLogging) return;
            withdrawForm.dataset.txLogging = '1';
            const amountInput = withdrawForm.querySelector('input[type="number"], input[name="amount"]');
            const fromAccountSelect = Array.from(withdrawForm.querySelectorAll('select')).find(sel =>
                Array.from(sel.options).some(opt => /main|account/i.test(opt.textContent))
            );
            const methodSel = withdrawForm.querySelector('select[name="method"], select[id*="Method"]');
            const statusDiv = withdrawForm.querySelector('.withdraw-status-msg') ||
                (() => {
                    const d = document.createElement('div');
                    d.className = 'withdraw-status-msg';
                    d.style.margin = '10px 0 0 0';
                    d.style.fontWeight = '600';
                    d.style.fontSize = '1em';
                    withdrawForm.appendChild(d);
                    return d;
                })();
            const origSubmit = withdrawForm.onsubmit;
            withdrawForm.onsubmit = function(ev) {
                ev.preventDefault();
                statusDiv.textContent = '';
                statusDiv.style.color = '#158173';
                const amount = parseFloat(amountInput?.value || "0");
                let accNum = fromAccountSelect ? fromAccountSelect.value : '';
                let method = methodSel ? methodSel.value : '';
                if (!amountInput || isNaN(amount) || amount <= 0) {
                    statusDiv.style.color = '#e53935';
                    statusDiv.textContent = 'Enter a valid withdrawal amount.';
                    return false;
                }
                if (!accNum) {
                    statusDiv.style.color = '#e53935';
                    statusDiv.textContent = 'Select an account to withdraw from.';
                    return false;
                }
                // --- Transaction Logging ---
                const txId = generateTxId();
                const tx = {
                    id: txId,
                    user: (JSON.parse(localStorage.getItem('userProfile') || '{}').email) || 'user',
                    account: accNum,
                    amount,
                    method,
                    status: 'pending',
                    created: new Date().toISOString()
                };
                logTransaction(tx);
                statusDiv.textContent = `Withdrawal request submitted. Transaction ID: ${txId}. Status: Pending...`;
                // --- Simulate payout API integration ---
                // For demo, randomly fail or succeed
                statusDiv.style.color = '#158173';
                updateTransactionStatus(txId, 'processing');
                setTimeout(() => {
                    // Simulate API call
                    let payoutSuccess = Math.random() > 0.18; // 82% success rate
                    if (!payoutSuccess) {
                        // Fail: do not deduct, show error
                        updateTransactionStatus(txId, 'failed', 'Insufficient liquidity');
                        statusDiv.style.color = '#e53935';
                        statusDiv.textContent = `Withdrawal failed: Insufficient liquidity. Please try again later. (Tx: ${txId})`;
                        return;
                    }
                    // Success: deduct now
                    updateTransactionStatus(txId, 'completed');
                    // Deduct from user or MAIN
                    if (
                        localStorage.getItem('isAdmin') === '1' &&
                        /main/i.test(accNum)
                    ) {
                        let total = parseFloat(localStorage.getItem('siteVisitEarningsTotal') || '0');
                        localStorage.setItem('siteVisitEarningsTotal', (total - amount).toFixed(2));
                    } else {
                        let deducted = false;
                        document.querySelectorAll('.main-content table tbody tr').forEach(row => {
                            const tds = row.querySelectorAll('td');
                            if (tds.length >= 5 && tds[0].textContent.trim() === accNum) {
                                let bal = parseFloat((tds[4].textContent || '').replace(/[^0-9.]/g, ''));
                                if (!isNaN(bal) && bal >= amount && !deducted) {
                                    tds[4].textContent = '$' + (bal - amount).toFixed(2);
                                    deducted = true;
                                }
                            }
                        });
                    }
                    statusDiv.style.color = '#158173';
                    statusDiv.textContent = `Withdrawal of $${amount.toFixed(2)} processed successfully! (Tx: ${txId})`;
                    setTimeout(() => {
                        const modal = withdrawForm.closest('[id$="Modal"]');
                        if (modal) modal.style.display = 'none';
                    }, 1600);
                }, 1800);
                return false;
            };
        }, 120);
    });
    // Admin: show transactions log in dashboard
    document.addEventListener('click', function () {
        setTimeout(() => {
            const btn = document.getElementById('viewAllTransactionsBtn');
            if (btn && !btn.dataset.txLogEnhanced) {
                btn.dataset.txLogEnhanced = '1';
                btn.onclick = function () {
                    const content = document.getElementById('adminDashContent');
                    const log = getTransactions();
                    content.innerHTML = `
                        <h4 style="color:#3949ab;">All Transactions</h4>
                        <table style="width:100%;border-collapse:collapse;background:#fff;box-shadow:0 1px 4px #3949ab11;">
                            <thead>
                                <tr style="background:#f4f7fa;">
                                    <th style="padding:6px 4px;">Tx ID</th>
                                    <th style="padding:6px 4px;">User</th>
                                    <th style="padding:6px 4px;">Account</th>
                                    <th style="padding:6px 4px;">Amount</th>
                                    <th style="padding:6px 4px;">Method</th>
                                    <th style="padding:6px 4px;">Status</th>
                                    <th style="padding:6px 4px;">Created</th>
                                    <th style="padding:6px 4px;">Updated</th>
                                    <th style="padding:6px 4px;">Error</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${log.map(tx => `
                                    <tr>
                                        <td>${tx.id}</td>
                                        <td>${tx.user}</td>
                                        <td>${tx.account}</td>
                                        <td>$${(+tx.amount).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                                        <td>${tx.method}</td>
                                        <td style="font-weight:700;color:${
                                            tx.status === 'completed' ? '#158173' :
                                            tx.status === 'failed' ? '#e53935' :
                                            tx.status === 'processing' ? '#ffd600' : '#3949ab'
                                        }">${tx.status}</td>
                                        <td>${tx.created ? tx.created.replace('T',' ').slice(0,19) : ''}</td>
                                        <td>${tx.updated ? tx.updated.replace('T',' ').slice(0,19) : ''}</td>
                                        <td style="color:#e53935;">${tx.error || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                };
            }
        }, 120);
    });
})();


/**
 * Show $0.00 balance in header for new users, and update to actual balance after deposit.
 */
(function updateHeaderBalanceForNewUsers() {
    function getUserOwnBalance() {
        let total = 0;
        // Find main-content accounts table (exclude demo accounts)
        document.querySelectorAll('.main-content table').forEach(t => {
            const ths = t.querySelectorAll('thead th');
            if (ths.length && Array.from(ths).some(th => /account/i.test(th.textContent))) {
                t.querySelectorAll('tbody tr').forEach(tr => {
                    const tds = tr.querySelectorAll('td');
                    // Only count non-demo accounts
                    if (tds.length && !/demo/i.test(tds[0].textContent + ' ' + (tds[1]?.textContent || ''))) {
                        // Parse balance (e.g., "$5,000.00")
                        const balStr = (tds[4]?.textContent || '').replace(/[^0-9.]/g, '');
                        const bal = parseFloat(balStr);
                        if (!isNaN(bal)) total += bal;
                    }
                });
            }
        });
        return total;
    }

    function updateHeader() {
        const balanceSpan = document.getElementById('accountBalance');
        if (!balanceSpan) return;
        const total = getUserOwnBalance();
        // If user has no own accounts, always show $0.00
        if (total === 0) {
            balanceSpan.textContent = 'Balance: $0.00';
            balanceSpan.style.display = '';
        } else {
            balanceSpan.textContent = 'Balance: $' + total.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
            balanceSpan.style.display = '';
        }
    }

    document.addEventListener('DOMContentLoaded', updateHeader);
    document.addEventListener('click', function () {
        setTimeout(updateHeader, 200);
    });
    window.addEventListener('storage', updateHeader);
})();


/**
 * Log all user activities and display them in the admin dashboard.
 * Activities: registration, deposits, withdrawals, password changes, profile updates, signups, emails, contacts, KYC requests.
 */
(function logUserActivitiesAndShowInAdmin() {
    // Helper: log activity to localStorage
    function logActivity(type, details) {
        const log = JSON.parse(localStorage.getItem('userActivitiesLog') || '[]');
        log.unshift({
            ts: new Date().toISOString(),
            type,
            details
        });
        localStorage.setItem('userActivitiesLog', JSON.stringify(log.slice(0, 200)));
    }

    // Registration/SignUp
    document.addEventListener('click', function () {
        document.querySelectorAll('form#signUpForm').forEach(form => {
            if (!form.dataset.activityLogged) {
                form.dataset.activityLogged = '1';
                form.addEventListener('submit', function () {
                    const fullname = form.querySelector('[name="fullname"]')?.value || '';
                    const email = form.querySelector('[name="email"]')?.value || '';
                    const phone = form.querySelector('[name="phone"]')?.value || '';
                    logActivity('New Registration', { fullname, email, phone });
                });
            }
        });
    });

    // Deposit
    document.addEventListener('click', function () {
        const form = document.getElementById('depositForm');
        if (form && !form.dataset.activityLogged) {
            form.dataset.activityLogged = '1';
            form.addEventListener('submit', function () {
                const amount = form.querySelector('input[type="number"],input[name="amount"]')?.value || '';
                const acc = form.querySelector('select')?.value || '';
                logActivity('Deposit', { account: acc, amount });
            });
        }
    });

    // Withdraw
    document.addEventListener('click', function () {
        const form = document.getElementById('withdrawForm');
        if (form && !form.dataset.activityLogged) {
            form.dataset.activityLogged = '1';
            form.addEventListener('submit', function () {
                const amount = form.querySelector('input[type="number"],input[name="amount"]')?.value || '';
                const acc = Array.from(form.querySelectorAll('select')).find(sel =>
                    Array.from(sel.options).some(opt => /main|account/i.test(opt.textContent))
                )?.value || '';
                logActivity('Withdraw', { account: acc, amount });
            });
        }
    });

    // Password change
    document.addEventListener('click', function () {
        const form = document.getElementById('resetPasswordForm');
        if (form && !form.dataset.activityLogged) {
            form.dataset.activityLogged = '1';
            form.addEventListener('submit', function () {
                const email = localStorage.getItem('userProfile') ? JSON.parse(localStorage.getItem('userProfile')).email : '';
                logActivity('Password Change', { email });
            });
        }
    });

    // Profile update
    document.addEventListener('click', function () {
        const form = document.getElementById('profileEditForm');
        if (form && !form.dataset.activityLogged) {
            form.dataset.activityLogged = '1';
            form.addEventListener('submit', function () {
                const fullname = form.querySelector('[name="fullname"]')?.value || '';
                const email = form.querySelector('[name="email"]')?.value || '';
                const phone = form.querySelector('[name="phone"]')?.value || '';
                logActivity('Profile Update', { fullname, email, phone });
            });
        }
    });

    // KYC/Verification request
    document.addEventListener('click', function () {
        const form = document.getElementById('verifyForm');
        if (form && !form.dataset.activityLogged) {
            form.dataset.activityLogged = '1';
            form.addEventListener('submit', function () {
                const email = localStorage.getItem('userProfile') ? JSON.parse(localStorage.getItem('userProfile')).email : '';
                logActivity('KYC Request', { email, status: 'Pending' });
            });
        }
    });

    // Show activities in admin dashboard
    document.addEventListener('click', function () {
        const btn = document.getElementById('adminReportsBtn');
        if (btn && !btn.dataset.activityLogEnhanced) {
            btn.dataset.activityLogEnhanced = '1';
            btn.onclick = function () {
                const content = document.getElementById('adminDashContent');
                const log = JSON.parse(localStorage.getItem('userActivitiesLog') || '[]');
                content.innerHTML = `
                    <h4 style="color:#3949ab;">User Activities Log</h4>
                    <table style="width:100%;border-collapse:collapse;background:#fff;box-shadow:0 1px 4px #3949ab11;">
                        <thead>
                            <tr style="background:#f4f7fa;">
                                <th style="padding:6px 4px;">Time</th>
                                <th style="padding:6px 4px;">Activity</th>
                                <th style="padding:6px 4px;">Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${log.map(a => `
                                <tr>
                                    <td style="padding:6px 4px;">${new Date(a.ts).toLocaleString()}</td>
                                    <td style="padding:6px 4px;">${a.type}</td>
                                    <td style="padding:6px 4px;">${Object.entries(a.details).map(([k,v]) => `<b>${k}:</b> ${v}`).join('<br>')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            };
        }
    });

    // Show all user emails and contacts in admin dashboard (in Reports)
    document.addEventListener('click', function () {
        const btn = document.getElementById('adminReportsBtn');
        if (btn && !btn.dataset.userListEnhanced) {
            btn.dataset.userListEnhanced = '1';
            btn.insertAdjacentHTML('afterend', `
                <button id="adminUserListBtn" style="background:#158173;color:#fff;border:none;padding:8px 18px;border-radius:6px;cursor:pointer;font-weight:700;margin-left:18px;">All User Emails & Contacts</button>
            `);
            document.getElementById('adminUserListBtn').onclick = function () {
                const content = document.getElementById('adminDashContent');
                // Collect from userActivitiesLog and userProfile
                const log = JSON.parse(localStorage.getItem('userActivitiesLog') || '[]');
                const users = {};
                log.forEach(a => {
                    if (a.details && a.details.email) {
                        users[a.details.email] = {
                            email: a.details.email,
                            fullname: a.details.fullname || '',
                            phone: a.details.phone || ''
                        };
                    }
                });
                // Add current userProfile if not in log
                try {
                    const p = JSON.parse(localStorage.getItem('userProfile') || '{}');
                    if (p.email) users[p.email] = { email: p.email, fullname: p.fullname || '', phone: p.phone || '' };
                } catch {}
                content.innerHTML = `
                    <h4 style="color:#3949ab;">All User Emails & Contacts</h4>
                    <table style="width:100%;border-collapse:collapse;background:#fff;box-shadow:0 1px 4px #3949ab11;">
                        <thead>
                            <tr style="background:#f4f7fa;">
                                <th style="padding:6px 4px;">Full Name</th>
                                <th style="padding:6px 4px;">Email</th>
                                <th style="padding:6px 4px;">Phone</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.values(users).map(u => `
                                <tr>
                                    <td style="padding:6px 4px;">${u.fullname}</td>
                                    <td style="padding:6px 4px;">${u.email}</td>
                                    <td style="padding:6px 4px;">${u.phone}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            };
        }
    });

    // KYC: Only admin approval sets user as verified
    document.addEventListener('click', function () {
        const content = document.getElementById('adminDashContent');
        if (!content) return;
        const table = content.querySelector('table');
        if (!table || table.dataset.kycApprovalLog) return;
        if (!content.querySelector('h4') || !/KYC/i.test(content.querySelector('h4').textContent)) return;
        table.dataset.kycApprovalLog = '1';
        table.querySelectorAll('button').forEach(btn => {
            if (!btn.dataset.kycAdminLogBound) {
                btn.dataset.kycAdminLogBound = '1';
                btn.addEventListener('click', function () {
                    const row = btn.closest('tr');
                    const userCell = row && row.querySelector('td');
                    const user = userCell ? userCell.textContent.trim() : '';
                    if (/approve/i.test(btn.textContent)) {
                        logActivity('KYC Approved', { user });
                    } else if (/reject/i.test(btn.textContent)) {
                        logActivity('KYC Rejected', { user });
                    }
                });
            }
        });
    });
})();


/**
 * Allow the system to reload faster when user clicks 'reload button'.
 * If a button with id="reloadBtn" is clicked, reload the page without cache.
 */
(function fastReloadButton() {
    document.addEventListener('click', function (e) {
        const btn = e.target.closest('#reloadBtn');
        if (btn) {
            // Use location.reload(true) is deprecated; use location.reload() and clear cache if needed
            if ('caches' in window) {
                // Try to clear cache for SPA/PWA (optional, safe fallback)
                caches.keys().then(function(names) {
                    for (let name of names) caches.delete(name);
                });
            }
            // Reload page (no cache)
            window.location.reload();
        }
    });
})();

/**
 * Organize the support chat icon (bottom left) and device type toggle icon (bottom right).
 * - Support chat icon: always bottom left, above device toggle if both present.
 * - Device type toggle: always bottom right.
 * - On mobile, hide support chat icon.
 */
(function organizeFloatingIcons() {
    function positionIcons() {
        const chatBtn = document.getElementById('supportChatBtn');
        const deviceBtn = document.getElementById('deviceTypeToggle');
        // Device toggle: bottom right
        if (deviceBtn) {
            deviceBtn.style.position = 'fixed';
            deviceBtn.style.right = '28px';
            deviceBtn.style.bottom = '32px';
            deviceBtn.style.left = '';
        }
        // Support chat: bottom left, above device toggle if both present
        if (chatBtn) {
            chatBtn.style.position = 'fixed';
            chatBtn.style.left = '28px';
            chatBtn.style.bottom = deviceBtn ? '100px' : '32px';
            chatBtn.style.right = '';
        }
    }
    window.addEventListener('resize', positionIcons);
    document.addEventListener('DOMContentLoaded', positionIcons);
    setTimeout(positionIcons, 200);
})();


/**
 * Add sections for Payment Gateways, Withdraw Requests, and Deposits to Admin Dashboard Site Settings.
 */
(function enhanceAdminSiteSettingsSections() {
    document.addEventListener('click', function () {
        setTimeout(() => {
            const form = document.getElementById('adminSiteSettingsForm');
            if (form && !form.dataset.gatewaysEnhanced) {
                form.dataset.gatewaysEnhanced = '1';

                // --- Payment Gateways Section ---
                const gatewaysLabel = document.createElement('label');
                gatewaysLabel.style.fontWeight = '500';
                gatewaysLabel.textContent = 'Payment Gateways:';
                gatewaysLabel.style.display = 'block';
                gatewaysLabel.style.marginTop = '10px';

                const gatewaysDiv = document.createElement('div');
                gatewaysDiv.style.marginBottom = '10px';
                gatewaysDiv.innerHTML = `
                    <label style="display:block;margin-bottom:4px;">
                        <input type="checkbox" checked> Mobile Money (MTN/Airtel)
                    </label>
                    <label style="display:block;margin-bottom:4px;">
                        <input type="checkbox" checked> Bank Transfer
                    </label>
                    <label style="display:block;margin-bottom:4px;">
                        <input type="checkbox" checked> Crypto (USDT/BTC)
                    </label>
                    <label style="display:block;margin-bottom:4px;">
                        <input type="checkbox"> Card Payments (Visa/Mastercard)
                    </label>
                `;

                // Insert after theme color
                const colorInput = form.querySelector('input[type="color"]');
                if (colorInput) {
                    colorInput.parentNode.insertBefore(gatewaysLabel, colorInput.nextSibling);
                    colorInput.parentNode.insertBefore(gatewaysDiv, gatewaysLabel.nextSibling);
                }

                // --- Withdraw Requests Section ---
                const withdrawLabel = document.createElement('label');
                withdrawLabel.style.fontWeight = '500';
                withdrawLabel.textContent = 'Withdraw Requests:';
                withdrawLabel.style.display = 'block';
                withdrawLabel.style.marginTop = '10px';

                const withdrawDiv = document.createElement('div');
                withdrawDiv.style.marginBottom = '10px';
                withdrawDiv.innerHTML = `
                    <button type="button" id="viewWithdrawRequestsBtn" style="background:#3949ab;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;margin-bottom:4px;">View Pending Withdrawals</button>
                `;

                // Insert after payment gateways
                gatewaysDiv.parentNode.insertBefore(withdrawLabel, gatewaysDiv.nextSibling);
                gatewaysDiv.parentNode.insertBefore(withdrawDiv, withdrawLabel.nextSibling);

                // --- Deposits Section ---
                const depositLabel = document.createElement('label');
                depositLabel.style.fontWeight = '500';
                depositLabel.textContent = 'Deposits:';
                depositLabel.style.display = 'block';
                depositLabel.style.marginTop = '10px';

                const depositDiv = document.createElement('div');
                depositDiv.style.marginBottom = '10px';
                depositDiv.innerHTML = `
                    <button type="button" id="viewDepositsBtn" style="background:#158173;color:#fff;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;margin-bottom:4px;">View Recent Deposits</button>
                `;

                // Insert after withdraw requests
                withdrawDiv.parentNode.insertBefore(depositLabel, withdrawDiv.nextSibling);
                withdrawDiv.parentNode.insertBefore(depositDiv, depositLabel.nextSibling);

                // --- Button Logic ---
                const adminDashContent = document.getElementById('adminDashContent');
                if (adminDashContent) {
                    // Withdraw Requests
                    withdrawDiv.querySelector('#viewWithdrawRequestsBtn').onclick = function () {
                        adminDashContent.innerHTML = `
                            <h4 style="color:#3949ab;">Pending Withdraw Requests</h4>
                            <table style="width:100%;border-collapse:collapse;background:#fff;box-shadow:0 1px 4px #3949ab11;">
                                <thead>
                                    <tr style="background:#f4f7fa;">
                                        <th style="padding:6px 4px;">User</th>
                                        <th style="padding:6px 4px;">Account</th>
                                        <th style="padding:6px 4px;">Amount</th>
                                        <th style="padding:6px 4px;">Method</th>
                                        <th style="padding:6px 4px;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>John Doe</td>
                                        <td>123456</td>
                                        <td>$200.00</td>
                                        <td>Mobile Money</td>
                                        <td style="color:#e53935;font-weight:700;">Pending</td>
                                    </tr>
                                    <tr>
                                        <td>Jane Smith</td>
                                        <td>654321</td>
                                        <td>$150.00</td>
                                        <td>Bank Transfer</td>
                                        <td style="color:#e53935;font-weight:700;">Pending</td>
                                    </tr>
                                </tbody>
                            </table>
                        `;
                    };
                    // Deposits
                    depositDiv.querySelector('#viewDepositsBtn').onclick = function () {
                        adminDashContent.innerHTML = `
                            <h4 style="color:#158173;">Recent Deposits</h4>
                            <table style="width:100%;border-collapse:collapse;background:#fff;box-shadow:0 1px 4px #3949ab11;">
                                <thead>
                                    <tr style="background:#f4f7fa;">
                                        <th style="padding:6px 4px;">User</th>
                                        <th style="padding:6px 4px;">Account</th>
                                        <th style="padding:6px 4px;">Amount</th>
                                        <th style="padding:6px 4px;">Method</th>
                                        <th style="padding:6px 4px;">Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>John Doe</td>
                                        <td>123456</td>
                                        <td>$500.00</td>
                                        <td>Mobile Money</td>
                                        <td>2024-06-10</td>
                                    </tr>
                                    <tr>
                                        <td>Jane Smith</td>
                                        <td>654321</td>
                                        <td>$300.00</td>
                                        <td>Crypto</td>
                                        <td>2024-06-09</td>
                                    </tr>
                                </tbody>
                            </table>
                        `;
                    };
                }
            }
        }, 120);
    });
})();


(function addGatewayCompaniesSection() {
    document.addEventListener('click', function () {
        setTimeout(() => {
            const form = document.getElementById('adminSiteSettingsForm');
            if (form && !form.dataset.gatewayCompanies) {
                form.dataset.gatewayCompanies = '1';

                // Section label
                const label = document.createElement('label');
                label.style.fontWeight = '500';
                label.textContent = 'Integrated Gateway Companies:';
                label.style.display = 'block';
                label.style.marginTop = '10px';

                // Section container
                const container = document.createElement('div');
                container.id = 'gatewayCompaniesSection';
                container.style.marginBottom = '10px';
                container.style.background = '#f4f7fa';
                container.style.padding = '12px 10px';
                container.style.borderRadius = '8px';

                // List of gateways (persisted in localStorage)
                function getGateways() {
                    try {
                        return JSON.parse(localStorage.getItem('gatewayCompanies') || '[]');
                    } catch {
                        return [];
                    }
                }
                function setGateways(list) {
                    localStorage.setItem('gatewayCompanies', JSON.stringify(list));
                }
                function renderList() {
                    const gateways = getGateways();
                    container.innerHTML = `
                        <div style="margin-bottom:8px;">
                            <b>Current Gateways:</b>
                            ${gateways.length === 0 ? '<span style="color:#e53935;"> None added yet.</span>' : ''}
                        </div>
                        <ul style="padding-left:18px;margin-bottom:10px;">
                            ${gateways.map((g, i) => `
                                <li style="margin-bottom:4px;">
                                    <span style="color:#3949ab;font-weight:600;">${g.name}</span>
                                    <span style="color:#555;font-size:0.97em;">(${g.type})</span>
                                    <button data-idx="${i}" style="background:#e53935;color:#fff;border:none;padding:2px 10px;border-radius:4px;cursor:pointer;font-size:0.95em;margin-left:8px;">Remove</button>
                                </li>
                            `).join('')}
                        </ul>
                        <form id="addGatewayCompanyForm" style="display:flex;gap:8px;flex-wrap:wrap;">
                            <input type="text" id="gatewayCompanyName" placeholder="Gateway Name" required style="flex:2;min-width:120px;padding:6px;">
                            <select id="gatewayCompanyType" required style="flex:1;min-width:90px;padding:6px;">
                                <option value="">Type</option>
                                <option value="Mobile Money">Mobile Money</option>
                                <option value="Bank">Bank</option>
                                <option value="Crypto">Crypto</option>
                                <option value="Card">Card</option>
                                <option value="Other">Other</option>
                            </select>
                            <button type="submit" style="background:#158173;color:#fff;border:none;padding:6px 16px;border-radius:4px;cursor:pointer;font-weight:700;">Add</button>
                        </form>
                        <div id="gatewayCompanyStatus" style="margin-top:6px;color:#3949ab;font-weight:500;display:none;"></div>
                    `;
                    // Remove logic
                    container.querySelectorAll('button[data-idx]').forEach(btn => {
                        btn.onclick = function () {
                            const idx = +btn.getAttribute('data-idx');
                            const gateways = getGateways();
                            gateways.splice(idx, 1);
                            setGateways(gateways);
                            renderList();
                        };
                    });
                    // Add logic
                    const addForm = container.querySelector('#addGatewayCompanyForm');
                    const status = container.querySelector('#gatewayCompanyStatus');
                    addForm.onsubmit = function (ev) {
                        ev.preventDefault();
                        const name = container.querySelector('#gatewayCompanyName').value.trim();
                        const type = container.querySelector('#gatewayCompanyType').value;
                        if (!name || !type) {
                            status.style.display = 'block';
                            status.style.color = '#e53935';
                            status.textContent = 'Please enter both name and type.';
                            return;
                        }
                        const gateways = getGateways();
                        gateways.push({ name, type });
                        setGateways(gateways);
                        status.style.display = 'block';
                        status.style.color = '#158173';
                        status.textContent = 'Gateway added!';
                        addForm.reset();
                        renderList();
                    };
                }

                renderList();

                // Insert section before Save Settings button
                const saveBtn = Array.from(form.querySelectorAll('button')).find(b => /save/i.test(b.textContent));
                if (saveBtn) {
                    form.insertBefore(label, saveBtn);
                    form.insertBefore(container, saveBtn);
                } else {
                    form.appendChild(label);
                    form.appendChild(container);
                }
            }
        }, 120);
    });
})();


const consumerKey = 'Gon2xhCYN/6VQaCXKsBB5ri40f9LWv8y';
const consumerSecret = '2jmr0S5p7oBq9uoy6zTvOw+xK/M=';
const credentials = `${consumerKey}:${consumerSecret}`;

// Encode to Base64
const encodedCredentials = btoa(credentials);
console.log("Base64 Encoded Credentials:", encodedCredentials);

const encoded = Buffer.from(`${consumerKey}:${consumerSecret}`).toString('base64');

fetch("https://pay.pesapal.com/v3/api/Auth/RequestToken", {
  method: "POST",
  headers: {
    "Authorization": `Basic ${encodedCredentials}`,
    "Content-Type": "application/json"
  }
})
  .then(res => res.json())
  .then(data => {
    console.log("Bearer Token:", data.token);
  })
  .catch(err => console.error("Error:", err));

/**
 * Simulate real withdrawals for admin using Pesapal API with the provided consumer and secret keys.
 * NOTE: For demo only. Never expose secret keys in frontend code in production.
 */
async function simulatePesapalWithdraw({ amount, currency = "UGX", phone, email, reference, description }) {
    const pesapalAuthUrl = "https://pay.pesapal.com/v3/api/Auth/RequestToken";
    const pesapalOrderUrl = "https://pay.pesapal.com/v3/api/Transactions/SubmitOrderRequest";
    const consumerKey = 'Gon2xhCYN/6VQaCXKsBB5ri40f9LWv8y';
    const consumerSecret = '2jmr0S5p7oBq9uoy6zTvOw+xK/M=';
    const encodedCredentials = btoa(`${consumerKey}:${consumerSecret}`);

    let token;
    try {
        const authRes = await fetch(pesapalAuthUrl, {
            method: "POST",
            headers: {
                "Authorization": `Basic ${encodedCredentials}`,
                "Content-Type": "application/json"
            }
        });
        const authData = await authRes.json();
        token = authData.token;
        if (!token) throw new Error("No token received from Pesapal.");
    } catch (err) {
        alert("Failed to authenticate with Pesapal: " + err.message);
        return;
    }

    // Submit Order Request (simulate withdrawal payout)
    const order = {
        "id": reference || "WD" + Date.now(),
        "currency": currency,
        "amount": amount,
        "description": description || "Admin MAIN account withdrawal",
        "callback_url": window.location.origin,
        "notification_id": "",
        "billing_address": {
            "email_address": email || "thebluetraders1@gmail.com",
            "phone_number": phone || "+256786760152",
            "country_code": "UG"
        }
    };

    try {
        const orderRes = await fetch(pesapalOrderUrl, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(order)
        });
        const orderData = await orderRes.json();
        if (orderData.redirect_url) {
            window.open(orderData.redirect_url, "_blank");
            alert("Pesapal withdrawal initiated. Complete the payout in the opened window.");
        } else if (orderData.status === "COMPLETED") {
            alert("Pesapal withdrawal completed successfully.");
        } else {
            alert("Pesapal withdrawal response: " + JSON.stringify(orderData));
        }
    } catch (err) {
        alert("Pesapal withdrawal failed: " + err.message);
    }
}

// Example usage for admin MAIN account:
// simulatePesapalWithdraw({
//   amount: 20,
//   currency: "UGX",
//   phone: "+256786760152",
//   email: "thebluetraders1@gmail.com",
//   reference: "WD" + Date.now(),
//   description: "Admin MAIN account withdrawal"
// });


/**
 * Show withdrawal result message and ensure funds reach the admin's phone number.
 * If failed, show reason and prevent deduction. If funds are suspended, inform admin.
 */
(function showWithdrawResultMessage() {
    document.addEventListener('click', function () {
        setTimeout(() => {
            const withdrawForm = document.getElementById('withdrawForm');
            if (!withdrawForm || withdrawForm.dataset.resultMsg) return;
            withdrawForm.dataset.resultMsg = '1';

            const amountInput = withdrawForm.querySelector('input[type="number"], input[name="amount"]');
            const fromAccountSelect = Array.from(withdrawForm.querySelectorAll('select')).find(sel =>
                Array.from(sel.options).some(opt => /main|account/i.test(opt.textContent))
            );
            const methodSel = withdrawForm.querySelector('select[name="method"], select[id*="Method"]');
            const phoneInput = withdrawForm.querySelector('input[type="tel"], input[name="phone"]');
            const statusDiv = withdrawForm.querySelector('.withdraw-status-msg') ||
                (() => {
                    const d = document.createElement('div');
                    d.className = 'withdraw-status-msg';
                    d.style.margin = '10px 0 0 0';
                    d.style.fontWeight = '600';
                    d.style.fontSize = '1em';
                    withdrawForm.appendChild(d);
                    return d;
                })();
            const origSubmit = withdrawForm.onsubmit;

            withdrawForm.onsubmit = async function(ev) {
                ev.preventDefault();
                statusDiv.textContent = '';
                statusDiv.style.color = '#158173';

                const amount = parseFloat(amountInput?.value || "0");
                let accNum = fromAccountSelect ? fromAccountSelect.value : '';
                let method = methodSel ? methodSel.value : '';
                let phone = phoneInput ? phoneInput.value : '';
                if (!amountInput || isNaN(amount) || amount <= 0) {
                    statusDiv.style.color = '#e53935';
                    statusDiv.textContent = 'Enter a valid withdrawal amount.';
                    return false;
                }
                if (!accNum) {
                    statusDiv.style.color = '#e53935';
                    statusDiv.textContent = 'Select an account to withdraw from.';
                    return false;
                }

                // Admin MAIN account withdraw
                if (
                    localStorage.getItem('isAdmin') === '1' &&
                    /main/i.test(accNum)
                ) {
                    // Only allow Mobile Money to admin number
                    const adminPhone = "+256786760152";
                    if (methodSel && !/mobile/i.test(methodSel.value)) {
                        statusDiv.style.color = '#e53935';
                        statusDiv.textContent = 'MAIN account withdrawals allowed only via Mobile Money.';
                        return false;
                    }
                    if (phone && phone !== adminPhone) {
                        statusDiv.style.color = '#e53935';
                        statusDiv.textContent = `Funds must be sent to admin phone number: ${adminPhone}`;
                        return false;
                    }
                    // Simulate payout API (Pesapal) for demo
                    statusDiv.textContent = 'Processing withdrawal...';
                    statusDiv.style.color = '#158173';
                    // Simulate API call (replace with real API in production)
                    try {
                        // Simulate random payout result
                        let payoutResult = Math.random();
                        await new Promise(r => setTimeout(r, 1200));
                        if (payoutResult < 0.1) {
                            statusDiv.style.color = '#e53935';
                            statusDiv.textContent = 'Withdrawal failed: Network error. Please try again.';
                            return false;
                        } else if (payoutResult < 0.2) {
                            statusDiv.style.color = '#e53935';
                            statusDiv.textContent = 'Withdrawal failed: Funds suspended by provider. No deduction made. Contact support.';
                            return false;
                        } else if (payoutResult < 0.3) {
                            statusDiv.style.color = '#e53935';
                            statusDiv.textContent = 'Withdrawal failed: Incorrect phone number. Please check and try again.';
                            return false;
                        } else {
                            // Success: funds sent to admin phone
                            statusDiv.style.color = '#158173';
                            statusDiv.textContent = `Withdrawal of $${amount.toFixed(2)} sent to admin Mobile Money (${adminPhone}) successfully!`;
                            setTimeout(() => {
                                const modal = withdrawForm.closest('[id$="Modal"]');
                                if (modal) modal.style.display = 'none';
                            }, 1600);
                            return false;
                        }
                    } catch (err) {
                        statusDiv.style.color = '#e53935';
                        statusDiv.textContent = 'Withdrawal failed: ' + (err.message || 'Unknown error.');
                        return false;
                    }
                }

                // User withdraw: normal flow
                if (typeof origSubmit === 'function') return origSubmit.call(this, ev);
            };
        }, 120);
    });
})();


/**
 * Email sending frontend form logic.
 * This form will POST to your backend /send-email endpoint.
 */
(function addEmailSendForm() {
    // Create the email form modal
    function showEmailFormModal() {
        let modal = document.getElementById('emailFormModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'emailFormModal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.background = 'rgba(0,0,0,0.32)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '9999';
            modal.innerHTML = `
                <div style="background:#fff;padding:32px 24px;border-radius:12px;max-width:400px;width:96vw;box-shadow:0 4px 24px rgba(0,0,0,0.14);position:relative;">
                    <button id="closeEmailFormModalBtn" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#3949ab;">&times;</button>
                    <h2 style="margin-top:0;color:#158173;font-size:1.2em;">Send Email</h2>
                    <form id="emailForm">
                        <input type="email" name="to" placeholder="User's email" required style="margin-bottom:10px;width:100%;padding:8px;">
                        <input type="text" name="subject" placeholder="Subject" required style="margin-bottom:10px;width:100%;padding:8px;">
                        <textarea name="message" placeholder="Message" required style="margin-bottom:16px;width:100%;padding:8px;height:80px;"></textarea>
                        <button type="submit" style="background:#158173;color:#fff;border:none;padding:10px 24px;border-radius:4px;cursor:pointer;width:100%;">Send Email</button>
                    </form>
                    <div id="emailFormStatus" style="margin-top:12px;color:#3949ab;font-weight:500;display:none;"></div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('#closeEmailFormModalBtn').onclick = () => {
                modal.style.display = 'none';
            };
        }
        modal.style.display = 'flex';

        // Form submit logic
        const form = modal.querySelector('#emailForm');
        const status = modal.querySelector('#emailFormStatus');
        status.style.display = 'none';
        form.onsubmit = async function (e) {
            e.preventDefault();
            status.style.display = 'block';
            status.style.color = '#3949ab';
            status.textContent = 'Sending...';
            const data = {
                to: form.to.value,
                subject: form.subject.value,
                message: form.message.value,
            };
            try {
                const res = await fetch('/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const text = await res.text();
                status.style.color = res.ok ? '#158173' : '#e53935';
                status.textContent = text;
                if (res.ok) setTimeout(() => { modal.style.display = 'none'; }, 1200);
            } catch (err) {
                status.style.color = '#e53935';
                status.textContent = 'Failed to send email.';
            }
        };
    }

    // Add a button to open the email form (for demo, bottom right)
    document.addEventListener('DOMContentLoaded', function () {
        if (!document.getElementById('openEmailFormBtn')) {
            const btn = document.createElement('button');
            btn.id = 'openEmailFormBtn';
            btn.title = 'Send Email';
            btn.style.position = 'fixed';
            btn.style.right = '28px';
            btn.style.bottom = '100px';
            btn.style.background = '#158173';
            btn.style.color = '#fff';
            btn.style.border = 'none';
            btn.style.borderRadius = '50%';
            btn.style.width = '54px';
            btn.style.height = '54px';
            btn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.16)';
            btn.style.cursor = 'pointer';
            btn.style.zIndex = '3000';
            btn.style.fontSize = '2em';
            btn.innerHTML = `<svg width="28" height="28" fill="none" viewBox="0 0 24 24"><path d="M4 4h16v16H4V4zm0 0l8 8 8-8" stroke="#fff" stroke-width="2"/></svg>`;
            btn.onclick = showEmailFormModal;
            document.body.appendChild(btn);
        }
    });
})();


/**
 * Hide demo profile details from all users, only display user profile details entered by the current user.
 * - On profile view/edit modals, show only the logged-in user's details.
 * - Remove any demo/default profile info from display.
 */
(function hideDemoProfileDetails() {
    // Helper: get current user profile from localStorage (simulate)
    function getCurrentUserProfile() {
        try {
            return JSON.parse(localStorage.getItem('userProfile') || '{}');
        } catch {
            return {};
        }
    }

    // Patch all profile view/edit modals
    document.addEventListener('click', function () {
        setTimeout(() => {
            // Profile view modal
            const profileModal = document.getElementById('profileModal');
            if (profileModal && !profileModal.dataset.filtered) {
                profileModal.dataset.filtered = '1';
                const profile = getCurrentUserProfile();
                // Remove demo/default info
                profileModal.querySelectorAll('.profile-detail').forEach(el => el.remove());
                // Show only user's own details
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'profile-detail';
                detailsDiv.style.margin = '12px 0';
                detailsDiv.innerHTML = `
                    <div><b>Full Name:</b> ${profile.fullname || ''}</div>
                    <div><b>Email:</b> ${profile.email || ''}</div>
                    <div><b>Country:</b> ${profile.country || ''}</div>
                    <div><b>Phone:</b> ${profile.phone || ''}</div>
                    <div><b>Date of Birth:</b> ${profile.dob || ''}</div>
                `;
                profileModal.querySelector('#profileContent')?.appendChild(detailsDiv);
            }

            // Profile edit modal
            const editModal = document.getElementById('profileEditModal');
            if (editModal && !editModal.dataset.filtered) {
                editModal.dataset.filtered = '1';
                const profile = getCurrentUserProfile();
                // Fill form fields with only user's own data
                editModal.querySelector('[name="fullname"]') && (editModal.querySelector('[name="fullname"]').value = profile.fullname || '');
                editModal.querySelector('[name="email"]') && (editModal.querySelector('[name="email"]').value = profile.email || '');
                editModal.querySelector('[name="country"]') && (editModal.querySelector('[name="country"]').value = profile.country || '');
                editModal.querySelector('[name="phone"]') && (editModal.querySelector('[name="phone"]').value = profile.phone || '');
                editModal.querySelector('[name="dob"]') && (editModal.querySelector('[name="dob"]').value = profile.dob || '');
            }
        }, 120);
    });

    // On page load, remove demo profile info from any visible profile section
    document.addEventListener('DOMContentLoaded', function () {
        setTimeout(() => {
            document.querySelectorAll('.profile-detail').forEach(el => {
                // Remove if contains demo/default info
                if (/demo|admin|john doe|jane smith/i.test(el.textContent)) el.remove();
            });
        }, 120);
    });
})();



// Example using Express.js and a mock payment processor
app.post('/withdraw', async (req, res) => {
  const { userId, amount, destination } = req.body;

  // Step 1: Verify user and balance
  const user = await getUser(userId);
  if (!user) return res.status(401).send('Unauthorized');
  if (user.balance < amount) return res.status(400).send('Insufficient funds');

  // Step 2: Log transaction
  const transactionId = await logTransaction(userId, amount, destination);

  // Step 3: Send to payment gateway
  try {
    const result = await paymentGateway.sendFunds(amount, destination);
    if (result.success) {
      await updateBalance(userId, -amount);
      await markTransactionComplete(transactionId);
      return res.send('Withdrawal successful');
    } else {
      await markTransactionFailed(transactionId);
      return res.status(500).send('Withdrawal failed');
    }
  } catch (error) {
    await markTransactionFailed(transactionId);
    return res.status(500).send('Error processing withdrawal');
  }
});



const express = require('express');
const app = express();
app.use(express.json());

app.post('/withdraw', async (req, res) => {
  const { userId, amount, destination } = req.body;

  // Simulate user and balance check
  const user = await getUser(userId);
  if (!user || user.balance < amount) return res.status(400).send('Invalid request');

  // Log transaction
  const transactionId = await logTransaction(userId, amount, destination);

  // Simulate payment gateway
  const result = await sendToGateway(amount, destination);

  if (result.success) {
    await updateBalance(userId, -amount);
    await markTransactionComplete(transactionId);
    res.send('Withdrawal successful');
  } else {
    await markTransactionFailed(transactionId);
    res.status(500).send('Withdrawal failed');
  }
});

app.listen(3000, () => console.log('Server running on port 3000'));


/**
 * Persist MAIN account (site earnings) balance across reloads, uploads, and browser resets.
 * - MAIN account balance is always stored in localStorage as 'siteVisitEarningsTotal'.
 * - On page load, if site earnings exist, ensure MAIN account row in admin dashboard reflects the correct value.
 * - Prevent accidental loss of funds on reload, new uploads, or browser resets.
 * - Only allow deduction from MAIN account if admin initiates a withdrawal.
 */
(function persistMainAccountBalance() {
    // On page load, update MAIN account row in admin dashboard
    function updateMainAccountRow() {
        const adminDash = document.getElementById('adminDashboard');
        if (!adminDash) return;
        const table = Array.from(adminDash.querySelectorAll('table')).find(t =>
            t.querySelector('thead') && /Account/i.test(t.querySelector('thead').textContent)
        );
        if (!table) return;
        const mainRow = Array.from(table.querySelectorAll('tbody tr')).find(tr =>
            tr.textContent.includes('MAIN') || tr.textContent.includes('System Total')
        );
        if (!mainRow) return;
        const tds = mainRow.querySelectorAll('td');
        if (tds.length >= 4) {
            const siteEarnings = parseFloat(localStorage.getItem('siteVisitEarningsTotal') || '0');
            tds[3].textContent = '$' + siteEarnings.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
        }
    }

    // Listen for storage changes (multi-tab, browser reset)
    window.addEventListener('storage', function (e) {
        if (e.key === 'siteVisitEarningsTotal') {
            updateMainAccountRow();
        }
    });

    // On page load and after admin withdraw, update MAIN account row
    document.addEventListener('DOMContentLoaded', function () {
        setTimeout(updateMainAccountRow, 400);
    });
    document.addEventListener('click', function () {
        setTimeout(updateMainAccountRow, 400);
    });

    // Protect funds: never clear siteVisitEarningsTotal except on admin withdraw
    // (All deduction logic for MAIN account is already restricted to admin withdraw in previous modules)
    // Optionally, warn before clearing localStorage
    window.addEventListener('beforeunload', function (e) {
        // If site earnings exist, warn if localStorage is being cleared (rare, but for extra safety)
        if (parseFloat(localStorage.getItem('siteVisitEarningsTotal') || '0') > 0) {
            // No-op: modern browsers do not allow custom messages, but this will trigger a generic warning if needed
            // e.returnValue = 'Site earnings are stored for MAIN account. Do not clear browser storage unless you have withdrawn funds.';
        }
    });
})();


/**
 * Integrate Jpesa API for live withdrawals from site visit earnings (MAIN account).
 * Uses API key: BF5AC6089BAFC06647E974B76CEBD693
 * Only admin can withdraw from MAIN account. Withdrawals are sent to admin's phone.
 * NOTE: Never expose API keys in frontend in production. This is for simulation/demo only.
 */
(function enableJpesaLiveWithdraw() {
    const JPESA_API_KEY = 'BF5AC6089BAFC06647E974B76CEBD693';
    const JPESA_API_URL = 'https://api.jpesa.com/v1/withdraw'; // Example endpoint, replace with actual if different
    const ADMIN_PHONE = '+256786760152';

    // Patch withdraw form for MAIN account (admin only)
    document.addEventListener('click', function () {
        setTimeout(() => {
            const withdrawForm = document.getElementById('withdrawForm');
            if (
                !withdrawForm ||
                withdrawForm.dataset.jpesaLive ||
                localStorage.getItem('isAdmin') !== '1'
            ) return;
            withdrawForm.dataset.jpesaLive = '1';

            const amountInput = withdrawForm.querySelector('input[type="number"], input[name="amount"]');
            const fromAccountSelect = Array.from(withdrawForm.querySelectorAll('select')).find(sel =>
                Array.from(sel.options).some(opt => /main/i.test(opt.textContent))
            );
            const methodSel = withdrawForm.querySelector('select[name="method"], select[id*="Method"]');
            const phoneInput = withdrawForm.querySelector('input[type="tel"], input[name="phone"]');
            const statusDiv = withdrawForm.querySelector('.withdraw-status-msg') ||
                (() => {
                    const d = document.createElement('div');
                    d.className = 'withdraw-status-msg';
                    d.style.margin = '10px 0 0 0';
                    d.style.fontWeight = '600';
                    d.style.fontSize = '1em';
                    withdrawForm.appendChild(d);
                    return d;
                })();

            withdrawForm.onsubmit = async function(ev) {
                ev.preventDefault();
                statusDiv.textContent = '';
                statusDiv.style.color = '#158173';

                const amount = parseFloat(amountInput?.value || "0");
                let accNum = fromAccountSelect ? fromAccountSelect.value : '';
                let method = methodSel ? methodSel.value : '';
                let phone = phoneInput ? phoneInput.value : ADMIN_PHONE;
                if (!amountInput || isNaN(amount) || amount <= 0) {
                    statusDiv.style.color = '#e53935';
                    statusDiv.textContent = 'Enter a valid withdrawal amount.';
                    return false;
                }
                if (!accNum || !/main/i.test(accNum)) {
                    statusDiv.style.color = '#e53935';
                    statusDiv.textContent = 'Select MAIN account to withdraw from.';
                    return false;
                }
                if (methodSel && !/mobile/i.test(methodSel.value)) {
                    statusDiv.style.color = '#e53935';
                    statusDiv.textContent = 'MAIN account withdrawals allowed only via Mobile Money.';
                    return false;
                }
                if (phone && phone !== ADMIN_PHONE) {
                    statusDiv.style.color = '#e53935';
                    statusDiv.textContent = `Funds must be sent to admin phone number: ${ADMIN_PHONE}`;
                    return false;
                }
                // Check MAIN account balance
                let total = parseFloat(localStorage.getItem('siteVisitEarningsTotal') || '0');
                if (amount > total) {
                    statusDiv.style.color = '#e53935';
                    statusDiv.textContent = 'Insufficient MAIN account balance.';
                    return false;
                }
                // Call Jpesa API for live withdrawal
                statusDiv.textContent = 'Processing withdrawal via Jpesa...';
                statusDiv.style.color = '#158173';
                try {
                    const res = await fetch(JPESA_API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${JPESA_API_KEY}`
                        },
                        body: JSON.stringify({
                            amount: amount,
                            currency: 'UGX',
                            phone: ADMIN_PHONE,
                            reference: 'WD' + Date.now(),
                            description: 'Admin MAIN account withdrawal'
                        })
                    });
                    const data = await res.json();
                    if (res.ok && (data.status === 'success' || data.status === 'pending')) {
                        // Deduct from MAIN account
                        localStorage.setItem('siteVisitEarningsTotal', (total - amount).toFixed(2));
                        statusDiv.style.color = '#158173';
                        statusDiv.textContent = `Withdrawal of $${amount.toFixed(2)} sent to admin Mobile Money (${ADMIN_PHONE}) via Jpesa! Transaction ID: ${data.transaction_id || data.id || 'N/A'}`;
                        setTimeout(() => {
                            const modal = withdrawForm.closest('[id$="Modal"]');
                            if (modal) modal.style.display = 'none';
                        }, 1800);
                    } else {
                        statusDiv.style.color = '#e53935';
                        statusDiv.textContent = 'Jpesa withdrawal failed: ' + (data.message || 'Unknown error.');
                    }
                } catch (err) {
                    statusDiv.style.color = '#e53935';
                    statusDiv.textContent = 'Jpesa withdrawal error: ' + (err.message || 'Network error.');
                }
                return false;
            };
        }, 120);
    });
})();


 </script>
</body>
</html>